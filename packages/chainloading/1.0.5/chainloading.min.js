(function(y){function l(a,b){this.chain=a;this.active=b||!1;this.completed=!0;this.state="";this.dfds=[];this.failCallbacks=[];this.nextLevel=null}function z(a,b,c,d,m){function r(a){p||(p=!0,f.length=0,c(a,g))}function l(){for(var a=0;a<f.length&&A&&!p&&0!==f[a].s;a++)null!==f[a].args&&g.args.push.apply(g.args,f[a].args),f.splice(a,1),a--;0===f.length&&r("resolved")}this.args=[];this.promise=new k;var g=this,e=this.promise,f=[],p=!1,A=!1,q;a=0;for(q=b.length;a<q;a++){if(b[a]===n)throw Error("Undefined sent to push/add. Did you forget to return a deferred?");
f.push({d:b[a],s:0,args:null})}a=0;for(q=f.length;a<q&&!p;a++)if("function"===typeof f[a].d)f[a].s=1,this.promise.done(f[a].d);else{if("function"!==typeof f[a].d.then)throw Error("Invalid deferred sent to chain");(function(a){a.d.then(function(){if(0===a.s){a.args=h.call(arguments);a.s=1;var b=this;e.done(function(){m.set(b);for(var a=0;a<d.length;a++)b===d[a].d&&(e.done(d[a].func),d.splice(a,1),a--)});l()}},function(){if(0===a.s){g.args=h.call(arguments);a.s=1;var b=this;e.fail(function(){m.set(b);
for(var a=0;a<d.length;a++)b===d[a].d&&(e.fail(d[a].func),d.splice(a,1),a--)});r("rejected")}})})(f[a])}A=!0;l()}function k(a){this.ctx=a||this;this.s="pending";this.args=null;this.callbacks=[]}function v(){}function t(){function a(){for(var a=0;a<s.length;a++)s[a].call(d),s.splice(a,1),a--}function b(b,q){var u=e!==n,c;if(u&&"rejected"===e.state)return new v;c=new l(d,!u||e.completed);c.addFailCallback(a);u&&(e.nextLevel=c);e=c;return c[b](q,m,r)}function c(b,q){e===n&&(e=new l(this,!0),e.addFailCallback(a));
return e[b](q,m,r)}var d=this,m=[],r=new w,s=[],g,e,f;this.push=this.next=function(){return b("requireDeferreds",h.call(arguments))};this.add=function(){return c("requireDeferreds",h.call(arguments))};this.pushIgnoreFail=this.nextIgnoreFail=function(){return b("optionalDeferreds",h.call(arguments))};this.addIgnoreFail=function(){return c("optionalDeferreds",h.call(arguments))};this.done=this.after=this.then=function(a,b){b?this.add(a):this.push(a);return this};this.then=function(a,b){var c,d;if("function"===
typeof a)this.done(a);else if(null!=a)for(c=0,d=a.length;c<d;c++)this.done(a[c]);if("function"===typeof b)this.fail(b);else if(null!=b)for(c=0,d=b.length;c<d;c++)this.fail(b[c]);return this};this.fail=this["catch"]=function(a){e===n?s.push(a):e.addFailCallback(a);return this};var p=function(a,b,c){return function(){var e;e=c===n?function(){a.apply(b,h.call(arguments))}:function(){a.apply(b,c.concat(h.call(arguments)));c.length=0};this===d||this instanceof k||r.has(this)?e.apply(this,h.call(arguments)):
m.push({d:this,func:e,s:this.state()})}};this.bind=function(a,b){return 3>arguments.length?p(a,b):p(a,b,h.call(arguments,2))};this.applyArgs=function(a,b){if(3>arguments.length)return g===n&&(g=[]),p(a,b,g);var c=h.call(arguments,2);return function(){var d=(g||[]).splice(0,g.length).concat(c).concat(h.call(arguments));p(a,b,d).call(this)}};this.storeArgs=function(){var a=h.call(arguments),b=function(){g===n&&(g=[]);g.push.apply(g,a)};if(this===d)return b;this instanceof k||r.has(this)?b():m.push({d:this,
func:b,s:this.state()})};this.always=function(a){return this.fail(a).done(a)};this.fork=function(){var a=new t;a.push(this);return a};this.state=function(){return e===n?"pending":("ignored"===e.state?"rejected":e.state)||"pending"};this.promise=function(){if(f===n){var a=function(a,b){return function(c,d,e){return a.call(b,c,d,e)}};f={state:this.state,done:a(this.done,this),fail:a(this.fail,this),always:a(this.always,this),then:a(this.then,this)}}return f}}var w=y.WeakMap,h=[].slice,B=function(){return this},
n;w===n&&(w=function(){var a=[];this.has=function(b){var c=-1;for(null!=b&&(c=a.length-1);0<=c&&a[c]!==b;)c--;return-1<c};this.set=function(b){a.push(b)}});l.prototype.newGroup=function(a,b,c,d){""===this.state&&(this.completed=!1);var m={s:0,r:this.active};this.dfds.push(m);return new z(this.chain,a,function(a,c){m.g=c;m.s=1;b(a,m.r)},c,d)};l.prototype.requireDeferreds=function(a,b,c){var d=this;return this.newGroup(a,function(a,b){switch(a){case "resolved":""===d.state&&(d.state="resolved");break;
case "rejected":d.state="rejected"}b&&d.complete()},b,c).promise};l.prototype.optionalDeferreds=function(a,b,c){var d=this;return this.newGroup(a,function(a,b){switch(a){case "resolved":""===d.state&&(d.state="resolved");break;case "rejected":d.state="ignored"}b&&d.complete()},b,c).promise};l.prototype.addFailCallback=function(a){"ignored"===this.state||"rejected"===this.state?a.call(this.chain):this.completed&&""!==this.state||this.failCallbacks.push(a)};l.prototype.complete=function(){this.active=
!0;for(var a=0;a<this.dfds.length;a++){if("function"===typeof this.dfds[a])this.dfds[a]();else{this.dfds[a].r=!0;if(0===this.dfds[a].s)break;this.dfds[a].g.complete(this.state)}this.dfds.splice(a,1);a--}0===this.dfds.length&&(this.completed=!0);!0===this.completed&&("rejected"===this.state?this.failed():(this.cleanup(!0),null!==this.nextLevel&&this.nextLevel.complete()))};l.prototype.failed=function(){for(var a=0;a<this.failCallbacks.length;a++)this.failCallbacks[a].call(this.chain),this.failCallbacks.splice(a,
1),a--;this.cleanup(!0);null!==this.nextLevel&&this.nextLevel.failed()};l.prototype.cleanup=function(a){var b,c;for(b=0;b<this.dfds.length;b++)this.dfds[b].r=!1,this.dfds.splice(b,1),b--;b=0;for(c=this.failCallbacks.length;b<c;b++)this.failCallbacks.shift();null!==this.nextLevel&&!0!==a&&this.nextLevel.cleanup()};z.prototype.complete=function(a){var b=this.promise.callbacks;"pending"===this.promise.s&&(this.promise.s="ignored"===a?"rejected":a,this.promise.args=this.args);for(a=0;a<b.length;a++)b[a].s===
this.promise.s&&b[a].f.apply(this.promise.ctx,this.promise.args),b.splice(a,1),a--};k.prototype.done=function(){var a,b;if("resolved"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to done "+typeof arguments[a]);this.callbacks.push({s:"resolved",f:arguments[a]})}return this};k.prototype.then=function(a,b){"function"===typeof a?this.done(a):
null!=a&&this.done.apply(this,a);"function"===typeof b?this.fail(b):null!=b&&this.fail.apply(this,b);return this};k.prototype.fail=function(){var a,b;if("rejected"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to fail "+typeof arguments[a]);this.callbacks.push({s:"rejected",f:arguments[a]})}return this};k.prototype["catch"]=k.prototype.fail;
k.prototype.always=function(){var a=h.call(arguments);return this.fail.apply(this,a).done.apply(this,a)};k.prototype.state=function(){return this.s};for(var x in k.prototype)k.prototype.hasOwnProperty(x)&&"function"===typeof k.prototype[x]&&(v.prototype[x]=B);v.prototype.state=function(){return"pending"};"undefined"!==typeof module?module.exports=t:(y.ChainLoading=t,"function"===typeof define&&"object"===typeof define.amd&&define.amd&&define("ChainLoading",function(){return t}))})(this);
