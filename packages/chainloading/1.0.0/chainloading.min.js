(function(w){function f(a,b){this.chain=a;this.active=b||!1;this.completed=!0;this.state="";this.dfds=[];this.failCallbacks=[];this.nextLevel=null}function x(a,b,e,c,k){function n(){for(var a=0;a<d.length&&0!==d[a].s;a++)null!==d[a].args&&l.args.push.apply(l.args,d[a].args),d.splice(a,1),a--;0===d.length&&e("resolved",l)}this.args=[];this.promise=new h;var l=this,f=this.promise,d=[],m;a=0;for(m=b.length;a<m;a++){if(b[a]===p)throw Error("Undefined sent to sent. Did you forget to return deferred?");
d.push({d:b[a],s:0,args:null})}a=0;for(m=d.length;a<m;a++)if("function"===typeof d[a].d)d[a].s=1,this.promise.done(d[a].d);else{if("function"!==typeof d[a].d.then)throw Error("Invalid deferred sent to chain");(function(a){var b;a.d.then(function(){a.args=g.call(arguments);a.s=1;var b=this;f.done(function(){k.set(b);for(var a=0;a<c.length;a++)b===c[a].d&&(f.done(c[a].func),c.splice(a,1),a--)});n()});b=function(){l.args=g.call(arguments);var a=this;f.fail(function(){k.set(a);for(var b=0;b<c.length;b++)a===
c[b].d&&(f.fail(c[b].func),c.splice(b,1),b--)});e("rejected",l)};if(a.d["catch"]!==p)a.d["catch"](b);else a.d.fail(b)})(d[a])}0<d.length&&n()}function h(a){this.ctx=a||this;this.s="pending";this.args=null;this.callbacks=[]}function t(){}function s(){function a(){for(var a=0;a<r.length;a++)r[a].call(c),r.splice(a,1),a--}function b(b,y){var e=d!==p,q;if(e&&"rejected"===d.state)return new t;q=new f(c,!e||d.completed);q.addFailCallback(a);e&&(d.nextLevel=q);d=q;return q[b](y,k,n)}function e(b,c){d===
p&&(d=new f(this,!0),d.addFailCallback(a));return d[b](c,k,n)}var c=this,k=[],n=new u,l=[],r=[],d;this.push=this.next=function(){return b("requireDeferreds",g.call(arguments))};this.add=function(){return e("requireDeferreds",g.call(arguments))};this.pushIgnoreFail=this.nextIgnoreFail=function(){return b("optionalDeferreds",g.call(arguments))};this.addIgnoreFail=function(){return e("optionalDeferreds",g.call(arguments))};this.done=this.after=this.then=function(a,b){b?this.add(a):this.push(a);return this};
this.then=function(a,b){var c,d;if("function"===typeof a)this.done(a);else if(null!=a)for(c=0,d=a.length;c<d;c++)this.done(a[c]);if("function"===typeof b)this.fail(b);else if(null!=b)for(c=0,d=b.length;c<d;c++)this.fail(b[c]);return this};this.fail=this["catch"]=function(a){d===p?r.push(a):d.addFailCallback(a);return this};var m=function(a,b,d){return function(){var e;e=d===p?function(){a.apply(b,g.call(arguments))}:function(){a.apply(b,d.concat(g.call(arguments)));d.length=0};this===c||this instanceof
h||n.has(this)?e.apply(this,g.call(arguments)):k.push({d:this,func:e,s:this.state()})}};this.bind=function(a,b){return 3>arguments.length?m(a,b):m(a,b,g.call(arguments,2))};this.applyArgs=function(a,b){if(3>arguments.length)return m(a,b,l);var c=g.call(arguments,2);return function(){var d=l.concat(c).concat(g.call(arguments));l.length=0;m(a,b,d).call(this)}};this.storeArgs=function(){var a=g.call(arguments),b=function(){l.push.apply(l,a)};if(this===c)return b;this instanceof h||n.has(this)?b():k.push({d:this,
func:b,s:this.state()})};this.always=function(a){return this.fail(a).done(a)};this.fork=function(){var a=new s;a.push(this);return a}}var u=w.WeakMap,g=[].slice,z=function(){return this},p;u===p&&(u=function(){var a=[];this.has=function(b){var e=-1;for(null!=b&&(e=a.length-1);0<=e&&a[e]!==b;)e--;return-1<e};this.set=function(b){a.push(b)}});f.prototype.newGroup=function(a,b,e,c){""===this.state&&(this.completed=!1);var k={s:0,r:this.active};this.dfds.push(k);return new x(this.chain,a,function(a,c){k.g=
c;k.s=1;b(a,k.r)},e,c)};f.prototype.requireDeferreds=function(a,b,e){var c=this;return this.newGroup(a,function(a,b){switch(a){case "resolved":""===c.state&&(c.state="resolved");break;case "rejected":c.state="rejected"}b&&c.complete()},b,e).promise};f.prototype.optionalDeferreds=function(a,b,e){var c=this;return this.newGroup(a,function(a,b){switch(a){case "resolved":""===c.state&&(c.state="resolved");break;case "rejected":c.state="ignored"}b&&c.complete()},b,e).promise};f.prototype.addFailCallback=
function(a){"ignored"===this.state||"rejected"===this.state?a.call(this.chain):this.completed&&""!==this.state||this.failCallbacks.push(a)};f.prototype.complete=function(){this.active=!0;for(var a=0;a<this.dfds.length;a++){if("function"===typeof this.dfds[a])this.dfds[a]();else{this.dfds[a].r=!0;if(0===this.dfds[a].s)break;this.dfds[a].g.complete(this.state)}this.dfds.splice(a,1);a--}0===this.dfds.length&&(this.completed=!0);!0===this.completed&&("rejected"===this.state?this.failed():(this.cleanup(!0),
null!==this.nextLevel&&this.nextLevel.complete()))};f.prototype.failed=function(){for(var a=0;a<this.failCallbacks.length;a++)this.failCallbacks[a].call(this.chain),this.failCallbacks.splice(a,1),a--;this.cleanup(!0);null!==this.nextLevel&&this.nextLevel.failed()};f.prototype.cleanup=function(a){var b,e;for(b=0;b<this.dfds.length;b++)this.dfds[b].r=!1,this.dfds.splice(b,1),b--;b=0;for(e=this.failCallbacks.length;b<e;b++)this.failCallbacks.shift();null!==this.nextLevel&&!0!==a&&this.nextLevel.cleanup()};
x.prototype.complete=function(a){var b=this.promise.callbacks;"pending"===this.promise.s&&(this.promise.s="ignored"===a?"rejected":a,this.promise.args=this.args);for(a=0;a<b.length;a++)b[a].s===this.promise.s&&b[a].f.apply(this.promise.ctx,this.promise.args),b.splice(a,1),a--};h.prototype.done=function(){var a,b;if("resolved"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to done "+
typeof arguments[a]);this.callbacks.push({s:"resolved",f:arguments[a]})}return this};h.prototype.then=function(a,b){"function"===typeof a?this.done(a):null!=a&&this.done.apply(this,a);"function"===typeof b?this.fail(b):null!=b&&this.fail.apply(this,b);return this};h.prototype.fail=function(){var a,b;if("rejected"===this.s)for(a=0,b=arguments.length;a<b;a++)arguments[a].apply(this.ctx,this.args);else if("pending"===this.s)for(a=0,b=arguments.length;a<b;a++){if("function"!==typeof arguments[a])throw Error("Invalid function sent to fail "+
typeof arguments[a]);this.callbacks.push({s:"rejected",f:arguments[a]})}return this};h.prototype["catch"]=h.prototype.fail;h.prototype.always=function(){var a=g.call(arguments);return this.fail.apply(this,a).done.apply(this,a)};h.prototype.state=function(){return this.s};for(var v in h.prototype)h.prototype.hasOwnProperty(v)&&"function"===typeof h.prototype[v]&&(t.prototype[v]=z);t.prototype.state=function(){return"pending"};"undefined"!==typeof module?module.exports=s:(w.ChainLoading=s,"function"==
typeof define&&"object"==typeof define.amd&&define.amd&&define("ChainLoading",function(){return s}))})(this);
