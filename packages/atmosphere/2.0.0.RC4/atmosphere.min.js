/**
 * Copyright 2012 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(){var ia="2.0.0-javascript",e={},s=[],D=[],U=Object.prototype.hasOwnProperty,e={onError:function(e){},onClose:function(e){},onOpen:function(e){},onReopen:function(e){},onMessage:function(e){},onReconnect:function(e,h){},onMessagePublished:function(e){},onTransportFailure:function(e,h){},onLocalMessage:function(e){},onFailureToReconnect:function(e,h){},AtmosphereRequest:function(d){function h(b,a){""===f.partialMessage&&("streaming"===a.transport&&b.responseText.length>a.maxStreamingLength)&& (f.messages=[],I(!0),g(),l(),L(b,a,0))}function g(){if(c.enableProtocol&&!c.firstMessage){var b="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+c.uuid,a=c.url.replace(/([?&])_=[^&]*/,b),a=a+(a===c.url?(/\?/.test(c.url)?"&":"?")+b:"");c.attachHeadersAsQueryString=!1;c.dropAtmosphereHeaders=!0;c.url=a;c.transport="polling";(b=c)||(b=V(""));b.transport="polling";b.method="GET";b.async=!1;b.reconnect=!1;b.force=!0;b.suspend=!1;Q(b)}}function m(){c.reconnect=!1;J=!0;f.request=c;f.state="unsubscribe"; f.responseBody="";f.status=408;y();g();l()}function l(){c.id&&clearTimeout(c.id);null!=v&&(v.close(),v=null);null!=E&&(E.abort(),E=null);null!=M&&(M.abort(),M=null);null!=r&&(r.webSocketOpened&&r.close(),r=null);null!=t&&(t.close(),t=null);null!=B&&(clearInterval(R),document.cookie=encodeURIComponent("atmosphere-"+c.url)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT",B.signal("close",{reason:"",heir:J?(B.get("children")||[])[0]:z}),B.close());null!=w&&w.close()}function aa(b){l();W=!0;J=!1;C=0;v=M=t= r=null;c=e.util.extend(c,b);c.mrequest=c.reconnect;c.reconnect||(c.reconnect=!0)}function F(){if(c.shared){w=ja(c);if(null!=w&&("debug"===c.logLevel&&e.util.debug("Storage service available. All communication will be local"),w.open(c)))return;"debug"===c.logLevel&&e.util.debug("No Storage service available.");w=null}c.firstMessage=!0;c.isOpen=!1;c.ctime=e.util.now();"websocket"!==c.transport&&"sse"!==c.transport?Q(c):"websocket"===c.transport?null!=c.webSocketImpl||window.WebSocket||window.MozWebSocket? q(!1):N("Websocket is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"):"sse"===c.transport&&(window.EventSource?x(!1):N("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+c.fallbackTransport+")"))}function ja(b){function a(a,b){var c,e=a.length;for(c=0;c<e;c++)a[c]===b&&a.splice(c,1);return e!==a.length}function k(a){a=e.util.parseJSON(a);var k=a.data;if("c"===a.target)switch(a.type){case "open":u("opening","local",c);break;case "close":p||(p=!0, "aborted"===k.reason?m():k.heir===z?F():setTimeout(function(){F()},100));break;case "message":O(k,"messageReceived",200,b.transport);break;case "localMessage":ba(k)}}function n(){var a=RegExp("(?:^|; )("+encodeURIComponent(h)+")=([^;]*)").exec(document.cookie);if(a)return e.util.parseJSON(decodeURIComponent(a[2]))}var f,d,p,h="atmosphere-"+b.url,g={storage:function(){if(e.util.supportStorage()){var c=window.localStorage,f=function(a){return e.util.parseJSON(c.getItem(h+"-"+a))},n=function(a,b){c.setItem(h+ "-"+a,e.util.stringifyJSON(b))};return{init:function(){n("children",f("children").concat([z]));e.util.on("storage.socket",function(a){a=a.originalEvent;a.key===h&&a.newValue&&k(a.newValue)});return f("opened")},signal:function(a,b){c.setItem(h,e.util.stringifyJSON({target:"p",type:a,data:b}))},close:function(){var c=f("children");e.util.off("storage.socket");c&&a(c,b.id)&&n("children",c)}}}},windowref:function(){var b=window.open("",h.replace(/\W/g,""));if(b&&!b.closed&&b.callbacks)return{init:function(){b.callbacks.push(k); b.children.push(z);return b.opened},signal:function(a,c){!b.closed&&b.fire&&b.fire(e.util.stringifyJSON({target:"p",type:a,data:c}))},close:function(){p||(a(b.callbacks,k),a(b.children,z))}}}};if((f=n())&&!(1E3<e.util.now()-f.ts)&&(d=g.storage()||g.windowref()))return{open:function(){var a;R=setInterval(function(){var a=f;(f=n())&&a.ts!==f.ts||k(e.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:a.heir}}))},1E3);(a=d.init())&&setTimeout(function(){u("opening","local",b)},50); return a},send:function(a){d.signal("send",a)},localSend:function(a){d.signal("localSend",e.util.stringifyJSON({id:z,event:a}))},close:function(){J||(clearInterval(R),d.signal("close"),d.close())}}}function s(){function b(a){a=e.util.parseJSON(a);var b=a.data;if("p"===a.target)switch(a.type){case "send":X(b);break;case "localSend":ba(b);break;case "close":m()}}function a(){document.cookie=encodeURIComponent(f)+"="+encodeURIComponent(e.util.stringifyJSON({ts:e.util.now()+1,heir:(k.get("children")|| [])[0]}))}var k,f="atmosphere-"+c.url,d={storage:function(){if(e.util.supportStorage()){var a=window.localStorage;return{init:function(){e.util.on("storage.socket",function(a){a=a.originalEvent;a.key===f&&a.newValue&&b(a.newValue)})},signal:function(b,c){a.setItem(f,e.util.stringifyJSON({target:"c",type:b,data:c}))},get:function(b){return e.util.parseJSON(a.getItem(f+"-"+b))},set:function(b,c){a.setItem(f+"-"+b,e.util.stringifyJSON(c))},close:function(){e.util.off("storage.socket");a.removeItem(f); a.removeItem(f+"-opened");a.removeItem(f+"-children")}}}},windowref:function(){var a=f.replace(/\W/g,""),c=document.getElementById(a),k;c||(c=document.createElement("div"),c.id=a,c.style.display="none",c.innerHTML='<iframe name="'+a+'" />',document.body.appendChild(c));k=c.firstChild.contentWindow;return{init:function(){k.callbacks=[b];k.fire=function(a){var b;for(b=0;b<k.callbacks.length;b++)k.callbacks[b](a)}},signal:function(a,b){!k.closed&&k.fire&&k.fire(e.util.stringifyJSON({target:"c",type:a, data:b}))},get:function(a){return k.closed?null:k[a]},set:function(a,b){k.closed||(k[a]=b)},close:function(){}}}};P=function(a){k.signal("message",a)};k=d.storage()||d.windowref();k.init();"debug"===c.logLevel&&e.util.debug("Installed StorageService "+k);k.set("children",[]);null==k.get("opened")||k.get("opened")||k.set("opened",!1);a();R=setInterval(a,1E3);B=k}function u(b,a,k){c.shared&&"local"!==a&&s();null!=B&&B.set("opened",!0);k.close=function(){m()};0<C&&"re-connecting"===b?(k.isReopen=!0, ka(f)):null==f.error&&(f.request=k,k=f.state,f.state=b,b=f.transport,f.transport=a,a=f.responseBody,y(),f.responseBody=a,f.state=k,f.transport=b)}function ca(b){b.transport="jsonp";var a=c,k;null!=b&&"undefined"!==typeof b&&(a=b);E={open:function(){function b(){var c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);var e=a.data;a.attachHeadersAsQueryString&&(c=K(a),""!==e&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(e)),e="");e=document.head||document.getElementsByTagName("head")[0]||document.documentElement; k=document.createElement("script");k.src=c+"&jsonpTransport="+d;k.clean=function(){k.clean=k.onerror=k.onload=k.onreadystatechange=null;k.parentNode&&k.parentNode.removeChild(k)};k.onload=k.onreadystatechange=function(){k.readyState&&!/loaded|complete/.test(k.readyState)||k.clean()};k.onerror=function(){k.clean();A(0,"maxReconnectOnClose reached")};e.insertBefore(k,e.firstChild)}var d="atmosphere"+ ++z;window[d]=function(b){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<a.maxRequest){a.executeCallbackBeforeReconnect|| L(E,a,0);if(null!=b&&"string"!==typeof b)try{b=b.message}catch(k){}G(b,a,f)||O(f.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&L(E,a,0)}else e.util.log(c.logLevel,["JSONP reconnect maximum try reached "+c.requestCount]),A(0,"maxRequest reached")};setTimeout(function(){b()},50)},abort:function(){k.clean&&k.clean()}};E.open()}function x(b){f.transport="sse";var a=K(c);"debug"===c.logLevel&&(e.util.debug("Invoking executeSSE"),e.util.debug("Using URL: "+a));if(c.enableProtocol&& b){var k=e.util.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(k)}if(b&&!c.reconnect)null!=t&&l();else{try{t=new EventSource(a,{withCredentials:c.withCredentials})}catch(d){A(0,d);N("SSE failed. Downgrading to fallback transport and resending");return}0<c.connectTimeout&&(c.id=setTimeout(function(){b||l()},c.connectTimeout));t.onopen=function(a){H(c);"debug"===c.logLevel&&e.util.debug("SSE successfully opened");c.enableProtocol||(b?u("re-opening","sse",c):u("opening","sse",c));b=!0;"POST"=== c.method&&(f.state="messageReceived",t.send(c.data))};t.onmessage=function(a){H(c);!c.enableXDR&&a.origin&&a.origin!==window.location.protocol+"//"+window.location.host?e.util.log(c.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(f.state="messageReceived",f.status=200,a=a.data,a=G(a,c,f),t.URL&&(t.interval=100,t.URL=K(c)),a||(y(),f.responseBody="",f.messages=[]))};t.onerror=function(a){clearTimeout(c.id);I(b);l();J?e.util.log(c.logLevel,["SSE closed normally"]):b? c.reconnect&&"sse"===f.transport&&(C++<c.maxReconnectOnClose?(u("re-connecting",c.transport,c),c.id=setTimeout(function(){x(!0)},c.reconnectInterval),f.responseBody="",f.messages=[]):(e.util.log(c.logLevel,["SSE reconnect maximum try reached "+C]),A(0,"maxReconnectOnClose reached"))):N("SSE failed. Downgrading to fallback transport and resending")}}}function q(b){f.transport="websocket";if(c.enableProtocol&&b){var a=e.util.now()-c.ctime;c.lastTimestamp=Number(c.stime)+Number(a)}a=e.util.getAbsoluteURL(K(c)).replace(/^http/, "ws");"debug"===c.logLevel&&(e.util.debug("Invoking executeWebSocket"),e.util.debug("Using URL: "+a));if(b&&!c.reconnect)null!=r&&l();else if(r=null!=c.webSocketImpl?c.webSocketImpl:window.WebSocket?new WebSocket(a):new MozWebSocket(a),null!=c.webSocketBinaryType&&(r.binaryType=c.webSocketBinaryType),0<c.connectTimeout&&(c.id=setTimeout(function(){if(!b){r.onclose({code:1002,reason:"",wasClean:!1});try{l()}catch(a){}}},c.connectTimeout)),r.onopen=function(a){H(c);"debug"===c.logLevel&&e.util.debug("Websocket successfully opened"); c.enableProtocol||(b?u("re-opening","websocket",c):u("opening","websocket",c));b=!0;r.webSocketOpened=b;"POST"===c.method&&(f.state="messageReceived",r.send(c.data))},r.onmessage=function(a){H(c);f.state="messageReceived";f.status=200;a=a.data;"string"===typeof a?G(a,c,f)||(y(),f.responseBody="",f.messages=[]):da(c,a)&&(f.responseBody=a,y(),f.responseBody=null)},r.onerror=function(a){clearTimeout(c.id)},r.onclose=function(a){clearTimeout(c.id);if("closed"!==f.state){var d=a.reason;if(""===d)switch(a.code){case 1E3:d= "Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:d="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:d="The endpoint is terminating the connection due to a protocol error.";break;case 1003:d="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data)."; break;case 1004:d="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:d="Unknown: no status code was provided even though one was expected.";break;case 1006:d="Connection was closed abnormally (that is, with no close frame being sent)."}e.util.warn("Websocket closed, reason: "+d);e.util.warn("Websocket closed, wasClean: "+a.wasClean);I(b);f.state="closed";J?e.util.log(c.logLevel,["Websocket closed normally"]):b?c.reconnect&&"websocket"=== f.transport&&(l(),C++<c.maxReconnectOnClose?(u("re-connecting",c.transport,c),c.id=setTimeout(function(){f.responseBody="";f.messages=[];q(!0)},c.reconnectInterval)):(e.util.log(c.logLevel,["Websocket reconnect maximum try reached "+c.requestCount]),e.util.warn("Websocket error, reason: "+a.reason),A(0,"maxReconnectOnClose reached"))):N("Websocket failed. Downgrading to Comet and resending")}},void 0===r.url)r.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function da(b, a){var c=!0;if(0!==e.util.trim(a)&&b.enableProtocol&&b.firstMessage){b.firstMessage=!1;var c=a.split(b.messageDelimiter),f=2===c.length?0:1;b.uuid=e.util.trim(c[f]);b.stime=e.util.trim(c[f+1]);c=!1;"long-polling"!==b.transport&&Y(b)}else Y(b);return c}function H(b){clearTimeout(b.id);0<b.timeout&&"polling"!==b.transport&&(b.id=setTimeout(function(){I(!0);l();g()},b.timeout))}function A(b,a){l();clearTimeout(c.id);f.state="error";f.reasonPhrase=a;f.responseBody="";f.status=b;f.messages=[];y()}function G(b, a,f){if(!da(c,b)||0===b.length)return!0;if(a.trackMessageLength){b=f.partialMessage+b;for(var d=[],h=b.indexOf(a.messageDelimiter);-1!==h;){var g=e.util.trim(b.substring(0,h)),p=+g;if(isNaN(p))throw Error('message length "'+g+'" is not a number');h+=a.messageDelimiter.length;h+p>b.length?h=-1:(d.push(b.substring(h,h+p)),b=b.substring(h+p,b.length),h=b.indexOf(a.messageDelimiter))}f.partialMessage=b;if(0!==d.length)f.responseBody=d.join(a.messageDelimiter),f.messages=d;else return f.responseBody="", f.messages=[],!0}else f.responseBody=b;return!1}function N(b){e.util.log(c.logLevel,[b]);if("undefined"!==typeof c.onTransportFailure)c.onTransportFailure(b,c);else if("undefined"!==typeof e.util.onTransportFailure)e.util.onTransportFailure(b,c);c.transport=c.fallbackTransport;b=-1===c.connectTimeout?0:c.connectTimeout;c.reconnect&&"none"!==c.transport||null==c.transport?(c.method=c.fallbackMethod,f.transport=c.fallbackTransport,c.fallbackTransport="none",c.id=setTimeout(function(){F()},b)):A(500, "Unable to reconnect with fallback transport")}function K(b,a){var d=c;null!=b&&"undefined"!==typeof b&&(d=b);null==a&&(a=d.url);if(!d.attachHeadersAsQueryString||-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+d.uuid;a+="&X-Atmosphere-Framework="+ia;a+="&X-Atmosphere-Transport="+d.transport;d.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");a=null!=d.lastTimestamp?a+("&X-Cache-Date="+d.lastTimestamp):a+"&X-Cache-Date=0"; ""!==d.contentType&&(a+="&Content-Type="+d.contentType);d.enableProtocol&&(a+="&X-atmo-protocol=true");e.util.each(d.headers,function(c,h){var g=e.util.isFunction(h)?h.call(this,d,b,f):h;null!=g&&(a+="&"+encodeURIComponent(c)+"="+encodeURIComponent(g))});return a}function Y(b){b.isOpen?b.isReopen&&(b.isReopen=!1,u("re-opening",b.transport,b)):(b.isOpen=!0,u("opening",b.transport,b))}function Q(b){var a=c;if(null!=b||"undefined"!==typeof b)a=b;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport|| a.enableXDR&&e.util.checkCORSSupport())ca(a);else{if(e.util.browser.msie&&10>e.util.browser.version){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?S(a):(v=Z(a),v.open());return}if(a.enableXDR&&window.XDomainRequest){S(a);return}}var d=function(){a.lastIndex=0;a.reconnect&&C++<a.maxReconnectOnClose?(u("re-connecting",b.transport,b),L(n,a,b.reconnectInterval)):A(0,"maxReconnectOnClose reached")};if(a.force||a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)){a.force= !1;var n=e.util.xhr();n.hasData=!1;U(n,a,!0);a.suspend&&(M=n);"polling"!==a.transport&&(f.transport=a.transport,n.onabort=function(){I(!0)},n.onerror=function(){f.error=!0;try{f.status=XMLHttpRequest.status}catch(a){f.status=500}f.status||(f.status=500);l();f.errorHandled||d()});n.onreadystatechange=function(){if(!J){f.error=null;var g=!1,p=!1;if(e.util.browser.opera&&"streaming"===a.transport&&2<a.readyState&&4===n.readyState)l(),d();else if(a.readyState=n.readyState,"streaming"===a.transport&&3<= n.readyState?p=!0:"long-polling"===a.transport&&4===n.readyState&&(p=!0),H(c),a.enableProtocol&&b.firstMessage||("polling"===a.transport||2!==n.readyState)||Y(a),p)if(p=0,0!==n.readyState&&(p=1E3<n.status?0:n.status),300<=p||0===p)f.errorHandled=!0,l(),d();else if(p=n.responseText,0===e.util.trim(p).length&&"long-polling"===a.transport)n.hasData?n.hasData=!1:d();else{n.hasData=!0;$(n,c);if("streaming"===a.transport)if(e.util.browser.opera)e.util.iterate(function(){if(500!==f.status&&n.responseText.length> a.lastIndex){try{f.status=n.status,f.headers=e.util.parseHeaders(n.getAllResponseHeaders()),$(n,c)}catch(b){f.status=404}H(c);f.state="messageReceived";var d=n.responseText.substring(a.lastIndex);a.lastIndex=n.responseText.length;(g=G(d,a,f))||y();h(n,a)}else if(400<f.status)return a.lastIndex=n.responseText.length,!1},0);else{var m=p.substring(a.lastIndex,p.length),g=G(m,a,f);a.lastIndex=p.length;if(g)return}else g=G(p,a,f);try{f.status=n.status,f.headers=e.util.parseHeaders(n.getAllResponseHeaders()), $(n,a)}catch(q){f.status=404}f.state=a.suspend?0===f.status?"closed":"messageReceived":"messagePublished";(p="streaming"!==b.transport)&&!a.executeCallbackBeforeReconnect&&L(n,a,0);0===f.responseBody.length||g||y();p&&a.executeCallbackBeforeReconnect&&L(n,a,0);h(n,a)}}};try{n.send(a.data),W=!0}catch(g){e.util.log(a.logLevel,["Unable to connect to "+a.url])}}else"debug"===a.logLevel&&e.util.log(a.logLevel,["Max re-connection reached."]),A(0,"maxRequest reached")}}function U(b,a,d){var n=a.url;null!= a.dispatchUrl&&"POST"===a.method&&(n+=a.dispatchUrl);n=K(a,n);n=e.util.prepareURL(n);d&&(b.open(a.method,n,a.async),-1<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(l(),O("Connect timeout","closed",200,a.transport))},a.connectTimeout)));c.withCredentials&&"withCredentials"in b&&(b.withCredentials=!0);c.dropAtmosphereHeaders||(b.setRequestHeader("X-Atmosphere-Framework",e.util.version),b.setRequestHeader("X-Atmosphere-Transport",a.transport),null!=a.lastTimestamp?b.setRequestHeader("X-Cache-Date", a.lastTimestamp):b.setRequestHeader("X-Cache-Date",0),a.trackMessageLength&&b.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),b.setRequestHeader("X-Atmosphere-tracking-id",a.uuid));""!==a.contentType&&b.setRequestHeader("Content-Type",a.contentType);e.util.each(a.headers,function(c,n){var h=e.util.isFunction(n)?n.call(this,b,a,d,f):n;null!=h&&b.setRequestHeader(c,h)})}function L(b,a,c){if(a.reconnect||a.suspend&&W){var d=0;b&&0!==b.readyState&&(d=1E3<b.status?0:b.status);f.status=0===d?204: d;f.reason=0===d?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.id=setTimeout(function(){Q(a)},c)}}function ka(b){b.state="re-connecting";ea(b)}function S(b){"polling"!==b.transport?(v=fa(b),v.open()):fa(b).open()}function fa(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var d=a.transport,h=0,g=new window.XDomainRequest,m=function(){"long-polling"===a.transport&&(a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest))&&(g.status=200,S(a))},p=a.rewriteURL||function(a){var b= /(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(b&&b[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b[2]+"&").replace(/&$/,"")}return a};g.onprogress=function(){clearTimeout(a.id);var b=g.responseText,b=b.substring(h);h+=b.length;if("polling"!==d){H(a);var c=G(b,a,f);if("long-polling"!==d||0!==e.util.trim(b))a.executeCallbackBeforeReconnect&&m(),c||O(f.responseBody, "messageReceived",200,d),a.executeCallbackBeforeReconnect||m()}};g.onerror=function(){"polling"!==a.transport&&(l(),C++<a.maxReconnectOnClose?a.id=setTimeout(function(){u("re-connecting",b.transport,b);S(a)},a.reconnectInterval):A(0,"maxReconnectOnClose reached"))};g.onload=function(){};return{open:function(){var b=a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);b=K(a,b);g.open(a.method,p(b));"GET"===a.method?g.send():g.send(a.data);-1<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&& (l(),O("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){g.abort()}}}function Z(b){var a=c;null!=b&&"undefined"!==typeof b&&(a=b);var d,h=new window.ActiveXObject("htmlfile");h.open();h.close();var g=a.url;null!=a.dispatchUrl&&(g+=a.dispatchUrl);"polling"!==a.transport&&(f.transport=a.transport);return{open:function(){var b=h.createElement("iframe");g=K(a);""!==a.data&&(g+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));g=e.util.prepareURL(g);b.src=g;h.body.appendChild(b); var p=b.contentDocument||b.contentWindow.document;d=e.util.iterate(function(){try{if(p.firstChild){var b=p.body?p.body.lastChild:p,g=function(){var a=b.cloneNode(!0);a.appendChild(p.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!p.body||!p.body.firstChild||"pre"!==p.body.firstChild.nodeName.toLowerCase()){var l=p.head||p.getElementsByTagName("head")[0]||p.documentElement||p,m=p.createElement("script");m.text="document.write('<plaintext>')";l.insertBefore(m,l.firstChild); l.removeChild(m);b=p.body.lastChild}a.closed&&(a.isReopen=!0);d=e.util.iterate(function(){var d=g();if(d.length>a.lastIndex){H(c);f.status=200;f.error=null;b.innerText="";if(G(d,a,f))return"";O(f.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===p.readyState)return I(!0),u("re-connecting",a.transport,a),a.id=setTimeout(function(){v=Z(a);v.open()},a.reconnectInterval),!1},null);return!1}}catch(q){return f.error=!0,u("re-connecting",a.transport,a),C++<a.maxReconnectOnClose? a.id=setTimeout(function(){v=Z(a);v.open()},a.reconnectInterval):A(0,"maxReconnectOnClose reached"),h.execCommand("Stop"),h.close(),!1}})},close:function(){d&&d();h.execCommand("Stop");I(!0)}}}function X(b){null!=w?w.send(b):null!=M||null!=t?T(b):null!=v?c.enableXDR&&e.util.checkCORSSupport()?(b=V(b),b.reconnect=!1,ca(b)):T(b):null!=E?T(b):null!=r&&la(b)}function T(b){b=V(b);Q(b)}function ga(b){var a=b;"object"===typeof a&&(a=b.data);return a}function V(b){var a=ga(b),a={connected:!1,timeout:6E4, method:"POST",url:c.url,contentType:c.contentType,headers:c.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:c.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:c.enableXDR,uuid:c.uuid,dispatchUrl:c.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",maxReconnectOnClose:c.maxReconnectOnClose};"object"===typeof b&&(a=e.util.extend(a,b));return a}function la(b){var a=ga(b),d;try{d=null!=c.dispatchUrl? c.webSocketPathDelimiter+c.dispatchUrl+c.webSocketPathDelimiter+a:a,r.send(d)}catch(e){r.onclose=function(a){},l(),N("Websocket failed. Downgrading to Comet and resending "+d),T(b)}}function ba(b){b=e.util.parseJSON(b);if(b.id!==z)if("undefined"!==typeof c.onLocalMessage)c.onLocalMessage(b.event);else if("undefined"!==typeof e.util.onLocalMessage)e.util.onLocalMessage(b.event)}function O(b,a,c,d){f.responseBody=b;f.transport=d;f.status=c;f.state=a;y()}function $(b,a){if(a.readResponsesHeaders||a.enableProtocol)try{var d= b.getResponseHeader("X-Cache-Date");d&&(null!=d&&0<d.length)&&(a.lastTimestamp=d.split(" ").pop());var h=b.getResponseHeader("X-Atmosphere-tracking-id");h&&null!=h&&(a.uuid=h.split(" ").pop());a.headers&&e.util.each(c.headers,function(a){var c=b.getResponseHeader(a);c&&(f.headers[a]=c)})}catch(g){}else a.lastTimestamp=e.util.now(),a.uuid=z}function ea(b){ha(b,c);ha(b,e.util)}function ha(b,a){switch(b.state){case "messageReceived":C=0;if("undefined"!==typeof a.onMessage)a.onMessage(b);break;case "error":if("undefined"!== typeof a.onError)a.onError(b);break;case "opening":if("undefined"!==typeof a.onOpen)a.onOpen(b);break;case "messagePublished":if("undefined"!==typeof a.onMessagePublished)a.onMessagePublished(b);break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(c,b);break;case "re-opening":if("undefined"!==typeof a.onReopen)a.onReopen(c,b);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(c,b);break;case "unsubscribe":case "closed":var d= "undefined"!==typeof c.closed?c.closed:!1;if("undefined"!==typeof a.onClose&&!d)a.onClose(b);c.closed=!0}}function I(b){"closed"!==f.state&&(f.state="closed",f.responseBody="",f.messages=[],f.status=b?200:501,y())}function y(){var b=function(a,b){b(f)};null==w&&null!=P&&P(f.responseBody);c.reconnect=c.mrequest;for(var a="string"===typeof f.responseBody,d=a&&c.trackMessageLength?0<f.messages.length?f.messages:[""]:Array(f.responseBody),h=0;h<d.length;h++)if(!(1<d.length&&0===d[h].length)&&(f.responseBody= a?e.util.trim(d[h]):d[h],null==w&&null!=P&&P(f.responseBody),0!==f.responseBody.length||"messageReceived"!==f.state)){ea(f);if(0<D.length){"debug"===c.logLevel&&e.util.debug("Invoking "+D.length+" global callbacks: "+f.state);try{e.util.each(D,b)}catch(g){e.util.log(c.logLevel,["Callback exception"+g])}}if("function"===typeof c.callback){"debug"===c.logLevel&&e.util.debug("Invoking request callbacks");try{c.callback(f)}catch(l){e.util.log(c.logLevel,["Callback exception"+l])}}}}var c={timeout:3E5, method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|", connectTimeout:-1,reconnectInterval:0,dropAtmosphereHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,onError:function(b){},onClose:function(b){},onOpen:function(b){},onMessage:function(b){},onReopen:function(b,a){},onReconnect:function(b,a){},onMessagePublished:function(b){},onTransportFailure:function(b,a){},onLocalMessage:function(b){},onFailureToReconnect:function(b,a){}},f={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[], state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,id:0},r=null,t=null,M=null,v=null,E=null,W=!0,C=0,J=!1,P=null,B,w=null,z=e.util.now(),R;aa(d);this.subscribe=function(b){aa(b);F()};this.execute=function(){F()};this.close=function(){m()};this.disconnect=function(){g()};this.getUrl=function(){return c.url};this.push=function(b,a){if(null!=a){var d=c.dispatchUrl;c.dispatchUrl=a;X(b);c.dispatchUrl=d}else X(b)};this.getUUID=function(){return c.uuid}; this.pushLocal=function(b){if(0!==b.length)try{w?w.localSend(b):B&&B.signal("localMessage",e.util.stringifyJSON({id:z,event:b}))}catch(a){e.util.error(a)}};this.enableProtocol=function(b){return c.enableProtocol};this.request=c;this.response=f},subscribe:function(d,h,g){"function"===typeof h&&e.addCallback(h);"string"!==typeof d?g=d:g.url=d;d=new e.AtmosphereRequest(g);d.execute();return s[s.length]=d},unsubscribe:function(){if(0<s.length)for(var d=[].concat(s),e=0;e<d.length;e++){var g=d[e];g.close(); clearTimeout(g.response.request.id)}s=[];D=[]},unsubscribeUrl:function(d){var e=-1;if(0<s.length)for(var g=0;g<s.length;g++){var m=s[g];if(m.getUrl()===d){m.close();clearTimeout(m.response.request.id);e=g;break}}0<=e&&s.splice(e,1)},addCallback:function(d){-1===e.util.inArray(d,D)&&D.push(d)},removeCallback:function(d){d=e.util.inArray(d,D);-1!==d&&D.splice(d,1)},util:{browser:{},parseHeaders:function(d){for(var e,g=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,m={};e=g.exec(d);)m[e[1]]=e[2];return m},now:function(){return(new Date).getTime()}, isArray:function(d){return"[object Array]"===Object.prototype.toString.call(d)},isBinary:function(d){d=Object.prototype.toString.call(d);return"[object Blob]"===d||"[object ArrayBuffer]"===d},isFunction:function(d){return"[object Function]"===Object.prototype.toString.call(d)},getAbsoluteURL:function(d){var e=document.createElement("div");e.innerHTML='<a href="'+d+'"/>';return encodeURI(decodeURI(e.firstChild.href))},prepareURL:function(d){var h=e.util.now(),g=d.replace(/([?&])_=[^&]*/,"$1_="+h); return g+(g===d?(/\?/.test(d)?"&":"?")+"_="+h:"")},trim:function(d){return String.prototype.trim?d.toString().trim():d.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(d){function h(d,g){g=e.util.isFunction(g)?g():null==g?"":g;l.push(encodeURIComponent(d)+"="+encodeURIComponent(g))}function g(d,l){var m;if(e.util.isArray(l))e.util.each(l,function(e,l){/\[\]$/.test(d)?h(d,l):g(d+"["+("object"===typeof l?e:"")+"]",l)});else if("[object Object]"===Object.prototype.toString.call(l))for(m in l)g(d+ "["+m+"]",l[m]);else h(d,l)}var m,l=[];for(m in d)g(m,d[m]);return l.join("&").replace(/%20/g,"+")},supportStorage:function(){var d=window.localStorage;if(d)try{return d.setItem("t","t"),d.removeItem("t"),window.StorageEvent&&!e.util.browser.msie&&!(e.util.browser.mozilla&&"1"===e.util.browser.version.split(".")[0])}catch(h){}return!1},iterate:function(d,e){var g;e=e||0;(function l(){g=setTimeout(function(){!1!==d()&&l()},e)})();return function(){clearTimeout(g)}},each:function(d,h,g){var m,l=0,s= d.length;m=e.util.isArray(d);if(g)if(m)for(;l<s&&(m=h.apply(d[l],g),!1!==m);l++);else for(l in d){if(m=h.apply(d[l],g),!1===m)break}else if(m)for(;l<s&&(m=h.call(d[l],l,d[l]),!1!==m);l++);else for(l in d)if(m=h.call(d[l],l,d[l]),!1===m)break;return d},extend:function(d){var e,g,m;for(e=1;e<arguments.length;e++)if(null!=(g=arguments[e]))for(m in g)d[m]=g[m];return d},on:function(d,e,g){d.addEventListener?d.addEventListener(e,g,!1):d.attachEvent&&d.attachEvent("on"+e,g)},off:function(d,e,g){d.removeEventListener? d.removeEventListener(e,g,!1):d.detachEvent&&d.detachEvent("on"+e,g)},log:function(d,e){if(window.console){var g=window.console[d];"function"===typeof g&&g.apply(window.console,e)}},warn:function(){e.util.log("warn",arguments)},info:function(){e.util.log("info",arguments)},debug:function(){e.util.log("debug",arguments)},error:function(){e.util.log("error",arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(d){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}}, parseJSON:function(d){return d?window.JSON&&window.JSON.parse?window.JSON.parse(d):(new Function("return "+d))():null},stringifyJSON:function(d){function e(d){return'"'+d.replace(m,function(d){var e=l[d];return"string"===typeof e?e:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"'}function g(d){return 10>d?"0"+d:d}var m=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,l={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f", "\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(d):function F(d,l){var m,s,x,q=l[d];x=typeof q;q&&("object"===typeof q&&"function"===typeof q.toJSON)&&(q=q.toJSON(d),x=typeof q);switch(x){case "string":return e(q);case "number":return isFinite(q)?String(q):"null";case "boolean":return String(q);case "object":if(!q)return"null";switch(Object.prototype.toString.call(q)){case "[object Date]":return isFinite(q.valueOf())?'"'+q.getUTCFullYear()+"-"+g(q.getUTCMonth()+ 1)+"-"+g(q.getUTCDate())+"T"+g(q.getUTCHours())+":"+g(q.getUTCMinutes())+":"+g(q.getUTCSeconds())+'Z"':"null";case "[object Array]":s=q.length;x=[];for(m=0;m<s;m++)x.push(F(m,q)||"null");return"["+x.join(",")+"]";default:x=[];for(m in q)U.call(q,m)&&(s=F(m,q))&&x.push(e(m)+":"+s);return"{"+x.join(",")+"}"}}}("",{"":d})},checkCORSSupport:function(){return e.util.browser.msie&&!window.XDomainRequest||e.util.browser.opera&&12>e.util.browser.version?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")? !0:!1}}};e.util.now();(function(){var d=navigator.userAgent.toLowerCase(),d=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||0>d.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];e.util.browser[d[1]||""]=!0;e.util.browser.version=d[2]||"0";if(e.util.browser.msie||e.util.browser.mozilla&&"1"===e.util.browser.version.split(".")[0])e.util.storage=!1})();e.util.on(window,"unload",function(d){e.unsubscribe()}); e.util.on(window,"keypress",function(d){27===d.which&&d.preventDefault()});e.util.on(window,"offline",function(){e.unsubscribe()});window.atmosphere=e})();
