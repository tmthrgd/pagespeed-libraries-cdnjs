/**
 * Copyright 2012 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(){var ha="2.0.0-javascript",c={},p=[],B=[],c={onError:function(c){},onClose:function(c){},onOpen:function(c){},onReopen:function(c){},onMessage:function(c){},onReconnect:function(c,h){},onMessagePublished:function(c){},onTransportFailure:function(c,h){},onLocalMessage:function(c){},onFailureToReconnect:function(c,h){},AtmosphereRequest:function(f){function h(b,a){""==e.partialMessage&&("streaming"==a.transport&&b.responseText.length>a.maxStreamingLength)&&(e.messages=[],C(!0),k(),l(),J(b, a,0))}function k(){if(d.enableProtocol&&!d.firstMessage){var b="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+d.uuid,a=d.url.replace(/([?&])_=[^&]*/,b),a=a+(a===d.url?(/\?/.test(d.url)?"&":"?")+b:"");d.attachHeadersAsQueryString=!1;d.dropAtmosphereHeaders=!0;d.url=a;d.transport="polling";(b=d)||(b=T(""));b.transport="polling";b.method="GET";b.async=!1;b.reconnect=!1;b.force=!0;b.suspend=!1;O(b)}}function m(){d.reconnect=!1;G=!0;e.request=d;e.state="unsubscribe";e.responseBody="";e.status= 408;w();k();l()}function l(){null!=u&&(u.close(),u=null);null!=D&&(D.abort(),D=null);null!=K&&(K.abort(),K=null);null!=r&&(r.webSocketOpened&&r.close(),r=null);null!=s&&(s.close(),s=null);null!=A&&(clearInterval(P),document.cookie=encodeURIComponent("atmosphere-"+d.url)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT",A.signal("close",{reason:"",heir:G?(A.get("children")||[])[0]:x}),A.close());null!=v&&v.close()}function Z(b){l();U=!0;G=!1;y=0;u=K=s=r=null;d=c.util.extend(d,b);d.mrequest=d.reconnect;d.reconnect|| (d.reconnect=!0)}function E(){if(d.shared){v=ia(d);if(null!=v&&("debug"==d.logLevel&&c.util.debug("Storage service available. All communication will be local"),v.open(d)))return;"debug"==d.logLevel&&c.util.debug("No Storage service available.");v=null}d.firstMessage=!0;d.isOpen=!1;d.ctime=c.util.now();"websocket"!=d.transport&&"sse"!=d.transport?O(d):"websocket"==d.transport?null!=d.webSocketImpl||window.WebSocket||window.MozWebSocket?n(!1):L("Websocket is not supported, using request.fallbackTransport ("+ d.fallbackTransport+")"):"sse"==d.transport&&(window.EventSource?$(!1):L("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+d.fallbackTransport+")"))}function ia(b){function a(a,b){var d,c=a.length;for(d=0;d<c;d++)a[d]===b&&a.splice(d,1);return c!==a.length}function Q(a){a=c.util.parseJSON(a);var e=a.data;if("c"===a.target)switch(a.type){case "open":t("opening","local",d);break;case "close":q||(q=!0,"aborted"===e.reason?m():e.heir===x?E():setTimeout(function(){E()},100)); break;case "message":M(e,"messageReceived",200,b.transport);break;case "localMessage":aa(e)}}function g(){var a=RegExp("(?:^|; )("+encodeURIComponent(h)+")=([^;]*)").exec(document.cookie);if(a)return c.util.parseJSON(decodeURIComponent(a[2]))}var e,f,q,h="atmosphere-"+b.url,k={storage:function(){if(c.util.supportStorage()){var d=window.localStorage,e=function(a){return c.util.parseJSON(d.getItem(h+"-"+a))},g=function(a,b){d.setItem(h+"-"+a,c.util.stringifyJSON(b))};return{init:function(){g("children", e("children").concat([x]));c.util.on("storage.socket",function(a){a=a.originalEvent;a.key===h&&a.newValue&&Q(a.newValue)});return e("opened")},signal:function(a,b){d.setItem(h,c.util.stringifyJSON({target:"p",type:a,data:b}))},close:function(){var d=e("children");c.util.off("storage.socket");d&&a(d,b.id)&&g("children",d)}}}},windowref:function(){var b=window.open("",h.replace(/\W/g,""));if(b&&!b.closed&&b.callbacks)return{init:function(){b.callbacks.push(Q);b.children.push(x);return b.opened},signal:function(a, d){!b.closed&&b.fire&&b.fire(c.util.stringifyJSON({target:"p",type:a,data:d}))},close:function(){q||(a(b.callbacks,Q),a(b.children,x))}}}};if((e=g())&&!(1E3<c.util.now()-e.ts)&&(f=k.storage()||k.windowref()))return{open:function(){var a;P=setInterval(function(){var a=e;(e=g())&&a.ts!==e.ts||Q(c.util.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:a.heir}}))},1E3);(a=f.init())&&setTimeout(function(){t("opening","local",b)},50);return a},send:function(a){f.signal("send",a)},localSend:function(a){f.signal("localSend", c.util.stringifyJSON({id:x,event:a}))},close:function(){G||(clearInterval(P),f.signal("close"),f.close())}}}function p(){function b(a){a=c.util.parseJSON(a);var b=a.data;if("p"===a.target)switch(a.type){case "send":V(b);break;case "localSend":aa(b);break;case "close":m()}}function a(){document.cookie=encodeURIComponent(g)+"="+encodeURIComponent(c.util.stringifyJSON({ts:c.util.now()+1,heir:(e.get("children")||[])[0]}))}var e,g="atmosphere-"+d.url,f={storage:function(){if(c.util.supportStorage()){var a= window.localStorage;return{init:function(){c.util.on("storage.socket",function(a){a=a.originalEvent;a.key===g&&a.newValue&&b(a.newValue)})},signal:function(b,d){a.setItem(g,c.util.stringifyJSON({target:"c",type:b,data:d}))},get:function(b){return c.util.parseJSON(a.getItem(g+"-"+b))},set:function(b,d){a.setItem(g+"-"+b,c.util.stringifyJSON(d))},close:function(){c.util.off("storage.socket");a.removeItem(g);a.removeItem(g+"-opened");a.removeItem(g+"-children")}}}},windowref:function(){var a=g.replace(/\W/g, ""),d=document.getElementById(a),e;d||(d=document.createElement("div"),d.id=a,d.style.display="none",d.innerHTML='<iframe name="'+a+'" />',document.body.appendChild(d));e=d.firstChild.contentWindow;return{init:function(){e.callbacks=[b];e.fire=function(a){var b;for(b=0;b<e.callbacks.length;b++)e.callbacks[b](a)}},signal:function(a,b){!e.closed&&e.fire&&e.fire(c.util.stringifyJSON({target:"c",type:a,data:b}))},get:function(a){return e.closed?null:e[a]},set:function(a,b){e.closed||(e[a]=b)},close:function(){}}}}; N=function(a){e.signal("message",a)};e=f.storage()||f.windowref();e.init();"debug"==d.logLevel&&c.util.debug("Installed StorageService "+e);e.set("children",[]);null==e.get("opened")||e.get("opened")||e.set("opened",!1);a();P=setInterval(a,1E3);A=e}function t(b,a,c){d.shared&&"local"!=a&&p();null!=A&&A.set("opened",!0);c.close=function(){m()};0<y&&"re-connecting"==b?(c.isReopen=!0,ja(e)):null==e.error&&(e.request=c,c=e.state,e.state=b,b=e.transport,e.transport=a,a=e.responseBody,w(),e.responseBody= a,e.state=c,e.transport=b)}function ba(b){b.transport="jsonp";var a=d;null!=b&&"undefined"!=typeof b&&(a=b);D={open:function(){function b(){var d=a.url;null!=a.dispatchUrl&&(d+=a.dispatchUrl);var e=a.data;a.attachHeadersAsQueryString&&(d=H(a),""!=e&&(d+="&X-Atmosphere-Post-Body="+encodeURIComponent(e)),e="");var e=document.head||document.getElementsByTagName("head")[0]||document.documentElement,c=document.createElement("script");c.src=d+"&jsonpTransport="+g;c.clean=function(){c.clean=c.onerror=c.onload= c.onreadystatechange=null;c.parentNode&&c.parentNode.removeChild(c)};c.onload=c.onreadystatechange=function(){c.readyState&&!/loaded|complete/.test(c.readyState)||c.clean()};c.onerror=function(){c.clean();z(0,"maxReconnectOnClose reached")};e.insertBefore(c,e.firstChild)}var g="atmosphere"+ ++x;window[g]=function(b){if(a.reconnect)if(-1==a.maxRequest||a.requestCount++<a.maxRequest){a.executeCallbackBeforeReconnect||J(D,a,0);if(null!=b&&"string"!=typeof b)try{b=b.message}catch(g){}F(b,a,e)||M(e.responseBody, "messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&J(D,a,0)}else c.util.log(d.logLevel,["JSONP reconnect maximum try reached "+d.requestCount]),z(0,"maxRequest reached")};setTimeout(function(){b()},50)},abort:function(){script.clean&&script.clean()}};D.open()}function $(b){e.transport="sse";var a=H(d);"debug"==d.logLevel&&(c.util.debug("Invoking executeSSE"),c.util.debug("Using URL: "+a));if(d.enableProtocol&&b){var f=c.util.now()-d.ctime;d.lastTimestamp=Number(d.stime)+Number(f)}if(b&& !d.reconnect)null!=s&&l();else{try{s=new EventSource(a,{withCredentials:d.withCredentials})}catch(g){z(0,g);L("SSE failed. Downgrading to fallback transport and resending");return}0<d.connectTimeout&&(d.id=setTimeout(function(){b||l()},d.connectTimeout));s.onopen=function(a){I(d);"debug"==d.logLevel&&c.util.debug("SSE successfully opened");d.enableProtocol||(b?t("re-opening","sse",d):t("opening","sse",d));b=!0;"POST"==d.method&&(e.state="messageReceived",s.send(d.data))};s.onmessage=function(a){I(d); a.origin&&a.origin!=window.location.protocol+"//"+window.location.host?c.util.log(d.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host]):(e.state="messageReceived",e.status=200,a=a.data,a=F(a,d,e),s.URL&&(s.interval=100,s.URL=H(d)),a||(w(),e.responseBody="",e.messages=[]))};s.onerror=function(a){clearTimeout(d.id);C(b);l();G?c.util.log(d.logLevel,["SSE closed normally"]):b?d.reconnect&&"sse"==e.transport&&(y++<d.maxReconnectOnClose?(t("re-connecting",d.transport,d),d.id= setTimeout(function(){$(!0)},d.reconnectInterval),e.responseBody="",e.messages=[]):(c.util.log(d.logLevel,["SSE reconnect maximum try reached "+y]),z(0,"maxReconnectOnClose reached"))):L("SSE failed. Downgrading to fallback transport and resending")}}}function n(b){e.transport="websocket";if(d.enableProtocol&&b){var a=c.util.now()-d.ctime;d.lastTimestamp=Number(d.stime)+Number(a)}a=c.util.getAbsoluteURL(H(d)).replace(/^http/,"ws");"debug"==d.logLevel&&(c.util.debug("Invoking executeWebSocket"),c.util.debug("Using URL: "+ a));if(b&&!d.reconnect)null!=r&&l();else if(r=null!=d.webSocketImpl?d.webSocketImpl:window.WebSocket?new WebSocket(a):new MozWebSocket(a),null!=d.webSocketBinaryType&&(r.binaryType=d.webSocketBinaryType),0<d.connectTimeout&&(d.id=setTimeout(function(){if(!b){r.onclose({code:1002,reason:"",wasClean:!1});try{l()}catch(a){}}},d.connectTimeout)),r.onopen=function(a){I(d);"debug"==d.logLevel&&c.util.debug("Websocket successfully opened");d.enableProtocol||(b?t("re-opening","websocket",d):t("opening","websocket", d));b=!0;r.webSocketOpened=b;"POST"==d.method&&(e.state="messageReceived",r.send(d.data))},r.onmessage=function(a){I(d);e.state="messageReceived";e.status=200;a=a.data;"string"==typeof a?F(a,d,e)||(w(),e.responseBody="",e.messages=[]):ca(d,a)&&(e.responseBody=a,w(),e.responseBody=null)},r.onerror=function(a){clearTimeout(d.id)},r.onclose=function(a){clearTimeout(d.id);if("closed"!=e.state){var g=a.reason;if(""===g)switch(a.code){case 1E3:g="Normal closure; the connection successfully completed whatever purpose for which it was created."; break;case 1001:g="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";break;case 1002:g="The endpoint is terminating the connection due to a protocol error.";break;case 1003:g="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:g="The endpoint is terminating the connection because a data frame was received that is too large."; break;case 1005:g="Unknown: no status code was provided even though one was expected.";break;case 1006:g="Connection was closed abnormally (that is, with no close frame being sent)."}c.util.warn("Websocket closed, reason: "+g);c.util.warn("Websocket closed, wasClean: "+a.wasClean);C(b);e.state="closed";G?c.util.log(d.logLevel,["Websocket closed normally"]):b?d.reconnect&&"websocket"==e.transport&&(l(),y++<d.maxReconnectOnClose?(t("re-connecting",d.transport,d),d.id=setTimeout(function(){e.responseBody= "";e.messages=[];n(!0)},d.reconnectInterval)):(c.util.log(d.logLevel,["Websocket reconnect maximum try reached "+d.requestCount]),c.util.warn("Websocket error, reason: "+a.reason),z(0,"maxReconnectOnClose reached"))):L("Websocket failed. Downgrading to Comet and resending")}},void 0===r.url)r.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function ca(b,a){var d=!0;if(0!=c.util.trim(a)&&b.enableProtocol&&b.firstMessage){b.firstMessage=!1;var d=a.split(b.messageDelimiter), e=2==d.length?0:1;b.uuid=c.util.trim(d[e]);b.stime=c.util.trim(d[e+1]);d=!1;"long-polling"!=b.transport&&W(b)}else W(b);return d}function I(b){clearTimeout(b.id);"polling"!=b.transport&&(b.id=setTimeout(function(){C(!0);l();k()},b.timeout))}function z(b,a){l();clearTimeout(d.id);e.state="error";e.reasonPhrase=a;e.responseBody="";e.status=b;e.messages=[];w()}function F(b,a,e){if(!ca(d,b)||0==b.length)return!0;if(a.trackMessageLength){b=e.partialMessage+b;for(var g=[],f=b.indexOf(a.messageDelimiter);-1!= f;){var h=c.util.trim(b.substring(0,f)),k=parseInt(h);if(isNaN(k))throw'message length "'+h+'" is not a number';f+=a.messageDelimiter.length;f+k>b.length?f=-1:(g.push(b.substring(f,f+k)),b=b.substring(f+k,b.length),f=b.indexOf(a.messageDelimiter))}e.partialMessage=b;if(0!=g.length)e.responseBody=g.join(a.messageDelimiter),e.messages=g;else return e.responseBody="",e.messages=[],!0}else e.responseBody=b;return!1}function L(b){c.util.log(d.logLevel,[b]);if("undefined"!=typeof d.onTransportFailure)d.onTransportFailure(b, d);else if("undefined"!=typeof c.util.onTransportFailure)c.util.onTransportFailure(b,d);d.transport=d.fallbackTransport;b=-1==d.connectTimeout?0:d.connectTimeout;d.reconnect&&"none"!=d.transport||null==d.transport?(d.method=d.fallbackMethod,e.transport=d.fallbackTransport,d.fallbackTransport="none",d.id=setTimeout(function(){E()},b)):z(500,"Unable to reconnect with fallback transport")}function H(b,a){var f=d;null!=b&&"undefined"!=typeof b&&(f=b);null==a&&(a=f.url);if(!f.attachHeadersAsQueryString|| -1!=a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!=a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+f.uuid;a+="&X-Atmosphere-Framework="+ha;a+="&X-Atmosphere-Transport="+f.transport;f.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");a=void 0!=f.lastTimestamp?a+("&X-Cache-Date="+f.lastTimestamp):a+"&X-Cache-Date=0";""!=f.contentType&&(a+="&Content-Type="+f.contentType);f.enableProtocol&&(a+="&X-atmo-protocol=true");c.util.each(f.headers,function(d,h){var k=c.util.isFunction(h)? h.call(this,f,b,e):h;null!=k&&(a+="&"+encodeURIComponent(d)+"="+encodeURIComponent(k))});return a}function ka(){c.util.browser.msie&&"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=function(){try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(b){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(a){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(d){}throw Error("This browser does not support XMLHttpRequest.");});return new XMLHttpRequest}function W(b){b.isOpen?b.isReopen&& (b.isReopen=!1,t("re-opening",b.transport,b)):(b.isOpen=!0,t("opening",b.transport,b))}function O(b){var a=d;if(null!=b||"undefined"!=typeof b)a=b;a.lastIndex=0;a.readyState=0;if("jsonp"==a.transport||a.enableXDR&&c.util.checkCORSSupport())ba(a);else{if(c.util.browser.msie&&10>c.util.browser.version){if("streaming"==a.transport){a.enableXDR&&window.XDomainRequest?R(a):(u=X(a),u.open());return}if(a.enableXDR&&window.XDomainRequest){R(a);return}}var f=function(){a.lastIndex=0;a.reconnect&&y++<a.maxReconnectOnClose? (t("re-connecting",b.transport,b),J(g,a,b.reconnectInterval)):z(0,"maxReconnectOnClose reached")};if(a.force||a.reconnect&&(-1==a.maxRequest||a.requestCount++<a.maxRequest)){a.force=!1;var g=ka();g.hasData=!1;la(g,a,!0);a.suspend&&(K=g);"polling"!=a.transport&&(e.transport=a.transport,g.onabort=function(){C(!0)},g.onerror=function(){e.error=!0;try{e.status=XMLHttpRequest.status}catch(a){e.status=500}e.status||(e.status=500);l();e.errorHandled||f()});g.onreadystatechange=function(){if(!G){e.error= null;var k=!1,q=!1;if(c.util.browser.opera&&"streaming"==a.transport&&2<a.readyState&&4==g.readyState)l(),f();else if(a.readyState=g.readyState,"streaming"==a.transport&&3<=g.readyState?q=!0:"long-polling"==a.transport&&4===g.readyState&&(q=!0),I(d),a.enableProtocol&&b.firstMessage||("polling"==a.transport||2!=g.readyState)||W(a),q)if(q=0,0!=g.readyState&&(q=1E3<g.status?0:g.status),300<=q||0==q)e.errorHandled=!0,l(),f();else if(q=g.responseText,0==c.util.trim(q).length&&"long-polling"==a.transport)g.hasData? g.hasData=!1:f();else{g.hasData=!0;Y(g,d);if("streaming"==a.transport)if(c.util.browser.opera)c.util.iterate(function(){if(500!=e.status&&g.responseText.length>a.lastIndex){try{e.status=g.status,e.headers=c.util.parseHeaders(g.getAllResponseHeaders()),Y(g,d)}catch(b){e.status=404}I(d);e.state="messageReceived";var f=g.responseText.substring(a.lastIndex);a.lastIndex=g.responseText.length;(k=F(f,a,e))||w();h(g,a)}else if(400<e.status)return a.lastIndex=g.responseText.length,!1},0);else{var m=q.substring(a.lastIndex, q.length),k=F(m,a,e);a.lastIndex=q.length;if(k)return}else k=F(q,a,e);try{e.status=g.status,e.headers=c.util.parseHeaders(g.getAllResponseHeaders()),Y(g,a)}catch(n){e.status=404}e.state=a.suspend?0==e.status?"closed":"messageReceived":"messagePublished";(q="streaming"!=b.transport)&&!a.executeCallbackBeforeReconnect&&J(g,a,0);0==e.responseBody.length||k||w();q&&a.executeCallbackBeforeReconnect&&J(g,a,0);h(g,a)}}};try{g.send(a.data),U=!0}catch(k){c.util.log(a.logLevel,["Unable to connect to "+a.url])}}else"debug"== a.logLevel&&c.util.log(a.logLevel,["Max re-connection reached."]),z(0,"maxRequest reached")}}function la(b,a,f){var g=a.url;null!=a.dispatchUrl&&"POST"==a.method&&(g+=a.dispatchUrl);g=H(a,g);g=c.util.prepareURL(g);f&&(b.open(a.method,g,a.async),-1<a.connectTimeout&&(a.id=setTimeout(function(){0==a.requestCount&&(l(),M("Connect timeout","closed",200,a.transport))},a.connectTimeout)));d.withCredentials&&"withCredentials"in b&&(b.withCredentials=!0);d.dropAtmosphereHeaders||(b.setRequestHeader("X-Atmosphere-Framework", c.util.version),b.setRequestHeader("X-Atmosphere-Transport",a.transport),void 0!=a.lastTimestamp?b.setRequestHeader("X-Cache-Date",a.lastTimestamp):b.setRequestHeader("X-Cache-Date",0),a.trackMessageLength&&b.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),b.setRequestHeader("X-Atmosphere-tracking-id",a.uuid));""!=a.contentType&&b.setRequestHeader("Content-Type",a.contentType);c.util.each(a.headers,function(d,g){var h=c.util.isFunction(g)?g.call(this,b,a,f,e):g;null!=h&&b.setRequestHeader(d, h)})}function J(b,a,d){if(a.reconnect||a.suspend&&U){var c=0;b&&0!=b.readyState&&(c=1E3<b.status?0:b.status);e.status=0==c?204:c;e.reason=0==c?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.id=setTimeout(function(){O(a)},d)}}function ja(b){b.state="re-connecting";da(b)}function R(b){"polling"!=b.transport?(u=ea(b),u.open()):ea(b).open()}function ea(b){var a=d;null!=b&&"undefined"!=typeof b&&(a=b);var f=a.transport,g=0,h=new window.XDomainRequest,m=function(){"long-polling"==a.transport&& (a.reconnect&&(-1==a.maxRequest||a.requestCount++<a.maxRequest))&&(h.status=200,R(a))},q=a.rewriteURL||function(a){var b=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(b&&b[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,";jsessionid="+b[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+b[2]+"&").replace(/&$/,"")}return a};h.onprogress=function(){n(h)};h.onerror=function(){"polling"!=a.transport&&(l(),y++<a.maxReconnectOnClose? a.id=setTimeout(function(){t("re-connecting",b.transport,b);R(a)},a.reconnectInterval):z(0,"maxReconnectOnClose reached"))};h.onload=function(){};var n=function(b){clearTimeout(a.id);b=b.responseText;b=b.substring(g);g+=b.length;if("polling"!=f){a.id=setTimeout(function(){y=a.maxReconnectOnClose;C(!0);k();l()},a.timeout);var d=F(b,a,e);if("long-polling"!=f||0!=c.util.trim(b))a.executeCallbackBeforeReconnect&&m(),d||M(e.responseBody,"messageReceived",200,f),a.executeCallbackBeforeReconnect||m()}}; return{open:function(){var b=a.url;null!=a.dispatchUrl&&(b+=a.dispatchUrl);b=H(a,b);h.open(a.method,q(b));"GET"==a.method?h.send():h.send(a.data);-1<a.connectTimeout&&(a.id=setTimeout(function(){0==a.requestCount&&(l(),M("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){h.abort()}}}function X(b){var a=d;null!=b&&"undefined"!=typeof b&&(a=b);var f,g=new window.ActiveXObject("htmlfile");g.open();g.close();var h=a.url;null!=a.dispatchUrl&&(h+=a.dispatchUrl);"polling"!= a.transport&&(e.transport=a.transport);return{open:function(){var b=g.createElement("iframe");h=H(a);""!=a.data&&(h+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));h=c.util.prepareURL(h);b.src=h;g.body.appendChild(b);var k=b.contentDocument||b.contentWindow.document;f=c.util.iterate(function(){try{if(k.firstChild){var b=k.body?k.body.lastChild:k,h=function(){var a=b.cloneNode(!0);a.appendChild(k.createTextNode("."));a=a.innerText;return a=a.substring(0,a.length-1)};if(!k.body||!k.body.firstChild|| "pre"!==k.body.firstChild.nodeName.toLowerCase()){var l=k.head||k.getElementsByTagName("head")[0]||k.documentElement||k,m=k.createElement("script");m.text="document.write('<plaintext>')";l.insertBefore(m,l.firstChild);l.removeChild(m);b=k.body.lastChild}a.closed&&(a.isReopen=!0);f=c.util.iterate(function(){var c=h();if(c.length>a.lastIndex){I(d);e.status=200;e.error=null;b.innerText="";if(F(c,a,e))return"";M(e.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===k.readyState)return C(!0), t("re-connecting",a.transport,a),a.id=setTimeout(function(){u=X(a);u.open()},a.reconnectInterval),!1},null);return!1}}catch(n){return e.error=!0,t("re-connecting",a.transport,a),y++<a.maxReconnectOnClose?a.id=setTimeout(function(){u=X(a);u.open()},a.reconnectInterval):z(0,"maxReconnectOnClose reached"),g.execCommand("Stop"),g.close(),!1}})},close:function(){f&&f();g.execCommand("Stop");C(!0)}}}function V(b){null!=v?v.send(b):null!=K||null!=s?S(b):null!=u?d.enableXDR&&c.util.checkCORSSupport()?(b= T(b),b.reconnect=!1,ba(b)):S(b):null!=D?S(b):null!=r&&ma(b)}function S(b){b=T(b);O(b)}function fa(b){var a=b;"object"==typeof a&&(a=b.data);return a}function T(b){var a=fa(b),a={connected:!1,timeout:6E4,method:"POST",url:d.url,contentType:d.contentType,headers:d.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:d.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:d.enableXDR,uuid:d.uuid,dispatchUrl:d.dispatchUrl, enableProtocol:!1,messageDelimiter:"|",maxReconnectOnClose:d.maxReconnectOnClose};"object"==typeof b&&(a=c.util.extend(a,b));return a}function ma(b){var a=fa(b),c;try{c=null!=d.dispatchUrl?d.webSocketPathDelimiter+d.dispatchUrl+d.webSocketPathDelimiter+a:a,r.send(c)}catch(e){r.onclose=function(a){},l(),L("Websocket failed. Downgrading to Comet and resending "+c),S(b)}}function aa(b){b=c.util.parseJSON(b);if(b.id!=x)if("undefined"!=typeof d.onLocalMessage)d.onLocalMessage(b.event);else if("undefined"!= typeof c.util.onLocalMessage)c.util.onLocalMessage(b.event)}function M(b,a,d,c){e.responseBody=b;e.transport=c;e.status=d;e.state=a;w()}function Y(b,a){if(a.readResponsesHeaders||a.enableProtocol)try{var f=b.getResponseHeader("X-Cache-Date");f&&(null!=f&&0<f.length)&&(a.lastTimestamp=f.split(" ").pop());var g=b.getResponseHeader("X-Atmosphere-tracking-id");g&&null!=g&&(a.uuid=g.split(" ").pop());a.headers&&c.util.each(d.headers,function(a){var d=b.getResponseHeader(a);d&&(e.headers[a]=d)})}catch(h){}else a.lastTimestamp= c.util.now(),a.uuid=x}function da(b){ga(b,d);ga(b,c.util)}function ga(b,a){switch(b.state){case "messageReceived":y=0;if("undefined"!=typeof a.onMessage)a.onMessage(b);break;case "error":if("undefined"!=typeof a.onError)a.onError(b);break;case "opening":if("undefined"!=typeof a.onOpen)a.onOpen(b);break;case "messagePublished":if("undefined"!=typeof a.onMessagePublished)a.onMessagePublished(b);break;case "re-connecting":if("undefined"!=typeof a.onReconnect)a.onReconnect(d,b);break;case "re-opening":if("undefined"!= typeof a.onReopen)a.onReopen(d,b);break;case "fail-to-reconnect":if("undefined"!=typeof a.onFailureToReconnect)a.onFailureToReconnect(d,b);break;case "unsubscribe":case "closed":var c="undefined"!=typeof d.closed?d.closed:!1;if("undefined"!=typeof a.onClose&&!c)a.onClose(b);d.closed=!0}}function C(b){"closed"!=e.state&&(e.state="closed",e.responseBody="",e.messages=[],e.status=b?200:501,w())}function w(){var b=function(a,b){b(e)};null==v&&null!=N&&N(e.responseBody);d.reconnect=d.mrequest;for(var a= "string"==typeof e.responseBody,f=a&&d.trackMessageLength?0<e.messages.length?e.messages:[""]:Array(e.responseBody),g=0;g<f.length;g++)if(!(1<f.length&&0==f[g].length)&&(e.responseBody=a?c.util.trim(f[g]):f[g],null==v&&null!=N&&N(e.responseBody),0!=e.responseBody.length||"messageReceived"!=e.state)){da(e);if(0<B.length){"debug"==d.logLevel&&c.util.debug("Invoking "+B.length+" global callbacks: "+e.state);try{c.util.each(B,b)}catch(h){c.util.log(d.logLevel,["Callback exception"+h])}}if("function"== typeof d.callback){"debug"==d.logLevel&&c.util.debug("Invoking request callbacks");try{d.callback(e)}catch(k){c.util.log(d.logLevel,["Callback exception"+k])}}}}var d={timeout:3E5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@", enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,lastTimestamp:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropAtmosphereHeaders:!0,uuid:0,async:!0,shared:!1,readResponsesHeaders:!1,maxReconnectOnClose:5,enableProtocol:!0,onError:function(b){},onClose:function(b){},onOpen:function(b){},onMessage:function(b){},onReopen:function(b,a){},onReconnect:function(b,a){},onMessagePublished:function(b){}, onTransportFailure:function(b,a){},onLocalMessage:function(b){},onFailureToReconnect:function(b,a){}},e={status:200,reasonPhrase:"OK",responseBody:"",messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,id:0},r=null,s=null,K=null,u=null,D=null,U=!0,y=0,G=!1,N=null,A,v=null,x=c.util.now(),P;Z(f);this.subscribe=function(b){Z(b);E()};this.execute=function(){E()};this.close=function(){m()};this.disconnect=function(){k()};this.getUrl= function(){return d.url};this.push=function(b,a){if(null!=a){var c=d.dispatchUrl;d.dispatchUrl=a;V(b);d.dispatchUrl=c}else V(b)};this.getUUID=function(){return d.uuid};this.pushLocal=function(b){if(0!=b.length)try{v?v.localSend(b):A&&A.signal("localMessage",c.util.stringifyJSON({id:x,event:b}))}catch(a){c.util.error(a)}};this.enableProtocol=function(b){return d.enableProtocol};this.request=d;this.response=e},subscribe:function(f,h,k){"function"==typeof h&&c.addCallback(h);"string"!=typeof f?k=f:k.url= f;f=new c.AtmosphereRequest(k);f.execute();return p[p.length]=f},unsubscribe:function(){if(0<p.length)for(var c=[].concat(p),h=0;h<c.length;h++){var k=c[h];k.close();clearTimeout(k.response.request.id)}p=[];B=[]},unsubscribeUrl:function(c){var h=-1;if(0<p.length)for(var k=0;k<p.length;k++){var m=p[k];if(m.getUrl()==c){m.close();clearTimeout(m.response.request.id);h=k;break}}0<=h&&p.splice(h,1)},addCallback:function(f){-1==c.util.inArray(f,B)&&B.push(f)},removeCallback:function(f){f=c.util.inArray(f, B);-1!=f&&B.splice(f,1)},util:{browser:{},parseHeaders:function(c){for(var h,k=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,m={};h=k.exec(c);)m[h[1]]=h[2];return m},now:function(){return(new Date).getTime()},isArray:function(c){return"[object Array]"===Object.prototype.toString.call(c)},isBinary:function(c){c=Object.prototype.toString.call(c);return"[object Blob]"===c||"[object ArrayBuffer]"===c},isFunction:function(c){return"[object Function]"===Object.prototype.toString.call(c)},getAbsoluteURL:function(c){var h= document.createElement("div");h.innerHTML='<a href="'+c+'"/>';return encodeURI(decodeURI(h.firstChild.href))},prepareURL:function(f){var h=c.util.now(),k=f.replace(/([?&])_=[^&]*/,"$1_="+h);return k+(k===f?(/\?/.test(f)?"&":"?")+"_="+h:"")},trim:function(c){return String.prototype.trim?c.toString().trim():c.toString().replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")},param:function(f){function h(f,h){h=c.util.isFunction(h)?h():null==h?"":h;l.push(encodeURIComponent(f)+"="+encodeURIComponent(h))} function k(f,l){var m;if(c.util.isArray(l))c.util.each(l,function(c,l){/\[\]$/.test(f)?h(f,l):k(f+"["+("object"===typeof l?c:"")+"]",l)});else if("[object Object]"===Object.prototype.toString.call(l))for(m in l)k(f+"["+m+"]",l[m]);else h(f,l)}var m,l=[];for(m in f)k(m,f[m]);return l.join("&").replace(/%20/g,"+")},supportStorage:function(){var f=window.localStorage;if(f)try{return f.setItem("t","t"),f.removeItem("t"),window.StorageEvent&&!c.util.browser.msie&&!(c.util.browser.mozilla&&"1"===c.util.browser.version.split(".")[0])}catch(h){}return!1}, iterate:function(c,h){var k;h=h||0;(function l(){k=setTimeout(function(){!1!==c()&&l()},h)})();return function(){clearTimeout(k)}},each:function(f,h,k){var m,l=0,p=f.length;m=c.util.isArray(f);if(k)if(m)for(;l<p&&(m=h.apply(f[l],k),!1!==m);l++);else for(l in f){if(m=h.apply(f[l],k),!1===m)break}else if(m)for(;l<p&&(m=h.call(f[l],l,f[l]),!1!==m);l++);else for(l in f)if(m=h.call(f[l],l,f[l]),!1===m)break;return f},extend:function(c){var h,k,m;for(h=1;h<arguments.length;h++)if(null!=(k=arguments[h]))for(m in k)c[m]= k[m];return c},on:function(c,h,k){c.addEventListener?c.addEventListener(h,k,!1):c.attachEvent&&c.attachEvent("on"+h,k)},off:function(c,h,k){c.removeEventListener?c.removeEventListener(h,k,!1):c.detachEvent&&c.detachEvent("on"+h,k)},log:function(c,h){if(window.console){var k=window.console[c];"function"==typeof k&&k.apply(window.console,h)}},warn:function(){c.util.log("warn",arguments)},info:function(){c.util.log("info",arguments)},debug:function(){c.util.log("debug",arguments)},error:function(){c.util.log("error", arguments)},xhr:function(){try{return new window.XMLHttpRequest}catch(c){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(h){}}},parseJSON:function(c){return c?window.JSON&&window.JSON.parse?window.JSON.parse(c):(new Function("return "+c))():null},stringifyJSON:function(c){function h(c){return'"'+c.replace(m,function(c){var f=l[c];return"string"===typeof f?f:"\\u"+("0000"+c.charCodeAt(0).toString(16)).slice(-4)})+'"'}function k(c){return 10>c?"0"+c:c}var m=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g, l={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return window.JSON&&window.JSON.stringify?window.JSON.stringify(c):function E(c,f){var l,m,p,n=f[c];p=typeof n;n&&("object"===typeof n&&"function"===typeof n.toJSON)&&(n=n.toJSON(c),p=typeof n);switch(p){case "string":return h(n);case "number":return isFinite(n)?String(n):"null";case "boolean":return String(n);case "object":if(!n)return"null";switch(Object.prototype.toString.call(n)){case "[object Date]":return isFinite(n.valueOf())? '"'+n.getUTCFullYear()+"-"+k(n.getUTCMonth()+1)+"-"+k(n.getUTCDate())+"T"+k(n.getUTCHours())+":"+k(n.getUTCMinutes())+":"+k(n.getUTCSeconds())+'Z"':"null";case "[object Array]":m=n.length;p=[];for(l=0;l<m;l++)p.push(E(l,n)||"null");return"["+p.join(",")+"]";default:p=[];for(l in n)hasOwn.call(n,l)&&(m=E(l,n))&&p.push(h(l)+":"+m);return"{"+p.join(",")+"}"}}}("",{"":c})},checkCORSSupport:function(){return c.util.browser.msie&&!window.XDomainRequest||c.util.browser.opera&&12>c.util.browser.version?!0: -1<navigator.userAgent.toLowerCase().indexOf("android")?!0:!1}}};c.util.now();(function(){var f=navigator.userAgent.toLowerCase(),f=/(chrome)[ \/]([\w.]+)/.exec(f)||/(webkit)[ \/]([\w.]+)/.exec(f)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(f)||/(msie) ([\w.]+)/.exec(f)||0>f.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(f)||[];c.util.browser[f[1]||""]=!0;c.util.browser.version=f[2]||"0";if(c.util.browser.msie||c.util.browser.mozilla&&"1"===c.util.browser.version.split(".")[0])c.util.storage= !1})();c.util.on(window,"unload",function(f){c.unsubscribe()});c.util.on(window,"keypress",function(c){27===c.which&&c.preventDefault()});c.util.on(window,"offline",function(){c.unsubscribe()});window.atmosphere=c})();