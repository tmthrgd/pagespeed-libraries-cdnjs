!function(e){"object"==typeof exports&&"object"==typeof module?e(require("../../lib/codemirror"),require("diff_match_patch")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","diff_match_patch"],e):e(CodeMirror,diff_match_patch)}(function(e,t){"use strict";function r(e,t){this.mv=e,this.type=t,this.classes="left"==t?{chunk:"CodeMirror-merge-l-chunk",start:"CodeMirror-merge-l-chunk-start",end:"CodeMirror-merge-l-chunk-end",insert:"CodeMirror-merge-l-inserted",del:"CodeMirror-merge-l-deleted",connect:"CodeMirror-merge-l-connect"}:{chunk:"CodeMirror-merge-r-chunk",start:"CodeMirror-merge-r-chunk-start",end:"CodeMirror-merge-r-chunk-end",insert:"CodeMirror-merge-r-inserted",del:"CodeMirror-merge-r-deleted",connect:"CodeMirror-merge-r-connect"},"align"==e.options.connect&&(this.aligners=[])}function i(t){t.diffOutOfDate&&(t.diff=k(t.orig.getValue(),t.edit.getValue()),t.diffOutOfDate=!1,e.signal(t.edit,"updateDiff",t.diff))}function o(e){function t(t){"full"==t&&(e.svg&&F(e.svg),e.copyButtons&&F(e.copyButtons),s(e.edit,l.marked,e.classes),s(e.orig,a.marked,e.classes),l.from=l.to=a.from=a.to=0),i(e),e.showDifferences&&(f(e.edit,e.diff,l,DIFF_INSERT,e.classes),f(e.orig,e.diff,a,DIFF_DELETE,e.classes)),h(e)}function r(e){clearTimeout(n),n=setTimeout(t,1==e?250:100)}function o(){e.diffOutOfDate||(e.diffOutOfDate=!0,l.from=l.to=a.from=a.to=0),r(!0)}var n,l={from:0,to:0,marked:[]},a={from:0,to:0,marked:[]};return e.edit.on("change",o),e.orig.on("change",o),e.edit.on("markerAdded",r),e.edit.on("markerCleared",r),e.orig.on("markerAdded",r),e.orig.on("markerCleared",r),e.edit.on("viewportChange",r),e.orig.on("viewportChange",r),t(),t}function n(e){e.edit.on("scroll",function(){l(e,DIFF_INSERT)&&h(e)}),e.orig.on("scroll",function(){l(e,DIFF_DELETE)&&h(e)})}function l(e,t){if(e.diffOutOfDate)return!1;if(!e.lockScroll)return!0;var r,i,o=+new Date;if(t==DIFF_INSERT?(r=e.edit,i=e.orig):(r=e.orig,i=e.edit),r.state.scrollSetBy==e&&(r.state.scrollSetAt||0)+50>o)return!1;var n=r.getScrollInfo();if("align"==e.mv.options.connect)v=n.top;else{var l,c,s=.5*n.clientHeight,f=n.top+s,d=r.lineAtHeight(f,"local"),h=D(e.diff,d,t==DIFF_INSERT),u=a(r,t==DIFF_INSERT?h.edit:h.orig),g=a(i,t==DIFF_INSERT?h.orig:h.edit),p=(f-u.top)/(u.bot-u.top),v=g.top-s+p*(g.bot-g.top);if(v>n.top&&(c=n.top/s)<1)v=v*c+n.top*(1-c);else if((l=n.height-n.clientHeight-n.top)<s){var m=i.getScrollInfo(),C=m.height-m.clientHeight-v;C>l&&(c=l/s)<1&&(v=v*c+(m.height-m.clientHeight-l)*(1-c))}}return i.scrollTo(n.left,v),i.state.scrollSetAt=o,i.state.scrollSetBy=e,!0}function a(e,t){var r=t.after;return null==r&&(r=e.lastLine()+1),{top:e.heightAtLine(t.before||0,"local"),bot:e.heightAtLine(r,"local")}}function c(e,t,r){e.lockScroll=t,t&&0!=r&&l(e,DIFF_INSERT)&&h(e),e.lockButton.innerHTML=t?"⇛⇚":"⇛&nbsp;&nbsp;⇚"}function s(t,r,i){for(var o=0;o<r.length;++o){var n=r[o];n instanceof e.TextMarker?n.clear():n.parent&&(t.removeLineClass(n,"background",i.chunk),t.removeLineClass(n,"background",i.start),t.removeLineClass(n,"background",i.end))}r.length=0}function f(e,t,r,i,o){var n=e.getViewport();e.operation(function(){r.from==r.to||n.from-r.to>20||r.from-n.to>20?(s(e,r.marked,o),d(e,t,i,r.marked,n.from,n.to,o),r.from=n.from,r.to=n.to):(n.from<r.from&&(d(e,t,i,r.marked,n.from,r.from,o),r.from=n.from),n.to>r.to&&(d(e,t,i,r.marked,r.to,n.to,o),r.to=n.to))})}function d(e,t,r,i,o,n,l){function a(t,r){for(var a=Math.max(o,t),c=Math.min(n,r),s=a;c>s;++s){var f=e.addLineClass(s,"background",l.chunk);s==t&&e.addLineClass(f,"background",l.start),s==r-1&&e.addLineClass(f,"background",l.end),i.push(f)}t==r&&a==r&&c==r&&i.push(a?e.addLineClass(a-1,"background",l.end):e.addLineClass(a,"background",l.start))}for(var c=B(0,0),s=B(o,0),f=e.clipPos(B(n-1)),d=r==DIFF_DELETE?l.del:l.insert,h=0,u=0;u<t.length;++u){var g=t[u],p=g[0],v=g[1];if(p==DIFF_EQUAL){var m=c.line+(L(t,u)?0:1);T(c,v);var C=c.line+(E(t,u)?1:0);C>m&&(u&&a(h,m),h=C)}else if(p==r){var k=T(c,v,!0),w=N(s,c),y=_(f,k);x(w,y)||i.push(e.markText(w,y,{className:d})),c=k}}h<=c.line&&a(h,c.line+1)}function h(e){if(e.showDifferences){var t="align"==e.mv.options.connect;if(t){if(!e.orig.curOp)return e.orig.operation(function(){h(e)});for(var r=0;r<e.aligners.length;r++)e.aligners[r].clear();e.aligners.length=0;var i={edit:0,orig:0}}if(e.svg){F(e.svg);var o=e.gap.offsetWidth;S(e.svg,"width",o,"height",e.gap.offsetHeight)}e.copyButtons&&F(e.copyButtons);var n=e.edit.getViewport(),l=e.orig.getViewport(),a=e.edit.getScrollInfo().top,c=e.orig.getScrollInfo().top;w(e.diff,function(r,s,f,d){if(f<=n.to&&d>=n.from&&r<=l.to&&s>=l.from&&u(e,r,s,f,d,c,a,o),t&&(f<=n.to||r<=l.to)){var h=d<n.from&&s<l.from;g(e,r,s,f,d,h&&i)}}),t&&(i.edit&&e.aligners.push(p(e.edit,0,i.edit)),i.orig&&e.aligners.push(p(e.orig,0,i.orig)))}}function u(e,t,r,i,o,n,l,a){var c="left"==e.type,s=e.orig.heightAtLine(t,"local")-n;if(e.svg){var f=s,d=e.edit.heightAtLine(i,"local")-l;if(c){var h=f;f=d,d=h}var u=e.orig.heightAtLine(r,"local")-n,g=e.edit.heightAtLine(o,"local")-l;if(c){var h=u;u=g,g=h}var p=" C "+a/2+" "+d+" "+a/2+" "+f+" "+(a+2)+" "+f,v=" C "+a/2+" "+u+" "+a/2+" "+g+" -1 "+g;S(e.svg.appendChild(document.createElementNS(R,"path")),"d","M -1 "+d+p+" L "+(a+2)+" "+u+v+" z","class",e.classes.connect)}if(e.copyButtons){var m=e.copyButtons.appendChild(O("div","left"==e.type?"⇝":"⇜","CodeMirror-merge-copy")),C=e.mv.options.allowEditingOriginals;if(m.title=C?"Push to left":"Revert chunk",m.chunk={topEdit:i,botEdit:o,topOrig:t,botOrig:r},m.style.top=s+"px",C){var k=e.orig.heightAtLine(i,"local")-l,w=e.copyButtons.appendChild(O("div","right"==e.type?"⇝":"⇜","CodeMirror-merge-copy-reverse"));w.title="Push to right",w.chunk={topEdit:t,botEdit:r,topOrig:i,botOrig:o},w.style.top=k+"px","right"==e.type?w.style.left="2px":w.style.right="2px"}}}function g(e,t,r,i,o,n){var l=e.orig.heightAtLine(t,"local"),a=e.orig.heightAtLine(r,"local"),c=e.edit.heightAtLine(i,"local"),s=e.edit.heightAtLine(o,"local"),f=a-l,d=s-c,h=d-f;return h>1?n?n.orig+=h:e.aligners.push(p(e.orig,r-1,h)):-1>h&&(n?n.edit-=h:e.aligners.push(p(e.edit,o-1,-h))),0}function p(e,t,r){var i=document.createElement("div");return i.style.height=r+"px",i.style.minWidth="1px",e.addLineWidget(t,i,{height:r})}function v(e,t,r,i){e.diffOutOfDate||t.replaceRange(r.getRange(B(i.topOrig,0),B(i.botOrig,0)),B(i.topEdit,0),B(i.botEdit,0))}function m(t){var r=t.lockButton=O("div",null,"CodeMirror-merge-scrolllock");r.title="Toggle locked scrolling";var i=O("div",[r],"CodeMirror-merge-scrolllock-wrap");e.on(r,"click",function(){c(t,!t.lockScroll)});var o=[i];if(t.mv.options.revertButtons!==!1&&(t.copyButtons=O("div",null,"CodeMirror-merge-copybuttons-"+t.type),e.on(t.copyButtons,"click",function(e){var r=e.target||e.srcElement;if(r.chunk)return"CodeMirror-merge-copy-reverse"==r.className?void v(t,t.orig,t.edit,r.chunk):void v(t,t.edit,t.orig,r.chunk)}),o.unshift(t.copyButtons)),"align"!=t.mv.options.connect){var n=document.createElementNS&&document.createElementNS(R,"svg");n&&!n.createSVGRect&&(n=null),t.svg=n,n&&o.push(n)}return t.gap=O("div",o,"CodeMirror-merge-gap")}function C(e){return"string"==typeof e?e:e.getValue()}function k(e,t){var r=H.diff_main(e,t);H.diff_cleanupSemantic(r);for(var i=0;i<r.length;++i){var o=r[i];o[1]?i&&r[i-1][0]==o[0]&&(r.splice(i--,1),r[i][1]+=o[1]):r.splice(i--,1)}return r}function w(e,t){for(var r=0,i=0,o=B(0,0),n=B(0,0),l=0;l<e.length;++l){var a=e[l],c=a[0];if(c==DIFF_EQUAL){var s=L(e,l)?0:1,f=o.line+s,d=n.line+s;T(o,a[1],null,n);var h=E(e,l)?1:0,u=o.line+h,g=n.line+h;u>f&&(l&&t(i,d,r,f),r=u,i=g)}else T(c==DIFF_INSERT?o:n,a[1])}(r<=o.line||i<=n.line)&&t(i,n.line+1,r,o.line+1)}function y(e){i(e);var t=[];return w(e.diff,function(e,r,i,o){t.push({origFrom:e,origTo:r,editFrom:i,editTo:o})}),t}function E(e,t){if(t==e.length-1)return!0;var r=e[t+1][1];return 1==r.length||10!=r.charCodeAt(0)?!1:t==e.length-2?!0:(r=e[t+2][1],r.length>1&&10==r.charCodeAt(0))}function L(e,t){if(0==t)return!0;var r=e[t-1][1];return 10!=r.charCodeAt(r.length-1)?!1:1==t?!0:(r=e[t-2][1],10==r.charCodeAt(r.length-1))}function D(e,t,r){var i,o,n,l;return w(e,function(e,a,c,s){var f=r?c:e,d=r?s:a;null==o&&(f>t?(o=c,l=e):d>t&&(o=s,l=a)),t>=d?(i=s,n=a):t>=f&&(i=c,n=e)}),{edit:{before:i,after:o},orig:{before:n,after:l}}}function M(e,t,r){function i(){n.clear(),e.removeLineClass(t,"wrap","CodeMirror-merge-collapsed-line")}e.addLineClass(t,"wrap","CodeMirror-merge-collapsed-line");var o=document.createElement("span");o.className="CodeMirror-merge-collapsed-widget",o.title="Identical text collapsed. Click to expand.";var n=e.markText(B(t,0),B(r-1),{inclusiveLeft:!0,inclusiveRight:!0,replacedWith:o,clearOnEnter:!0});return o.addEventListener("click",i),{mark:n,clear:i}}function b(e,t,r,i){var o=M(e.orig,t,t+i),n=M(e.edit,r,r+i);o.mark.on("clear",function(){n.clear()}),n.mark.on("clear",function(){o.clear()})}function I(e,t){"number"!=typeof t&&(t=2);var r=e.orig.firstLine(),i=e.edit.firstLine();w(e.diff,function(o,n,l,a){var c=o-t-r;c>t&&b(e,r,i,c),r=n+t,i=a+t});var o=e.orig.lastLine()+1-r;o>t&&b(e,r,i,o)}function O(e,t,r,i){var o=document.createElement(e);if(r&&(o.className=r),i&&(o.style.cssText=i),"string"==typeof t)o.appendChild(document.createTextNode(t));else if(t)for(var n=0;n<t.length;++n)o.appendChild(t[n]);return o}function F(e){for(var t=e.childNodes.length;t>0;--t)e.removeChild(e.firstChild)}function S(e){for(var t=1;t<arguments.length;t+=2)e.setAttribute(arguments[t],arguments[t+1])}function A(e,t){t||(t={});for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}function T(e,t,r,i){for(var o=r?B(e.line,e.ch):e,n=0;;){var l=t.indexOf("\n",n);if(-1==l)break;++o.line,i&&++i.line,n=l+1}return o.ch=(n?0:o.ch)+(t.length-n),i&&(i.ch=(n?0:i.ch)+(t.length-n)),o}function _(e,t){return(e.line-t.line||e.ch-t.ch)<0?e:t}function N(e,t){return(e.line-t.line||e.ch-t.ch)>0?e:t}function x(e,t){return e.line==t.line&&e.ch==t.ch}var B=e.Pos,R="http://www.w3.org/2000/svg";r.prototype={constructor:r,init:function(t,r,i){this.edit=this.mv.edit,this.orig=e(t,A({value:r,readOnly:!this.mv.options.allowEditingOriginals},A(i))),this.diff=k(C(r),C(i.value)),this.diffOutOfDate=!1,this.showDifferences=i.showDifferences!==!1,this.forceUpdate=o(this),c(this,!0,!1),n(this)},setShowDifferences:function(e){e=e!==!1,e!=this.showDifferences&&(this.showDifferences=e,this.forceUpdate("full"))}};var V=e.MergeView=function(t,i){if(!(this instanceof V))return new V(t,i);this.options=i;var o=i.origLeft,n=null==i.origRight?i.orig:i.origRight;if(o&&n){if("align"==i.connect)throw new Error('connect: "align" is not supported for three-way merge views');if(i.collapseIdentical)throw new Error("collapseIdentical option is not supported for three-way merge views")}var l=null!=o,a=null!=n,c=1+(l?1:0)+(a?1:0),s=[],f=this.left=null,d=this.right=null;if(l){f=this.left=new r(this,"left");var u=O("div",null,"CodeMirror-merge-pane");s.push(u),s.push(m(f))}var g=O("div",null,"CodeMirror-merge-pane");if(s.push(g),a){d=this.right=new r(this,"right"),s.push(m(d));var p=O("div",null,"CodeMirror-merge-pane");s.push(p)}(a?p:g).className+=" CodeMirror-merge-pane-rightmost",s.push(O("div",null,null,"height: 0; clear: both;"));var v=this.wrap=t.appendChild(O("div",s,"CodeMirror-merge CodeMirror-merge-"+c+"pane"));this.edit=e(g,A(i)),f&&f.init(u,o,i),d&&d.init(p,n,i),i.collapseIdentical&&I(f||d,i.collapseIdentical);var C=function(){f&&h(f),d&&h(d)};e.on(window,"resize",C);var k=setInterval(function(){for(var t=v.parentNode;t&&t!=document.body;t=t.parentNode);t||(clearInterval(k),e.off(window,"resize",C))},5e3)};V.prototype={constuctor:V,editor:function(){return this.edit},rightOriginal:function(){return this.right&&this.right.orig},leftOriginal:function(){return this.left&&this.left.orig},setShowDifferences:function(e){this.right&&this.right.setShowDifferences(e),this.left&&this.left.setShowDifferences(e)},rightChunks:function(){return this.right&&y(this.right)},leftChunks:function(){return this.left&&y(this.left)}};var H=new t});