(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("../python/python"),require("../stex/stex"),require("../../addon/mode/overlay")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../python/python","../stex/stex","../../addon/mode/overlay"],e):e(CodeMirror)})(function(e){"use strict";e.defineMode("rst",function(t,n){var r=/^\*\*[^\*\s](?:[^\*]*[^\*\s])?\*\*/,i=/^\*[^\*\s](?:[^\*]*[^\*\s])?\*/,s=/^``[^`\s](?:[^`]*[^`\s])``/,o=/^(?:[\d]+(?:[\.,]\d+)*)/,u=/^(?:\s\+[\d]+(?:[\.,]\d+)*)/,a=/^(?:\s\-[\d]+(?:[\.,]\d+)*)/,f="[Hh][Tt][Tt][Pp][Ss]?://",l="(?:[\\d\\w.-]+)\\.(?:\\w{2,6})",c="(?:/[\\d\\w\\#\\%\\&\\-\\.\\,\\/\\:\\=\\?\\~]+)*",h=new RegExp("^"+f+l+c),p={token:function(e){if(e.match(r)&&e.match(/\W+|$/,!1))return"strong";if(e.match(i)&&e.match(/\W+|$/,!1))return"em";if(e.match(s)&&e.match(/\W+|$/,!1))return"string-2";if(e.match(o))return"number";if(e.match(u))return"positive";if(e.match(a))return"negative";if(e.match(h))return"link";while(e.next()!=null){if(e.match(r,!1))break;if(e.match(i,!1))break;if(e.match(s,!1))break;if(e.match(o,!1))break;if(e.match(u,!1))break;if(e.match(a,!1))break;if(e.match(h,!1))break}return null}},d=e.getMode(t,n.backdrop||"rst-base");return e.overlayMode(d,p,!0)},"python","stex"),e.defineMode("rst-base",function(t){function n(e){var t=Array.prototype.slice.call(arguments,1);return e.replace(/{(\d+)}/g,function(e,n){return typeof t[n]!="undefined"?t[n]:e})}function r(e){this.message=e}function i(e,t){if(!e)throw new r(t);return e}function z(t,n){var r=null;if(t.sol()&&t.match(U,!1))Q(n,J,{mode:s,local:e.startState(s)});else if(t.sol()&&t.match(y))Q(n,W),r="meta";else if(t.sol()&&t.match(g))Q(n,z),r="header";else if(Y(n)==A||t.match(A,!1))switch(G(n)){case 0:Q(n,z,K(A,1)),i(t.match(/^:/)),r="meta";break;case 1:Q(n,z,K(A,2)),i(t.match(c)),r="keyword",t.current().match(/^(?:math|latex)/)&&(n.tmp_stex=!0);break;case 2:Q(n,z,K(A,3)),i(t.match(/^:`/)),r="meta";break;case 3:n.tmp_stex&&(n.tmp_stex=undefined,n.tmp={mode:o,local:e.startState(o)});if(n.tmp){if(t.peek()=="`"){Q(n,z,K(A,4)),n.tmp=undefined;break}r=n.tmp.mode.token(t,n.tmp.local);break}Q(n,z,K(A,4)),i(t.match(m)),r="string";break;case 4:Q(n,z,K(A,5)),i(t.match(/^`/)),r="meta";break;case 5:Q(n,z,K(A,6)),i(t.match(f));break;default:Q(n,z),i(t.current()=="")}else if(Y(n)==O||t.match(O,!1))switch(G(n)){case 0:Q(n,z,K(O,1)),i(t.match(/^`/)),r="meta";break;case 1:Q(n,z,K(O,2)),i(t.match(m)),r="string";break;case 2:Q(n,z,K(O,3)),i(t.match(/^`:/)),r="meta";break;case 3:Q(n,z,K(O,4)),i(t.match(c)),r="keyword";break;case 4:Q(n,z,K(O,5)),i(t.match(/^:/)),r="meta";break;case 5:Q(n,z,K(O,6)),i(t.match(f));break;default:Q(n,z),i(t.current()=="")}else if(Y(n)==M||t.match(M,!1))switch(G(n)){case 0:Q(n,z,K(M,1)),i(t.match(/^:/)),r="meta";break;case 1:Q(n,z,K(M,2)),i(t.match(c)),r="keyword";break;case 2:Q(n,z,K(M,3)),i(t.match(/^:/)),r="meta";break;case 3:Q(n,z,K(M,4)),i(t.match(f));break;default:Q(n,z),i(t.current()=="")}else if(Y(n)==T||t.match(T,!1))switch(G(n)){case 0:Q(n,z,K(T,1)),i(t.match(P)),r="variable-2";break;case 1:Q(n,z,K(T,2)),t.match(/^_?_?/)&&(r="link");break;default:Q(n,z),i(t.current()=="")}else if(t.match(N))Q(n,z),r="quote";else if(t.match(C))Q(n,z),r="quote";else if(t.match(k)){Q(n,z);if(!t.peek()||t.peek().match(/^\W$/))r="link"}else if(Y(n)==L||t.match(L,!1))switch(G(n)){case 0:!t.peek()||t.peek().match(/^\W$/)?Q(n,z,K(L,1)):t.match(L);break;case 1:Q(n,z,K(L,2)),i(t.match(/^`/)),r="link";break;case 2:Q(n,z,K(L,3)),i(t.match(m));break;case 3:Q(n,z,K(L,4)),i(t.match(/^`_/)),r="link";break;default:Q(n,z),i(t.current()=="")}else t.match(R)?Q(n,V):t.next()&&Q(n,z);return r}function W(t,n){var r=null;if(Y(n)==E||t.match(E,!1))switch(G(n)){case 0:Q(n,W,K(E,1)),i(t.match(P)),r="variable-2";break;case 1:Q(n,W,K(E,2)),i(t.match(H));break;case 2:Q(n,W,K(E,3)),i(t.match(B)),r="keyword";break;case 3:Q(n,W,K(E,4)),i(t.match(j)),r="meta";break;default:Q(n,z),i(t.current()=="")}else if(Y(n)==w||t.match(w,!1))switch(G(n)){case 0:Q(n,W,K(w,1)),i(t.match(_)),r="keyword",t.current().match(/^(?:math|latex)/)?n.tmp_stex=!0:t.current().match(/^python/)&&(n.tmp_py=!0);break;case 1:Q(n,W,K(w,2)),i(t.match(D)),r="meta";if(t.match(/^latex\s*$/)||n.tmp_stex)n.tmp_stex=undefined,Q(n,J,{mode:o,local:e.startState(o)});break;case 2:Q(n,W,K(w,3));if(t.match(/^python\s*$/)||n.tmp_py)n.tmp_py=undefined,Q(n,J,{mode:s,local:e.startState(s)});break;default:Q(n,z),i(t.current()=="")}else if(Y(n)==b||t.match(b,!1))switch(G(n)){case 0:Q(n,W,K(b,1)),i(t.match(F)),i(t.match(I)),r="link";break;case 1:Q(n,W,K(b,2)),i(t.match(q)),r="meta";break;default:Q(n,z),i(t.current()=="")}else t.match(S)?(Q(n,z),r="quote"):t.match(x)?(Q(n,z),r="quote"):(t.eatSpace(),t.eol()?Q(n,z):(t.skipToEnd(),Q(n,X),r="comment"));return r}function X(e,t){return $(e,t,"comment")}function V(e,t){return $(e,t,"meta")}function $(e,t,n){return e.eol()||e.eatSpace()?(e.skipToEnd(),n):(Q(t,z),null)}function J(e,t){return t.ctx.mode&&t.ctx.local?e.sol()?(e.eatSpace()||Q(t,z),null):t.ctx.mode.token(e,t.ctx.local):(Q(t,z),null)}function K(e,t,n,r){return{phase:e,stage:t,mode:n,local:r}}function Q(e,t,n){e.tok=t,e.ctx=n||{}}function G(e){return e.ctx.stage||0}function Y(e){return e.ctx.phase}r.prototype.toString=function(){return"AssertException: "+this.message};var s=e.getMode(t,"python"),o=e.getMode(t,"stex"),u="\\s+",a="(?:\\s*|\\W|$)",f=new RegExp(n("^{0}",a)),l="(?:[^\\W\\d_](?:[\\w!\"#$%&'()\\*\\+,\\-\\./:;<=>\\?]*[^\\W_])?)",c=new RegExp(n("^{0}",l)),h="(?:[^\\W\\d_](?:[\\w\\s!\"#$%&'()\\*\\+,\\-\\./:;<=>\\?]*[^\\W_])?)",p=n("(?:{0}|`{1}`)",l,h),d="(?:[^\\s\\|](?:[^\\|]*[^\\s\\|])?)",v="(?:[^\\`]+)",m=new RegExp(n("^{0}",v)),g=new RegExp("^([!'#$%&\"()*+,-./:;<=>?@\\[\\\\\\]^_`{|}~])\\1{3,}\\s*$"),y=new RegExp(n("^\\.\\.{0}",u)),b=new RegExp(n("^_{0}:{1}|^__:{1}",p,a)),w=new RegExp(n("^{0}::{1}",p,a)),E=new RegExp(n("^\\|{0}\\|{1}{2}::{3}",d,u,p,a)),S=new RegExp(n("^\\[(?:\\d+|#{0}?|\\*)]{1}",p,a)),x=new RegExp(n("^\\[{0}\\]{1}",p,a)),T=new RegExp(n("^\\|{0}\\|",d)),N=new RegExp(n("^\\[(?:\\d+|#{0}?|\\*)]_",p)),C=new RegExp(n("^\\[{0}\\]_",p)),k=new RegExp(n("^{0}__?",p)),L=new RegExp(n("^`{0}`_",v)),A=new RegExp(n("^:{0}:`{1}`{2}",l,v,a)),O=new RegExp(n("^`{1}`:{0}:{2}",l,v,a)),M=new RegExp(n("^:{0}:{1}",l,a)),_=new RegExp(n("^{0}",p)),D=new RegExp(n("^::{0}",a)),P=new RegExp(n("^\\|{0}\\|",d)),H=new RegExp(n("^{0}",u)),B=new RegExp(n("^{0}",p)),j=new RegExp(n("^::{0}",a)),F=new RegExp("^_"),I=new RegExp(n("^{0}|_",p)),q=new RegExp(n("^:{0}",a)),R=new RegExp("^::\\s*$"),U=new RegExp("^\\s+(?:>>>|In \\[\\d+\\]:)\\s");return{startState:function(){return{tok:z,ctx:K(undefined,0)}},copyState:function(t){var n=t.ctx,r=t.tmp;return n.local&&(n={mode:n.mode,local:e.copyState(n.mode,n.local)}),r&&(r={mode:r.mode,local:e.copyState(r.mode,r.local)}),{tok:t.tok,ctx:n,tmp:r}},innerMode:function(e){return e.tmp?{state:e.tmp.local,mode:e.tmp.mode}:e.ctx.mode?{state:e.ctx.local,mode:e.ctx.mode}:null},token:function(e,t){return t.tok(e,t)}}},"python","stex"),e.defineMIME("text/x-rst","rst")});