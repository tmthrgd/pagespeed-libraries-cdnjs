/**
* @file smartymixed.js
* @brief Smarty Mixed Codemirror mode (Smarty + Mixed HTML)
* @author Ruslan Osmanov <rrosmanov at gmail dot com>
* @version 3.0
* @date 05.07.2013
*/(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"),require("../smarty/smarty")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed","../smarty/smarty"],e):e(CodeMirror)})(function(e){"use strict";e.defineMode("smartymixed",function(t){var n,r,i,s,o=e.getMode(t,"htmlmixed"),u=e.getMode(t,"smarty"),n={rightDelimiter:"}",leftDelimiter:"{"};return t.hasOwnProperty("leftDelimiter")&&(n.leftDelimiter=t.leftDelimiter),t.hasOwnProperty("rightDelimiter")&&(n.rightDelimiter=t.rightDelimiter),r={smartyComment:new RegExp("^"+n.leftDelimiter+"\\*"),literalOpen:new RegExp(n.leftDelimiter+"literal"+n.rightDelimiter),literalClose:new RegExp(n.leftDelimiter+"/literal"+n.rightDelimiter),hasLeftDelimeter:new RegExp(".*"+n.leftDelimiter),htmlHasLeftDelimeter:new RegExp("[^<>]*"+n.leftDelimiter)},i={chain:function(e,t,n){return t.tokenize=n,n(e,t)},cleanChain:function(e,t,n){return t.tokenize=null,t.localState=null,t.localMode=null,typeof n=="string"?n?n:null:n(e,t)},maybeBackup:function(e,t,n){var r=e.current(),i=r.search(t),s;if(i>-1)e.backUp(r.length-i);else if(s=r.match(/<\/?$/))e.backUp(r.length),e.match(t,!1)||e.match(r[0]);return n}},s={html:function(e,t){return!t.inLiteral&&e.match(r.htmlHasLeftDelimeter,!1)&&t.htmlMixedState.htmlState.tagName===null?(t.tokenize=s.smarty,t.localMode=u,t.localState=u.startState(o.indent(t.htmlMixedState,"")),i.maybeBackup(e,n.leftDelimiter,u.token(e,t.localState))):!t.inLiteral&&e.match(n.leftDelimiter,!1)?(t.tokenize=s.smarty,t.localMode=u,t.localState=u.startState(o.indent(t.htmlMixedState,"")),i.maybeBackup(e,n.leftDelimiter,u.token(e,t.localState))):o.token(e,t.htmlMixedState)},smarty:function(e,t){if(e.match(n.leftDelimiter,!1)){if(e.match(r.smartyComment,!1))return i.chain(e,t,s.inBlock("comment","*"+n.rightDelimiter))}else if(e.match(n.rightDelimiter,!1))return e.eat(n.rightDelimiter),t.tokenize=s.html,t.localMode=o,t.localState=t.htmlMixedState,"tag";return i.maybeBackup(e,n.rightDelimiter,u.token(e,t.localState))},inBlock:function(e,t){return function(n,r){while(!n.eol()){if(n.match(t)){i.cleanChain(n,r,"");break}n.next()}return e}}},{startState:function(){var e=o.startState();return{token:s.html,localMode:null,localState:null,htmlMixedState:e,tokenize:null,inLiteral:!1}},copyState:function(t){var n=null,r=t.tokenize||t.token;return t.localState&&(n=e.copyState(r!=s.html?u:o,t.localState)),{token:t.token,tokenize:t.tokenize,localMode:t.localMode,localState:n,htmlMixedState:e.copyState(o,t.htmlMixedState),inLiteral:t.inLiteral}},token:function(e,t){if(e.match(n.leftDelimiter,!1)){if(!t.inLiteral&&e.match(r.literalOpen,!0))return t.inLiteral=!0,"keyword";if(t.inLiteral&&e.match(r.literalClose,!0))return t.inLiteral=!1,"keyword"}t.inLiteral&&t.localState!=t.htmlMixedState&&(t.tokenize=s.html,t.localMode=o,t.localState=t.htmlMixedState);var i=(t.tokenize||t.token)(e,t);return i},indent:function(t,n){return t.localMode==u||t.inLiteral&&!t.localMode||r.hasLeftDelimeter.test(n)?e.Pass:o.indent(t.htmlMixedState,n)},innerMode:function(e){return{state:e.localState||e.htmlMixedState,mode:e.localMode||o}}}},"htmlmixed","smarty"),e.defineMIME("text/x-smarty","smartymixed")});