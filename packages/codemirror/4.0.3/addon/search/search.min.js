// Define search commands. Depends on dialog.js or another
// implementation of the openDialog method.
// Replace works a little oddly -- it will do the replace on the next
// Ctrl-G (or whatever is bound to findNext) press. You prevent a
// replace by making sure the match is no longer selected when hitting
// Ctrl-G.
(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror"),require("./searchcursor"),require("../dialog/dialog")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./searchcursor","../dialog/dialog"],e):e(CodeMirror)})(function(e){"use strict";function t(e,t){var n;return typeof e=="string"?(n=e.charAt(0),e=new RegExp("^"+e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"i":"")):e=new RegExp("^(?:"+e.source+")",e.ignoreCase?"i":""),{token:function(r){if(r.match(e))return"searching";while(!r.eol()){r.next(),n&&!t&&(r.skipTo(n)||r.skipToEnd());if(r.match(e,!1))break}}}}function n(){this.posFrom=this.posTo=this.query=null,this.overlay=null}function r(e){return e.state.search||(e.state.search=new n)}function i(e){return typeof e=="string"&&e==e.toLowerCase()}function s(e,t,n){return e.getSearchCursor(t,n,i(t))}function o(e,t,n,r,i){e.openDialog?e.openDialog(t,i,{value:r}):i(prompt(n,r))}function u(e,t,n,r){e.openConfirm?e.openConfirm(t,r):confirm(n)&&r[0]()}function a(e){var t=e.match(/^\/(.*)\/([a-z]*)$/);return t?(e=new RegExp(t[1],t[2].indexOf("i")==-1?"":"i"),e.test("")&&(e=/x^/)):e==""&&(e=/x^/),e}function l(e,n){var s=r(e);if(s.query)return c(e,n);o(e,f,"Search for:",e.getSelection(),function(r){e.operation(function(){if(!r||s.query)return;s.query=a(r),e.removeOverlay(s.overlay,i(s.query)),s.overlay=t(s.query,i(s.query)),e.addOverlay(s.overlay),s.posFrom=s.posTo=e.getCursor(),c(e,n)})})}function c(t,n){t.operation(function(){var i=r(t),o=s(t,i.query,n?i.posFrom:i.posTo);if(!o.find(n)){o=s(t,i.query,n?e.Pos(t.lastLine()):e.Pos(t.firstLine(),0));if(!o.find(n))return}t.setSelection(o.from(),o.to()),t.scrollIntoView({from:o.from(),to:o.to()}),i.posFrom=o.from(),i.posTo=o.to()})}function h(e){e.operation(function(){var t=r(e);if(!t.query)return;t.query=null,e.removeOverlay(t.overlay)})}function m(e,t){o(e,p,"Replace:",e.getSelection(),function(n){if(!n)return;n=a(n),o(e,d,"Replace with:","",function(r){if(t)e.operation(function(){for(var t=s(e,n);t.findNext();)if(typeof n!="string"){var i=e.getRange(t.from(),t.to()).match(n);t.replace(r.replace(/\$(\d)/g,function(e,t){return i[t]}))}else t.replace(r)});else{h(e);var i=s(e,n,e.getCursor()),o=function(){var t=i.from(),r;if(!(r=i.findNext())){i=s(e,n);if(!(r=i.findNext())||t&&i.from().line==t.line&&i.from().ch==t.ch)return}e.setSelection(i.from(),i.to()),e.scrollIntoView({from:i.from(),to:i.to()}),u(e,v,"Replace?",[function(){a(r)},o])},a=function(e){i.replace(typeof n=="string"?r:r.replace(/\$(\d)/g,function(t,n){return e[n]})),o()};o()}})})}var f='Search: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',p='Replace: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',d='With: <input type="text" style="width: 10em"/>',v="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";e.commands.find=function(e){h(e),l(e)},e.commands.findNext=l,e.commands.findPrev=function(e){l(e,!0)},e.commands.clearSearch=h,e.commands.replace=m,e.commands.replaceAll=function(e){m(e,!0)}});