(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../../lib/codemirror")):typeof define=="function"&&define.amd?define(["../../lib/codemirror"],e):e(CodeMirror)})(function(e){"use strict";function r(e,t,n){this.cm=e,this.getHints=t,this.options=n,this.widget=this.onClose=null}function i(e){return typeof e=="string"?e:e.text}function s(e,t){function i(e,i){var s;typeof i!="string"?s=function(e){return i(e,t)}:n.hasOwnProperty(i)?s=n[i]:s=i,r[e]=s}var n={Up:function(){t.moveFocus(-1)},Down:function(){t.moveFocus(1)},PageUp:function(){t.moveFocus(-t.menuSize()+1,!0)},PageDown:function(){t.moveFocus(t.menuSize()-1,!0)},Home:function(){t.setFocus(0)},End:function(){t.setFocus(t.length-1)},Enter:t.pick,Tab:t.pick,Esc:t.close},r=e.customKeys?{}:n;if(e.customKeys)for(var s in e.customKeys)e.customKeys.hasOwnProperty(s)&&i(s,e.customKeys[s]);if(e.extraKeys)for(var s in e.extraKeys)e.extraKeys.hasOwnProperty(s)&&i(s,e.extraKeys[s]);return r}function o(e,t){while(t&&t!=e){if(t.nodeName.toUpperCase()==="LI"&&t.parentNode==e)return t;t=t.parentNode}}function u(r,u){this.completion=r,this.data=u;var a=this,f=r.cm,l=r.options,c=this.hints=document.createElement("ul");c.className="CodeMirror-hints",this.selectedHint=l.getDefaultSelection?l.getDefaultSelection(f,l,u):0;var h=u.list;for(var p=0;p<h.length;++p){var d=c.appendChild(document.createElement("li")),v=h[p],m=t+(p!=this.selectedHint?"":" "+n);v.className!=null&&(m=v.className+" "+m),d.className=m,v.render?v.render(d,u,v):d.appendChild(document.createTextNode(v.displayText||i(v))),d.hintId=p}var g=f.cursorCoords(l.alignWithWord!==!1?u.from:null),y=g.left,b=g.bottom,w=!0;c.style.left=y+"px",c.style.top=b+"px";var E=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth),S=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(l.container||document.body).appendChild(c);var x=c.getBoundingClientRect(),T=x.bottom-S;if(T>0){var N=x.bottom-x.top,C=x.top-(g.bottom-g.top);if(C-N>0)c.style.top=(b=C-N)+"px",w=!1;else if(N>S){c.style.height=S-5+"px",c.style.top=(b=g.bottom-x.top)+"px";var k=f.getCursor();u.from.ch!=k.ch&&(g=f.cursorCoords(k),c.style.left=(y=g.left)+"px",x=c.getBoundingClientRect())}}var L=x.left-E;L>0&&(x.right-x.left>E&&(c.style.width=E-5+"px",L-=x.right-x.left-E),c.style.left=(y=g.left-L)+"px"),f.addKeyMap(this.keyMap=s(l,{moveFocus:function(e,t){a.changeActive(a.selectedHint+e,t)},setFocus:function(e){a.changeActive(e)},menuSize:function(){return a.screenAmount()},length:h.length,close:function(){r.close()},pick:function(){a.pick()},data:u}));if(l.closeOnUnfocus!==!1){var A;f.on("blur",this.onBlur=function(){A=setTimeout(function(){r.close()},100)}),f.on("focus",this.onFocus=function(){clearTimeout(A)})}var O=f.getScrollInfo();return f.on("scroll",this.onScroll=function(){var e=f.getScrollInfo(),t=f.getWrapperElement().getBoundingClientRect(),n=b+O.top-e.top,i=n-(window.pageYOffset||(document.documentElement||document.body).scrollTop);w||(i+=c.offsetHeight);if(i<=t.top||i>=t.bottom)return r.close();c.style.top=n+"px",c.style.left=y+O.left-e.left+"px"}),e.on(c,"dblclick",function(e){var t=o(c,e.target||e.srcElement);t&&t.hintId!=null&&(a.changeActive(t.hintId),a.pick())}),e.on(c,"click",function(e){var t=o(c,e.target||e.srcElement);t&&t.hintId!=null&&(a.changeActive(t.hintId),l.completeOnSingleClick&&a.pick())}),e.on(c,"mousedown",function(){setTimeout(function(){f.focus()},20)}),e.signal(u,"select",h[0],c.firstChild),!0}var t="CodeMirror-hint",n="CodeMirror-hint-active";e.showHint=function(t,n,i){if(t.listSelections().length>1||t.somethingSelected())return;if(n==null){if(i&&i.async)return;n=e.hint.auto}t.state.completionActive&&t.state.completionActive.close();var s=t.state.completionActive=new r(t,n,i||{});e.signal(t,"startCompletion",t);if(!s.options.async)return s.showHints(n(t,s.options));n(t,function(e){s.showHints(e)},s.options)},r.prototype={close:function(){if(!this.active())return;this.cm.state.completionActive=null,this.widget&&this.widget.close(),this.onClose&&this.onClose(),e.signal(this.cm,"endCompletion",this.cm)},active:function(){return this.cm.state.completionActive==this},pick:function(t,n){var r=t.list[n];r.hint?r.hint(this.cm,t,r):this.cm.replaceRange(i(r),r.from||t.from,r.to||t.to),e.signal(t,"pick",r),this.close()},showHints:function(e){if(!e||!e.list.length||!this.active())return this.close();this.options.completeSingle!=0&&e.list.length==1?this.pick(e,0):this.showWidget(e)},showWidget:function(t){function c(){if(i)return;i=!0,r.close(),r.cm.off("cursorActivity",v),t&&e.signal(t,"close")}function h(){if(i)return;e.signal(t,"update"),r.options.async?r.getHints(r.cm,p,r.options):p(r.getHints(r.cm,r.options))}function p(e){t=e;if(i)return;if(!t||!t.list.length)return c();r.widget=new u(r,t)}function d(){n&&(l(n),n=0)}function v(){d();var e=r.cm.getCursor(),t=r.cm.getLine(e.line);e.line!=o.line||t.length-e.ch!=a-o.ch||e.ch<o.ch||r.cm.somethingSelected()||e.ch&&s.test(t.charAt(e.ch-1))?r.close():(n=f(h),r.widget&&r.widget.close())}this.widget=new u(this,t),e.signal(t,"shown");var n=0,r=this,i,s=this.options.closeCharacters||/[\s()\[\]{};:>,]/,o=this.cm.getCursor(),a=this.cm.getLine(o.line).length,f=window.requestAnimationFrame||function(e){return setTimeout(e,1e3/60)},l=window.cancelAnimationFrame||clearTimeout;this.cm.on("cursorActivity",v),this.onClose=c}},u.prototype={close:function(){if(this.completion.widget!=this)return;this.completion.widget=null,this.hints.parentNode.removeChild(this.hints),this.completion.cm.removeKeyMap(this.keyMap);var e=this.completion.cm;this.completion.options.closeOnUnfocus!==!1&&(e.off("blur",this.onBlur),e.off("focus",this.onFocus)),e.off("scroll",this.onScroll)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(t,r){t>=this.data.list.length?t=r?this.data.list.length-1:0:t<0&&(t=r?0:this.data.list.length-1);if(this.selectedHint==t)return;var i=this.hints.childNodes[this.selectedHint];i.className=i.className.replace(" "+n,""),i=this.hints.childNodes[this.selectedHint=t],i.className+=" "+n,i.offsetTop<this.hints.scrollTop?this.hints.scrollTop=i.offsetTop-3:i.offsetTop+i.offsetHeight>this.hints.scrollTop+this.hints.clientHeight&&(this.hints.scrollTop=i.offsetTop+i.offsetHeight-this.hints.clientHeight+3),e.signal(this.data,"select",this.data.list[this.selectedHint],i)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}},e.registerHelper("hint","auto",function(t,n){var r=t.getHelpers(t.getCursor(),"hint"),i;if(r.length)for(var s=0;s<r.length;s++){var o=r[s](t,n);if(o&&o.list.length)return o}else if(i=t.getHelper(t.getCursor(),"hintWords")){if(i)return e.hint.fromList(t,{words:i})}else if(e.hint.anyword)return e.hint.anyword(t,n)}),e.registerHelper("hint","fromList",function(t,n){var r=t.getCursor(),i=t.getTokenAt(r),s=[];for(var o=0;o<n.words.length;o++){var u=n.words[o];u.slice(0,i.string.length)==i.string&&s.push(u)}if(s.length)return{list:s,from:e.Pos(r.line,i.start),to:e.Pos(r.line,i.end)}}),e.commands.autocomplete=e.showHint});