/**
 * Supported keybindings:
 *
 *   Motion:
 *   h, j, k, l
 *   gj, gk
 *   e, E, w, W, b, B, ge, gE
 *   f<character>, F<character>, t<character>, T<character>
 *   $, ^, 0, -, +, _
 *   gg, G
 *   %
 *   '<character>, `<character>
 *
 *   Operator:
 *   d, y, c
 *   dd, yy, cc
 *   g~, g~g~
 *   >, <, >>, <<
 *
 *   Operator-Motion:
 *   x, X, D, Y, C, ~
 *
 *   Action:
 *   a, i, s, A, I, S, o, O
 *   zz, z., z<CR>, zt, zb, z-
 *   J
 *   u, Ctrl-r
 *   m<character>
 *   r<character>
 *
 *   Modes:
 *   ESC - leave insert mode, visual mode, and clear input state.
 *   Ctrl-[, Ctrl-c - same as ESC.
 *
 * Registers: unnamed, -, a-z, A-Z, 0-9
 *   (Does not respect the special case for number registers when delete
 *    operator is made with these commands: %, (, ),  , /, ?, n, N, {, } )
 *   TODO: Implement the remaining registers.
 * Marks: a-z, A-Z, and 0-9
 *   TODO: Implement the remaining special marks. They have more complex
 *       behavior.
 *
 * Events:
 *  'vim-mode-change' - raised on the editor anytime the current mode changes,
 *                      Event object: {mode: "visual", subMode: "linewise"}
 *
 * Code structure:
 *  1. Default keymap
 *  2. Variable declarations and short basic helpers
 *  3. Instance (External API) implementation
 *  4. Internal state tracking objects (input state, counter) implementation
 *     and instanstiation
 *  5. Key handler (the main command dispatcher) implementation
 *  6. Motion, operator, and action implementations
 *  7. Helper functions for the key handler, motions, operators, and actions
 *  8. Set up Vim to work as a keymap for CodeMirror.
 */(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/dialog/dialog")):typeof define=="function"&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/dialog/dialog"],e):e(CodeMirror)})(function(e){"use strict";var t=[{keys:["<Left>"],type:"keyToKey",toKeys:["h"]},{keys:["<Right>"],type:"keyToKey",toKeys:["l"]},{keys:["<Up>"],type:"keyToKey",toKeys:["k"]},{keys:["<Down>"],type:"keyToKey",toKeys:["j"]},{keys:["<Space>"],type:"keyToKey",toKeys:["l"]},{keys:["<BS>"],type:"keyToKey",toKeys:["h"]},{keys:["<C-Space>"],type:"keyToKey",toKeys:["W"]},{keys:["<C-BS>"],type:"keyToKey",toKeys:["B"]},{keys:["<S-Space>"],type:"keyToKey",toKeys:["w"]},{keys:["<S-BS>"],type:"keyToKey",toKeys:["b"]},{keys:["<C-n>"],type:"keyToKey",toKeys:["j"]},{keys:["<C-p>"],type:"keyToKey",toKeys:["k"]},{keys:["<C-[>"],type:"keyToKey",toKeys:["<Esc>"]},{keys:["<C-c>"],type:"keyToKey",toKeys:["<Esc>"]},{keys:["s"],type:"keyToKey",toKeys:["c","l"],context:"normal"},{keys:["s"],type:"keyToKey",toKeys:["x","i"],context:"visual"},{keys:["S"],type:"keyToKey",toKeys:["c","c"],context:"normal"},{keys:["S"],type:"keyToKey",toKeys:["d","c","c"],context:"visual"},{keys:["<Home>"],type:"keyToKey",toKeys:["0"]},{keys:["<End>"],type:"keyToKey",toKeys:["$"]},{keys:["<PageUp>"],type:"keyToKey",toKeys:["<C-b>"]},{keys:["<PageDown>"],type:"keyToKey",toKeys:["<C-f>"]},{keys:["<CR>"],type:"keyToKey",toKeys:["j","^"],context:"normal"},{keys:["H"],type:"motion",motion:"moveToTopLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["M"],type:"motion",motion:"moveToMiddleLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["L"],type:"motion",motion:"moveToBottomLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["h"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!1}},{keys:["l"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["j"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,linewise:!0}},{keys:["k"],type:"motion",motion:"moveByLines",motionArgs:{forward:!1,linewise:!0}},{keys:["g","j"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!0}},{keys:["g","k"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!1}},{keys:["w"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1}},{keys:["W"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1,bigWord:!0}},{keys:["e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,inclusive:!0}},{keys:["E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["b"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1}},{keys:["B"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1,bigWord:!0}},{keys:["g","e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,inclusive:!0}},{keys:["g","E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["{"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!1,toJumplist:!0}},{keys:["}"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!0,toJumplist:!0}},{keys:["<C-f>"],type:"motion",motion:"moveByPage",motionArgs:{forward:!0}},{keys:["<C-b>"],type:"motion",motion:"moveByPage",motionArgs:{forward:!1}},{keys:["<C-d>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:!0,explicitRepeat:!0}},{keys:["<C-u>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:!1,explicitRepeat:!0}},{keys:["g","g"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:["G"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!0,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:["0"],type:"motion",motion:"moveToStartOfLine"},{keys:["^"],type:"motion",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["+"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0}},{keys:["-"],type:"motion",motion:"moveByLines",motionArgs:{forward:!1,toFirstChar:!0}},{keys:["_"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0,repeatOffset:-1}},{keys:["$"],type:"motion",motion:"moveToEol",motionArgs:{inclusive:!0}},{keys:["%"],type:"motion",motion:"moveToMatchedSymbol",motionArgs:{inclusive:!0,toJumplist:!0}},{keys:["f","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["F","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!1}},{keys:["t","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["T","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!1}},{keys:[";"],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!0}},{keys:[","],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!1}},{keys:["'","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0}},{keys:["`","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0}},{keys:["]","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!0}},{keys:["[","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!1}},{keys:["]","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!0,linewise:!0}},{keys:["[","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!1,linewise:!0}},{keys:["]","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:!0,toJumplist:!0}},{keys:["[","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:!1,toJumplist:!0}},{keys:["|"],type:"motion",motion:"moveToColumn",motionArgs:{}},{keys:["o"],type:"motion",motion:"moveToOtherHighlightedEnd",motionArgs:{},context:"visual"},{keys:["d"],type:"operator",operator:"delete"},{keys:["y"],type:"operator",operator:"yank"},{keys:["c"],type:"operator",operator:"change"},{keys:[">"],type:"operator",operator:"indent",operatorArgs:{indentRight:!0}},{keys:["<"],type:"operator",operator:"indent",operatorArgs:{indentRight:!1}},{keys:["g","~"],type:"operator",operator:"swapcase"},{keys:["n"],type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:!0}},{keys:["N"],type:"motion",motion:"findNext",motionArgs:{forward:!1,toJumplist:!0}},{keys:["x"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!0},operatorMotionArgs:{visualLine:!1}},{keys:["X"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!1},operatorMotionArgs:{visualLine:!0}},{keys:["D"],type:"operatorMotion",operator:"delete",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["Y"],type:"operatorMotion",operator:"yank",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["C"],type:"operatorMotion",operator:"change",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["~"],type:"operatorMotion",operator:"swapcase",operatorArgs:{shouldMoveCursor:!0},motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["<C-i>"],type:"action",action:"jumpListWalk",actionArgs:{forward:!0}},{keys:["<C-o>"],type:"action",action:"jumpListWalk",actionArgs:{forward:!1}},{keys:["<C-e>"],type:"action",action:"scroll",actionArgs:{forward:!0,linewise:!0}},{keys:["<C-y>"],type:"action",action:"scroll",actionArgs:{forward:!1,linewise:!0}},{keys:["a"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"charAfter"}},{keys:["A"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"eol"}},{keys:["i"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"inplace"}},{keys:["I"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"firstNonBlank"}},{keys:["o"],type:"action",action:"newLineAndEnterInsertMode",isEdit:!0,interlaceInsertRepeat:!0,actionArgs:{after:!0}},{keys:["O"],type:"action",action:"newLineAndEnterInsertMode",isEdit:!0,interlaceInsertRepeat:!0,actionArgs:{after:!1}},{keys:["v"],type:"action",action:"toggleVisualMode"},{keys:["V"],type:"action",action:"toggleVisualMode",actionArgs:{linewise:!0}},{keys:["g","v"],type:"action",action:"reselectLastSelection"},{keys:["J"],type:"action",action:"joinLines",isEdit:!0},{keys:["p"],type:"action",action:"paste",isEdit:!0,actionArgs:{after:!0,isEdit:!0}},{keys:["P"],type:"action",action:"paste",isEdit:!0,actionArgs:{after:!1,isEdit:!0}},{keys:["r","character"],type:"action",action:"replace",isEdit:!0},{keys:["@","character"],type:"action",action:"replayMacro"},{keys:["q","character"],type:"action",action:"enterMacroRecordMode"},{keys:["R"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{replace:!0}},{keys:["u"],type:"action",action:"undo"},{keys:["<C-r>"],type:"action",action:"redo"},{keys:["m","character"],type:"action",action:"setMark"},{keys:['"',"character"],type:"action",action:"setRegister"},{keys:["z","z"],type:"action",action:"scrollToCursor",actionArgs:{position:"center"}},{keys:["z","."],type:"action",action:"scrollToCursor",actionArgs:{position:"center"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","t"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"}},{keys:["z","<CR>"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","-"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"}},{keys:["z","b"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["."],type:"action",action:"repeatLastEdit"},{keys:["<C-a>"],type:"action",action:"incrementNumberToken",isEdit:!0,actionArgs:{increase:!0,backtrack:!1}},{keys:["<C-x>"],type:"action",action:"incrementNumberToken",isEdit:!0,actionArgs:{increase:!1,backtrack:!1}},{keys:["a","character"],type:"motion",motion:"textObjectManipulation"},{keys:["i","character"],type:"motion",motion:"textObjectManipulation",motionArgs:{textObjectInner:!0}},{keys:["/"],type:"search",searchArgs:{forward:!0,querySrc:"prompt",toJumplist:!0}},{keys:["?"],type:"search",searchArgs:{forward:!1,querySrc:"prompt",toJumplist:!0}},{keys:["*"],type:"search",searchArgs:{forward:!0,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:["#"],type:"search",searchArgs:{forward:!1,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:[":"],type:"ex"}],n=e.Pos,r=function(){function i(e,t){var r=e.state.vim;if(r.insertMode||r.exMode)return;var i=t.ranges[0].head,s=t.ranges[0].anchor;if(i.ch&&i.ch==e.doc.getLine(i.line).length){var o=n(i.line,i.ch-1);t.update([{anchor:J(i,s)?o:s,head:o}])}}function s(e){var t=e.state.vim;return t.onPasteFn||(t.onPasteFn=function(){t.insertMode||(e.setCursor(W(e.getCursor(),0,1)),R.enterInsertMode(e,{},t))}),t.onPasteFn}function f(e,t){var n=[];for(var r=e;r<e+t;r++)n.push(String.fromCharCode(r));return n}function g(e,t){return t>=e.firstLine()&&t<=e.lastLine()}function y(e){return/^[a-z]$/.test(e)}function b(e){return"()[]{}".indexOf(e)!=-1}function w(e){return o.test(e)}function E(e){return/^[A-Z]$/.test(e)}function S(e){return/^\s*$/.test(e)}function x(e,t){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1}function N(e,t,n){if(t===undefined)throw Error("defaultValue is required");n||(n="string"),T[e]={type:n,defaultValue:t},C(e,t)}function C(e,t){var n=T[e];if(!n)throw Error("Unknown option: "+e);if(n.type=="boolean"){if(t&&t!==!0)throw Error("Invalid argument: "+e+"="+t);t!==!1&&(t=!0)}n.value=n.type=="boolean"?!!t:t}function k(e){var t=T[e];if(!t)throw Error("Unknown option: "+e);return t.value}function O(){this.latestRegister=undefined,this.isPlaying=!1,this.isRecording=!1,this.onRecordingDone=undefined,this.lastInsertModeChanges=A()}function M(e){return e.state.vim||(e.state.vim={inputState:new H,lastEditInputState:undefined,lastEditActionCommand:undefined,lastHPos:-1,lastHSPos:-1,lastMotion:null,marks:{},insertMode:!1,insertModeRepeat:undefined,visualMode:!1,visualLine:!1,lastSelection:null}),e.state.vim}function D(){_={searchQuery:null,searchIsReversed:!1,jumpList:L(),macroModeState:new O,lastChararacterSearch:{increment:0,forward:!0,selectedCharacter:""},registerController:new j({})};for(var e in T){var t=T[e];t.value=t.defaultValue}}function H(){this.prefixRepeat=[],this.motionRepeat=[],this.operator=null,this.operatorArgs=null,this.motion=null,this.motionArgs=null,this.keyBuffer=[],this.registerName=null}function B(e,t){this.clear(),this.keyBuffer=[e||""],this.insertModeChanges=[],this.linewise=!!t}function j(e){this.registers=e,this.unnamedRegister=e['"']=new B}function U(e,t,r){var i=Math.min(Math.max(e.firstLine(),t.line),e.lastLine()),s=G(e,i)-1;s=r?s+1:s;var o=Math.min(Math.max(0,t.ch),s);return n(i,o)}function z(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function W(e,t,r){return n(e.line+t,e.ch+r)}function X(e,t){for(var n=0;n<e.length;n++)if(e[n]!=t[n]&&t[n]!="character")return!1;return!0}function V(e,t,n){return function(){for(var r=0;r<n;r++)t(e)}}function $(e){return n(e.line,e.ch)}function J(e,t){return e.ch==t.ch&&e.line==t.line}function K(e,t){return e.line<t.line?!0:e.line==t.line&&e.ch<t.ch?!0:!1}function Q(e,t,n){var r=K(e,t),i=K(t,n);return r&&i}function G(e,t){return e.getLine(t).length}function Y(e){return e.split("").reverse().join("")}function Z(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function et(e){return e.replace(/([.?*+$\[\]\/\\(){}|\-])/g,"\\$1")}function tt(t){t.off("mousedown",tt);var n=t.state.vim;n.lastSelection={curStart:n.marks["<"].find(),curEnd:n.marks[">"].find(),visualMode:n.visualMode,visualLine:n.visualLine},n.visualMode=!1,n.visualLine=!1;var r=t.getCursor("anchor"),i=t.getCursor("head");J(r,i)||t.setCursor(U(t,i)),e.signal(t,"vim-mode-change",{mode:"normal"})}function nt(e,t,n){var r=e.getRange(t,n);if(/\n\s*$/.test(r)){var i=r.split("\n");i.pop();var s;for(var s=i.pop();i.length>0&&s&&S(s);s=i.pop())n.line--,n.ch=0;s?(n.line--,n.ch=G(e,n.line)):n.ch=0}}function rt(e,t,n){t.ch=0,n.ch=0,n.line++}function it(e){if(!e)return 0;var t=e.search(/\S/);return t==-1?e.length:t}function st(e,t,r,i,s){var o=e.getCursor(),u=e.getLine(o.line),a=o.ch,f=u.substring(a),l;s?l=f.search(/\w/):l=f.search(/\S/);if(l==-1)return null;a+=l,f=u.substring(a);var c=u.substring(0,a),h;i?h=/^\S+/:/\w/.test(u.charAt(a))?h=/^\w+/:h=/^[^\w\s]+/;var p=h.exec(f),d=a,v=a+p[0].length,m=Y(c),g=h.exec(m);g&&(d-=g[0].length);if(t){var y=u.substring(v),b=y.match(/^\s*/)[0].length;if(b>0)v+=b;else{var w=m.length-d,E=m.substring(w),S=E.match(/^\s*/)[0].length;d-=S}}return{start:n(o.line,d),end:n(o.line,v)}}function ot(e,t,n){J(t,n)||_.jumpList.add(e,t,n)}function ut(e,t){_.lastChararacterSearch.increment=e,_.lastChararacterSearch.forward=t.forward,_.lastChararacterSearch.selectedCharacter=t.selectedCharacter}function lt(e,t,r,i){var s=$(e.getCursor()),o=r?1:-1,u=r?e.lineCount():-1,a=s.ch,f=s.line,l=e.getLine(f),c={lineText:l,nextCh:l.charAt(a),lastCh:null,index:a,symb:i,reverseSymb:(r?{")":"(","}":"{"}:{"(":")","{":"}"})[i],forward:r,depth:0,curMoveThrough:!1},h=at[i];if(!h)return s;var p=ft[h].init,d=ft[h].isComplete;p&&p(c);while(f!==u&&t){c.index+=o,c.nextCh=c.lineText.charAt(c.index);if(!c.nextCh){f+=o,c.lineText=e.getLine(f)||"";if(o>0)c.index=0;else{var v=c.lineText.length;c.index=v>0?v-1:0}c.nextCh=c.lineText.charAt(c.index)}d(c)&&(s.line=f,s.ch=c.index,t--)}return c.nextCh||c.curMoveThrough?n(f,c.index):s}function ct(e,t,n,r,i){var s=t.line,o=t.ch,f=e.getLine(s),l=n?1:-1,c=r?a:u;if(i&&f==""){s+=l,f=e.getLine(s);if(!g(e,s))return null;o=n?0:f.length}for(;;){if(i&&f=="")return{from:0,to:0,line:s};var h=l>0?f.length:-1,p=h,d=h;while(o!=h){var v=!1;for(var m=0;m<c.length&&!v;++m)if(c[m].test(f.charAt(o))){p=o;while(o!=h&&c[m].test(f.charAt(o)))o+=l;d=o,v=p!=d;if(p==t.ch&&s==t.line&&d==p+l)continue;return{from:Math.min(p,d+1),to:Math.max(p,d),line:s}}v||(o+=l)}s+=l;if(!g(e,s))return null;f=e.getLine(s),o=l>0?0:f.length}throw new Error("The impossible happened.")}function ht(e,t,r,i,s){var o=e.getCursor(),u=$(o),a=[];(r&&!i||!r&&i)&&t++;var f=!r||!i;for(var l=0;l<t;l++){var c=ct(e,o,r,s,f);if(!c){var h=G(e,e.lastLine());a.push(r?{line:e.lastLine(),from:h,to:h}:{line:0,from:0,to:0});break}a.push(c),o=n(c.line,r?c.to-1:c.from)}var p=a.length!=t,d=a[0],v=a.pop();return r&&!i?(!p&&(d.from!=u.ch||d.line!=u.line)&&(v=a.pop()),n(v.line,v.from)):r&&i?n(v.line,v.to-1):!r&&i?(!p&&(d.to!=u.ch||d.line!=u.line)&&(v=a.pop()),n(v.line,v.to)):n(v.line,v.from)}function pt(e,t,r,i){var s=e.getCursor(),o=s.ch,u;for(var a=0;a<t;a++){var f=e.getLine(s.line);u=mt(o,f,i,r,!0);if(u==-1)return null;o=u}return n(e.getCursor().line,u)}function dt(e,t){var r=e.getCursor().line;return U(e,n(r,t-1))}function vt(e,t,n,r){if(!x(n,v))return;t.marks[n]&&t.marks[n].clear(),t.marks[n]=e.setBookmark(r)}function mt(e,t,n,r,i){var s;return r?(s=t.indexOf(n,e+1),s!=-1&&!i&&(s-=1)):(s=t.lastIndexOf(n,e-1),s!=-1&&!i&&(s+=1)),s}function gt(e){return e==="string"||e==="comment"?1:0}function yt(e,t,r){var i=t.line,s=t.ch;r=r?r:e.getLine(i).charAt(s);var o=e.getTokenAt(n(i,s+1)).type,u=gt(o),a={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{"}[r];if(!a)return t;var f={"(":1,"{":1,"[":1}[r]||-1,l=f===1?e.lineCount():-1,c=1,h=r,p=s,d=e.getLine(i);while(i!==l&&c>0){p+=f,h=d.charAt(p);if(!h){i+=f,d=e.getLine(i)||"";if(f>0)p=0;else{var v=d.length;p=v>0?v-1:0}h=d.charAt(p)}var m=e.getTokenAt(n(i,p+1)).type,g=gt(m);u>=g&&(h===r?c++:h===a&&c--)}return h?n(i,p):t}function bt(e,t,n){var r=$(e.getCursor()),i=yt(e,r,t),s=yt(e,i);if(s.line==i.line&&s.ch>i.ch||s.line>i.line){var o=s;s=i,i=o}return n?i.ch+=1:s.ch+=1,{start:s,end:i}}function wt(e,t,r){var i=$(e.getCursor()),s=e.getLine(i.line),o=s.split(""),u,a,f,l,c=o.indexOf(t);i.ch<c?i.ch=c:c<i.ch&&o[i.ch]==t&&(a=i.ch,--i.ch);if(o[i.ch]==t&&!a)u=i.ch+1;else for(f=i.ch;f>-1&&!u;f--)o[f]==t&&(u=f+1);if(u&&!a)for(f=u,l=o.length;f<l&&!a;f++)o[f]==t&&(a=f);return!u||!a?{start:i,end:i}:(r&&(--u,++a),{start:n(i.line,u),end:n(i.line,a)})}function Et(){}function St(e){var t=e.state.vim;return t.searchState_||(t.searchState_=new Et)}function xt(e,t,n,r,i){e.openDialog?e.openDialog(t,r,{bottom:!0,value:i.value,onKeyDown:i.onKeyDown,onKeyUp:i.onKeyUp}):r(prompt(n,""))}function Tt(e){var t=!1,n=[];for(var r=0;r<e.length;r++){var i=e.charAt(r);!t&&i=="/"&&n.push(r),t=!t&&i=="\\"}return n}function Nt(e){var t=["|","(",")","{"],n=["}"],r=!1,i=[];for(var s=-1;s<e.length;s++){var o=e.charAt(s)||"",u=e.charAt(s+1)||"",a=t.indexOf(u)!=-1;r?((o!=="\\"||!a)&&i.push(o),r=!1):o==="\\"?(r=!0,n.indexOf(u)!=-1&&(a=!0),(!a||u==="\\")&&i.push(o)):(i.push(o),a&&u!=="\\"&&i.push("\\"))}return i.join("")}function Ct(e){var t=!1,n=[];for(var r=-1;r<e.length;r++){var i=e.charAt(r)||"",s=e.charAt(r+1)||"";t?(n.push(i),t=!1):i==="\\"?(t=!0,w(s)||s==="$"?n.push("$"):s!=="/"&&s!=="\\"&&n.push("\\")):(i==="$"&&n.push("$"),n.push(i),s==="/"&&n.push("\\"))}return n.join("")}function kt(t){var n=new e.StringStream(t),r=[];while(!n.eol()){while(n.peek()&&n.peek()!="\\")r.push(n.next());n.match("\\/",!0)?r.push("/"):n.match("\\\\",!0)?r.push("\\"):r.push(n.next())}return r.join("")}function Lt(e,t,n){if(e instanceof RegExp)return e;var r=Tt(e),i,s;if(!r.length)i=e;else{i=e.substring(0,r[0]);var o=e.substring(r[0]);s=o.indexOf("i")!=-1}if(!i)return null;k("pcre")||(i=Nt(i)),n&&(t=/^[^A-Z]*$/.test(i));var u=new RegExp(i,t||s?"i":undefined);return u}function At(e,t){e.openNotification?e.openNotification('<span style="color: red">'+t+"</span>",{bottom:!0,duration:5e3}):alert(t)}function Ot(e,t){var n="";return e&&(n+='<span style="font-family: monospace">'+e+"</span>"),n+='<input type="text"/> <span style="color: #888">',t&&(n+='<span style="color: #888">',n+=t,n+="</span>"),n}function _t(e,t){var n=(t.prefix||"")+" "+(t.desc||""),r=Ot(t.prefix,t.desc);xt(e,r,n,t.onClose,t)}function Dt(e,t){if(e instanceof RegExp&&t instanceof RegExp){var n=["global","multiline","ignoreCase","source"];for(var r=0;r<n.length;r++){var i=n[r];if(e[i]!==t[i])return!1}return!0}return!1}function Pt(e,t,n,r){if(!t)return;var i=St(e),s=Lt(t,!!n,!!r);if(!s)return;return Bt(e,s),Dt(s,i.getQuery())?s:(i.setQuery(s),s)}function Ht(e){if(e.source.charAt(0)=="^")var t=!0;return{token:function(n){if(t&&!n.sol()){n.skipToEnd();return}var r=n.match(e,!1);if(r){if(r[0].length==0)return n.next(),"searching";if(!n.sol()){n.backUp(1);if(!e.exec(n.next()+r[0]))return n.next(),null}return n.match(e),"searching"}while(!n.eol()){n.next();if(n.match(e,!1))break}},query:e}}function Bt(e,t){var n=St(e).getOverlay();if(!n||t!=n.query)n&&e.removeOverlay(n),n=Ht(t),e.addOverlay(n),St(e).setOverlay(n)}function jt(e,t,r,i){return i===undefined&&(i=1),e.operation(function(){var s=e.getCursor(),o=e.getSearchCursor(r,s);for(var u=0;u<i;u++){var a=o.find(t);u==0&&a&&J(o.from(),s)&&(a=o.find(t));if(!a){o=e.getSearchCursor(r,t?n(e.lastLine()):n(e.firstLine(),0));if(!o.find(t))return}}return o.from()})}function Ft(e){e.removeOverlay(St(e).getOverlay()),St(e).setOverlay(null)}function It(e,t,n){return typeof e!="number"&&(e=e.line),t instanceof Array?x(e,t):n?e>=t&&e<=n:e==t}function qt(e){var t=e.getScrollInfo(),n=6,r=10,i=e.coordsChar({left:0,top:n+t.top},"local"),s=t.clientHeight-r+t.top,o=e.coordsChar({left:0,top:s},"local");return{top:i.line,bottom:o.line}}function Ut(e){var t,n,r=[];while(e){n=/<\w+-.+?>|<\w+>|./.exec(e);if(n===null)break;t=n[0],e=e.substring(n.index+t.length),r.push(t)}return r}function Xt(t,n,r,i,s,o,u){function l(){t.operation(function(){while(!a)c(),h();p()})}function c(){var e=t.getRange(s.from(),s.to()),n=e.replace(o,u);s.replace(n)}function h(){var e=s.findNext();e?It(s.from(),r,i)?(t.scrollIntoView(s.from(),30),t.setSelection(s.from(),s.to()),f=s.from(),a=!1):a=!0:a=!0}function p(e){e&&e(),t.focus();if(f){t.setCursor(f);var n=t.state.vim;n.exMode=!1,n.lastHPos=n.lastHSPos=f.ch}}function d(n,r,i){e.e_stop(n);var s=e.keyName(n);switch(s){case"Y":c(),h();break;case"N":h();break;case"A":t.operation(l);break;case"L":c();case"Q":case"Esc":case"Ctrl-C":case"Ctrl-[":p(i)}a&&p(i)}t.state.vim.exMode=!0;var a=!1,f=s.from();h();if(a){At(t,"No matches for "+o.source);return}if(!n){l();return}_t(t,{prefix:"replace with <strong>"+u+"</strong> (y/n/a/q/l)",onKeyDown:d})}function Vt(){function t(e,t){var n=e;E(n)&&t=="Ctrl"&&(n=n.toLowerCase()),t&&(n=t.charAt(0)+"-"+n);var r={Enter:"CR",Backspace:"BS",Delete:"Del"}[n];return n=r?r:n,n=n.length>1?"<"+n+">":n,n}function n(t){return function(n){e.Vim.handleKey(n,t)}}function i(e,i){for(var s=0;s<e.length;s++){var o=e[s];!i&&o.length==1&&(o="'"+o+"'");var u=t(e[s],i),a=i?i+"-"+o:o;r[a]=n(u)}}var r={nofallthrough:!0,style:"fat-cursor"};return i(l),i(c),i(l,"Ctrl"),i(p),i(p,"Ctrl"),i(h),i(h,"Ctrl"),i(d),i(d,"Ctrl"),r}function $t(t){var n=t.state.vim,r=_.macroModeState,i=r.isPlaying;i||(t.off("change",Gt),t.off("cursorActivity",Yt),e.off(t.getInputField(),"keydown",en)),!i&&n.insertModeRepeat>1&&(tn(t,n,n.insertModeRepeat-1,!0),n.lastEditInputState.repeatOverride=n.insertModeRepeat),delete n.insertModeRepeat,t.setCursor(t.getCursor().line,t.getCursor().ch-1),n.insertMode=!1,t.setOption("keyMap","vim"),t.setOption("disableInput",!0),t.toggleOverwrite(!1),e.signal(t,"vim-mode-change",{mode:"normal"}),r.isRecording&&Qt(r)}function Jt(t,n,r,i){var s=_.registerController.getRegister(i),o=s.keyBuffer,u=0;r.isPlaying=!0;for(var a=0;a<o.length;a++){var f=o[a],l,c;while(f)l=/<\w+-.+?>|<\w+>|./.exec(f),c=l[0],f=f.substring(l.index+c.length),e.Vim.handleKey(t,c),n.insertMode&&(nn(t,s.insertModeChanges[u++].changes,1),$t(t))}r.isPlaying=!1}function Kt(e,t){if(e.isPlaying)return;var n=e.latestRegister,r=_.registerController.getRegister(n);r&&r.pushText(t)}function Qt(e){if(e.isPlaying)return;var t=e.latestRegister,n=_.registerController.getRegister(t);n&&n.pushInsertModeChanges(e.lastInsertModeChanges)}function Gt(e,t){var n=_.macroModeState,r=n.lastInsertModeChanges;if(!n.isPlaying)while(t){r.expectCursorActivityForChange=!0;if(t.origin=="+input"||t.origin=="paste"||t.origin===undefined){var i=t.text.join("\n");r.changes.push(i)}t=t.next}}function Yt(){var e=_.macroModeState;if(e.isPlaying)return;var t=e.lastInsertModeChanges;t.expectCursorActivityForChange?t.expectCursorActivityForChange=!1:t.changes=[]}function Zt(e){this.keyName=e}function en(t){function s(){return r.changes.push(new Zt(i)),!0}var n=_.macroModeState,r=n.lastInsertModeChanges,i=e.keyName(t);(i.indexOf("Delete")!=-1||i.indexOf("Backspace")!=-1)&&e.lookupKey(i,["vim-insert"],s)}function tn(e,t,n,r){function u(){s?F.processAction(e,t,t.lastEditActionCommand):F.evalInput(e,t)}function a(n){if(i.lastInsertModeChanges.changes.length>0){n=t.lastEditActionCommand?n:1;var r=i.lastInsertModeChanges;i.lastInsertModeChanges={},nn(e,r.changes,n),i.lastInsertModeChanges=r}}var i=_.macroModeState;i.isPlaying=!0;var s=!!t.lastEditActionCommand,o=t.inputState;t.inputState=t.lastEditInputState;if(s&&t.lastEditActionCommand.interlaceInsertRepeat)for(var f=0;f<n;f++)u(),a(1);else r||u(),a(n);t.inputState=o,t.insertMode&&!r&&$t(e),i.isPlaying=!1}function nn(t,n,r){function i(n){return typeof n=="string"?e.commands[n](t):n(t),!0}for(var s=0;s<r;s++)for(var o=0;o<n.length;o++){var u=n[o];if(u instanceof Zt)e.lookupKey(u.keyName,["vim-insert"],i);else{var a=t.getCursor();t.replaceRange(u,a,a)}}}e.defineOption("vimMode",!1,function(t,n){n?(t.setOption("keyMap","vim"),t.setOption("disableInput",!0),e.signal(t,"vim-mode-change",{mode:"normal"}),t.on("beforeSelectionChange",i),M(t),e.on(t.getInputField(),"paste",s(t))):t.state.vim&&(t.setOption("keyMap","default"),t.setOption("disableInput",!1),t.off("beforeSelectionChange",i),e.off(t.getInputField(),"paste",s(t)),t.state.vim=null)});var o=/[\d]/,u=[/\w/,/[^\w\s]/],a=[/\S/],l=f(65,26),c=f(97,26),h=f(48,10),p="~`!@#$%^&*()_-+=[{}]\\|/?.,<>:;\"'".split(""),d=["Left","Right","Up","Down","Space","Backspace","Esc","Home","End","PageUp","PageDown","Enter"],v=[].concat(l,c,h,["<",">"]),m=[].concat(l,c,h,["-",'"']),T={},L=function(){function s(s,o,u){function l(n){var r=++t%e,o=i[r];o&&o.clear(),i[r]=s.setBookmark(n)}var a=t%e,f=i[a];if(f){var c=f.find();c&&!J(c,o)&&l(o)}else l(o);l(u),n=t,r=t-e+1,r<0&&(r=0)}function o(s,o){t+=o,t>n?t=n:t<r&&(t=r);var u=i[(e+t)%e];if(u&&!u.find()){var a=o>0?1:-1,f,l=s.getCursor();do{t+=a,u=i[(e+t)%e];if(u&&(f=u.find())&&!J(l,f))break}while(t<n&&t>r)}return u}var e=100,t=-1,n=0,r=0,i=new Array(e);return{cachedCursor:undefined,add:s,move:o}},A=function(e){return e?{changes:e.changes,expectCursorActivityForChange:e.expectCursorActivityForChange}:{changes:[],expectCursorActivityForChange:!1}};O.prototype={exitMacroRecordMode:function(){var e=_.macroModeState;e.onRecordingDone(),e.onRecordingDone=undefined,e.isRecording=!1},enterMacroRecordMode:function(e,t){var n=_.registerController.getRegister(t);n&&(n.clear(),this.latestRegister=t,this.onRecordingDone=e.openDialog("(recording)["+t+"]",null,{bottom:!0}),this.isRecording=!0)}};var _,P={buildKeyMap:function(){},getRegisterController:function(){return _.registerController},resetVimGlobalState_:D,getVimGlobalState_:function(){return _},maybeInitVimState_:M,InsertModeKey:Zt,map:function(e,t,n){Wt.map(e,t,n)},setOption:C,getOption:k,defineOption:N,defineEx:function(e,t,n){if(e.indexOf(t)!==0)throw new Error('(Vim.defineEx) "'+t+'" is not a prefix of "'+e+'", command not registered');zt[e]=n,Wt.commandMap_[t]={name:e,shortName:t,type:"api"}},handleKey:function(n,r){var i,s=M(n),o=_.macroModeState;if(o.isRecording&&r=="q"){o.exitMacroRecordMode(),s.inputState=new H;return}if(r=="<Esc>"){s.inputState=new H,s.visualMode&&tt(n);return}!s.visualMode&&!J(n.getCursor("head"),n.getCursor("anchor"))&&(s.visualMode=!0,s.visualLine=!1,e.signal(n,"vim-mode-change",{mode:"visual"}),n.on("mousedown",tt));if(r!="0"||r=="0"&&s.inputState.getRepeat()===0)i=F.matchCommand(r,t,s);if(!i){w(r)&&s.inputState.pushRepeatDigit(r),o.isRecording&&Kt(o,r);return}if(i.type=="keyToKey")for(var u=0;u<i.toKeys.length;u++)this.handleKey(n,i.toKeys[u]);else o.isRecording&&Kt(o,r),F.processCommand(n,s,i)},handleEx:function(e,t){Wt.processCommand(e,t)}};H.prototype.pushRepeatDigit=function(e){this.operator?this.motionRepeat=this.motionRepeat.concat(e):this.prefixRepeat=this.prefixRepeat.concat(e)},H.prototype.getRepeat=function(){var e=0;if(this.prefixRepeat.length>0||this.motionRepeat.length>0)e=1,this.prefixRepeat.length>0&&(e*=parseInt(this.prefixRepeat.join(""),10)),this.motionRepeat.length>0&&(e*=parseInt(this.motionRepeat.join(""),10));return e},B.prototype={setText:function(e,t){this.keyBuffer=[e||""],this.linewise=!!t},pushText:function(e,t){if(t||this.linewise)this.keyBuffer.push("\n"),this.linewise=!0;this.keyBuffer.push(e)},pushInsertModeChanges:function(e){this.insertModeChanges.push(A(e))},clear:function(){this.keyBuffer=[],this.insertModeChanges=[],this.linewise=!1},toString:function(){return this.keyBuffer.join("")}},j.prototype={pushText:function(e,t,n,r){r&&n.charAt(0)=="\n"&&(n=n.slice(1)+"\n"),r&&n.charAt(n.length-1)!=="\n"&&(n+="\n");var i=this.isValidRegister(e)?this.getRegister(e):null;if(!i){switch(t){case"yank":this.registers[0]=new B(n,r);break;case"delete":case"change":n.indexOf("\n")==-1?this.registers["-"]=new B(n,r):(this.shiftNumericRegisters_(),this.registers[1]=new B(n,r))}this.unnamedRegister.setText(n,r);return}var s=E(e);s?(i.append(n,r),this.unnamedRegister.append(n,r)):(i.setText(n,r),this.unnamedRegister.setText(n,r))},getRegister:function(e){return this.isValidRegister(e)?(e=e.toLowerCase(),this.registers[e]||(this.registers[e]=new B),this.registers[e]):this.unnamedRegister},isValidRegister:function(e){return e&&x(e,m)},shiftNumericRegisters_:function(){for(var e=9;e>=2;e--)this.registers[e]=this.getRegister(""+(e-1))}};var F={matchCommand:function(e,t,n){function f(t){return i.length<t.keys.length?(r.keyBuffer.push(e),null):(t.keys[i.length-1]=="character"&&(r.selectedCharacter=o),r.keyBuffer=[],t)}var r=n.inputState,i=r.keyBuffer.concat(e),s=[],o;for(var u=0;u<t.length;u++){var a=t[u];if(X(i,a.keys)){if(r.operator&&a.type=="action")continue;if(a.keys[i.length-1]=="character"){o=i[i.length-1];if(o.length>1)switch(o){case"<CR>":o="\n";break;case"<Space>":o=" ";break;default:continue}}s.push(a)}}if(!s.length)return r.keyBuffer=[],null;if(s.length==1)return f(s[0]);var l=n.visualMode?"visual":"normal",c;for(var u=0;u<s.length;u++){var h=s[u];if(h.context==l){c=h;break}!c&&!h.context&&(c=h)}return f(c)},processCommand:function(e,t,n){t.inputState.repeatOverride=n.repeatOverride;switch(n.type){case"motion":this.processMotion(e,t,n);break;case"operator":this.processOperator(e,t,n);break;case"operatorMotion":this.processOperatorMotion(e,t,n);break;case"action":this.processAction(e,t,n);break;case"search":this.processSearch(e,t,n);break;case"ex":case"keyToEx":this.processEx(e,t,n);break;default:}},processMotion:function(e,t,n){t.inputState.motion=n.motion,t.inputState.motionArgs=z(n.motionArgs),this.evalInput(e,t)},processOperator:function(e,t,n){var r=t.inputState;if(r.operator){if(r.operator==n.operator){r.motion="expandToLine",r.motionArgs={linewise:!0},this.evalInput(e
,t);return}t.inputState=new H}r.operator=n.operator,r.operatorArgs=z(n.operatorArgs),t.visualMode&&this.evalInput(e,t)},processOperatorMotion:function(e,t,n){var r=t.visualMode,i=z(n.operatorMotionArgs);i&&r&&i.visualLine&&(t.visualLine=!0),this.processOperator(e,t,n),r||this.processMotion(e,t,n)},processAction:function(e,t,n){var r=t.inputState,i=r.getRepeat(),s=!!i,o=z(n.actionArgs)||{};r.selectedCharacter&&(o.selectedCharacter=r.selectedCharacter),n.operator&&this.processOperator(e,t,n),n.motion&&this.processMotion(e,t,n),(n.motion||n.operator)&&this.evalInput(e,t),o.repeat=i||1,o.repeatIsExplicit=s,o.registerName=r.registerName,t.inputState=new H,t.lastMotion=null,n.isEdit&&this.recordLastEdit(t,r,n),R[n.action](e,o,t)},processSearch:function(t,n,r){function a(e,i,s){try{Pt(t,e,i,s)}catch(o){At(t,"Invalid regex: "+e);return}F.processMotion(t,n,{type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:r.searchArgs.toJumplist}})}function f(e){t.scrollTo(u.left,u.top),a(e,!0,!0)}function l(e,n){var r;try{r=Pt(t,n,!0,!0)}catch(s){}r?t.scrollIntoView(jt(t,!i,r),30):(Ft(t),t.scrollTo(u.left,u.top))}function c(n,r,i){var s=e.keyName(n);if(s=="Esc"||s=="Ctrl-C"||s=="Ctrl-[")Pt(t,o),Ft(t),t.scrollTo(u.left,u.top),e.e_stop(n),i(),t.focus()}if(!t.getSearchCursor)return;var i=r.searchArgs.forward;St(t).setReversed(!i);var s=i?"/":"?",o=St(t).getQuery(),u=t.getScrollInfo();switch(r.searchArgs.querySrc){case"prompt":_t(t,{onClose:f,prefix:s,desc:Mt,onKeyUp:l,onKeyDown:c});break;case"wordUnderCursor":var h=st(t,!1,!0,!1,!0),p=!0;h||(h=st(t,!1,!0,!1,!1),p=!1);if(!h)return;var d=t.getLine(h.start.line).substring(h.start.ch,h.end.ch);p?d="\\b"+d+"\\b":d=et(d),_.jumpList.cachedCursor=t.getCursor(),t.setCursor(h.start),a(d,!0,!1)}},processEx:function(t,n,r){function i(e){Wt.processCommand(t,e)}function s(n,r,i){var s=e.keyName(n);if(s=="Esc"||s=="Ctrl-C"||s=="Ctrl-[")e.e_stop(n),i(),t.focus()}r.type=="keyToEx"?Wt.processCommand(t,r.exArgs.input):n.visualMode?_t(t,{onClose:i,prefix:":",value:"'<,'>",onKeyDown:s}):_t(t,{onClose:i,prefix:":",onKeyDown:s})},evalInput:function(e,t){var r=t.inputState,i=r.motion,s=r.motionArgs||{},o=r.operator,u=r.operatorArgs||{},a=r.registerName,f=$(e.getCursor("head")),l=$(e.getCursor("anchor")),c=$(f),h=$(c),p,d;o&&this.recordLastEdit(t,r),r.repeatOverride!==undefined?d=r.repeatOverride:d=r.getRepeat();if(d>0&&s.explicitRepeat)s.repeatIsExplicit=!0;else if(s.noRepeat||!s.explicitRepeat&&d===0)d=1,s.repeatIsExplicit=!1;r.selectedCharacter&&(s.selectedCharacter=u.selectedCharacter=r.selectedCharacter),s.repeat=d,t.inputState=new H;if(i){var v=I[i](e,s,t);t.lastMotion=I[i];if(!v)return;if(s.toJumplist){var m=_.jumpList,g=m.cachedCursor;g?(ot(e,g,v),delete m.cachedCursor):ot(e,h,v)}v instanceof Array?(c=v[0],p=v[1]):p=v,p||(p=n(c.line,c.ch));if(t.visualMode){K(l,f)&&(J(l,p)||K(p,l))?l.ch+=1:K(f,l)&&(J(l,p)||K(l,p))&&(l.ch-=1),f=p,l=v instanceof Array?c:l;if(t.visualLine)if(K(l,f)){l.ch=0;var y=e.lastLine();f.line>y&&(f.line=y),f.ch=G(e,f.line)}else f.ch=0,l.ch=G(e,l.line);e.setSelection(l,f),vt(e,t,"<",K(l,f)?l:f),vt(e,t,">",K(l,f)?f:l)}else o||(p=U(e,p),e.setCursor(p.line,p.ch))}if(o){var b=!1;t.lastMotion=null,u.repeat=d,t.visualMode&&(c=l,p=f,s.inclusive=!0);if(K(p,c)){var w=c;c=p,p=w,b=!0}s.inclusive&&(!t.visualMode||!b)&&p.ch++;var E=s.linewise||t.visualMode&&t.visualLine;E?rt(e,c,p):s.forward&&nt(e,c,p),u.registerName=a,u.linewise=E,q[o](e,u,t,c,p,h),t.visualMode&&tt(e)}},recordLastEdit:function(e,t,n){var r=_.macroModeState;if(r.isPlaying)return;e.lastEditInputState=t,e.lastEditActionCommand=n,r.lastInsertModeChanges.changes=[],r.lastInsertModeChanges.expectCursorActivityForChange=!1}},I={moveToTopLine:function(e,t){var r=qt(e).top+t.repeat-1;return n(r,it(e.getLine(r)))},moveToMiddleLine:function(e){var t=qt(e),r=Math.floor((t.top+t.bottom)*.5);return n(r,it(e.getLine(r)))},moveToBottomLine:function(e,t){var r=qt(e).bottom-t.repeat+1;return n(r,it(e.getLine(r)))},expandToLine:function(e,t){var r=e.getCursor();return n(r.line+t.repeat-1,Infinity)},findNext:function(e,t){var n=St(e),r=n.getQuery();if(!r)return;var i=!t.forward;return i=n.isReversed()?!i:i,Bt(e,r),jt(e,i,r,t.repeat)},goToMark:function(e,t,n){var r=n.marks[t.selectedCharacter];return r?r.find():null},moveToOtherHighlightedEnd:function(e){var t=$(e.getCursor("head")),n=$(e.getCursor("anchor"));return K(n,t)?t.ch+=1:K(t,n)&&(n.ch-=1),[t,n]},jumpToMark:function(e,t,r){var i=e.getCursor();for(var s=0;s<t.repeat;s++){var o=i;for(var u in r.marks){if(!y(u))continue;var a=r.marks[u].find(),f=t.forward?K(a,o):K(o,a);if(f)continue;if(t.linewise&&a.line==o.line)continue;var l=J(o,i),c=t.forward?Q(o,a,i):Q(i,a,o);if(l||c)i=a}}return t.linewise&&(i=n(i.line,it(e.getLine(i.line)))),i},moveByCharacters:function(e,t){var r=e.getCursor(),i=t.repeat,s=t.forward?r.ch+i:r.ch-i;return n(r.line,s)},moveByLines:function(e,t,r){var i=e.getCursor(),s=i.ch;switch(r.lastMotion){case this.moveByLines:case this.moveByDisplayLines:case this.moveByScroll:case this.moveToColumn:case this.moveToEol:s=r.lastHPos;break;default:r.lastHPos=s}var o=t.repeat+(t.repeatOffset||0),u=t.forward?i.line+o:i.line-o,a=e.firstLine(),f=e.lastLine();if(u<a&&i.line==a||u>f&&i.line==f)return;return t.toFirstChar&&(s=it(e.getLine(u)),r.lastHPos=s),r.lastHSPos=e.charCoords(n(u,s),"div").left,n(u,s)},moveByDisplayLines:function(e,t,r){var i=e.getCursor();switch(r.lastMotion){case this.moveByDisplayLines:case this.moveByScroll:case this.moveByLines:case this.moveToColumn:case this.moveToEol:break;default:r.lastHSPos=e.charCoords(i,"div").left}var s=t.repeat,o=e.findPosV(i,t.forward?s:-s,"line",r.lastHSPos);if(o.hitSide)if(t.forward)var u=e.charCoords(o,"div"),a={top:u.top+8,left:r.lastHSPos},o=e.coordsChar(a,"div");else{var f=e.charCoords(n(e.firstLine(),0),"div");f.left=r.lastHSPos,o=e.coordsChar(f,"div")}return r.lastHPos=o.ch,o},moveByPage:function(e,t){var n=e.getCursor(),r=t.repeat;e.moveV(t.forward?r:-r,"page");var i=e.getCursor();return e.setCursor(n),i},moveByParagraph:function(e,t){var r=e.getCursor().line,i=t.repeat,s=t.forward?1:-1;for(var o=0;o<i;o++){if(!t.forward&&r===e.firstLine()||t.forward&&r==e.lastLine())break;r+=s;while(r!==e.firstLine()&&r!=e.lastLine()&&e.getLine(r))r+=s}return n(r,0)},moveByScroll:function(e,t,n){var r=e.getScrollInfo(),i=null,s=t.repeat;s||(s=r.clientHeight/(2*e.defaultTextHeight()));var o=e.charCoords(e.getCursor(),"local");t.repeat=s;var i=I.moveByDisplayLines(e,t,n);if(!i)return null;var u=e.charCoords(i,"local");return e.scrollTo(null,r.top+u.top-o.top),i},moveByWords:function(e,t){return ht(e,t.repeat,!!t.forward,!!t.wordEnd,!!t.bigWord)},moveTillCharacter:function(e,t){var n=t.repeat,r=pt(e,n,t.forward,t.selectedCharacter),i=t.forward?-1:1;return ut(i,t),r?(r.ch+=i,r):null},moveToCharacter:function(e,t){var n=t.repeat;return ut(0,t),pt(e,n,t.forward,t.selectedCharacter)||e.getCursor()},moveToSymbol:function(e,t){var n=t.repeat;return lt(e,n,t.forward,t.selectedCharacter)||e.getCursor()},moveToColumn:function(e,t,n){var r=t.repeat;return n.lastHPos=r-1,n.lastHSPos=e.charCoords(e.getCursor(),"div").left,dt(e,r)},moveToEol:function(e,t,r){var i=e.getCursor();r.lastHPos=Infinity;var s=n(i.line+t.repeat-1,Infinity),o=e.clipPos(s);return o.ch--,r.lastHSPos=e.charCoords(o,"div").left,s},moveToFirstNonWhiteSpaceCharacter:function(e){var t=e.getCursor();return n(t.line,it(e.getLine(t.line)))},moveToMatchedSymbol:function(e){var t=e.getCursor(),r=t.line,i=t.ch,s=e.getLine(r),o,u=e.getTokenAt(t).type,a=gt(u);do{o=s.charAt(i++);if(o&&b(o)){var f=e.getTokenAt(n(r,i)).type,l=gt(f);if(a>=l)break}}while(o);return o?yt(e,n(r,i-1),o):t},moveToStartOfLine:function(e){var t=e.getCursor();return n(t.line,0)},moveToLineOrEdgeOfDocument:function(e,t){var r=t.forward?e.lastLine():e.firstLine();return t.repeatIsExplicit&&(r=t.repeat-e.getOption("firstLineNumber")),n(r,it(e.getLine(r)))},textObjectManipulation:function(e,t){var n={"(":")",")":"(","{":"}","}":"{","[":"]","]":"["},r={"'":!0,'"':!0},i=t.selectedCharacter,s=!t.textObjectInner,o;if(n[i])o=bt(e,n[i],s);else if(r[i])o=wt(e,i,s);else if(i==="W")o=st(e,s,!0,!0);else{if(i!=="w")return null;o=st(e,s,!0,!1)}return[o.start,o.end]},repeatLastCharacterSearch:function(e,t){var n=_.lastChararacterSearch,r=t.repeat,i=t.forward===n.forward,s=(n.increment?1:0)*(i?-1:1);e.moveH(-s,"char"),t.inclusive=i?!0:!1;var o=pt(e,r,i,n.selectedCharacter);return o?(o.ch+=s,o):(e.moveH(s,"char"),e.getCursor())}},q={change:function(e,t,n,r,i){_.registerController.pushText(t.registerName,"change",e.getRange(r,i),t.linewise);if(t.linewise){var s=i.line>e.lastLine()?"":"\n";e.replaceRange(s,r,i),e.indentLine(r.line,"smart"),r.ch=null}else{var o=e.getRange(r,i);if(!S(o)){var u=/\s+$/.exec(o);u&&(i=W(i,0,-u[0].length))}e.replaceRange("",r,i)}R.enterInsertMode(e,{},e.state.vim),e.setCursor(r)},"delete":function(e,t,n,r,i){t.linewise&&i.line>e.lastLine()&&r.line>e.firstLine()&&(r.line--,r.ch=G(e,r.line)),_.registerController.pushText(t.registerName,"delete",e.getRange(r,i),t.linewise),e.replaceRange("",r,i),t.linewise?e.setCursor(I.moveToFirstNonWhiteSpaceCharacter(e)):e.setCursor(r)},indent:function(e,t,n,r,i){var s=r.line,o=i.line,u=n.visualMode?t.repeat:1;t.linewise&&o--;for(var a=s;a<=o;a++)for(var f=0;f<u;f++)e.indentLine(a,t.indentRight);e.setCursor(r),e.setCursor(I.moveToFirstNonWhiteSpaceCharacter(e))},swapcase:function(e,t,n,r,i,s){var o=e.getRange(r,i),u="";for(var a=0;a<o.length;a++){var f=o.charAt(a);u+=E(f)?f.toLowerCase():f.toUpperCase()}e.replaceRange(u,r,i),t.shouldMoveCursor||e.setCursor(s)},yank:function(e,t,n,r,i,s){_.registerController.pushText(t.registerName,"yank",e.getRange(r,i),t.linewise),e.setCursor(s)}},R={jumpListWalk:function(e,t,n){if(n.visualMode)return;var r=t.repeat,i=t.forward,s=_.jumpList,o=s.move(e,i?r:-r),u=o?o.find():undefined;u=u?u:e.getCursor(),e.setCursor(u)},scroll:function(e,t,n){if(n.visualMode)return;var r=t.repeat||1,i=e.defaultTextHeight(),s=e.getScrollInfo().top,o=i*r,u=t.forward?s+o:s-o,a=$(e.getCursor()),f=e.charCoords(a,"local");if(t.forward)u>f.top?(a.line+=(u-f.top)/i,a.line=Math.ceil(a.line),e.setCursor(a),f=e.charCoords(a,"local"),e.scrollTo(null,f.top)):e.scrollTo(null,u);else{var l=u+e.getScrollInfo().clientHeight;l<f.bottom?(a.line-=(f.bottom-l)/i,a.line=Math.floor(a.line),e.setCursor(a),f=e.charCoords(a,"local"),e.scrollTo(null,f.bottom-e.getScrollInfo().clientHeight)):e.scrollTo(null,u)}},scrollToCursor:function(e,t){var r=e.getCursor().line,i=e.charCoords(n(r,0),"local"),s=e.getScrollInfo().clientHeight,o=i.top,u=i.bottom-o;switch(t.position){case"center":o=o-s/2+u;break;case"bottom":o=o-s+u*1.4;break;case"top":o+=u*.4}e.scrollTo(null,o)},replayMacro:function(e,t,n){var r=t.selectedCharacter,i=t.repeat,s=_.macroModeState;r=="@"&&(r=s.latestRegister);while(i--)Jt(e,n,s,r)},enterMacroRecordMode:function(e,t){var n=_.macroModeState,r=t.selectedCharacter;n.enterMacroRecordMode(e,r)},enterInsertMode:function(t,r,i){if(t.getOption("readOnly"))return;i.insertMode=!0,i.insertModeRepeat=r&&r.repeat||1;var s=r?r.insertAt:null;if(s=="eol"){var o=t.getCursor();o=n(o.line,G(t,o.line)),t.setCursor(o)}else s=="charAfter"?t.setCursor(W(t.getCursor(),0,1)):s=="firstNonBlank"&&t.setCursor(I.moveToFirstNonWhiteSpaceCharacter(t));t.setOption("keyMap","vim-insert"),t.setOption("disableInput",!1),r&&r.replace?(t.toggleOverwrite(!0),t.setOption("keyMap","vim-replace"),e.signal(t,"vim-mode-change",{mode:"replace"})):(t.setOption("keyMap","vim-insert"),e.signal(t,"vim-mode-change",{mode:"insert"})),_.macroModeState.isPlaying||(t.on("change",Gt),t.on("cursorActivity",Yt),e.on(t.getInputField(),"keydown",en))},toggleVisualMode:function(t,r,i){var s=r.repeat,o=t.getCursor(),u;i.visualMode?(o=t.getCursor("anchor"),u=t.getCursor("head"),!i.visualLine&&r.linewise?(i.visualLine=!0,o.ch=K(o,u)?0:G(t,o.line),u.ch=K(o,u)?G(t,u.line):0,t.setSelection(o,u),e.signal(t,"vim-mode-change",{mode:"visual",subMode:"linewise"})):i.visualLine&&!r.linewise?(i.visualLine=!1,e.signal(t,"vim-mode-change",{mode:"visual"})):tt(t)):(t.on("mousedown",tt),i.visualMode=!0,i.visualLine=!!r.linewise,i.visualLine?(o.ch=0,u=U(t,n(o.line+s-1,G(t,o.line)),!0)):u=U(t,n(o.line,o.ch+s),!0),!r.repeatIsExplicit&&!i.visualLine?(t.setCursor(u),t.setSelection(u,o)):t.setSelection(o,u),e.signal(t,"vim-mode-change",{mode:"visual",subMode:i.visualLine?"linewise":""})),vt(t,i,"<",K(o,u)?o:u),vt(t,i,">",K(o,u)?u:o)},reselectLastSelection:function(t,n,r){if(r.lastSelection){var i=r.lastSelection;t.setSelection(i.curStart,i.curEnd),i.visualLine?(r.visualMode=!0,r.visualLine=!0):(r.visualMode=!0,r.visualLine=!1),e.signal(t,"vim-mode-change",{mode:"visual",subMode:r.visualLine?"linewise":""})}},joinLines:function(e,t,r){var i,s;if(r.visualMode)i=e.getCursor("anchor"),s=e.getCursor("head"),s.ch=G(e,s.line)-1;else{var o=Math.max(t.repeat,2);i=e.getCursor(),s=U(e,n(i.line+o-1,Infinity))}var u=0;e.operation(function(){for(var t=i.line;t<s.line;t++){u=G(e,i.line);var r=n(i.line+1,G(e,i.line+1)),o=e.getRange(i,r);o=o.replace(/\n\s*/g," "),e.replaceRange(o,i,r)}var a=n(i.line,u);e.setCursor(a)})},newLineAndEnterInsertMode:function(t,r,i){i.insertMode=!0;var s=$(t.getCursor());if(s.line===t.firstLine()&&!r.after)t.replaceRange("\n",n(t.firstLine(),0)),t.setCursor(t.firstLine(),0);else{s.line=r.after?s.line:s.line-1,s.ch=G(t,s.line),t.setCursor(s);var o=e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent;o(t)}this.enterInsertMode(t,{repeat:r.repeat},i)},paste:function(e,t){var r=$(e.getCursor()),i=_.registerController.getRegister(t.registerName),s=i.toString();if(!s)return;if(t.repeat>1)var s=Array(t.repeat+1).join(s);var o=i.linewise;o?t.after?(s="\n"+s.slice(0,s.length-1),r.ch=G(e,r.line)):r.ch=0:r.ch+=t.after?1:0,e.replaceRange(s,r);var u,a;o&&t.after?u=n(r.line+1,it(e.getLine(r.line+1))):o&&!t.after?u=n(r.line,it(e.getLine(r.line))):!o&&t.after?(a=e.indexFromPos(r),u=e.posFromIndex(a+s.length-1)):(a=e.indexFromPos(r),u=e.posFromIndex(a+s.length)),e.setCursor(u)},undo:function(t,n){t.operation(function(){V(t,e.commands.undo,n.repeat)(),t.setCursor(t.getCursor("anchor"))})},redo:function(t,n){V(t,e.commands.redo,n.repeat)()},setRegister:function(e,t,n){n.inputState.registerName=t.selectedCharacter},setMark:function(e,t,n){var r=t.selectedCharacter;vt(e,n,r,e.getCursor())},replace:function(t,r,i){var s=r.selectedCharacter,o=t.getCursor(),u,a;if(i.visualMode)o=t.getCursor("start"),a=t.getCursor("end"),a=t.clipPos(n(a.line,a.ch+1));else{var f=t.getLine(o.line);u=o.ch+r.repeat,u>f.length&&(u=f.length),a=n(o.line,u)}if(s=="\n")i.visualMode||t.replaceRange("",o,a),(e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent)(t);else{var l=t.getRange(o,a);l=l.replace(/[^\n]/g,s),t.replaceRange(l,o,a),i.visualMode?(t.setCursor(o),tt(t)):t.setCursor(W(a,0,-1))}},incrementNumberToken:function(e,t){var r=e.getCursor(),i=e.getLine(r.line),s=/-?\d+/g,o,u,a,f,l;while((o=s.exec(i))!==null){l=o[0],u=o.index,a=u+l.length;if(r.ch<a)break}if(!t.backtrack&&a<=r.ch)return;if(!l)return;var c=t.increase?1:-1,h=parseInt(l)+c*t.repeat,p=n(r.line,u),d=n(r.line,a);f=h.toString(),e.replaceRange(f,p,d),e.setCursor(n(r.line,u+f.length-1))},repeatLastEdit:function(e,t,n){var r=n.lastEditInputState;if(!r)return;var i=t.repeat;i&&t.repeatIsExplicit?n.lastEditInputState.repeatOverride=i:i=n.lastEditInputState.repeatOverride||i,tn(e,n,i,!1)}},at={"(":"bracket",")":"bracket","{":"bracket","}":"bracket","[":"section","]":"section","*":"comment","/":"comment",m:"method",M:"method","#":"preprocess"},ft={bracket:{isComplete:function(e){if(e.nextCh===e.symb){e.depth++;if(e.depth>=1)return!0}else e.nextCh===e.reverseSymb&&e.depth--;return!1}},section:{init:function(e){e.curMoveThrough=!0,e.symb=(e.forward?"]":"[")===e.symb?"{":"}"},isComplete:function(e){return e.index===0&&e.nextCh===e.symb}},comment:{isComplete:function(e){var t=e.lastCh==="*"&&e.nextCh==="/";return e.lastCh=e.nextCh,t}},method:{init:function(e){e.symb=e.symb==="m"?"{":"}",e.reverseSymb=e.symb==="{"?"}":"{"},isComplete:function(e){return e.nextCh===e.symb?!0:!1}},preprocess:{init:function(e){e.index=0},isComplete:function(e){if(e.nextCh==="#"){var t=e.lineText.match(/#(\w+)/)[1];if(t==="endif"){if(e.forward&&e.depth===0)return!0;e.depth++}else if(t==="if"){if(!e.forward&&e.depth===0)return!0;e.depth--}if(t==="else"&&e.depth===0)return!0}return!1}}};N("pcre",!0,"boolean"),Et.prototype={getQuery:function(){return _.query},setQuery:function(e){_.query=e},getOverlay:function(){return this.searchOverlay},setOverlay:function(e){this.searchOverlay=e},isReversed:function(){return _.isReversed},setReversed:function(e){_.isReversed=e}};var Mt="(Javascript regexp)",Rt=[{name:"map"},{name:"nmap",shortName:"nm"},{name:"vmap",shortName:"vm"},{name:"unmap"},{name:"write",shortName:"w"},{name:"undo",shortName:"u"},{name:"redo",shortName:"red"},{name:"set",shortName:"set"},{name:"sort",shortName:"sor"},{name:"substitute",shortName:"s"},{name:"nohlsearch",shortName:"noh"},{name:"delmarks",shortName:"delm"},{name:"registers",shortName:"reg"}];r.ExCommandDispatcher=function(){this.buildCommandMap_()},r.ExCommandDispatcher.prototype={processCommand:function(t,n){var r=t.state.vim;r.visualMode&&tt(t);var i=new e.StringStream(n),s={};s.input=n;try{this.parseInput_(t,i,s)}catch(o){throw At(t,o),o}var u;if(!s.commandName)s.line!==undefined&&(u="move");else{var a=this.matchCommand_(s.commandName);if(a){u=a.name,this.parseCommandArgs_(i,s,a);if(a.type=="exToKey"){for(var f=0;f<a.toKeys.length;f++)e.Vim.handleKey(t,a.toKeys[f]);return}if(a.type=="exToEx"){this.processCommand(t,a.toInput);return}}}if(!u){At(t,'Not an editor command ":'+n+'"');return}try{zt[u](t,s)}catch(o){throw At(t,o),o}},parseInput_:function(e,t,n){t.eatWhile(":"),t.eat("%")?(n.line=e.firstLine(),n.lineEnd=e.lastLine()):(n.line=this.parseLineSpec_(e,t),n.line!==undefined&&t.eat(",")&&(n.lineEnd=this.parseLineSpec_(e,t)));var r=t.match(/^(\w+)/);return r?n.commandName=r[1]:n.commandName=t.match(/.*/)[0],n},parseLineSpec_:function(e,t){var n=t.match(/^(\d+)/);if(n)return parseInt(n[1],10)-1;switch(t.next()){case".":return e.getCursor().line;case"$":return e.lastLine();case"'":var r=e.state.vim.marks[t.next()];if(r&&r.find())return r.find().line;throw new Error("Mark not set");default:return t.backUp(1),undefined}},parseCommandArgs_:function(e,t,n){if(e.eol())return;t.argString=e.match(/.*/)[0];var r=n.argDelimiter||/\s+/,i=Z(t.argString).split(r);i.length&&i[0]&&(t.args=i)},matchCommand_:function(e){for(var t=e.length;t>0;t--){var n=e.substring(0,t);if(this.commandMap_[n]){var r=this.commandMap_[n];if(r.name.indexOf(e)===0)return r}}return null},buildCommandMap_:function(){this.commandMap_={};for(var e=0;e<Rt.length;e++){var t=Rt[e],n=t.shortName||t.name;this.commandMap_[n]=t}},map:function(e,n,r){if(e!=":"&&e.charAt(0)==":"){if(r)throw Error("Mode not supported for ex mappings");var i=e.substring(1);n!=":"&&n.charAt(0)==":"?this.commandMap_[i]={name:i,type:"exToEx",toInput:n.substring(1),user:!0}:this.commandMap_[i]={name:i,type:"exToKey",toKeys:Ut(n),user:!0}}else if(n!=":"&&n.charAt(0)==":"){var s={keys:Ut(e),type:"keyToEx",exArgs:{input:n.substring(1)},user:!0};r&&(s.context=r),t.unshift(s)}else{var s={keys:Ut(e),type:"keyToKey",toKeys:Ut(n),user:!0};r&&(s.context=r),t.unshift(s)}},unmap:function(e,n){var r=function(e,t){if(e===t)return!0;if(e==null||t==null)return!0;if(e.length!=t.length)return!1;for(var n=0;n<e.length;n++)if(e[n]!==t[n])return!1;return!0};if(e!=":"&&e.charAt(0)==":"){if(n)throw Error("Mode not supported for ex mappings");var i=e.substring(1);if(this.commandMap_[i]&&this.commandMap_[i].user){delete this.commandMap_[i];return}}else{var s=Ut(e);for(var o=0;o<t.length;o++)if(r(s,t[o].keys)&&t[o].context===n&&t[o].user){t.splice(o,1);return}}throw Error("No such mapping.")}};var zt={map:function(e,t,n){var r=t.args;if(!r||r.length<2){e&&At(e,"Invalid mapping: "+t.input);return}Wt.map(r[0],r[1],n)},nmap:function(e,t){this.map(e,t,"normal")},vmap:function(e,t){this.map(e,t,"visual")},unmap:function(e,t,n){var r=t.args;if(!r||r.length<1){e&&At(e,"No such mapping: "+t.input);return}Wt.unmap(r[0],n)},move:function(e,t){F.processCommand(e,e.state.vim,{type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0},repeatOverride:t.line+1})},set:function(e,t){var n=t.args;if(!n||n.length<1){e&&At(e,"Invalid mapping: "+t.input);return}var r=n[0].split("="),i=r[0],s=r[1],o=!1;if(i.charAt(i.length-1)=="?"){if(s)throw Error("Trailing characters: "+t.argString);i=i.substring(0,i.length-1),o=!0}s===undefined&&i.substring(0,2)=="no"&&(i=i.substring(2),s=!1);var u=T[i]&&T[i].type=="boolean";u&&s==undefined&&(s=!0);if(!u&&!s||o){var a=k(i);a===!0||a===!1?At(e," "+(a?"":"no")+i):At(e,"  "+i+"="+a)}else C(i,s)},registers:function(e,t){var n=t.args,r=_.registerController.registers,i="----------Registers----------<br><br>";if(!n)for(var s in r){var o=r[s].toString();o.length&&(i+='"'+s+"    "+o+"<br>")}else{var s;n=n.join("");for(var u=0;u<n.length;u++){s=n.charAt(u);if(!_.registerController.isValidRegister(s))continue;var a=r[s]||new B;i+='"'+s+"    "+a.text+"<br>"}}At(e,i)},sort:function(t,r){function a(){if(r.argString){var t=new e.StringStream(r.argString);t.eat("!")&&(i=!0);if(t.eol())return;if(!t.eatSpace())return"Invalid arguments";var n=t.match(/[a-z]+/);if(n){n=n[0],s=n.indexOf("i")!=-1,o=n.indexOf("u")!=-1;var a=n.indexOf("d")!=-1&&1,f=n.indexOf("x")!=-1&&1,l=n.indexOf("o")!=-1&&1;if(a+f+l>1)return"Invalid arguments";u=a&&"decimal"||f&&"hex"||l&&"octal"}t.eatSpace()&&t.match(/\/.*\//)&&"patterns not supported"}}function w(e,t){if(i){var n;n=e,e=t,t=n}s&&(e=e.toLowerCase(),t=t.toLowerCase());var r=u&&v.exec(e),o=u&&v.exec(t);return r?(r=parseInt((r[1]+r[2]).toLowerCase(),m),o=parseInt((o[1]+o[2]).toLowerCase(),m),r-o):e<t?-1:1}var i,s,o,u,f=a();if(f){At(t,f+": "+r.argString);return}var l=r.line||t.firstLine(),c=r.lineEnd||r.line||t.lastLine();if(l==c)return;var h=n(l,0),p=n(c,G(t,c)),d=t.getRange(h,p).split("\n"),v=u=="decimal"?/(-?)([\d]+)/:u=="hex"?/(-?)(?:0x)?([0-9a-f]+)/i:u=="octal"?/([0-7]+)/:null,m=u=="decimal"?10:u=="hex"?16:u=="octal"?8:null,g=[],y=[];if(u)for(var b=0;b<d.length;b++)v.exec(d[b])?g.push(d[b]):y.push(d[b]);else y=d;g.sort(w),y.sort(w),d=i?g.concat(y):y.concat(g);if(o){var E=d,S;d=[];for(var b=0;b<E.length;b++)E[b]!=S&&d.push(E[b]),S=E[b]}t.replaceRange(d.join("\n"),h,p)},substitute:function(e,t){if(!e.getSearchCursor)throw new Error("Search feature not available. Requires searchcursor.js or any other getSearchCursor implementation.");var r=t.argString,i=Tt(r);if(i[0]!==0){At(e,"Substitutions should be of the form :s/pattern/replace/");return}var s=r.substring(i[0]+1,i[1]),o="",u,a,f=!1;i[1]&&(o=r.substring(i[1]+1,i[2]),k("pcre")?o=kt(o):o=Ct(o));if(i[2]){var l=r.substring(i[2]+1).split(" ");u=l[0],a=parseInt(l[1])}u&&(u.indexOf("c")!=-1&&(f=!0,u.replace("c","")),s=s+"/"+u);if(s)try{Pt(e,s,!0,!0)}catch(c){At(e,"Invalid regex: "+s);return}var h=St(e),p=h.getQuery(),d=t.line!==undefined?t.line:e.getCursor().line,v=t.lineEnd||d;a&&(d=v,v=d+a-1);var m=U(e,n(d,0)),g=e.getSearchCursor(p,m);Xt(e,f,d,v,g,p,o)},redo:e.commands.redo,undo:e.commands.undo,write:function(t){e.commands.save?e.commands.save(t):t.save()},nohlsearch:function(e){Ft(e)},delmarks:function(t,n){if(!n.argString||!Z(n.argString)){At(t,"Argument required");return}var r=t.state.vim,i=new e.StringStream(Z(n.argString));while(!i.eol()){i.eatSpace();var s=i.pos;if(!i.match(/[a-zA-Z]/,!1)){At(t,"Invalid argument: "+n.argString.substring(s));return}var o=i.next();if(i.match("-",!0)){if(!i.match(/[a-zA-Z]/,!1)){At(t,"Invalid argument: "+n.argString.substring(s));return}var u=o,a=i.next();if(!(y(u)&&y(a)||E(u)&&E(a))){At(t,"Invalid argument: "+u+"-");return}var f=u.charCodeAt(0),l=a.charCodeAt(0);if(f>=l){At(t,"Invalid argument: "+n.argString.substring(s));return}for(var c=0;c<=l-f;c++){var h=String.fromCharCode(f+c);delete r.marks[h]}}else delete r.marks[o]}}},Wt=new r.ExCommandDispatcher;return e.keyMap.vim=Vt(),e.keyMap["vim-insert"]={Esc:$t,"Ctrl-[":$t,"Ctrl-C":$t,"Ctrl-N":"autocomplete","Ctrl-P":"autocomplete",Enter:function(t){var n=e.commands.newlineAndIndentContinueComment||e.commands.newlineAndIndent;n(t)},fallthrough:["default"]},e.keyMap["vim-replace"]={Backspace:"goCharLeft",fallthrough:["vim-insert"]},D(),P};e.Vim=r()});