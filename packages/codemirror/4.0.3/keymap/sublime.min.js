// A rough approximation of Sublime Text's keybindings
// Depends on addon/search/searchcursor.js and optionally addon/dialog/dialogs.js
(function(e){typeof exports=="object"&&typeof module=="object"?e(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):typeof define=="function"&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],e):e(CodeMirror)})(function(e){"use strict";function s(t,n,i){if(i<0&&n.ch==0)return t.clipPos(r(n.line-1));var s=t.getLine(n.line);if(i>0&&n.ch>=s.length)return t.clipPos(r(n.line+1,0));var o="start",u;for(var a=n.ch,f=i<0?0:s.length,l=0;a!=f;a+=i,l++){var c=s.charAt(i<0?a-1:a),h=c!="_"&&e.isWordChar(c)?"w":"o";h=="w"&&c.toUpperCase()==c&&(h="W");if(o=="start")h!="o"&&(o="in",u=h);else if(o=="in"&&u!=h){u=="w"&&h=="W"&&i<0&&a--;if(u=="W"&&h=="w"&&i>0){u="w";continue}break}}return r(n.line,a)}function o(e,t){e.extendSelectionsBy(function(n){return e.display.shift||e.doc.extend||n.empty()?s(e.doc,n.head,t):t<0?n.from():n.to()})}function u(e,t){e.operation(function(){var n=e.listSelections().length,i=[],s=-1;for(var o=0;o<n;o++){var u=e.listSelections()[o].head;if(u.line<=s)continue;var a=r(u.line+(t?0:1),0);e.replaceRange("\n",a,null,"+insertLine"),e.indentLine(a.line,null,!0),i.push({head:a,anchor:a}),s=u.line+1}e.setSelections(i)})}function a(t,n){var i=n.ch,s=i,o=t.getLine(n.line);while(i&&e.isWordChar(o.charAt(i-1)))--i;while(s<o.length&&e.isWordChar(o.charAt(s)))++s;return{from:r(n.line,i),to:r(n.line,s),word:o.slice(i,s)}}function l(e){var t=e.getCursor(),n=e.scanForBracket(t,-1);if(!n)return;for(;;){var i=e.scanForBracket(t,1);if(!i)return;if(i.ch==f.charAt(f.indexOf(n.ch)+1))return e.setSelection(r(n.pos.line,n.pos.ch+1),i.pos,!1),!0;t=r(i.pos.line,i.pos.ch+1)}}function c(e,t){var n=e.listSelections(),i=[],s;for(var o=0;o<n.length;o++){var u=n[o];if(u.empty())continue;var a=u.from().line,f=u.to().line;while(o<n.length-1&&n[o+1].from().line==f)f=u[++o].to().line;i.push(a,f)}i.length?s=!0:i.push(e.firstLine(),e.lastLine()),e.operation(function(){var n=[];for(var o=0;o<i.length;o+=2){var u=i[o],a=i[o+1],f=r(u,0),l=r(a),c=e.getRange(f,l,!1);t?c.sort():c.sort(function(e,t){var n=e.toUpperCase(),r=t.toUpperCase();return n!=r&&(e=n,t=r),e<t?-1:e==t?0:1}),e.replaceRange(c,f,l),s&&n.push({anchor:f,head:l})}s&&e.setSelections(n,0)})}function p(t,n){t.operation(function(){var r=t.listSelections(),i=[],s=[];for(var o=0;o<r.length;o++){var u=r[o];u.empty()?(i.push(o),s.push("")):s.push(n(t.getRange(u.from(),u.to())))}t.replaceSelections(s,"around","case");for(var o=i.length-1,f;o>=0;o--){var u=r[i[o]];if(f&&e.cmpPos(u.head,f)>0)continue;var l=a(t,u.head);f=l.from,t.replaceRange(n(l.word),l.from,l.to)}})}function d(t,n){var i=t.getCursor("from"),s=t.getCursor("to");if(e.cmpPos(i,s)==0){var o=a(t,i);if(!o.word)return;i=o.from,s=o.to}var u=t.getRange(i,s),f=t.getSearchCursor(u,n?s:i);(n?f.findNext():f.findPrevious())?t.setSelection(f.from(),f.to()):(f=t.getSearchCursor(u,n?r(t.firstLine(),0):t.clipPos(r(t.lastLine()))),(n?f.findNext():f.findPrevious())?t.setSelection(f.from(),f.to()):o&&t.setSelection(i,s))}var t=e.keyMap.sublime={fallthrough:"default"},n=e.commands,r=e.Pos,i=e.keyMap["default"]==e.keyMap.pcDefault?"Ctrl-":"Cmd-";n[t["Alt-Left"]="goSubwordLeft"]=function(e){o(e,-1)},n[t["Alt-Right"]="goSubwordRight"]=function(e){o(e,1)},n[t[i+"Up"]="scrollLineUp"]=function(e){e.scrollTo(null,e.getScrollInfo().top-e.defaultTextHeight())},n[t[i+"Down"]="scrollLineDown"]=function(e){e.scrollTo(null,e.getScrollInfo().top+e.defaultTextHeight())},n[t["Shift-"+i+"L"]="splitSelectionByLine"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var s=t[i].from(),o=t[i].to();for(var u=s.line;u<=o.line;++u)o.line>s.line&&u==o.line&&o.ch==0||n.push({anchor:u==s.line?s:r(u,0),head:u==o.line?o:r(u)})}e.setSelections(n,0)},t["Shift-Tab"]="indentLess",n[t.Esc="singleSelectionTop"]=function(e){var t=e.listSelections()[0];e.setSelection(t.anchor,t.head,{scroll:!1})},n[t[i+"L"]="selectLine"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var s=t[i];n.push({anchor:r(s.from().line,0),head:r(s.to().line+1,0)})}e.setSelections(n)},t["Shift-"+i+"K"]="deleteLine",n[t[i+"Enter"]="insertLineAfter"]=function(e){u(e,!1)},n[t["Shift-"+i+"Enter"]="insertLineBefore"]=function(e){u(e,!0)},n[t[i+"D"]="selectNextOccurrence"]=function(t){var n=t.getCursor("from"),i=t.getCursor("to"),s=t.state.sublimeFindFullWord==t.doc.sel;if(e.cmpPos(n,i)==0){var o=a(t,n);if(!o.word)return;t.setSelection(o.from,o.to),s=!0}else{var u=t.getRange(n,i),f=s?new RegExp("\\b"+u+"\\b"):u,l=t.getSearchCursor(f,i);l.findNext()?t.addSelection(l.from(),l.to()):(l=t.getSearchCursor(f,r(t.firstLine(),0)),l.findNext()&&t.addSelection(l.from(),l.to()))}s&&(t.state.sublimeFindFullWord=t.doc.sel)};var f="(){}[]";n[t["Shift-"+i+"Space"]="selectScope"]=function(e){l(e)||e.execCommand("selectAll")},n[t["Shift-"+i+"M"]="selectBetweenBrackets"]=function(t){if(!l(t))return e.Pass},n[t[i+"M"]="goToBracket"]=function(t){t.extendSelectionsBy(function(n){var i=t.scanForBracket(n.head,1);if(i&&e.cmpPos(i.pos,n.head)!=0)return i.pos;var s=t.scanForBracket(n.head,-1);return s&&r(s.pos.line,s.pos.ch+1)||n.head})},n[t["Shift-"+i+"Up"]="swapLineUp"]=function(e){var t=e.listSelections(),n=[],i=e.firstLine()-1;for(var s=0;s<t.length;s++){var o=t[s],u=o.from().line-1,a=o.to().line;u>i?n.push(u,a):n.length&&(n[n.length-1]=a),i=a}e.operation(function(){for(var t=0;t<n.length;t+=2){var i=n[t],s=n[t+1],o=e.getLine(i);e.replaceRange("",r(i,0),r(i+1,0),"+swapLine");if(s>e.lastLine()){e.replaceRange("\n"+o,r(e.lastLine()),null,"+swapLine");var u=e.listSelections(),a=u[u.length-1],f=a.head.line==s?r(s-1):a.head,l=a.anchor.line==s?r(s-1):a.anchor;e.setSelections(u.slice(0,u.length-1).concat([{head:f,anchor:l}]))}else e.replaceRange(o+"\n",r(s,0),null,"+swapLine")}e.scrollIntoView()})},n[t["Shift-"+i+"Down"]="swapLineDown"]=function(e){var t=e.listSelections(),n=[],i=e.lastLine()+1;for(var s=t.length-1;s>=0;s--){var o=t[s],u=o.to().line+1,a=o.from().line;u<i?n.push(u,a):n.length&&(n[n.length-1]=a),i=a}e.operation(function(){for(var t=n.length-2;t>=0;t-=2){var i=n[t],s=n[t+1],o=e.getLine(i);i==e.lastLine()?e.replaceRange("",r(i-1),r(i),"+swapLine"):e.replaceRange("",r(i,0),r(i+1,0),"+swapLine"),e.replaceRange(o+"\n",r(s,0),null,"+swapLine")}e.scrollIntoView()})},t[i+"/"]="toggleComment",n[t[i+"J"]="joinLines"]=function(e){var t=e.listSelections(),n=[];for(var i=0;i<t.length;i++){var s=t[i],o=s.from(),u=o.line,a=s.to().line;while(i<t.length-1&&t[i+1].from().line==a)a=t[++i].to().line;n.push({start:u,end:a,anchor:!s.empty()&&o})}e.operation(function(){var t=0,i=[];for(var s=0;s<n.length;s++){var o=n[s],u=o.anchor&&r(o.anchor.line-t,o.anchor.ch),a;for(var f=o.start;f<=o.end;f++){var l=f-t;f==o.end&&(a=r(l,e.getLine(l).length+1)),l<e.lastLine()&&(e.replaceRange(" ",r(l),r(l+1,/^\s*/.exec(e.getLine(l+1))[0].length)),++t)}i.push({anchor:u||a,head:a})}e.setSelections(i,0)})},n[t["Shift-"+i+"D"]="duplicateLine"]=function(e){e.operation(function(){var t=e.listSelections().length;for(var n=0;n<t;n++){var i=e.listSelections()[n];i.empty()?e.replaceRange(e.getLine(i.head.line)+"\n",r(i.head.line,0)):e.replaceRange(e.getRange(i.from(),i.to()),i.from())}e.scrollIntoView()})},t[i+"T"]="transposeChars",n[t.F9="sortLines"]=function(e){c(e,!0)},n[t[i+"F9"]="sortLinesInsensitive"]=function(e){c(e,!1)},n[t.F2="nextBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)while(t.length){var n=t.shift(),r=n.find();if(r)return t.push(n),e.setSelection(r.from,r.to)}},n[t["Shift-F2"]="prevBookmark"]=function(e){var t=e.state.sublimeBookmarks;if(t)while(t.length){t.unshift(t.pop());var n=t[t.length-1].find();if(!!n)return e.setSelection(n.from,n.to);t.pop()}},n[t[i+"F2"]="toggleBookmark"]=function(e){var t=e.listSelections(),n=e.state.sublimeBookmarks||(e.state.sublimeBookmarks=[]);for(var r=0;r<t.length;r++){var i=t[r].from(),s=t[r].to(),o=e.findMarks(i,s);for(var u=0;u<o.length;u++)if(o[u].sublimeBookmark){o[u].clear();for(var a=0;a<n.length;a++)n[a]==o[u]&&n.splice(a--,1);break}u==o.length&&n.push(e.markText(i,s,{sublimeBookmark:!0,clearWhenEmpty:!1}))}},n[t["Shift-"+i+"F2"]="clearBookmarks"]=function(e){var t=e.state.sublimeBookmarks;if(t)for(var n=0;n<t.length;n++)t[n].clear();t.length=0},n[t["Alt-F2"]="selectBookmarks"]=function(e){var t=e.state.sublimeBookmarks,n=[];if(t)for(var r=0;r<t.length;r++){var i=t[r].find();i?n.push({anchor:i.from,head:i.to}):t.splice(r--,0)}n.length&&e.setSelections(n,0)},t["Alt-Q"]="wrapLines";var h=e.keyMap["sublime-Ctrl-K"]={auto:"sublime",nofallthrough:!0};t[i+"K"]=function(e){e.setOption("keyMap","sublime-Ctrl-K")},h[i+"Backspace"]="delLineLeft",n[h[i+"K"]="delLineRight"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=t.length-1;n>=0;n--)e.replaceRange("",t[n].anchor,r(t[n].to().line),"+delete");e.scrollIntoView()})},n[h[i+"U"]="upcaseAtCursor"]=function(e){p(e,function(e){return e.toUpperCase()})},n[h[i+"L"]="downcaseAtCursor"]=function(e){p(e,function(e){return e.toLowerCase()})},n[h[i+"Space"]="setSublimeMark"]=function(e){e.state.sublimeMark&&e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor())},n[h[i+"A"]="selectToSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&e.setSelection(e.getCursor(),t)},n[h[i+"W"]="deleteToSublimeMark"]=function(t){var n=t.state.sublimeMark&&t.state.sublimeMark.find();if(n){var r=t.getCursor(),i=n;if(e.cmpPos(r,i)>0){var s=i;i=r,r=s}t.state.sublimeKilled=t.getRange(r,i),t.replaceRange("",r,i)}},n[h[i+"X"]="swapWithSublimeMark"]=function(e){var t=e.state.sublimeMark&&e.state.sublimeMark.find();t&&(e.state.sublimeMark.clear(),e.state.sublimeMark=e.setBookmark(e.getCursor()),e.setCursor(t))},n[h[i+"Y"]="sublimeYank"]=function(e){e.state.sublimeKilled!=null&&e.replaceSelection(e.state.sublimeKilled,null,"paste")},h[i+"G"]="clearBookmarks",n[h[i+"C"]="showInCenter"]=function(e){var t=e.cursorCoords(null,"local");e.scrollTo(null,(t.top+t.bottom)/2-e.getScrollInfo().clientHeight/2)},n[t["Shift-Alt-Up"]="selectLinesUpward"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=0;n<t.length;n++){var i=t[n];i.head.line>e.firstLine()&&e.addSelection(r(i.head.line-1,i.head.ch))}})},n[t["Shift-Alt-Down"]="selectLinesDownward"]=function(e){e.operation(function(){var t=e.listSelections();for(var n=0;n<t.length;n++){var i=t[n];i.head.line<e.lastLine()&&e.addSelection(r(i.head.line+1,i.head.ch))}})},n[t[i+"F3"]="findUnder"]=function(e){d(e,!0)},n[t["Shift-"+i+"F3"]="findUnderPrevious"]=function(e){d(e,!1)},t["Shift-"+i+"["]="fold",t["Shift-"+i+"]"]="unfold",h[i+"0"]=h[i+"j"]="unfoldAll",t[i+"I"]="findIncremental",t["Shift-"+i+"I"]="findIncrementalReverse",t[i+"H"]="replace",t.F3="findNext",t["Shift-F3"]="findPrev"});