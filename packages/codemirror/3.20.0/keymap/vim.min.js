/**
 * Supported keybindings:
 *
 *   Motion:
 *   h, j, k, l
 *   gj, gk
 *   e, E, w, W, b, B, ge, gE
 *   f<character>, F<character>, t<character>, T<character>
 *   $, ^, 0, -, +, _
 *   gg, G
 *   %
 *   '<character>, `<character>
 *
 *   Operator:
 *   d, y, c
 *   dd, yy, cc
 *   g~, g~g~
 *   >, <, >>, <<
 *
 *   Operator-Motion:
 *   x, X, D, Y, C, ~
 *
 *   Action:
 *   a, i, s, A, I, S, o, O
 *   zz, z., z<CR>, zt, zb, z-
 *   J
 *   u, Ctrl-r
 *   m<character>
 *   r<character>
 *
 *   Modes:
 *   ESC - leave insert mode, visual mode, and clear input state.
 *   Ctrl-[, Ctrl-c - same as ESC.
 *
 * Registers: unamed, -, a-z, A-Z, 0-9
 *   (Does not respect the special case for number registers when delete
 *    operator is made with these commands: %, (, ),  , /, ?, n, N, {, } )
 *   TODO: Implement the remaining registers.
 * Marks: a-z, A-Z, and 0-9
 *   TODO: Implement the remaining special marks. They have more complex
 *       behavior.
 *
 * Events:
 *  'vim-mode-change' - raised on the editor anytime the current mode changes,
 *                      Event object: {mode: "visual", subMode: "linewise"}
 *
 * Code structure:
 *  1. Default keymap
 *  2. Variable declarations and short basic helpers
 *  3. Instance (External API) implementation
 *  4. Internal state tracking objects (input state, counter) implementation
 *     and instanstiation
 *  5. Key handler (the main command dispatcher) implementation
 *  6. Motion, operator, and action implementations
 *  7. Helper functions for the key handler, motions, operators, and actions
 *  8. Set up Vim to work as a keymap for CodeMirror.
 */(function(){"use strict";var e=[{keys:["<Left>"],type:"keyToKey",toKeys:["h"]},{keys:["<Right>"],type:"keyToKey",toKeys:["l"]},{keys:["<Up>"],type:"keyToKey",toKeys:["k"]},{keys:["<Down>"],type:"keyToKey",toKeys:["j"]},{keys:["<Space>"],type:"keyToKey",toKeys:["l"]},{keys:["<BS>"],type:"keyToKey",toKeys:["h"]},{keys:["<C-Space>"],type:"keyToKey",toKeys:["W"]},{keys:["<C-BS>"],type:"keyToKey",toKeys:["B"]},{keys:["<S-Space>"],type:"keyToKey",toKeys:["w"]},{keys:["<S-BS>"],type:"keyToKey",toKeys:["b"]},{keys:["<C-n>"],type:"keyToKey",toKeys:["j"]},{keys:["<C-p>"],type:"keyToKey",toKeys:["k"]},{keys:["C-["],type:"keyToKey",toKeys:["<Esc>"]},{keys:["<C-c>"],type:"keyToKey",toKeys:["<Esc>"]},{keys:["s"],type:"keyToKey",toKeys:["c","l"],context:"normal"},{keys:["s"],type:"keyToKey",toKeys:["x","i"],context:"visual"},{keys:["S"],type:"keyToKey",toKeys:["c","c"],context:"normal"},{keys:["S"],type:"keyToKey",toKeys:["d","c","c"],context:"visual"},{keys:["<Home>"],type:"keyToKey",toKeys:["0"]},{keys:["<End>"],type:"keyToKey",toKeys:["$"]},{keys:["<PageUp>"],type:"keyToKey",toKeys:["<C-b>"]},{keys:["<PageDown>"],type:"keyToKey",toKeys:["<C-f>"]},{keys:["H"],type:"motion",motion:"moveToTopLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["M"],type:"motion",motion:"moveToMiddleLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["L"],type:"motion",motion:"moveToBottomLine",motionArgs:{linewise:!0,toJumplist:!0}},{keys:["h"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!1}},{keys:["l"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["j"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,linewise:!0}},{keys:["k"],type:"motion",motion:"moveByLines",motionArgs:{forward:!1,linewise:!0}},{keys:["g","j"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!0}},{keys:["g","k"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:!1}},{keys:["w"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1}},{keys:["W"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!1,bigWord:!0}},{keys:["e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,inclusive:!0}},{keys:["E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!0,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["b"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1}},{keys:["B"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!1,bigWord:!0}},{keys:["g","e"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,inclusive:!0}},{keys:["g","E"],type:"motion",motion:"moveByWords",motionArgs:{forward:!1,wordEnd:!0,bigWord:!0,inclusive:!0}},{keys:["{"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!1,toJumplist:!0}},{keys:["}"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:!0,toJumplist:!0}},{keys:["<C-f>"],type:"motion",motion:"moveByPage",motionArgs:{forward:!0}},{keys:["<C-b>"],type:"motion",motion:"moveByPage",motionArgs:{forward:!1}},{keys:["<C-d>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:!0,explicitRepeat:!0}},{keys:["<C-u>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:!1,explicitRepeat:!0}},{keys:["g","g"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:["G"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!0,explicitRepeat:!0,linewise:!0,toJumplist:!0}},{keys:["0"],type:"motion",motion:"moveToStartOfLine"},{keys:["^"],type:"motion",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["+"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0}},{keys:["-"],type:"motion",motion:"moveByLines",motionArgs:{forward:!1,toFirstChar:!0}},{keys:["_"],type:"motion",motion:"moveByLines",motionArgs:{forward:!0,toFirstChar:!0,repeatOffset:-1}},{keys:["$"],type:"motion",motion:"moveToEol",motionArgs:{inclusive:!0}},{keys:["%"],type:"motion",motion:"moveToMatchedSymbol",motionArgs:{inclusive:!0,toJumplist:!0}},{keys:["f","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["F","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:!1}},{keys:["t","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!0,inclusive:!0}},{keys:["T","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:!1}},{keys:[";"],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!0}},{keys:[","],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:!1}},{keys:["'","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0}},{keys:["`","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:!0}},{keys:["]","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!0}},{keys:["[","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!1}},{keys:["]","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!0,linewise:!0}},{keys:["[","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:!1,linewise:!0}},{keys:["]","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:!0,toJumplist:!0}},{keys:["[","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:!1,toJumplist:!0}},{keys:["|"],type:"motion",motion:"moveToColumn",motionArgs:{}},{keys:["d"],type:"operator",operator:"delete"},{keys:["y"],type:"operator",operator:"yank"},{keys:["c"],type:"operator",operator:"change"},{keys:[">"],type:"operator",operator:"indent",operatorArgs:{indentRight:!0}},{keys:["<"],type:"operator",operator:"indent",operatorArgs:{indentRight:!1}},{keys:["g","~"],type:"operator",operator:"swapcase"},{keys:["n"],type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:!0}},{keys:["N"],type:"motion",motion:"findNext",motionArgs:{forward:!1,toJumplist:!0}},{keys:["x"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!0},operatorMotionArgs:{visualLine:!1}},{keys:["X"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:!1},operatorMotionArgs:{visualLine:!0}},{keys:["D"],type:"operatorMotion",operator:"delete",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["Y"],type:"operatorMotion",operator:"yank",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["C"],type:"operatorMotion",operator:"change",motion:"moveToEol",motionArgs:{inclusive:!0},operatorMotionArgs:{visualLine:!0}},{keys:["~"],type:"operatorMotion",operator:"swapcase",operatorArgs:{shouldMoveCursor:!0},motion:"moveByCharacters",motionArgs:{forward:!0}},{keys:["<C-i>"],type:"action",action:"jumpListWalk",actionArgs:{forward:!0}},{keys:["<C-o>"],type:"action",action:"jumpListWalk",actionArgs:{forward:!1}},{keys:["a"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"charAfter"}},{keys:["A"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"eol"}},{keys:["i"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"inplace"}},{keys:["I"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{insertAt:"firstNonBlank"}},{keys:["o"],type:"action",action:"newLineAndEnterInsertMode",isEdit:!0,interlaceInsertRepeat:!0,actionArgs:{after:!0}},{keys:["O"],type:"action",action:"newLineAndEnterInsertMode",isEdit:!0,interlaceInsertRepeat:!0,actionArgs:{after:!1}},{keys:["v"],type:"action",action:"toggleVisualMode"},{keys:["V"],type:"action",action:"toggleVisualMode",actionArgs:{linewise:!0}},{keys:["J"],type:"action",action:"joinLines",isEdit:!0},{keys:["p"],type:"action",action:"paste",isEdit:!0,actionArgs:{after:!0,isEdit:!0}},{keys:["P"],type:"action",action:"paste",isEdit:!0,actionArgs:{after:!1,isEdit:!0}},{keys:["r","character"],type:"action",action:"replace",isEdit:!0},{keys:["@","character"],type:"action",action:"replayMacro"},{keys:["q","character"],type:"action",action:"enterMacroRecordMode"},{keys:["R"],type:"action",action:"enterInsertMode",isEdit:!0,actionArgs:{replace:!0}},{keys:["u"],type:"action",action:"undo"},{keys:["<C-r>"],type:"action",action:"redo"},{keys:["m","character"],type:"action",action:"setMark"},{keys:['"',"character"],type:"action",action:"setRegister"},{keys:["z","z"],type:"action",action:"scrollToCursor",actionArgs:{position:"center"}},{keys:["z","."],type:"action",action:"scrollToCursor",actionArgs:{position:"center"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","t"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"}},{keys:["z","<CR>"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","-"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"}},{keys:["z","b"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["."],type:"action",action:"repeatLastEdit"},{keys:["<C-a>"],type:"action",action:"incrementNumberToken",isEdit:!0,actionArgs:{increase:!0,backtrack:!1}},{keys:["<C-x>"],type:"action",action:"incrementNumberToken",isEdit:!0,actionArgs:{increase:!1,backtrack:!1}},{keys:["a","character"],type:"motion",motion:"textObjectManipulation"},{keys:["i","character"],type:"motion",motion:"textObjectManipulation",motionArgs:{textObjectInner:!0}},{keys:["/"],type:"search",searchArgs:{forward:!0,querySrc:"prompt",toJumplist:!0}},{keys:["?"],type:"search",searchArgs:{forward:!1,querySrc:"prompt",toJumplist:!0}},{keys:["*"],type:"search",searchArgs:{forward:!0,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:["#"],type:"search",searchArgs:{forward:!1,querySrc:"wordUnderCursor",toJumplist:!0}},{keys:[":"],type:"ex"}],t=function(){function n(e,t){var n=e.state.vim;if(n.insertMode||n.exMode)return;var r=t.head;r.ch&&r.ch==e.doc.getLine(r.line).length&&r.ch--}function o(e,t){var n=[];for(var r=e;r<e+t;r++)n.push(String.fromCharCode(r));return n}function d(e,t){return t>=e.firstLine()&&t<=e.lastLine()}function v(e){return/^[a-z]$/.test(e)}function m(e){return"()[]{}".indexOf(e)!=-1}function g(e){return r.test(e)}function y(e){return/^[A-Z]$/.test(e)}function b(e){return/^\s*$/.test(e)}function w(e,t){for(var n=0;n<t.length;n++)if(t[n]==e)return!0;return!1}function x(e){return e.state.vim||(e.state.vim={inputState:new k,lastEditInputState:undefined,lastEditActionCommand:undefined,lastHPos:-1,lastHSPos:-1,lastMotion:null,marks:{},insertMode:!1,insertModeRepeat:undefined,visualMode:!1,visualLine:!1}),e.state.vim}function N(){T={searchQuery:null,searchIsReversed:!1,jumpList:E(),macroModeState:S(),lastChararacterSearch:{increment:0,forward:!0,selectedCharacter:""},registerController:new A({})}}function k(){this.prefixRepeat=[],this.motionRepeat=[],this.operator=null,this.operatorArgs=null,this.motion=null,this.motionArgs=null,this.keyBuffer=[],this.registerName=null}function L(e,t){this.clear(),e&&this.set(e,t)}function A(e){this.registers=e,this.unamedRegister=e['"']=new L}function H(e,t,n){var r=Math.min(Math.max(e.firstLine(),t.line),e.lastLine()),i=W(e,r)-1;i=n?i+1:i;var s=Math.min(Math.max(0,t.ch),i);return{line:r,ch:s}}function B(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t}function j(e,t,n){return{line:e.line+t,ch:e.ch+n}}function F(e,t){for(var n=0;n<e.length;n++)if(e[n]!=t[n]&&t[n]!="character")return!1;return!0}function I(e,t,n){return function(){for(var r=0;r<n;r++)t(e)}}function q(e){return{line:e.line,ch:e.ch}}function R(e,t){return e.ch==t.ch&&e.line==t.line}function U(e,t){return e.line<t.line?!0:e.line==t.line&&e.ch<t.ch?!0:!1}function z(e,t,n){var r=U(e,t),i=U(t,n);return r&&i}function W(e,t){return e.getLine(t).length}function X(e){return e.split("").reverse().join("")}function V(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function $(e){return e.replace(/([.?*+$\[\]\/\\(){}|\-])/g,"\\$1")}function J(e){e.off("mousedown",J);var t=e.state.vim;t.visualMode=!1,t.visualLine=!1;var n=e.getCursor("anchor"),r=e.getCursor("head");R(n,r)||e.setCursor(H(e,r)),CodeMirror.signal(e,"vim-mode-change",{mode:"normal"})}function K(e,t,n){var r=e.getRange(t,n);if(/\n\s*$/.test(r)){var i=r.split("\n");i.pop();var s;for(var s=i.pop();i.length>0&&s&&b(s);s=i.pop())n.line--,n.ch=0;s?(n.line--,n.ch=W(e,n.line)):n.ch=0}}function Q(e,t,n){t.ch=0,n.ch=0,n.line++}function G(e){if(!e)return 0;var t=e.search(/\S/);return t==-1?e.length:t}function Y(e,t,n,r,i){var s=e.getCursor(),o=e.getLine(s.line),u=s.ch,a=o.substring(u),f;i?f=a.search(/\w/):f=a.search(/\S/);if(f==-1)return null;u+=f,a=o.substring(u);var l=o.substring(0,u),c;r?c=/^\S+/:/\w/.test(o.charAt(u))?c=/^\w+/:c=/^[^\w\s]+/;var h=c.exec(a),p=u,d=u+h[0].length,v=X(l),m=c.exec(v);m&&(p-=m[0].length);if(t){var g=o.substring(d),y=g.match(/^\s*/)[0].length;if(y>0)d+=y;else{var b=v.length-p,w=v.substring(b),E=w.match(/^\s*/)[0].length;p-=E}}return{start:{line:s.line,ch:p},end:{line:s.line,ch:d}}}function Z(e,t,n){R(t,n)||T.jumpList.add(e,t,n)}function et(e,t){T.lastChararacterSearch.increment=e,T.lastChararacterSearch.forward=t.forward,T.lastChararacterSearch.selectedCharacter=t.selectedCharacter}function rt(e,t,n,r){var i=e.getCursor(),s=n?1:-1,o=n?e.lineCount():-1,u=i.ch,a=i.line,f=e.getLine(a),l={lineText:f,nextCh:f.charAt(u),lastCh:null,index:u,symb:r,reverseSymb:(n?{")":"(","}":"{"}:{"(":")","{":"}"})[r],forward:n,depth:0,curMoveThrough:!1},c=tt[r];if(!c)return i;var h=nt[c].init,p=nt[c].isComplete;h&&h(l);while(a!==o&&t){l.index+=s,l.nextCh=l.lineText.charAt(l.index);if(!l.nextCh){a+=s,l.lineText=e.getLine(a)||"";if(s>0)l.index=0;else{var d=l.lineText.length;l.index=d>0?d-1:0}l.nextCh=l.lineText.charAt(l.index)}p(l)&&(i.line=a,i.ch=l.index,t--)}return l.nextCh||l.curMoveThrough?{line:a,ch:l.index}:i}function it(e,t,n,r,o){var u=t.line,a=t.ch,f=e.getLine(u),l=n?1:-1,c=r?s:i;if(o&&f==""){u+=l,f=e.getLine(u);if(!d(e,u))return null;a=n?0:f.length}for(;;){if(o&&f=="")return{from:0,to:0,line:u};var h=l>0?f.length:-1,p=h,v=h;while(a!=h){var m=!1;for(var g=0;g<c.length&&!m;++g)if(c[g].test(f.charAt(a))){p=a;while(a!=h&&c[g].test(f.charAt(a)))a+=l;v=a,m=p!=v;if(p==t.ch&&u==t.line&&v==p+l)continue;return{from:Math.min(p,v+1),to:Math.max(p,v),line:u}}m||(a+=l)}u+=l;if(!d(e,u))return null;f=e.getLine(u),a=l>0?0:f.length}throw new Error("The impossible happened.")}function st(e,t,n,r,i){var s=e.getCursor(),o=q(s),u=[];(n&&!r||!n&&r)&&t++;var a=!n||!r;for(var f=0;f<t;f++){var l=it(e,s,n,i,a);if(!l){var c=W(e,e.lastLine());u.push(n?{line:e.lastLine(),from:c,to:c}:{line:0,from:0,to:0});break}u.push(l),s={line:l.line,ch:n?l.to-1:l.from}}var h=u.length!=t,p=u[0],d=u.pop();return n&&!r?(!h&&(p.from!=o.ch||p.line!=o.line)&&(d=u.pop()),{line:d.line,ch:d.from}):n&&r?{line:d.line,ch:d.to-1}:!n&&r?(!h&&(p.to!=o.ch||p.line!=o.line)&&(d=u.pop()),{line:d.line,ch:d.to}):{line:d.line,ch:d.from}}function ot(e,t,n,r){var i=e.getCursor(),s=i.ch,o;for(var u=0;u<t;u++){var a=e.getLine(i.line);o=ft(s,a,r,n,!0);if(o==-1)return null;s=o}return{line:e.getCursor().line,ch:o}}function ut(e,t){var n=e.getCursor().line;return H(e,{line:n,ch:t-1})}function at(e,t,n,r){if(!w(n,h))return;t.marks[n]&&t.marks[n].clear(),t.marks[n]=e.setBookmark(r)}function ft(e,t,n,r,i){var s;return r?(s=t.indexOf(n,e+1),s!=-1&&!i&&(s-=1)):(s=t.lastIndexOf(n,e-1),s!=-1&&!i&&(s+=1)),s}function lt(e){return e==="string"||e==="comment"?1:0}function ct(e,t,n){var r=t.line,i=t.ch;n=n?n:e.getLine(r).charAt(i);var s=e.getTokenAt({line:r,ch:i+1}).type,o=lt(s),u={"(":")",")":"(","[":"]","]":"[","{":"}","}":"{"}[n];if(!u)return t;var a={"(":1,"{":1,"[":1}[n]||-1,f=a===1?e.lineCount():-1,l=1,c=n,h=i,p=e.getLine(r);while(r!==f&&l>0){h+=a,c=p.charAt(h);if(!c){r+=a,p=e.getLine(r)||"";if(a>0)h=0;else{var d=p.length;h=d>0?d-1:0}c=p.charAt(h)}var v=e.getTokenAt({line:r,ch:h+1}).type,m=lt(v);o>=m&&(c===n?l++:c===u&&l--)}return c?{line:r,ch:h}:t}function ht(e,t,n){var r=e.getCursor(),i=ct(e,r,t),s=ct(e,i);return s.ch+=n?1:0,i.ch+=n?0:1,{start:s,end:i}}function pt(e,t,n){var r=e.getCursor(),i=e.getLine(r.line),s=i.split(""),o,u,a,f,l=s.indexOf(t);r.ch<l?r.ch=l:l<r.ch&&s[r.ch]==t&&(u=r.ch,--r.ch);if(s[r.ch]==t&&!u)o=r.ch+1;else for(a=r.ch;a>-1&&!o;a--)s[a]==t&&(o=a+1);if(o&&!u)for(a=o,f=s.length;a<f&&!u;a++)s[a]==t&&(u=a);return!o||!u?{start:r,end:r}:(n&&(--o,++u),{start:{line:r.line,ch:o},end:{line:r.line,ch:u}})}function dt(){}function vt(e){var t=e.state.vim;return t.searchState_||(t.searchState_=new dt)}function mt(e,t,n,r,i){e.openDialog?e.openDialog(t,r,{bottom:!0,value:i.value,onKeyDown:i.onKeyDown,onKeyUp:i.onKeyUp}):r(prompt(n,""))}function gt(e){var t=!1,n=[];for(var r=0;r<e.length;r++){var i=e.charAt(r);!t&&i=="/"&&n.push(r),t=i=="\\"}return n}function yt(e,t,n){if(e instanceof RegExp)return e;var r=gt(e),i,s;if(!r.length)i=e;else{i=e.substring(0,r[0]);var o=e.substring(r[0]);s=o.indexOf("i")!=-1}if(!i)return null;n&&(t=/^[^A-Z]*$/.test(i));var u=new RegExp(i,t||s?"i":undefined);return u}function bt(e,t){e.openNotification?e.openNotification('<span style="color: red">'+t+"</span>",{bottom:!0,duration:5e3}):alert(t)}function wt(e,t){var n="";return e&&(n+='<span style="font-family: monospace">'+e+"</span>"),n+='<input type="text"/> <span style="color: #888">',t&&(n+='<span style="color: #888">',n+=t,n+="</span>"),n}function St(e,t){var n=(t.prefix||"")+" "+(t.desc||""),r=wt(t.prefix,t.desc);mt(e,r,n,t.onClose,t)}function xt(e,t){if(e instanceof RegExp&&t instanceof RegExp){var n=["global","multiline","ignoreCase","source"];for(var r=0;r<n.length;r++){var i=n[r];if(e[i]!==t[i])return!1}return!0}return!1}function Tt(e,t,n,r){if(!t)return;var i=vt(e),s=yt(t,!!n,!!r);if(!s)return;return Ct(e,s),xt(s,i.getQuery())?s:(i.setQuery(s),s)}function Nt(e){if(e.source.charAt(0)=="^")var t=!0;return{token:function(n){if(t&&!n.sol()){n.skipToEnd();return}var r=n.match(e,!1);if(r){if(r[0].length==0)return n.next(),"searching";if(!n.sol()){n.backUp(1);if(!e.exec(n.next()+r[0]))return n.next(),null}return n.match(e),"searching"}while(!n.eol()){n.next();if(n.match(e,!1))break}},query:e}}function Ct(e,t){var n=vt(e).getOverlay();if(!n||t!=n.query)n&&e.removeOverlay(n),n=Nt(t),e.addOverlay(n),vt(e).setOverlay(n)}function kt(e,t,n,r){return r===undefined&&(r=1),e.operation(function(){var i=e.getCursor(),s=e.getSearchCursor(n,i);for(var o=0;o<r;o++){var u=s.find(t);o==0&&u&&R(s.from(),i)&&(u=s.find(t));if(!u){s=e.getSearchCursor(n,t?{line:e.lastLine()}:{line:e.firstLine(),ch:0});if(!s.find(t))return}}return s.from()})}function Lt(e){e.removeOverlay(vt(e).getOverlay()),vt(e).setOverlay(null)}function At(e,t,n){return typeof e!="number"&&(e=e.line),t instanceof Array?w(e,t):n?e>=t&&e<=n:e==t}function Ot(e){var t=e.getScrollInfo(),n=6,r=10,i=e.coordsChar({left:0,top:n+t.top},"local"),s=t.clientHeight-r+t.top,o=e.coordsChar({left:0,top:s},"local");return{top:i.line,bottom:o.line}}function _t(e){var t,n,r=[];while(e){n=/<\w+-.+?>|<\w+>|./.exec(e);if(n===null)break;t=n[0],e=e.substring(n.index+t.length),r.push(t)}return r}function Ht(e,t,n,r,i,s,o){function f(){e.operation(function(){while(!u)l(),c();h()})}function l(){var t=e.getRange(i.from(),i.to()),n=t.replace(s,o);i.replace(n)}function c(){var t=i.findNext();t?At(i.from(),n,r)?(e.scrollIntoView(i.from(),30),e.setSelection(i.from(),i.to()),a=i.from(),u=!1):u=!0:u=!0}function h(t){t&&t(),e.focus();if(a){e.setCursor(a);var n=e.state.vim;n.exMode=!1,n.lastHPos=n.lastHSPos=a.ch}}function p(t,n,r){CodeMirror.e_stop(t);var i=CodeMirror.keyName(t);switch(i){case"Y":l(),c();break;case"N":c();break;case"A":e.operation(f);break;case"L":l();case"Q":case"Esc":case"Ctrl-C":case"Ctrl-[":h(r)}u&&h(r)}e.state.vim.exMode=!0;var u=!1,a=i.from();c();if(u)throw new Error("No matches for "+s.source);if(!t){f();return}St(e,{prefix:"replace with <strong>"+o+"</strong> (y/n/a/q/l)",onKeyDown:p})}function Bt(){function e(e,t){var n=e;y(n)&&(t=="Shift"?t=null:n=n.toLowerCase()),t&&(n=t.charAt(0)+"-"+n);var r={Enter:"CR",Backspace:"BS",Delete:"Del"}[n];return n=r?r:n,n=n.length>1?"<"+n+">":n,n}function t(e){return function(t){CodeMirror.Vim.handleKey(t,e)}}function r(r,i){for(var s=0;s<r.length;s++){var o=r[s];!i&&w(o,l)&&(o="'"+o+"'");var u=e(r[s],i),a=i?i+"-"+o:o;n[a]=t(u)}}var n={nofallthrough:!0,disableInput:!0,style:"fat-cursor"};return r(u),r(u,"Shift"),r(u,"Ctrl"),r(l),r(l,"Ctrl"),r(f),r(f,"Ctrl"),r(c),r(c,"Ctrl"),n}function jt(e){var t=e.state.vim,n=T.macroModeState.inReplay;n||(e.off("change",zt),e.off("cursorActivity",Wt),CodeMirror.off(e.getInputField(),"keydown",Vt)),!n&&t.insertModeRepeat>1&&($t(e,t,t.insertModeRepeat-1,!0),t.lastEditInputState.repeatOverride=t.insertModeRepeat),delete t.insertModeRepeat,e.setCursor(e.getCursor().line,e.getCursor().ch-1,!0),t.insertMode=!1,e.setOption("keyMap","vim"),e.toggleOverwrite(!1),CodeMirror.signal(e,"vim-mode-change",{mode:"normal"})}function Ft(e,t){var n,r,i=T.registerController.getRegister(t),s=i.toString(),o=e.macroKeyBuffer;qt(e);do{n=/<\w+-.+?>|<\w+>|./.exec(s);if(n===null)break;r=n[0],s=s.substring(n.index+r.length),o.push(r)}while(s);return o}function It(e,t){var n=t.join("");T.registerController.setRegisterText(e,n)}function qt(e){if(e.isMacroPlaying)return;var t=e.macroKeyBuffer;t.length=0}function Rt(e,t,n){t.isMacroPlaying=!0;for(var r=0,i=n.length;r<i;r++)CodeMirror.Vim.handleKey(e,n[r]);t.isMacroPlaying=!1}function Ut(e,t){if(e.isMacroPlaying)return;var n=e.macroKeyBuffer;n.push(t)}function zt(e,t){var n=T.macroModeState,r=n.lastInsertModeChanges;while(t){r.expectCursorActivityForChange=!0;if(t.origin=="+input"||t.origin=="paste"||t.origin===undefined){var i=t.text.join("\n");r.changes.push(i)}t=t.next}}function Wt(){var e=T.macroModeState,t=e.lastInsertModeChanges;t.expectCursorActivityForChange?t.expectCursorActivityForChange=!1:t.changes=[]}function Xt(e){this.keyName=e}function Vt(e){function i(){return n.changes.push(new Xt(r)),!0}var t=T.macroModeState,n=t.lastInsertModeChanges,r=CodeMirror.keyName(e);(r.indexOf("Delete")!=-1||r.indexOf("Backspace")!=-1)&&CodeMirror.lookupKey(r,["vim-insert"],i)}function $t(e,t,n,r){function u(){s?O.processAction(e,t,t.lastEditActionCommand):O.evalInput(e,t)}function a(n){i.lastInsertModeChanges.changes.length>0&&(n=t.lastEditActionCommand?n:1,Jt(e,n,i))}var i=T.macroModeState;i.inReplay=!0;var s=!!t.lastEditActionCommand,o=t.inputState;t.inputState=t.lastEditInputState;if(s&&t.lastEditActionCommand.interlaceInsertRepeat)for(var f=0;f<n;f++)u(),a(1);else r||u(),a(n);t.inputState=o,t.insertMode&&!r&&jt(e),i.inReplay=!1}function Jt(e,t,n){function i(t){return typeof t=="string"?CodeMirror.commands[t](e):t(e),!0}var r=n.lastInsertModeChanges;for(var s=0;s<t;s++)for(var o=0;o<r.changes.length;o++){var u=r.changes[o];if(u instanceof Xt)CodeMirror.lookupKey(u.keyName,["vim-insert"],i);else{var a=e.getCursor();e.replaceRange(u,a,a)}}}CodeMirror.defineOption("vimMode",!1,function(e,t){t?(e.setOption("keyMap","vim"),CodeMirror.signal(e,"vim-mode-change",{mode:"normal"}),e.on("beforeSelectionChange",n),x(e)):e.state.vim&&(e.setOption("keyMap","default"),e.off("beforeSelectionChange",n),e.state.vim=null)});var r=/[\d]/,i=[/\w/,/[^\w\s]/],s=[/\S/],u=o(65,26),a=o(97,26),f=o(48,10),l="~`!@#$%^&*()_-+=[{}]\\|/?.,<>:;\"'".split(""),c=["Left","Right","Up","Down","Space","Backspace","Esc","Home","End","PageUp","PageDown","Enter"],h=[].concat(u,a,f,["<",">"]),p=[].concat(u,a,f,["-",'"']),E=function(){function s(s,o,u){function l(n){var r=++t%e,o=i[r];o&&o.clear(),i[r]=s.setBookmark(n)}var a=t%e,f=i[a];if(f){var c=f.find();c&&!R(c,o)&&l(o)}else l(o);l(u),n=t,r=t-e+1,r<0&&(r=0)}function o(s,o){t+=o,t>n?t=n:t<r&&(t=r);var u=i[(e+t)%e];if(u&&!u.find()){var a=o>0?1:-1,f,l=s.getCursor();do{t+=a,u=i[(e+t)%e];if(u&&(f=u.find())&&!R(l,f))break}while(t<n&&t>r)}return u}var e=100,t=-1,n=0,r=0,i=new Array(e);return{cachedCursor:undefined,add:s,move:o}},S=function(){return{macroKeyBuffer:[],latestRegister:undefined,inReplay:!1,lastInsertModeChanges:{changes:[],expectCursorActivityForChange:!1},enteredMacroMode:undefined,isMacroPlaying:!1,toggle:function(e,t){this.enteredMacroMode?(this.enteredMacroMode(),this.enteredMacroMode=undefined):(this.latestRegister=t,this.enteredMacroMode=e.openDialog("(recording)["+t+"]",null,{bottom:!0}))}}},T,C={buildKeyMap:function(){},getRegisterController:function(){return T.registerController},resetVimGlobalState_:N,getVimGlobalState_:function(){return T},maybeInitVimState_:x,InsertModeKey:Xt,map:function(e,t){Pt.map(e,t)},defineEx:function(e,t,n){if(e.indexOf(t)!==0)throw new Error('(Vim.defineEx) "'+t+'" is not a prefix of "'+e+'", command not registered');Dt[e]=n,Pt.commandMap_[t]={name:e,shortName:t,type:"api"}},handleKey:function(t,n){var r,i=x(t),s=T.macroModeState;if(s.enteredMacroMode&&n=="q"){D.exitMacroRecordMode(),i.inputState=new k;return}if(n=="<Esc>"){i.inputState=new k,i.visualMode&&J(t);return}!i.visualMode&&!R(t.getCursor("head"),t.getCursor("anchor"))&&(i.visualMode=!0,i.visualLine=!1,CodeMirror.signal(t,"vim-mode-change",{mode:"visual"}),t.on("mousedown",J));if(n!="0"||n=="0"&&i.inputState.getRepeat()===0)r=O.matchCommand(n,e,i);if(!r){g(n)&&i.inputState.pushRepeatDigit(n);return}if(r.type=="keyToKey")for(var o=0;o<r.toKeys.length;o++)this.handleKey(t,r.toKeys[o]);else s.enteredMacroMode&&Ut(s,n),O.processCommand(t,i,r)},handleEx:function(e,t){Pt.processCommand(e,t)}};k.prototype.pushRepeatDigit=function(e){this.operator?this.motionRepeat=this.motionRepeat.concat(e):this.prefixRepeat=this.prefixRepeat.concat(e)},k.prototype.getRepeat=function(){var e=0;if(this.prefixRepeat.length>0||this.motionRepeat.length>0)e=1,this.prefixRepeat.length>0&&(e*=parseInt(this.prefixRepeat.join(""),10)),this.motionRepeat.length>0&&(e*=parseInt(this.motionRepeat.join(""),10));return e},L.prototype={set:function(e,t){this.text=e,this.linewise=!!t},append:function(e,t){t||this.linewise?(this.text+="\n"+e,this.linewise=!0):this.text+=e},clear:function(){this.text="",this.linewise=!1},toString:function(){return this.text}},A.prototype={pushText:function(e,t,n,r){r&&n.charAt(0)=="\n"&&(n=n.slice(1)+"\n"),r&&n.charAt(n.length-1)!=="\n"&&(n+="\n");var i=this.isValidRegister(e)?this.getRegister(e):null;if(!i){switch(t){case"yank":this.registers[0]=new L(n,r);break;case"delete":case"change":n.indexOf("\n")==-1?this.registers["-"]=new L(n,r):(this.shiftNumericRegisters_(),this.registers[1]=new L(n,r))}this.unamedRegister.set(n,r);return}var s=y(e);s?(i.append(n,r),this.unamedRegister.append(n,r)):(i.set(n,r),this.unamedRegister.set(n,r))},setRegisterText:function(e,t,n){this.getRegister(e).set(t,n)},getRegister:function(e){return this.isValidRegister(e)?(e=e.toLowerCase(),this.registers[e]||(this.registers[e]=new L),this.registers[e]):this.unamedRegister},isValidRegister:function(e){return e&&w(e,p)},shiftNumericRegisters_:function(){for(var e=9;e>=2;e--)this.registers[e]=this.getRegister(""+(e-1))}};var O={matchCommand:function(e,t,n){function f(t){return i.length<t.keys.length?(r.keyBuffer.push(e),null):(t.keys[i.length-1]=="character"&&(r.selectedCharacter=o),r.keyBuffer=[],t)}var r=n.inputState,i=r.keyBuffer.concat(e),s=[],o;for(var u=0;u<t.length;u++){var a=t[u];if(F(i,a.keys)){if(r.operator&&a.type=="action")continue;if(a.keys[i.length-1]=="character"){o=i[i.length-1];if(o.length>1)switch(o){case"<CR>":o="\n";break;case"<Space>":o=" ";break;default:continue}}s.push(a)}}if(!s.length)return r.keyBuffer=[],null;if(s.length==1)return f(s[0]);var l=n.visualMode?"visual":"normal",c=s[0];for(var u=0;u<s.length;u++)if(s[u].context==l){c=s[u];break}return f(c)},processCommand:function(e,t,n){t.inputState.repeatOverride=n.repeatOverride;switch(n.type){case"motion":this.processMotion(e,t,n);break;case"operator":this.processOperator(e,t,n);break;case"operatorMotion":this.processOperatorMotion(e,t,n);break;case"action":this.processAction(e,t,n);break;case"search":this.processSearch(e,t,n);break;case"ex":case"keyToEx":this.processEx(e,t,n);break;default:}},processMotion:function(e,t,n){t.inputState.motion=n.motion,t.inputState.motionArgs=B(n.motionArgs),this.evalInput(e,t)},processOperator:function(e,t,n){var r=t.inputState;if(r.operator){if(r.operator==n.operator){r.motion="expandToLine",r.motionArgs={linewise:!0},this.evalInput(e,t);return}t.inputState=new k}r.operator=n.operator,r.operatorArgs=B(n.operatorArgs),t.visualMode&&this.evalInput(e,t)},processOperatorMotion:function(e,t,n){var r=t.visualMode,i=B(n.operatorMotionArgs);i&&r&&i.visualLine&&(t.visualLine=!0),this.processOperator(e,t,n),r||this.processMotion(e,t,n)},processAction:function(e,t,n){var r=t.inputState,i=r.getRepeat(),s=!!i,o=B(n.actionArgs)||{};r.selectedCharacter&&(o.selectedCharacter=r.selectedCharacter),n.operator&&this.processOperator(e,t,n),n.motion&&this.processMotion(e,t,n),(n.motion||n.operator)&&this.evalInput(e,t),o.repeat=i||1,o.repeatIsExplicit=s,o.registerName=r.registerName,t.inputState=new k,t.lastMotion=null,n.isEdit&&this.recordLastEdit(t,r,n),D[n.action](e,o,t)},processSearch:function(e,t,n){function u(r,i,s){try{Tt(e,r,i,s)}catch(o){bt(e,"Invalid regex: "+r);return}O.processMotion(e,t,{type:"motion",motion:"findNext",motionArgs:{forward:!0,toJumplist:n.searchArgs.toJumplist}})}function a(t){e.scrollTo(o.left,o.top),u(t,!0,!0)}function f(t,n){var i;try{i=Tt(e,n,!0,!0)}catch(s){}i?e.scrollIntoView(kt(e,!r,i),30):(Lt(e),e.scrollTo(o.left,o.top))}function l(t,n,r){var i=CodeMirror.keyName(t);if(i=="Esc"||i=="Ctrl-C"||i=="Ctrl-[")Tt(e,s),Lt(e),e.scrollTo(o.left,o.top),CodeMirror.e_stop(t),r(),e.focus()}if(!e.getSearchCursor)return;var r=n.searchArgs.forward;vt(e).setReversed(!r);var i=r?"/":"?",s=vt(e).getQuery(),o=e.getScrollInfo();switch(n.searchArgs.querySrc){case"prompt":St(e,{onClose:a,prefix:i,desc:Et,onKeyUp:f,onKeyDown:l});break;case"wordUnderCursor":var c=Y(e,!1,!0,!1,!0),h=!0;c||(c=Y(e,!1,!0,!1,!1),h=!1);if(!c)return;var p=e.getLine(c.start.line).substring(c.start.ch,c.end.ch);h?p="\\b"+p+"\\b":p=$(p),T.jumpList.cachedCursor=e.getCursor(),e.setCursor(c.start),u(p,!0,!1)}},processEx:function(e,t,n){function r(t){Pt.processCommand(e,t)}function i(t,n,r){var i=CodeMirror.keyName(t);if(i=="Esc"||i=="Ctrl-C"||i=="Ctrl-[")CodeMirror.e_stop(t),r(),e.focus()}n.type=="keyToEx"?Pt.processCommand(e,n.exArgs.input):t.visualMode?St(e,{onClose:r,prefix:":",value:"'<,'>",onKeyDown:i}):St(e,{onClose:r,prefix:":",onKeyDown:i})},evalInput:function(e,t){var n=t.inputState,r=n.motion,i=n.motionArgs||{},s=n.operator,o=n.operatorArgs||{},u=n.registerName,a=e.getCursor("head"),f=e.getCursor("anchor"),l=q(a),c=q(l),h,p;s&&this.recordLastEdit(t,n),n.repeatOverride!==undefined?p=n.repeatOverride:p=n.getRepeat();if(p>0&&i.explicitRepeat)i.repeatIsExplicit=!0;else if(i.noRepeat||!i.explicitRepeat&&p===0)p=1,i.repeatIsExplicit=!1;n.selectedCharacter&&(i.selectedCharacter=o.selectedCharacter=n.selectedCharacter),i.repeat=p,t.inputState=new k;if(r){var d=M[r](e,i,t);t.lastMotion=M[r];if(!d)return;if(i.toJumplist){var v=T.jumpList,m=v.cachedCursor;m?(Z(e,m,d),delete v.cachedCursor):Z(e,c,d)}d instanceof Array?(l=d[0],h=d[1]):h=d,h||(h={ch:l.ch,line:l.line});if(t.visualMode){U(f,a)&&(R(f,h)||U(h,f))?f.ch+=1:U(a,f)&&(R(f,h)||U(f,h))&&(f.ch-=1),a=h;if(
t.visualLine)if(U(f,a)){f.ch=0;var g=e.lastLine();a.line>g&&(a.line=g),a.ch=W(e,a.line)}else a.ch=0,f.ch=W(e,f.line);e.setSelection(f,a),at(e,t,"<",U(f,a)?f:a),at(e,t,">",U(f,a)?a:f)}else s||(h=H(e,h),e.setCursor(h.line,h.ch))}if(s){var y=!1;t.lastMotion=null,o.repeat=p,t.visualMode&&(l=f,h=a,i.inclusive=!0);if(U(h,l)){var b=l;l=h,h=b,y=!0}i.inclusive&&(!t.visualMode||!y)&&h.ch++;var w=i.linewise||t.visualMode&&t.visualLine;w?Q(e,l,h):i.forward&&K(e,l,h),o.registerName=u,o.linewise=w,_[s](e,o,t,l,h,c),t.visualMode&&J(e)}},recordLastEdit:function(e,t,n){var r=T.macroModeState;if(r.inReplay)return;e.lastEditInputState=t,e.lastEditActionCommand=n,r.lastInsertModeChanges.changes=[],r.lastInsertModeChanges.expectCursorActivityForChange=!1}},M={moveToTopLine:function(e,t){var n=Ot(e).top+t.repeat-1;return{line:n,ch:G(e.getLine(n))}},moveToMiddleLine:function(e){var t=Ot(e),n=Math.floor((t.top+t.bottom)*.5);return{line:n,ch:G(e.getLine(n))}},moveToBottomLine:function(e,t){var n=Ot(e).bottom-t.repeat+1;return{line:n,ch:G(e.getLine(n))}},expandToLine:function(e,t){var n=e.getCursor();return{line:n.line+t.repeat-1,ch:Infinity}},findNext:function(e,t){var n=vt(e),r=n.getQuery();if(!r)return;var i=!t.forward;return i=n.isReversed()?!i:i,Ct(e,r),kt(e,i,r,t.repeat)},goToMark:function(e,t,n){var r=n.marks[t.selectedCharacter];return r?r.find():null},jumpToMark:function(e,t,n){var r=e.getCursor();for(var i=0;i<t.repeat;i++){var s=r;for(var o in n.marks){if(!v(o))continue;var u=n.marks[o].find(),a=t.forward?U(u,s):U(s,u);if(a)continue;if(t.linewise&&u.line==s.line)continue;var f=R(s,r),l=t.forward?z(s,u,r):z(r,u,s);if(f||l)r=u}}return t.linewise&&(r.ch=G(e.getLine(r.line))),r},moveByCharacters:function(e,t){var n=e.getCursor(),r=t.repeat,i=t.forward?n.ch+r:n.ch-r;return{line:n.line,ch:i}},moveByLines:function(e,t,n){var r=e.getCursor(),i=r.ch;switch(n.lastMotion){case this.moveByLines:case this.moveByDisplayLines:case this.moveByScroll:case this.moveToColumn:case this.moveToEol:i=n.lastHPos;break;default:n.lastHPos=i}var s=t.repeat+(t.repeatOffset||0),o=t.forward?r.line+s:r.line-s,u=e.firstLine(),a=e.lastLine();if(o<u&&r.line==u||o>a&&r.line==a)return;return t.toFirstChar&&(i=G(e.getLine(o)),n.lastHPos=i),n.lastHSPos=e.charCoords({line:o,ch:i},"div").left,{line:o,ch:i}},moveByDisplayLines:function(e,t,n){var r=e.getCursor();switch(n.lastMotion){case this.moveByDisplayLines:case this.moveByScroll:case this.moveByLines:case this.moveToColumn:case this.moveToEol:break;default:n.lastHSPos=e.charCoords(r,"div").left}var i=t.repeat,s=e.findPosV(r,t.forward?i:-i,"line",n.lastHSPos);if(s.hitSide)if(t.forward)var o=e.charCoords(s,"div"),u={top:o.top+8,left:n.lastHSPos},s=e.coordsChar(u,"div");else{var a=e.charCoords({line:e.firstLine(),ch:0},"div");a.left=n.lastHSPos,s=e.coordsChar(a,"div")}return n.lastHPos=s.ch,s},moveByPage:function(e,t){var n=e.getCursor(),r=t.repeat;e.moveV(t.forward?r:-r,"page");var i=e.getCursor();return e.setCursor(n),i},moveByParagraph:function(e,t){var n=e.getCursor().line,r=t.repeat,i=t.forward?1:-1;for(var s=0;s<r;s++){if(!t.forward&&n===e.firstLine()||t.forward&&n==e.lastLine())break;n+=i;while(n!==e.firstLine()&&n!=e.lastLine()&&e.getLine(n))n+=i}return{line:n,ch:0}},moveByScroll:function(e,t,n){var r=e.getScrollInfo(),i=null,s=t.repeat;s||(s=r.clientHeight/(2*e.defaultTextHeight()));var o=e.charCoords(e.getCursor(),"local");t.repeat=s;var i=M.moveByDisplayLines(e,t,n);if(!i)return null;var u=e.charCoords(i,"local");return e.scrollTo(null,r.top+u.top-o.top),i},moveByWords:function(e,t){return st(e,t.repeat,!!t.forward,!!t.wordEnd,!!t.bigWord)},moveTillCharacter:function(e,t){var n=t.repeat,r=ot(e,n,t.forward,t.selectedCharacter),i=t.forward?-1:1;return et(i,t),r?(r.ch+=i,r):e.getCursor()},moveToCharacter:function(e,t){var n=t.repeat;return et(0,t),ot(e,n,t.forward,t.selectedCharacter)||e.getCursor()},moveToSymbol:function(e,t){var n=t.repeat;return rt(e,n,t.forward,t.selectedCharacter)||e.getCursor()},moveToColumn:function(e,t,n){var r=t.repeat;return n.lastHPos=r-1,n.lastHSPos=e.charCoords(e.getCursor(),"div").left,ut(e,r)},moveToEol:function(e,t,n){var r=e.getCursor();n.lastHPos=Infinity;var i={line:r.line+t.repeat-1,ch:Infinity},s=e.clipPos(i);return s.ch--,n.lastHSPos=e.charCoords(s,"div").left,i},moveToFirstNonWhiteSpaceCharacter:function(e){var t=e.getCursor();return{line:t.line,ch:G(e.getLine(t.line))}},moveToMatchedSymbol:function(e){var t=e.getCursor(),n=t.line,r=t.ch,i=e.getLine(n),s,o=e.getTokenAt(t).type,u=lt(o);do{s=i.charAt(r++);if(s&&m(s)){var a=e.getTokenAt({line:n,ch:r}).type,f=lt(a);if(u>=f)break}}while(s);return s?ct(e,{line:n,ch:r-1},s):t},moveToStartOfLine:function(e){var t=e.getCursor();return{line:t.line,ch:0}},moveToLineOrEdgeOfDocument:function(e,t){var n=t.forward?e.lastLine():e.firstLine();return t.repeatIsExplicit&&(n=t.repeat-e.getOption("firstLineNumber")),{line:n,ch:G(e.getLine(n))}},textObjectManipulation:function(e,t){var n=t.selectedCharacter,r=!t.textObjectInner;if(!P[n])return null;var i=P[n](e,r),s=i.start,o=i.end;return[s,o]},repeatLastCharacterSearch:function(e,t){var n=T.lastChararacterSearch,r=t.repeat,i=t.forward===n.forward,s=(n.increment?1:0)*(i?-1:1);e.moveH(-s,"char"),t.inclusive=i?!0:!1;var o=ot(e,r,i,n.selectedCharacter);return o?(o.ch+=s,o):(e.moveH(s,"char"),e.getCursor())}},_={change:function(e,t,n,r,i){T.registerController.pushText(t.registerName,"change",e.getRange(r,i),t.linewise);if(t.linewise){var s=i.line>e.lastLine()?"":"\n";e.replaceRange(s,r,i),e.indentLine(r.line,"smart"),r.ch=null}else{var o=e.getRange(r,i);if(!b(o)){var u=/\s+$/.exec(o);u&&(i=j(i,0,-u[0].length))}e.replaceRange("",r,i)}D.enterInsertMode(e,{},e.state.vim),e.setCursor(r)},"delete":function(e,t,n,r,i){t.linewise&&i.line>e.lastLine()&&r.line>e.firstLine()&&(r.line--,r.ch=W(e,r.line)),T.registerController.pushText(t.registerName,"delete",e.getRange(r,i),t.linewise),e.replaceRange("",r,i),t.linewise?e.setCursor(M.moveToFirstNonWhiteSpaceCharacter(e)):e.setCursor(r)},indent:function(e,t,n,r,i){var s=r.line,o=i.line,u=n.visualMode?t.repeat:1;t.linewise&&o--;for(var a=s;a<=o;a++)for(var f=0;f<u;f++)e.indentLine(a,t.indentRight);e.setCursor(r),e.setCursor(M.moveToFirstNonWhiteSpaceCharacter(e))},swapcase:function(e,t,n,r,i,s){var o=e.getRange(r,i),u="";for(var a=0;a<o.length;a++){var f=o.charAt(a);u+=y(f)?f.toLowerCase():f.toUpperCase()}e.replaceRange(u,r,i),t.shouldMoveCursor||e.setCursor(s)},yank:function(e,t,n,r,i,s){T.registerController.pushText(t.registerName,"yank",e.getRange(r,i),t.linewise),e.setCursor(s)}},D={jumpListWalk:function(e,t,n){if(n.visualMode)return;var r=t.repeat,i=t.forward,s=T.jumpList,o=s.move(e,i?r:-r),u=o?o.find():undefined;u=u?u:e.getCursor(),e.setCursor(u)},scrollToCursor:function(e,t){var n=e.getCursor().line,r=e.charCoords({line:n,ch:0},"local"),i=e.getScrollInfo().clientHeight,s=r.top,o=r.bottom-s;switch(t.position){case"center":s=s-i/2+o;break;case"bottom":s=s-i+o*1.4;break;case"top":s+=o*.4}e.scrollTo(null,s)},replayMacro:function(e,t){var n=t.selectedCharacter,r=t.repeat,i=T.macroModeState;n=="@"&&(n=i.latestRegister);var s=Ft(i,n);while(r--)Rt(e,i,s)},exitMacroRecordMode:function(){var e=T.macroModeState;e.toggle(),It(e.latestRegister,e.macroKeyBuffer)},enterMacroRecordMode:function(e,t){var n=T.macroModeState,r=t.selectedCharacter;n.toggle(e,r),qt(n)},enterInsertMode:function(e,t,n){if(e.getOption("readOnly"))return;n.insertMode=!0,n.insertModeRepeat=t&&t.repeat||1;var r=t?t.insertAt:null;if(r=="eol"){var i=e.getCursor();i={line:i.line,ch:W(e,i.line)},e.setCursor(i)}else r=="charAfter"?e.setCursor(j(e.getCursor(),0,1)):r=="firstNonBlank"&&e.setCursor(M.moveToFirstNonWhiteSpaceCharacter(e));e.setOption("keyMap","vim-insert"),t&&t.replace?(e.toggleOverwrite(!0),e.setOption("keyMap","vim-replace"),CodeMirror.signal(e,"vim-mode-change",{mode:"replace"})):(e.setOption("keyMap","vim-insert"),CodeMirror.signal(e,"vim-mode-change",{mode:"insert"})),T.macroModeState.inReplay||(e.on("change",zt),e.on("cursorActivity",Wt),CodeMirror.on(e.getInputField(),"keydown",Vt))},toggleVisualMode:function(e,t,n){var r=t.repeat,i=e.getCursor(),s;n.visualMode?(i=e.getCursor("anchor"),s=e.getCursor("head"),!n.visualLine&&t.linewise?(n.visualLine=!0,i.ch=U(i,s)?0:W(e,i.line),s.ch=U(i,s)?W(e,s.line):0,e.setSelection(i,s),CodeMirror.signal(e,"vim-mode-change",{mode:"visual",subMode:"linewise"})):n.visualLine&&!t.linewise?(n.visualLine=!1,CodeMirror.signal(e,"vim-mode-change",{mode:"visual"})):J(e)):(e.on("mousedown",J),n.visualMode=!0,n.visualLine=!!t.linewise,n.visualLine?(i.ch=0,s=H(e,{line:i.line+r-1,ch:W(e,i.line)},!0)):s=H(e,{line:i.line,ch:i.ch+r},!0),!t.repeatIsExplicit&&!n.visualLine?(e.setCursor(s),e.setSelection(s,i)):e.setSelection(i,s),CodeMirror.signal(e,"vim-mode-change",{mode:"visual",subMode:n.visualLine?"linewise":""})),at(e,n,"<",U(i,s)?i:s),at(e,n,">",U(i,s)?s:i)},joinLines:function(e,t,n){var r,i;if(n.visualMode)r=e.getCursor("anchor"),i=e.getCursor("head"),i.ch=W(e,i.line)-1;else{var s=Math.max(t.repeat,2);r=e.getCursor(),i=H(e,{line:r.line+s-1,ch:Infinity})}var o=0;e.operation(function(){for(var t=r.line;t<i.line;t++){o=W(e,r.line);var n={line:r.line+1,ch:W(e,r.line+1)},s=e.getRange(r,n);s=s.replace(/\n\s*/g," "),e.replaceRange(s,r,n)}var u={line:r.line,ch:o};e.setCursor(u)})},newLineAndEnterInsertMode:function(e,t,n){n.insertMode=!0;var r=e.getCursor();if(r.line===e.firstLine()&&!t.after)e.replaceRange("\n",{line:e.firstLine(),ch:0}),e.setCursor(e.firstLine(),0);else{r.line=t.after?r.line:r.line-1,r.ch=W(e,r.line),e.setCursor(r);var i=CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent;i(e)}this.enterInsertMode(e,{repeat:t.repeat},n)},paste:function(e,t){var n=e.getCursor(),r=T.registerController.getRegister(t.registerName);if(!r.text)return;for(var i="",s=0;s<t.repeat;s++)i+=r.text;var o=r.linewise;o?t.after?(i="\n"+i.slice(0,i.length-1),n.ch=W(e,n.line)):n.ch=0:n.ch+=t.after?1:0,e.replaceRange(i,n);var u,a;o&&t.after?u={line:n.line+1,ch:G(e.getLine(n.line+1))}:o&&!t.after?u={line:n.line,ch:G(e.getLine(n.line))}:!o&&t.after?(a=e.indexFromPos(n),u=e.posFromIndex(a+i.length-1)):(a=e.indexFromPos(n),u=e.posFromIndex(a+i.length)),e.setCursor(u)},undo:function(e,t){e.operation(function(){I(e,CodeMirror.commands.undo,t.repeat)(),e.setCursor(e.getCursor("anchor"))})},redo:function(e,t){I(e,CodeMirror.commands.redo,t.repeat)()},setRegister:function(e,t,n){n.inputState.registerName=t.selectedCharacter},setMark:function(e,t,n){var r=t.selectedCharacter;at(e,n,r,e.getCursor())},replace:function(e,t,n){var r=t.selectedCharacter,i=e.getCursor(),s,o;if(n.visualMode)i=e.getCursor("start"),o=e.getCursor("end"),o=e.clipPos({line:o.line,ch:o.ch+1});else{var u=e.getLine(i.line);s=i.ch+t.repeat,s>u.length&&(s=u.length),o={line:i.line,ch:s}}if(r=="\n")n.visualMode||e.replaceRange("",i,o),(CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent)(e);else{var a=e.getRange(i,o);a=a.replace(/[^\n]/g,r),e.replaceRange(a,i,o),n.visualMode?(e.setCursor(i),J(e)):e.setCursor(j(o,0,-1))}},incrementNumberToken:function(e,t){var n=e.getCursor(),r=e.getLine(n.line),i=/-?\d+/g,s,o,u,a,f;while((s=i.exec(r))!==null){f=s[0],o=s.index,u=o+f.length;if(n.ch<u)break}if(!t.backtrack&&u<=n.ch)return;if(!f)return;var l=t.increase?1:-1,c=parseInt(f)+l*t.repeat,h={ch:o,line:n.line},p={ch:u,line:n.line};a=c.toString(),e.replaceRange(a,h,p),e.setCursor({line:n.line,ch:o+a.length-1})},repeatLastEdit:function(e,t,n){var r=n.lastEditInputState;if(!r)return;var i=t.repeat;i&&t.repeatIsExplicit?n.lastEditInputState.repeatOverride=i:i=n.lastEditInputState.repeatOverride||i,$t(e,n,i,!1)}},P={w:function(e,t){return Y(e,t,!0,!1)},W:function(e,t){return Y(e,t,!0,!0)},"{":function(e,t){return ht(e,"}",t)},"(":function(e,t){return ht(e,")",t)},"[":function(e,t){return ht(e,"]",t)},"'":function(e,t){return pt(e,"'",t)},'"':function(e,t){return pt(e,'"',t)}},tt={"(":"bracket",")":"bracket","{":"bracket","}":"bracket","[":"section","]":"section","*":"comment","/":"comment",m:"method",M:"method","#":"preprocess"},nt={bracket:{isComplete:function(e){if(e.nextCh===e.symb){e.depth++;if(e.depth>=1)return!0}else e.nextCh===e.reverseSymb&&e.depth--;return!1}},section:{init:function(e){e.curMoveThrough=!0,e.symb=(e.forward?"]":"[")===e.symb?"{":"}"},isComplete:function(e){return e.index===0&&e.nextCh===e.symb}},comment:{isComplete:function(e){var t=e.lastCh==="*"&&e.nextCh==="/";return e.lastCh=e.nextCh,t}},method:{init:function(e){e.symb=e.symb==="m"?"{":"}",e.reverseSymb=e.symb==="{"?"}":"{"},isComplete:function(e){return e.nextCh===e.symb?!0:!1}},preprocess:{init:function(e){e.index=0},isComplete:function(e){if(e.nextCh==="#"){var t=e.lineText.match(/#(\w+)/)[1];if(t==="endif"){if(e.forward&&e.depth===0)return!0;e.depth++}else if(t==="if"){if(!e.forward&&e.depth===0)return!0;e.depth--}if(t==="else"&&e.depth===0)return!0}return!1}}};dt.prototype={getQuery:function(){return T.query},setQuery:function(e){T.query=e},getOverlay:function(){return this.searchOverlay},setOverlay:function(e){this.searchOverlay=e},isReversed:function(){return T.isReversed},setReversed:function(e){T.isReversed=e}};var Et="(Javascript regexp)",Mt=[{name:"map",type:"builtIn"},{name:"write",shortName:"w",type:"builtIn"},{name:"undo",shortName:"u",type:"builtIn"},{name:"redo",shortName:"red",type:"builtIn"},{name:"sort",shortName:"sor",type:"builtIn"},{name:"substitute",shortName:"s",type:"builtIn"},{name:"nohlsearch",shortName:"noh",type:"builtIn"},{name:"delmarks",shortName:"delm",type:"builtin"}];t.ExCommandDispatcher=function(){this.buildCommandMap_()},t.ExCommandDispatcher.prototype={processCommand:function(e,t){var n=e.state.vim;n.visualMode&&J(e);var r=new CodeMirror.StringStream(t),i={};i.input=t;try{this.parseInput_(e,r,i)}catch(s){bt(e,s);return}var o;if(!i.commandName)i.line!==undefined&&(o="move");else{var u=this.matchCommand_(i.commandName);if(u){o=u.name,this.parseCommandArgs_(r,i,u);if(u.type=="exToKey"){for(var a=0;a<u.toKeys.length;a++)CodeMirror.Vim.handleKey(e,u.toKeys[a]);return}if(u.type=="exToEx"){this.processCommand(e,u.toInput);return}}}if(!o){bt(e,'Not an editor command ":'+t+'"');return}try{Dt[o](e,i)}catch(s){bt(e,s)}},parseInput_:function(e,t,n){t.eatWhile(":"),t.eat("%")?(n.line=e.firstLine(),n.lineEnd=e.lastLine()):(n.line=this.parseLineSpec_(e,t),n.line!==undefined&&t.eat(",")&&(n.lineEnd=this.parseLineSpec_(e,t)));var r=t.match(/^(\w+)/);return r?n.commandName=r[1]:n.commandName=t.match(/.*/)[0],n},parseLineSpec_:function(e,t){var n=t.match(/^(\d+)/);if(n)return parseInt(n[1],10)-1;switch(t.next()){case".":return e.getCursor().line;case"$":return e.lastLine();case"'":var r=e.state.vim.marks[t.next()];if(r&&r.find())return r.find().line;throw new Error("Mark not set");default:return t.backUp(1),undefined}},parseCommandArgs_:function(e,t,n){if(e.eol())return;t.argString=e.match(/.*/)[0];var r=n.argDelimiter||/\s+/,i=V(t.argString).split(r);i.length&&i[0]&&(t.args=i)},matchCommand_:function(e){for(var t=e.length;t>0;t--){var n=e.substring(0,t);if(this.commandMap_[n]){var r=this.commandMap_[n];if(r.name.indexOf(e)===0)return r}}return null},buildCommandMap_:function(){this.commandMap_={};for(var e=0;e<Mt.length;e++){var t=Mt[e],n=t.shortName||t.name;this.commandMap_[n]=t}},map:function(t,n){if(t!=":"&&t.charAt(0)==":"){var r=t.substring(1);n!=":"&&n.charAt(0)==":"?this.commandMap_[r]={name:r,type:"exToEx",toInput:n.substring(1)}:this.commandMap_[r]={name:r,type:"exToKey",toKeys:_t(n)}}else n!=":"&&n.charAt(0)==":"?e.unshift({keys:_t(t),type:"keyToEx",exArgs:{input:n.substring(1)}}):e.unshift({keys:_t(t),type:"keyToKey",toKeys:_t(n)})}};var Dt={map:function(e,t){var n=t.args;if(!n||n.length<2){e&&bt(e,"Invalid mapping: "+t.input);return}Pt.map(n[0],n[1],e)},move:function(e,t){O.processCommand(e,e.state.vim,{type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:!1,explicitRepeat:!0,linewise:!0},repeatOverride:t.line+1})},sort:function(e,t){function o(){if(t.argString){var e=new CodeMirror.StringStream(t.argString);e.eat("!")&&(n=!0);if(e.eol())return;if(!e.eatSpace())throw new Error("invalid arguments "+e.match(/.*/)[0]);var o=e.match(/[a-z]+/);if(o){o=o[0],r=o.indexOf("i")!=-1,i=o.indexOf("u")!=-1;var u=o.indexOf("d")!=-1&&1,a=o.indexOf("x")!=-1&&1,f=o.indexOf("o")!=-1&&1;if(u+a+f>1)throw new Error("invalid arguments");s=u&&"decimal"||a&&"hex"||f&&"octal"}if(e.eatSpace()&&e.match(/\/.*\//))throw new Error("patterns not supported")}}function g(e,t){if(n){var i;i=e,e=t,t=i}r&&(e=e.toLowerCase(),t=t.toLowerCase());var o=s&&h.exec(e),u=s&&h.exec(t);return o?(o=parseInt((o[1]+o[2]).toLowerCase(),p),u=parseInt((u[1]+u[2]).toLowerCase(),p),o-u):e<t?-1:1}var n,r,i,s;o();var u=t.line||e.firstLine(),a=t.lineEnd||t.line||e.lastLine();if(u==a)return;var f={line:u,ch:0},l={line:a,ch:W(e,a)},c=e.getRange(f,l).split("\n"),h=s=="decimal"?/(-?)([\d]+)/:s=="hex"?/(-?)(?:0x)?([0-9a-f]+)/i:s=="octal"?/([0-7]+)/:null,p=s=="decimal"?10:s=="hex"?16:s=="octal"?8:null,d=[],v=[];if(s)for(var m=0;m<c.length;m++)h.exec(c[m])?d.push(c[m]):v.push(c[m]);else v=c;d.sort(g),v.sort(g),c=n?d.concat(v):v.concat(d);if(i){var y=c,b;c=[];for(var m=0;m<y.length;m++)y[m]!=b&&c.push(y[m]),b=y[m]}e.replaceRange(c.join("\n"),f,l)},substitute:function(e,t){if(!e.getSearchCursor)throw new Error("Search feature not available. Requires searchcursor.js or any other getSearchCursor implementation.");var n=t.argString,r=gt(n);if(r[0]!==0){bt(e,"Substitutions should be of the form :s/pattern/replace/");return}var i=n.substring(r[0]+1,r[1]),s="",o,u,a=!1;r[1]&&(s=n.substring(r[1]+1,r[2]));if(r[2]){var f=n.substring(r[2]+1).split(" ");o=f[0],u=parseInt(f[1])}o&&(o.indexOf("c")!=-1&&(a=!0,o.replace("c","")),i=i+"/"+o);if(i)try{Tt(e,i,!0,!0)}catch(l){bt(e,"Invalid regex: "+i);return}var c=vt(e),h=c.getQuery(),p=t.line!==undefined?t.line:e.getCursor().line,d=t.lineEnd||p;u&&(p=d,d=p+u-1);var v=H(e,{line:p,ch:0}),m=e.getSearchCursor(h,v);Ht(e,a,p,d,m,h,s)},redo:CodeMirror.commands.redo,undo:CodeMirror.commands.undo,write:function(e){CodeMirror.commands.save?CodeMirror.commands.save(e):e.save()},nohlsearch:function(e){Lt(e)},delmarks:function(e,t){if(!t.argString||!t.argString.trim()){bt(e,"Argument required");return}var n=e.state.vim,r=new CodeMirror.StringStream(t.argString.trim());while(!r.eol()){r.eatSpace();var i=r.pos;if(!r.match(/[a-zA-Z]/,!1)){bt(e,"Invalid argument: "+t.argString.substring(i));return}var s=r.next();if(r.match("-",!0)){if(!r.match(/[a-zA-Z]/,!1)){bt(e,"Invalid argument: "+t.argString.substring(i));return}var o=s,u=r.next();if(!(v(o)&&v(u)||y(o)&&y(u))){bt(e,"Invalid argument: "+o+"-");return}var a=o.charCodeAt(0),f=u.charCodeAt(0);if(a>=f){bt(e,"Invalid argument: "+t.argString.substring(i));return}for(var l=0;l<=f-a;l++){var c=String.fromCharCode(a+l);delete n.marks[c]}}else delete n.marks[s]}}},Pt=new t.ExCommandDispatcher;return CodeMirror.keyMap.vim=Bt(),CodeMirror.keyMap["vim-insert"]={Esc:jt,"Ctrl-[":jt,"Ctrl-C":jt,"Ctrl-N":"autocomplete","Ctrl-P":"autocomplete",Enter:function(e){var t=CodeMirror.commands.newlineAndIndentContinueComment||CodeMirror.commands.newlineAndIndent;t(e)},fallthrough:["default"]},CodeMirror.keyMap["vim-replace"]={Backspace:"goCharLeft",fallthrough:["vim-insert"]},N(),C};CodeMirror.Vim=t()})();