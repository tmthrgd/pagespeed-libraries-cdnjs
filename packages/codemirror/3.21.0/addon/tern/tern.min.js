// Glue code between CodeMirror and Tern.
//
// Create a CodeMirror.TernServer to wrap an actual Tern server,
// register open documents (CodeMirror.Doc instances) with it, and
// call its methods to activate the assisting functions that Tern
// provides.
//
// Options supported (all optional):
// * defs: An array of JSON definition data structures.
// * plugins: An object mapping plugin names to configuration
//   options.
// * getFile: A function(name, c) that can be used to access files in
//   the project that haven't been loaded yet. Simply do c(null) to
//   indicate that a file is not available.
// * fileFilter: A function(value, docName, doc) that will be applied
//   to documents before passing them on to Tern.
// * switchToDoc: A function(name) that should, when providing a
//   multi-file view, switch the view or focus to the named file.
// * showError: A function(editor, message) that can be used to
//   override the way errors are displayed.
// * completionTip: Customize the content in tooltips for completions.
//   Is passed a single argument—the completion's data as returned by
//   Tern—and may return a string, DOM node, or null to indicate that
//   no tip should be shown. By default the docstring is shown.
// * typeTip: Like completionTip, but for the tooltips shown for type
//   queries.
// * responseFilter: A function(doc, query, request, error, data) that
//   will be applied to the Tern responses before treating them
//
//
// It is possible to run the Tern server in a web worker by specifying
// these additional options:
// * useWorker: Set to true to enable web worker mode. You'll probably
//   want to feature detect the actual value you use here, for example
//   !!window.Worker.
// * workerScript: The main script of the worker. Point this to
//   wherever you are hosting worker.js from this directory.
// * workerDeps: An array of paths pointing (relative to workerScript)
//   to the Acorn and Tern libraries and any Tern plugins you want to
//   load. Or, if you minified those into a single script and included
//   them in the workerScript, simply leave this undefined.
(function(){"use strict";function r(e,t,n){var r=e.docs[t];r?n(_(e,r)):e.options.getFile?e.options.getFile(t,n):n(null)}function i(e,t,n){for(var r in e.docs){var i=e.docs[r];if(i.doc==t)return i}if(!n)for(var s=0;;++s){r="[doc"+(s||"")+"]";if(!e.docs[r]){n=r;break}}return e.addDoc(n,t)}function s(e,t,r){var s=i(e,t),u=e.cachedArgHints;u&&u.doc==t&&x(u.start,r.to)<=0&&(e.cachedArgHints=null);var a=s.changed;a==null&&(s.changed=a={from:r.from.line,to:r.from.line});var f=r.from.line+(r.text.length-1);r.from.line<a.to&&(a.to=a.to-(r.to.line-f)),f>=a.to&&(a.to=f+1),a.from>r.from.line&&(a.from=r.from.line),t.lineCount()>n&&r.to-a.from>100&&setTimeout(function(){s.changed&&s.changed.to-s.changed.from>100&&o(e,s)},200)}function o(e,t){e.server.request({files:[{type:"full",name:t.name,text:_(e,t)}]},function(e){e?console.error(e):t.changed=null})}function u(n,r,i){n.request(r,{type:"completions",types:!0,docs:!0,urls:!0},function(s,o){if(s)return O(n,r,s);var u=[],f="",l=o.start,c=o.end;r.getRange(e(l.line,l.ch-2),l)=='["'&&r.getRange(c,e(c.line,c.ch+2))!='"]'&&(f='"]');for(var h=0;h<o.completions.length;++h){var p=o.completions[h],d=a(p.type);o.guess&&(d+=" "+t+"guess"),u.push({text:p.name+f,displayText:p.name,className:d,data:p})}var v={from:l,to:c,list:u},m=null;CodeMirror.on(v,"close",function(){L(m)}),CodeMirror.on(v,"update",function(){L(m)}),CodeMirror.on(v,"select",function(e,r){L(m);var i=n.options.completionTip?n.options.completionTip(e.data):e.data.doc;i&&(m=k(r.parentNode.getBoundingClientRect().right+window.pageXOffset,r.getBoundingClientRect().top+window.pageYOffset,i),m.className+=" "+t+"hint-doc")}),i(v)})}function a(e){var n;return e=="?"?n="unknown":e=="number"||e=="string"||e=="bool"?n=e:/^fn\(/.test(e)?n="fn":/^\[/.test(e)?n="array":n="object",t+"completion "+t+"completion-"+n}function f(e,t,n){e.request(t,"type",function(n,r){if(n)return O(e,t,n);if(e.options.typeTip)var i=e.options.typeTip(r);else{var i=T("span",null,T("strong",null,r.type||"not found"));r.doc&&i.appendChild(document.createTextNode(" — "+r.doc)),r.url&&(i.appendChild(document.createTextNode(" ")),i.appendChild(T("a",null,"[docs]")).href=r.url)}C(t,i)},n)}function l(t,n){M(t);if(n.somethingSelected())return;var r=n.getTokenAt(n.getCursor()).state,i=CodeMirror.innerMode(n.getMode(),r);if(i.mode.name!="javascript")return;var s=i.state.lexical;if(s.info!="call")return;var o,u=s.pos||0,a=n.getOption("tabSize");for(var f=n.getCursor().line,l=Math.max(0,f-9),p=!1;f>=l;--f){var d=n.getLine(f),v=0;for(var m=0;;){var g=d.indexOf("	",m);if(g==-1)break;v+=a-(g+v)%a-1,m=g+1}o=s.column-v;if(d.charAt(o)=="("){p=!0;break}}if(!p)return;var y=e(f,o),b=t.cachedArgHints;if(b&&b.doc==n.getDoc()&&x(y,b.start)==0)return c(t,n,u);t.request(n,{type:"type",preferFunction:!0,end:y},function(e,r){if(e||!r.type||!/^fn\(/.test(r.type))return;t.cachedArgHints={start:m,type:h(r.type),name:r.exprName||r.name||"fn",guess:r.guess,doc:n.getDoc()},c(t,n,u)})}function c(e,n,r){M(e);var i=e.cachedArgHints,s=i.type,o=T("span",i.guess?t+"fhint-guess":null,T("span",t+"fname",i.name),"(");for(var u=0;u<s.args.length;++u){u&&o.appendChild(document.createTextNode(", "));var a=s.args[u];o.appendChild(T("span",t+"farg"+(u==r?" "+t+"farg-current":""),a.name||"?")),a.type!="?"&&(o.appendChild(document.createTextNode(": ")),o.appendChild(T("span",t+"type",a.type)))}o.appendChild(document.createTextNode(s.rettype?") -> ":")")),s.rettype&&o.appendChild(T("span",t+"type",s.rettype));var f=n.cursorCoords(null,"page");e.activeArgHints=k(f.right+1,f.bottom,o)}function h(e){function r(t){var r=0,i=n;for(;;){var s=e.charAt(n);if(t.test(s)&&!r)return e.slice(i,n);/[{\[\(]/.test(s)?++r:/[}\]\)]/.test(s)&&--r,++n}}var t=[],n=3;if(e.charAt(n)!=")")for(;;){var i=e.slice(n).match(/^([^, \(\[\{]+): /);i&&(n+=i[0].length,i=i[1]),t.push({name:i,type:r(/[\),]/)});if(e.charAt(n)==")")break;n+=2}var s=e.slice(n).match(/^\) -> (.*)$/);return{args:t,rettype:s&&s[1]}}function p(e,t){function n(n){var r={type:"definition",variable:n||null},s=i(e,t.getDoc());e.server.request(E(e,s,r),function(n,r){if(n)return O(e,t,n);if(!r.file&&r.url){window.open(r.url);return}if(r.file){var i=e.docs[r.file],o;if(i&&(o=m(i.doc,r))){e.jumpStack.push({file:s.name,start:t.getCursor("from"),end:t.getCursor("to")}),v(e,s,i,o.start,o.end);return}}O(e,t,"Could not find a definition.")})}g(t)?n():N(t,"Jump to variable",function(e){e&&n(e)})}function d(e,t){var n=e.jumpStack.pop(),r=n&&e.docs[n.file];if(!r)return;v(e,i(e,t.getDoc()),r,n.start,n.end)}function v(e,t,n,r,i){n.doc.setSelection(i,r),t!=n&&e.options.switchToDoc&&(M(e),e.options.switchToDoc(n.name))}function m(t,n){var r=n.context.slice(0,n.contextOffset).split("\n"),i=n.start.line-(r.length-1),s=e(i,(r.length==1?n.start.ch:t.getLine(i).length)-r[0].length),o=t.getLine(i).slice(s.ch);for(var u=i+1;u<t.lineCount()&&o.length<n.context.length;++u)o+="\n"+t.getLine(u);if(o.slice(0,n.context.length)==n.context)return n;var a=t.getSearchCursor(n.context,0,!1),f,l=Infinity;while(a.findNext()){var c=a.from(),h=Math.abs(c.line-s.line)*1e4;h||(h=Math.abs(c.ch-s.ch)),h<l&&(f=c,l=h)}if(!f)return null;r.length==1?f.ch+=r[0].length:f=e(f.line+(r.length-1),r[r.length-1].length);if(n.start.line==n.end.line)var p=e(f.line,f.ch+(n.end.ch-n.start.ch));else var p=e(f.line+(n.end.line-n.start.line),n.end.ch);return{start:f,end:p}}function g(e){var t=e.getCursor("end"),n=e.getTokenAt(t);return n.start<t.ch&&(n.type=="comment"||n.type=="string")?!1:/\w/.test(e.getLine(t.line).slice(Math.max(t.ch-1,0),t.ch+1))}function y(e,t){var n=t.getTokenAt(t.getCursor());/\w/.test(n.string)||O(e,t,"Not at a variable"),N(t,"New name for "+n.string,function(n){e.request(t,{type:"rename",newName:n,fullDocs:!0},function(n,r){if(n)return O(e,t,n);w(e,r.changes)})})}function w(e,t){var n=Object.create(null);for(var r=0;r<t.length;++r){var i=t[r];(n[i.file]||(n[i.file]=[])).push(i)}for(var s in n){var o=e.docs[s],u=n[s];if(!o)continue;u.sort(function(e,t){return x(t.start,e.start)});var a="*rename"+ ++b;for(var r=0;r<u.length;++r){var i=u[r];o.doc.replaceRange(i.text,i.start,i.end,a)}}}function E(t,r,i,s){var o=[],u=0,a=!i.fullDocs;a||delete i.fullDocs,typeof i=="string"&&(i={type:i}),i.lineCharPositions=!0,i.end==null&&(i.end=s||r.doc.getCursor("end"),r.doc.somethingSelected()&&(i.start=r.doc.getCursor("start")));var f=i.start||i.end;if(r.changed)if(r.doc.lineCount()>n&&a!==!1&&r.changed.to-r.changed.from<100&&r.changed.from<=f.line&&r.changed.to>i.end.line){o.push(S(r,f,i.end)),i.file="#0";var u=o[0].offsetLines;i.start!=null&&(i.start=e(i.start.line- -u,i.start.ch)),i.end=e(i.end.line-u,i.end.ch)}else o.push({type:"full",name:r.name,text:_(t,r)}),i.file=r.name,r.changed=null;else i.file=r.name;for(var l in t.docs){var c=t.docs[l];c.changed&&c!=r&&(o.push({type:"full",name:c.name,text:_(t,c)}),c.changed=null)}return{query:i,files:o}}function S(t,n,r){var i=t.doc,s=null,o=null,u,a=4;for(var f=n.line-1,l=Math.max(0,f-50);f>=l;--f){var c=i.getLine(f),h=c.search(/\bfunction\b/);if(h<0)continue;var p=CodeMirror.countColumn(c,null,a);if(s!=null&&s<=p)continue;s=p,o=f}o==null&&(o=l);var d=Math.min(i.lastLine(),r.line+20);if(s==null||s==CodeMirror.countColumn(i.getLine(n.line),null,a))u=d;else for(u=r.line+1;u<d;++u){var p=CodeMirror.countColumn(i.getLine(u),null,a);if(p<=s)break}var v=e(o,0);return{type:"part",name:t.name,offsetLines:v.line,text:i.getRange(v,e(u,0))}}function x(e,t){return e.line-t.line||e.ch-t.ch}function T(e,t){var n=document.createElement(e);t&&(n.className=t);for(var r=2;r<arguments.length;++r){var i=arguments[r];typeof i=="string"&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function N(e,t,n){e.openDialog?e.openDialog(t+": <input type=text>",n):n(prompt(t,""))}function C(e,t){function i(){if(!r.parentNode)return;e.off("cursorActivity",i),A(r)}var n=e.cursorCoords(),r=k(n.right+1,n.bottom,t);setTimeout(i,1700),e.on("cursorActivity",i)}function k(e,n,r){var i=T("div",t+"tooltip",r);return i.style.left=e+"px",i.style.top=n+"px",document.body.appendChild(i),i}function L(e){var t=e&&e.parentNode;t&&t.removeChild(e)}function A(e){e.style.opacity="0",setTimeout(function(){L(e)},1100)}function O(e,t,n){e.options.showError?e.options.showError(t,n):C(t,String(n))}function M(e){e.activeArgHints&&(L(e.activeArgHints),e.activeArgHints=null)}function _(e,t){var n=t.doc.getValue();return e.options.fileFilter&&(n=e.options.fileFilter(n,t.name,t.doc)),n}function D(e){function s(e,r){r&&(e.id=++n,i[n]=r),t.postMessage(e)}var t=new Worker(e.options.workerScript);t.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps});var n=0,i={};t.onmessage=function(t){var n=t.data;n.type=="getFile"?r(e,n.name,function(e,t){s({type:"getFile",err:String(e),text:t,id:n.id})}):n.type=="debug"?console.log(n.message):n.id&&i[n.id]&&(i[n.id](n.err,n.body),delete i[n.id])},t.onerror=function(e){for(var t in i)i[t](e);i={}},this.addFile=function(e,t){s({type:"add",name:e,text:t})},this.delFile=function(e){s({type:"del",name:e})},this.request=function(e,t){s({type:"req",body:e},t)}}CodeMirror.TernServer=function(e){var t=this;this.options=e||{};var n=this.options.plugins||(this.options.plugins={});n.doc_comment||(n.doc_comment=!0),this.options.useWorker?this.server=new D(this):this.server=new tern.Server({getFile:function(e,n){return r(t,e,n)},async:!0,defs:this.options.defs||[],plugins:n}),this.docs=Object.create(null),this.trackChange=function(e,n){s(t,e,n)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[]},CodeMirror.TernServer.prototype={addDoc:function(e,t){var n={doc:t,name:e,changed:null};return this.server.addFile(e,_(this,n)),CodeMirror.on(t,"change",this.trackChange),this.docs[e]=n},delDoc:function(e){var t=this.docs[e];if(!t)return;CodeMirror.off(t.doc,"change",this.trackChange),delete this.docs[e],this.server.delFile(e)},hideDoc:function(e){M(this);var t=this.docs[e];t&&t.changed&&o(this,t)},complete:function(e){var t=this;CodeMirror.showHint(e,function(e,n){return u(t,e,n)},{async:!0})},getHint:function(e,t){return u(this,e,t)},showType:function(e,t){f(this,e,t)},updateArgHints:function(e){l(this,e)},jumpToDef:function(e){p(this,e)},jumpBack:function(e){d(this,e)},rename:function(e){y(this,e)},request:function(e,t,n,r){var s=this,o=i(this,e.getDoc()),u=E(this,o,t,r);this.server.request(u,function(e,r){!e&&s.options.responseFilter&&(r=s.options.responseFilter(o,t,u,e,r)),n(e,r)})}};var e=CodeMirror.Pos,t="CodeMirror-Tern-",n=250,b=0})();