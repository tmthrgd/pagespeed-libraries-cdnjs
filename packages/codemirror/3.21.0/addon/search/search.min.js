// Define search commands. Depends on dialog.js or another
// implementation of the openDialog method.
// Replace works a little oddly -- it will do the replace on the next
// Ctrl-G (or whatever is bound to findNext) press. You prevent a
// replace by making sure the match is no longer selected when hitting
// Ctrl-G.
(function(){function e(e,t){var n;return typeof e=="string"?(n=e.charAt(0),e=new RegExp("^"+e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),t?"i":"")):e=new RegExp("^(?:"+e.source+")",e.ignoreCase?"i":""),typeof e=="string"?{token:function(t){if(t.match(e))return"searching";t.next(),t.skipTo(e.charAt(0))||t.skipToEnd()}}:{token:function(t){if(t.match(e))return"searching";while(!t.eol()){t.next(),n&&(t.skipTo(n)||t.skipToEnd());if(t.match(e,!1))break}}}}function t(){this.posFrom=this.posTo=this.query=null,this.overlay=null}function n(e){return e.state.search||(e.state.search=new t)}function r(e){return typeof e=="string"&&e==e.toLowerCase()}function i(e,t,n){return e.getSearchCursor(t,n,r(t))}function s(e,t,n,r,i){e.openDialog?e.openDialog(t,i,{value:r}):i(prompt(n,r))}function o(e,t,n,r){e.openConfirm?e.openConfirm(t,r):confirm(n)&&r[0]()}function u(e){var t=e.match(/^\/(.*)\/([a-z]*)$/);return t?new RegExp(t[1],t[2].indexOf("i")==-1?"":"i"):e}function f(t,i){var o=n(t);if(o.query)return l(t,i);s(t,a,"Search for:",t.getSelection(),function(n){t.operation(function(){if(!n||o.query)return;o.query=u(n),t.removeOverlay(o.overlay,r(o.query)),o.overlay=e(o.query),t.addOverlay(o.overlay),o.posFrom=o.posTo=t.getCursor(),l(t,i)})})}function l(e,t){e.operation(function(){var r=n(e),s=i(e,r.query,t?r.posFrom:r.posTo);if(!s.find(t)){s=i(e,r.query,t?CodeMirror.Pos(e.lastLine()):CodeMirror.Pos(e.firstLine(),0));if(!s.find(t))return}e.setSelection(s.from(),s.to()),e.scrollIntoView({from:s.from(),to:s.to()}),r.posFrom=s.from(),r.posTo=s.to()})}function c(e){e.operation(function(){var t=n(e);if(!t.query)return;t.query=null,e.removeOverlay(t.overlay)})}function v(e,t){s(e,h,"Replace:",e.getSelection(),function(n){if(!n)return;n=u(n),s(e,p,"Replace with:","",function(r){if(t)e.operation(function(){for(var t=i(e,n);t.findNext();)if(typeof n!="string"){var s=e.getRange(t.from(),t.to()).match(n);t.replace(r.replace(/\$(\d)/,function(e,t){return s[t]}))}else t.replace(r)});else{c(e);var s=i(e,n,e.getCursor()),u=function(){var t=s.from(),r;if(!(r=s.findNext())){s=i(e,n);if(!(r=s.findNext())||t&&s.from().line==t.line&&s.from().ch==t.ch)return}e.setSelection(s.from(),s.to()),e.scrollIntoView({from:s.from(),to:s.to()}),o(e,d,"Replace?",[function(){a(r)},u])},a=function(e){s.replace(typeof n=="string"?r:r.replace(/\$(\d)/,function(t,n){return e[n]})),u()};u()}})})}var a='Search: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',h='Replace: <input type="text" style="width: 10em"/> <span style="color: #888">(Use /re/ syntax for regexp search)</span>',p='With: <input type="text" style="width: 10em"/>',d="Replace? <button>Yes</button> <button>No</button> <button>Stop</button>";CodeMirror.commands.find=function(e){c(e),f(e)},CodeMirror.commands.findNext=f,CodeMirror.commands.findPrev=function(e){f(e,!0)},CodeMirror.commands.clearSearch=c,CodeMirror.commands.replace=v,CodeMirror.commands.replaceAll=function(e){v(e,!0)}})();