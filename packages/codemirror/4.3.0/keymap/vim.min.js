(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/dialog/dialog"),require("../addon/edit/matchbrackets.js"))}else{if(typeof define=="function"&&define.amd){define(["../lib/codemirror","../addon/search/searchcursor","../addon/dialog/dialog","../addon/edit/matchbrackets"],a)}else{a(CodeMirror)}}})(function(b){var a=[{keys:["<Left>"],type:"keyToKey",toKeys:["h"]},{keys:["<Right>"],type:"keyToKey",toKeys:["l"]},{keys:["<Up>"],type:"keyToKey",toKeys:["k"]},{keys:["<Down>"],type:"keyToKey",toKeys:["j"]},{keys:["<Space>"],type:"keyToKey",toKeys:["l"]},{keys:["<BS>"],type:"keyToKey",toKeys:["h"]},{keys:["<C-Space>"],type:"keyToKey",toKeys:["W"]},{keys:["<C-BS>"],type:"keyToKey",toKeys:["B"]},{keys:["<S-Space>"],type:"keyToKey",toKeys:["w"]},{keys:["<S-BS>"],type:"keyToKey",toKeys:["b"]},{keys:["<C-n>"],type:"keyToKey",toKeys:["j"]},{keys:["<C-p>"],type:"keyToKey",toKeys:["k"]},{keys:["<C-[>"],type:"keyToKey",toKeys:["<Esc>"]},{keys:["<C-c>"],type:"keyToKey",toKeys:["<Esc>"]},{keys:["s"],type:"keyToKey",toKeys:["c","l"],context:"normal"},{keys:["s"],type:"keyToKey",toKeys:["x","i"],context:"visual"},{keys:["S"],type:"keyToKey",toKeys:["c","c"],context:"normal"},{keys:["S"],type:"keyToKey",toKeys:["d","c","c"],context:"visual"},{keys:["<Home>"],type:"keyToKey",toKeys:["0"]},{keys:["<End>"],type:"keyToKey",toKeys:["$"]},{keys:["<PageUp>"],type:"keyToKey",toKeys:["<C-b>"]},{keys:["<PageDown>"],type:"keyToKey",toKeys:["<C-f>"]},{keys:["<CR>"],type:"keyToKey",toKeys:["j","^"],context:"normal"},{keys:["H"],type:"motion",motion:"moveToTopLine",motionArgs:{linewise:true,toJumplist:true}},{keys:["M"],type:"motion",motion:"moveToMiddleLine",motionArgs:{linewise:true,toJumplist:true}},{keys:["L"],type:"motion",motion:"moveToBottomLine",motionArgs:{linewise:true,toJumplist:true}},{keys:["h"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:false}},{keys:["l"],type:"motion",motion:"moveByCharacters",motionArgs:{forward:true}},{keys:["j"],type:"motion",motion:"moveByLines",motionArgs:{forward:true,linewise:true}},{keys:["k"],type:"motion",motion:"moveByLines",motionArgs:{forward:false,linewise:true}},{keys:["g","j"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:true}},{keys:["g","k"],type:"motion",motion:"moveByDisplayLines",motionArgs:{forward:false}},{keys:["w"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:false}},{keys:["W"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:false,bigWord:true}},{keys:["e"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:true,inclusive:true}},{keys:["E"],type:"motion",motion:"moveByWords",motionArgs:{forward:true,wordEnd:true,bigWord:true,inclusive:true}},{keys:["b"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:false}},{keys:["B"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:false,bigWord:true}},{keys:["g","e"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:true,inclusive:true}},{keys:["g","E"],type:"motion",motion:"moveByWords",motionArgs:{forward:false,wordEnd:true,bigWord:true,inclusive:true}},{keys:["{"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:false,toJumplist:true}},{keys:["}"],type:"motion",motion:"moveByParagraph",motionArgs:{forward:true,toJumplist:true}},{keys:["<C-f>"],type:"motion",motion:"moveByPage",motionArgs:{forward:true}},{keys:["<C-b>"],type:"motion",motion:"moveByPage",motionArgs:{forward:false}},{keys:["<C-d>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:true,explicitRepeat:true}},{keys:["<C-u>"],type:"motion",motion:"moveByScroll",motionArgs:{forward:false,explicitRepeat:true}},{keys:["g","g"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:false,explicitRepeat:true,linewise:true,toJumplist:true}},{keys:["G"],type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:true,explicitRepeat:true,linewise:true,toJumplist:true}},{keys:["0"],type:"motion",motion:"moveToStartOfLine"},{keys:["^"],type:"motion",motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["+"],type:"motion",motion:"moveByLines",motionArgs:{forward:true,toFirstChar:true}},{keys:["-"],type:"motion",motion:"moveByLines",motionArgs:{forward:false,toFirstChar:true}},{keys:["_"],type:"motion",motion:"moveByLines",motionArgs:{forward:true,toFirstChar:true,repeatOffset:-1}},{keys:["$"],type:"motion",motion:"moveToEol",motionArgs:{inclusive:true}},{keys:["%"],type:"motion",motion:"moveToMatchedSymbol",motionArgs:{inclusive:true,toJumplist:true}},{keys:["f","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:true,inclusive:true}},{keys:["F","character"],type:"motion",motion:"moveToCharacter",motionArgs:{forward:false}},{keys:["t","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:true,inclusive:true}},{keys:["T","character"],type:"motion",motion:"moveTillCharacter",motionArgs:{forward:false}},{keys:[";"],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:true}},{keys:[","],type:"motion",motion:"repeatLastCharacterSearch",motionArgs:{forward:false}},{keys:["'","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:true,linewise:true}},{keys:["`","character"],type:"motion",motion:"goToMark",motionArgs:{toJumplist:true}},{keys:["]","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:true}},{keys:["[","`"],type:"motion",motion:"jumpToMark",motionArgs:{forward:false}},{keys:["]","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:true,linewise:true}},{keys:["[","'"],type:"motion",motion:"jumpToMark",motionArgs:{forward:false,linewise:true}},{keys:["]","p"],type:"action",action:"paste",isEdit:true,actionArgs:{after:true,isEdit:true,matchIndent:true}},{keys:["[","p"],type:"action",action:"paste",isEdit:true,actionArgs:{after:false,isEdit:true,matchIndent:true}},{keys:["]","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:true,toJumplist:true}},{keys:["[","character"],type:"motion",motion:"moveToSymbol",motionArgs:{forward:false,toJumplist:true}},{keys:["|"],type:"motion",motion:"moveToColumn",motionArgs:{}},{keys:["o"],type:"motion",motion:"moveToOtherHighlightedEnd",motionArgs:{},context:"visual"},{keys:["d"],type:"operator",operator:"delete"},{keys:["y"],type:"operator",operator:"yank"},{keys:["c"],type:"operator",operator:"change"},{keys:[">"],type:"operator",operator:"indent",operatorArgs:{indentRight:true}},{keys:["<"],type:"operator",operator:"indent",operatorArgs:{indentRight:false}},{keys:["g","~"],type:"operator",operator:"swapcase"},{keys:["n"],type:"motion",motion:"findNext",motionArgs:{forward:true,toJumplist:true}},{keys:["N"],type:"motion",motion:"findNext",motionArgs:{forward:false,toJumplist:true}},{keys:["x"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:true},operatorMotionArgs:{visualLine:false}},{keys:["X"],type:"operatorMotion",operator:"delete",motion:"moveByCharacters",motionArgs:{forward:false},operatorMotionArgs:{visualLine:true}},{keys:["D"],type:"operatorMotion",operator:"delete",motion:"moveToEol",motionArgs:{inclusive:true},operatorMotionArgs:{visualLine:true}},{keys:["Y"],type:"operatorMotion",operator:"yank",motion:"moveToEol",motionArgs:{inclusive:true},operatorMotionArgs:{visualLine:true}},{keys:["C"],type:"operatorMotion",operator:"change",motion:"moveToEol",motionArgs:{inclusive:true},operatorMotionArgs:{visualLine:true}},{keys:["~"],type:"operatorMotion",operator:"swapcase",operatorArgs:{shouldMoveCursor:true},motion:"moveByCharacters",motionArgs:{forward:true}},{keys:["<C-i>"],type:"action",action:"jumpListWalk",actionArgs:{forward:true}},{keys:["<C-o>"],type:"action",action:"jumpListWalk",actionArgs:{forward:false}},{keys:["<C-e>"],type:"action",action:"scroll",actionArgs:{forward:true,linewise:true}},{keys:["<C-y>"],type:"action",action:"scroll",actionArgs:{forward:false,linewise:true}},{keys:["a"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"charAfter"}},{keys:["A"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"eol"}},{keys:["A"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"endOfSelectedArea"},context:"visual"},{keys:["i"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"inplace"}},{keys:["I"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{insertAt:"firstNonBlank"}},{keys:["o"],type:"action",action:"newLineAndEnterInsertMode",isEdit:true,interlaceInsertRepeat:true,actionArgs:{after:true}},{keys:["O"],type:"action",action:"newLineAndEnterInsertMode",isEdit:true,interlaceInsertRepeat:true,actionArgs:{after:false}},{keys:["v"],type:"action",action:"toggleVisualMode"},{keys:["V"],type:"action",action:"toggleVisualMode",actionArgs:{linewise:true}},{keys:["g","v"],type:"action",action:"reselectLastSelection"},{keys:["J"],type:"action",action:"joinLines",isEdit:true},{keys:["p"],type:"action",action:"paste",isEdit:true,actionArgs:{after:true,isEdit:true}},{keys:["P"],type:"action",action:"paste",isEdit:true,actionArgs:{after:false,isEdit:true}},{keys:["r","character"],type:"action",action:"replace",isEdit:true},{keys:["@","character"],type:"action",action:"replayMacro"},{keys:["q","character"],type:"action",action:"enterMacroRecordMode"},{keys:["R"],type:"action",action:"enterInsertMode",isEdit:true,actionArgs:{replace:true}},{keys:["u"],type:"action",action:"undo"},{keys:["u"],type:"action",action:"changeCase",actionArgs:{toLower:true},context:"visual",isEdit:true},{keys:["U"],type:"action",action:"changeCase",actionArgs:{toLower:false},context:"visual",isEdit:true},{keys:["<C-r>"],type:"action",action:"redo"},{keys:["m","character"],type:"action",action:"setMark"},{keys:['"',"character"],type:"action",action:"setRegister"},{keys:["z","z"],type:"action",action:"scrollToCursor",actionArgs:{position:"center"}},{keys:["z","."],type:"action",action:"scrollToCursor",actionArgs:{position:"center"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","t"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"}},{keys:["z","<CR>"],type:"action",action:"scrollToCursor",actionArgs:{position:"top"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["z","-"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"}},{keys:["z","b"],type:"action",action:"scrollToCursor",actionArgs:{position:"bottom"},motion:"moveToFirstNonWhiteSpaceCharacter"},{keys:["."],type:"action",action:"repeatLastEdit"},{keys:["<C-a>"],type:"action",action:"incrementNumberToken",isEdit:true,actionArgs:{increase:true,backtrack:false}},{keys:["<C-x>"],type:"action",action:"incrementNumberToken",isEdit:true,actionArgs:{increase:false,backtrack:false}},{keys:["a","character"],type:"motion",motion:"textObjectManipulation"},{keys:["i","character"],type:"motion",motion:"textObjectManipulation",motionArgs:{textObjectInner:true}},{keys:["/"],type:"search",searchArgs:{forward:true,querySrc:"prompt",toJumplist:true}},{keys:["?"],type:"search",searchArgs:{forward:false,querySrc:"prompt",toJumplist:true}},{keys:["*"],type:"search",searchArgs:{forward:true,querySrc:"wordUnderCursor",wholeWordOnly:true,toJumplist:true}},{keys:["#"],type:"search",searchArgs:{forward:false,querySrc:"wordUnderCursor",wholeWordOnly:true,toJumplist:true}},{keys:["g","*"],type:"search",searchArgs:{forward:true,querySrc:"wordUnderCursor",toJumplist:true}},{keys:["g","#"],type:"search",searchArgs:{forward:false,querySrc:"wordUnderCursor",toJumplist:true}},{keys:[":"],type:"ex"}];var c=b.Pos;var d=function(){b.defineOption("vimMode",false,function(bb,bc){if(bc){bb.setOption("keyMap","vim");bb.setOption("disableInput",true);bb.setOption("showCursorWhenSelecting",false);b.signal(bb,"vim-mode-change",{mode:"normal"});bb.on("cursorActivity",O);z(bb);b.on(bb.getInputField(),"paste",J(bb))}else{if(bb.state.vim){bb.setOption("keyMap","default");bb.setOption("disableInput",false);bb.off("cursorActivity",O);b.off(bb.getInputField(),"paste",J(bb));bb.state.vim=null}}});function J(bb){var bc=bb.state.vim;if(!bc.onPasteFn){bc.onPasteFn=function(){if(!bc.insertMode){bb.setCursor(x(bb.getCursor(),0,1));o.enterInsertMode(bb,{},bc)}}}return bc.onPasteFn}var aG=/[\d]/;var ae=[(/\w/),(/[^\w\s]/)],a1=[(/\S/)];function ad(be,bc){var bd=[];for(var bb=be;bb<be+bc;bb++){bd.push(String.fromCharCode(bb))}return bd}var U=ad(65,26);var aa=ad(97,26);var K=ad(48,10);var h="~`!@#$%^&*()_-+=[{}]\\|/?.,<>:;\"'".split("");var aE=["Left","Right","Up","Down","Space","Backspace","Esc","Home","End","PageUp","PageDown","Enter"];var ap=[].concat(U,aa,K,["<",">"]);var k=[].concat(U,aa,K,["-",'"',".",":","/"]);function e(bb,bc){return bc>=bb.firstLine()&&bc<=bb.lastLine()}function y(bb){return(/^[a-z]$/).test(bb)}function E(bb){return"()[]{}".indexOf(bb)!=-1}function T(bb){return aG.test(bb)}function u(bb){return(/^[A-Z]$/).test(bb)}function H(bb){return(/^\s*$/).test(bb)}function C(bd,bb){for(var bc=0;bc<bb.length;bc++){if(bb[bc]==bd){return true}}return false}var ag={};function av(bc,bb,bd){if(bb===undefined){throw Error("defaultValue is required")}if(!bd){bd="string"}ag[bc]={type:bd,defaultValue:bb};at(bc,bb)}function at(bb,bd){var bc=ag[bb];if(!bc){throw Error("Unknown option: "+bb)}if(bc.type=="boolean"){if(bd&&bd!==true){throw Error("Invalid argument: "+bb+"="+bd)}else{if(bd!==false){bd=true}}}bc.value=bc.type=="boolean"?!!bd:bd}function n(bb){var bc=ag[bb];if(!bc){throw Error("Unknown option: "+bb)}return bc.value}var ac=function(){var bf=100;var bh=-1;var be=0;var bd=0;var bc=new Array(bf);function bg(bi,bk,bl){var bm=bh%bf;var bn=bc[bm];function bj(bq){var bp=++bh%bf;var br=bc[bp];if(br){br.clear()}bc[bp]=bi.setBookmark(bq)}if(bn){var bo=bn.find();if(bo&&!a9(bo,bk)){bj(bk)}}else{bj(bk)}bj(bl);be=bh;bd=bh-bf+1;if(bd<0){bd=0}}function bb(bi,bm){bh+=bm;if(bh>be){bh=be}else{if(bh<bd){bh=bd}}var bn=bc[(bf+bh)%bf];if(bn&&!bn.find()){var bl=bm>0?1:-1;var bk;var bj=bi.getCursor();do{bh+=bl;bn=bc[(bf+bh)%bf];if(bn&&(bk=bn.find())&&!a9(bj,bk)){break}}while(bh<be&&bh>bd)}return bn}return{cachedCursor:undefined,add:bg,move:bb}};var g=function(bb){if(bb){return{changes:bb.changes,expectCursorActivityForChange:bb.expectCursorActivityForChange}}return{changes:[],expectCursorActivityForChange:false}};function ai(){this.latestRegister=undefined;this.isPlaying=false;this.isRecording=false;this.replaySearchQueries=[];this.onRecordingDone=undefined;this.lastInsertModeChanges=g()}ai.prototype={exitMacroRecordMode:function(){var bb=p.macroModeState;bb.onRecordingDone();bb.onRecordingDone=undefined;bb.isRecording=false},enterMacroRecordMode:function(bb,bd){var bc=p.registerController.getRegister(bd);if(bc){bc.clear();this.latestRegister=bd;this.onRecordingDone=bb.openDialog("(recording)["+bd+"]",null,{bottom:true});this.isRecording=true}}};function z(bb){if(!bb.state.vim){bb.state.vim={inputState:new ak(),lastEditInputState:undefined,lastEditActionCommand:undefined,lastHPos:-1,lastHSPos:-1,lastMotion:null,marks:{},fakeCursor:null,insertMode:false,insertModeRepeat:undefined,visualMode:false,visualLine:false,lastSelection:null,lastPastedText:null}}return bb.state.vim}var p;function t(){p={searchQuery:null,searchIsReversed:false,lastSubstituteReplacePart:undefined,jumpList:ac(),macroModeState:new ai,lastChararacterSearch:{increment:0,forward:true,selectedCharacter:""},registerController:new V({}),searchHistoryController:new aL({}),exCommandHistoryController:new aL({})};for(var bb in ag){var bc=ag[bb];bc.value=bc.defaultValue}}var az={buildKeyMap:function(){},getRegisterController:function(){return p.registerController},resetVimGlobalState_:t,getVimGlobalState_:function(){return p},maybeInitVimState_:z,InsertModeKey:aY,map:function(bc,bd,bb){l.map(bc,bd,bb)},setOption:at,getOption:n,defineOption:av,defineEx:function(bb,bd,bc){if(bb.indexOf(bd)!==0){throw new Error('(Vim.defineEx) "'+bd+'" is not a prefix of "'+bb+'", command not registered')}aM[bb]=bc;l.commandMap_[bd]={name:bb,shortName:bd,type:"api"}},handleKey:function(bb,be){var bg;var bc=z(bb);var bf=p.macroModeState;if(bf.isRecording){if(be=="q"){bf.exitMacroRecordMode();i(bb);return}}if(be=="<Esc>"){i(bb);if(bc.visualMode){aC(bb)}return}if(!bc.visualMode&&!a9(bb.getCursor("head"),bb.getCursor("anchor"))){bc.visualMode=true;bc.visualLine=false;b.signal(bb,"vim-mode-change",{mode:"visual"});bb.on("mousedown",aC)}if(be!="0"||(be=="0"&&bc.inputState.getRepeat()===0)){bg=aQ.matchCommand(be,a,bc)}if(!bg){if(T(be)){bc.inputState.pushRepeatDigit(be)}if(bf.isRecording){B(bf,be)}return}if(bg.type=="keyToKey"){for(var bd=0;bd<bg.toKeys.length;bd++){this.handleKey(bb,bg.toKeys[bd])}}else{if(bf.isRecording){B(bf,be)}aQ.processCommand(bb,bc,bg)}},handleEx:function(bb,bc){l.processCommand(bb,bc)}};function ak(){this.prefixRepeat=[];this.motionRepeat=[];this.operator=null;this.operatorArgs=null;this.motion=null;this.motionArgs=null;this.keyBuffer=[];this.registerName=null}ak.prototype.pushRepeatDigit=function(bb){if(!this.operator){this.prefixRepeat=this.prefixRepeat.concat(bb)}else{this.motionRepeat=this.motionRepeat.concat(bb)}};ak.prototype.getRepeat=function(){var bb=0;if(this.prefixRepeat.length>0||this.motionRepeat.length>0){bb=1;if(this.prefixRepeat.length>0){bb*=parseInt(this.prefixRepeat.join(""),10)}if(this.motionRepeat.length>0){bb*=parseInt(this.motionRepeat.join(""),10)}}return bb};function i(bb,bc){bb.state.vim.inputState=new ak();b.signal(bb,"vim-command-done",bc)}function a2(bc,bb){this.clear();this.keyBuffer=[bc||""];this.insertModeChanges=[];this.searchQueries=[];this.linewise=!!bb}a2.prototype={setText:function(bc,bb){this.keyBuffer=[bc||""];this.linewise=!!bb},pushText:function(bc,bb){if(bb){if(!this.linewise){this.keyBuffer.push("\n")}this.linewise=true}this.keyBuffer.push(bc)},pushInsertModeChanges:function(bb){this.insertModeChanges.push(g(bb))},pushSearchQuery:function(bb){this.searchQueries.push(bb)},clear:function(){this.keyBuffer=[];this.insertModeChanges=[];this.searchQueries=[];this.linewise=false},toString:function(){return this.keyBuffer.join("")}};function V(bb){this.registers=bb;this.unnamedRegister=bb['"']=new a2();bb["."]=new a2();bb[":"]=new a2();bb["/"]=new a2()}V.prototype={pushText:function(be,bc,bg,bf){if(bf&&bg.charAt(0)=="\n"){bg=bg.slice(1)+"\n"}if(bf&&bg.charAt(bg.length-1)!=="\n"){bg+="\n"}var bd=this.isValidRegister(be)?this.getRegister(be):null;if(!bd){switch(bc){case"yank":this.registers["0"]=new a2(bg,bf);break;case"delete":case"change":if(bg.indexOf("\n")==-1){this.registers["-"]=new a2(bg,bf)}else{this.shiftNumericRegisters_();this.registers["1"]=new a2(bg,bf)}break}this.unnamedRegister.setText(bg,bf);return}var bb=u(be);if(bb){bd.pushText(bg,bf)}else{bd.setText(bg,bf)}this.unnamedRegister.setText(bd.toString(),bf)},getRegister:function(bb){if(!this.isValidRegister(bb)){return this.unnamedRegister}bb=bb.toLowerCase();if(!this.registers[bb]){this.registers[bb]=new a2()}return this.registers[bb]},isValidRegister:function(bb){return bb&&C(bb,k)},shiftNumericRegisters_:function(){for(var bb=9;bb>=2;bb--){this.registers[bb]=this.getRegister(""+(bb-1))}}};function aL(){this.historyBuffer=[];this.iterator;this.initialPrefix=null}aL.prototype={nextMatch:function(bc,bb){var bh=this.historyBuffer;var be=bb?-1:1;if(this.initialPrefix===null){this.initialPrefix=bc}for(var bg=this.iterator+be;bb?bg>=0:bg<bh.length;bg+=be){var bf=bh[bg];for(var bd=0;bd<=bf.length;bd++){if(this.initialPrefix==bf.substring(0,bd)){this.iterator=bg;return bf}}}if(bg>=bh.length){this.iterator=bh.length;return this.initialPrefix}if(bg<0){return bc}},pushInput:function(bb){var bc=this.historyBuffer.indexOf(bb);if(bc>-1){this.historyBuffer.splice(bc,1)}if(bb.length){this.historyBuffer.push(bb)}},reset:function(){this.initialPrefix=null;this.iterator=this.historyBuffer.length}};var aQ={matchCommand:function(bm,bl,be){var bi=be.inputState;var bn=bi.keyBuffer.concat(bm);var bh=[];var bb;for(var bf=0;bf<bl.length;bf++){var bd=bl[bf];if(a0(bn,bd.keys)){if(bi.operator&&bd.type=="action"){continue}if(bd.keys[bn.length-1]=="character"){bb=bn[bn.length-1];if(bb.length>1){switch(bb){case"<CR>":bb="\n";break;case"<Space>":bb=" ";break;default:continue}}}bh.push(bd)}}function bk(bo){if(bn.length<bo.keys.length){bi.keyBuffer.push(bm);return null}else{if(bo.keys[bn.length-1]=="character"){bi.selectedCharacter=bb}bi.keyBuffer=[];return bo}}if(!bh.length){bi.keyBuffer=[];return null}else{if(bh.length==1){return bk(bh[0])}else{var bc=be.visualMode?"visual":"normal";var bg;for(var bf=0;bf<bh.length;bf++){var bj=bh[bf];if(bj.context==bc){bg=bj;break}else{if(!bg&&!bj.context){bg=bj}}}return bk(bg)}}},processCommand:function(bb,bc,bd){bc.inputState.repeatOverride=bd.repeatOverride;switch(bd.type){case"motion":this.processMotion(bb,bc,bd);break;case"operator":this.processOperator(bb,bc,bd);break;case"operatorMotion":this.processOperatorMotion(bb,bc,bd);break;case"action":this.processAction(bb,bc,bd);break;case"search":this.processSearch(bb,bc,bd);break;case"ex":case"keyToEx":this.processEx(bb,bc,bd);break;default:break}},processMotion:function(bb,bc,bd){bc.inputState.motion=bd.motion;bc.inputState.motionArgs=aX(bd.motionArgs);this.evalInput(bb,bc)},processOperator:function(bc,bd,be){var bb=bd.inputState;if(bb.operator){if(bb.operator==be.operator){bb.motion="expandToLine";bb.motionArgs={linewise:true};this.evalInput(bc,bd);return}else{i(bc)}}bb.operator=be.operator;bb.operatorArgs=aX(be.operatorArgs);if(bd.visualMode){this.evalInput(bc,bd)}},processOperatorMotion:function(bb,be,bf){var bd=be.visualMode;var bc=aX(bf.operatorMotionArgs);if(bc){if(bd&&bc.visualLine){be.visualLine=true}}this.processOperator(bb,be,bf);if(!bd){this.processMotion(bb,be,bf)}},processAction:function(bc,be,bh){var bb=be.inputState;var bg=bb.getRepeat();var bf=!!bg;var bd=aX(bh.actionArgs)||{};if(bb.selectedCharacter){bd.selectedCharacter=bb.selectedCharacter}if(bh.operator){this.processOperator(bc,be,bh)}if(bh.motion){this.processMotion(bc,be,bh)}if(bh.motion||bh.operator){this.evalInput(bc,be)}bd.repeat=bg||1;bd.repeatIsExplicit=bf;bd.registerName=bb.registerName;i(bc);be.lastMotion=null;if(bh.isEdit){this.recordLastEdit(be,bb,bh)}o[bh.action](bc,bd,be)},processSearch:function(bq,bj,bi){if(!bq.getSearchCursor){return}var bl=bi.searchArgs.forward;var bg=bi.searchArgs.wholeWordOnly;ar(bq).setReversed(!bl);var bm=(bl)?"/":"?";var bo=ar(bq).getQuery();var bd=bq.getScrollInfo();function bh(bt,br,bs){p.searchHistoryController.pushInput(bt);p.searchHistoryController.reset();try{a8(bq,bt,br,bs)}catch(bu){aZ(bq,"Invalid regex: "+bt);return}aQ.processMotion(bq,bj,{type:"motion",motion:"findNext",motionArgs:{forward:true,toJumplist:bi.searchArgs.toJumplist}})}function bp(br){bq.scrollTo(bd.left,bd.top);bh(br,true,true);var bs=p.macroModeState;if(bs.isRecording){F(bs,br)}}function bf(bv,bu,bw){var bt=b.keyName(bv),br;if(bt=="Up"||bt=="Down"){br=bt=="Up"?true:false;bu=p.searchHistoryController.nextMatch(bu,br)||"";bw(bu)}else{if(bt!="Left"&&bt!="Right"&&bt!="Ctrl"&&bt!="Alt"&&bt!="Shift"){p.searchHistoryController.reset()}}var bs;try{bs=a8(bq,bu,true,true)}catch(bv){}if(bs){bq.scrollIntoView(ba(bq,!bl,bs),30)}else{aw(bq);bq.scrollTo(bd.left,bd.top)}}function bc(bt,bs,bu){var br=b.keyName(bt);if(br=="Esc"||br=="Ctrl-C"||br=="Ctrl-["){p.searchHistoryController.pushInput(bs);p.searchHistoryController.reset();a8(bq,bo);aw(bq);bq.scrollTo(bd.left,bd.top);b.e_stop(bt);bu();bq.focus()}}switch(bi.searchArgs.querySrc){case"prompt":var bk=p.macroModeState;if(bk.isPlaying){var bn=bk.replaySearchQueries.shift();bh(bn,true,false)}else{aJ(bq,{onClose:bp,prefix:bm,desc:G,onKeyUp:bf,onKeyDown:bc})}break;case"wordUnderCursor":var be=ao(bq,false,true,false,true);var bb=true;if(!be){be=ao(bq,false,true,false,false);bb=false}if(!be){return}var bn=bq.getLine(be.start.line).substring(be.start.ch,be.end.ch);if(bb&&bg){bn="\\b"+bn+"\\b"}else{bn=f(bn)}p.jumpList.cachedCursor=bq.getCursor();bq.setCursor(be.start);bh(bn,true,false);break}},processEx:function(bb,bc,bf){function be(bg){p.exCommandHistoryController.pushInput(bg);p.exCommandHistoryController.reset();l.processCommand(bb,bg)}function bd(bj,bh,bk){var bi=b.keyName(bj),bg;if(bi=="Esc"||bi=="Ctrl-C"||bi=="Ctrl-["){p.exCommandHistoryController.pushInput(bh);p.exCommandHistoryController.reset();b.e_stop(bj);bk();bb.focus()}if(bi=="Up"||bi=="Down"){bg=bi=="Up"?true:false;bh=p.exCommandHistoryController.nextMatch(bh,bg)||"";bk(bh)}else{if(bi!="Left"&&bi!="Right"&&bi!="Ctrl"&&bi!="Alt"&&bi!="Shift"){p.exCommandHistoryController.reset()}}}if(bf.type=="keyToEx"){l.processCommand(bb,bf.exArgs.input)}else{if(bc.visualMode){aJ(bb,{onClose:be,prefix:":",value:"'<,'>",onKeyDown:bd})}else{aJ(bb,{onClose:be,prefix:":",onKeyDown:bd})}}},evalInput:function(bf,bs){var bk=bs.inputState;var bp=bk.motion;var bl=bk.motionArgs||{};var bg=bk.operator;var bw=bk.operatorArgs||{};var bm=bk.registerName;var bc=w(bf.getCursor("head"));var bq=w(bf.getCursor("anchor"));var be=w(bc);var bj=w(be);var bt;var bh;if(bg){this.recordLastEdit(bs,bk)}if(bk.repeatOverride!==undefined){bh=bk.repeatOverride}else{bh=bk.getRepeat()}if(bh>0&&bl.explicitRepeat){bl.repeatIsExplicit=true}else{if(bl.noRepeat||(!bl.explicitRepeat&&bh===0)){bh=1;bl.repeatIsExplicit=false}}if(bk.selectedCharacter){bl.selectedCharacter=bw.selectedCharacter=bk.selectedCharacter}bl.repeat=bh;i(bf);if(bp){var br=aK[bp](bf,bl,bs);bs.lastMotion=aK[bp];if(!br){return}if(bl.toJumplist){var bv=p.jumpList;var bi=bv.cachedCursor;if(bi){aV(bf,bi,br);delete bv.cachedCursor}else{aV(bf,bj,br)}}if(br instanceof Array){be=br[0];bt=br[1]}else{bt=br}if(!bt){bt=c(be.line,be.ch)}if(bs.visualMode){if(ay(bq,bc)&&(a9(bq,bt)||ay(bt,bq))){bq.ch+=1;bt.ch-=1}else{if(ay(bc,bq)&&(a9(bq,bt)||ay(bq,bt))){bq.ch-=1;bt.ch+=1}}if(bs.lastHPos!=Infinity){bs.lastHPos=bt.ch}bc=bt;bq=(br instanceof Array)?be:bq;if(bs.visualLine){if(ay(bq,bc)){bq.ch=0;var bb=bf.lastLine();if(bc.line>bb){bc.line=bb}bc.ch=aF(bf,bc.line)}else{bc.ch=0;bq.ch=aF(bf,bq.line)}}bf.setSelection(bq,bc);aB(bf,bs,"<",ay(bq,bc)?bq:bc);aB(bf,bs,">",ay(bq,bc)?bc:bq)}else{if(!bg){bt=N(bf,bt);bf.setCursor(bt.line,bt.ch)}}}if(bg){var bo=false;bs.lastMotion=null;bw.repeat=bh;if(bs.visualMode){be=bq;bt=bc;bl.inclusive=true}if(bt&&ay(bt,be)){var bu=be;be=bt;bt=bu;bo=true}else{if(!bt){bt=w(be)}}if(bl.inclusive&&!bs.visualMode){bt.ch++}if(bw.selOffset){bt.line=be.line+bw.selOffset.line;if(bw.selOffset.line){bt.ch=bw.selOffset.ch}else{bt.ch=be.ch+bw.selOffset.ch}}else{if(bs.visualMode){var bn=c();bn.line=bt.line-be.line;if(bn.line){bn.ch=bt.ch}else{bn.ch=bt.ch-be.ch}bw.selOffset=bn}}var bd=bl.linewise||(bs.visualMode&&bs.visualLine)||bw.linewise;if(bd){aT(bf,be,bt)}else{if(bl.forward){Z(bf,be,bt)}}bw.registerName=bm;bw.linewise=bd;D[bg](bf,bw,bs,be,bt,bj);if(bs.visualMode){aC(bf)}}},recordLastEdit:function(bc,bb,bd){var be=p.macroModeState;if(be.isPlaying){return}bc.lastEditInputState=bb;bc.lastEditActionCommand=bd;be.lastInsertModeChanges.changes=[];be.lastInsertModeChanges.expectCursorActivityForChange=false}};var aK={moveToTopLine:function(bb,bd){var bc=aS(bb).top+bd.repeat-1;return c(bc,aI(bb.getLine(bc)))},moveToMiddleLine:function(bb){var bd=aS(bb);var bc=Math.floor((bd.top+bd.bottom)*0.5);return c(bc,aI(bb.getLine(bc)))},moveToBottomLine:function(bb,bd){var bc=aS(bb).bottom-bd.repeat+1;return c(bc,aI(bb.getLine(bc)))},expandToLine:function(bb,bc){var bd=bb.getCursor();return c(bd.line+bc.repeat-1,Infinity)},findNext:function(bb,bc){var bf=ar(bb);var be=bf.getQuery();if(!be){return}var bd=!bc.forward;bd=(bf.isReversed())?!bd:bd;au(bb,be);return ba(bb,bd,be,bc.repeat)},goToMark:function(bb,bd,bc){var bf=bc.marks[bd.selectedCharacter];if(bf){var be=bf.find();return bd.linewise?{line:be.line,ch:aI(bb.getLine(be.line))}:be}return null},moveToOtherHighlightedEnd:function(bc){var bd=w(bc.getCursor("head"));var bb=w(bc.getCursor("anchor"));if(ay(bb,bd)){bd.ch+=1}else{if(ay(bd,bb)){bb.ch-=1}}return([bd,bb])},jumpToMark:function(bi,be,bf){var bd=bi.getCursor();for(var bg=0;bg<be.repeat;bg++){var bk=bd;for(var bj in bf.marks){if(!y(bj)){continue}var bc=bf.marks[bj].find();var bb=(be.forward)?ay(bc,bk):ay(bk,bc);if(bb){continue}if(be.linewise&&(bc.line==bk.line)){continue}var bh=a9(bk,bd);var bl=(be.forward)?aD(bk,bc,bd):aD(bd,bc,bk);if(bh||bl){bd=bc}}}if(be.linewise){bd=c(bd.line,aI(bi.getLine(bd.line)))}return bd},moveByCharacters:function(bb,bc){var bf=bb.getCursor();var be=bc.repeat;var bd=bc.forward?bf.ch+be:bf.ch-be;return c(bf.line,bd)},moveByLines:function(bg,bc,bd){var bi=bg.getCursor();var be=bi.ch;switch(bd.lastMotion){case this.moveByLines:case this.moveByDisplayLines:case this.moveByScroll:case this.moveToColumn:case this.moveToEol:be=bd.lastHPos;break;default:bd.lastHPos=be}var bb=bc.repeat+(bc.repeatOffset||0);var bj=bc.forward?bi.line+bb:bi.line-bb;var bf=bg.firstLine();var bh=bg.lastLine();if((bj<bf&&bi.line==bf)||(bj>bh&&bi.line==bh)){return}if(bc.toFirstChar){be=aI(bg.getLine(bj));bd.lastHPos=be}bd.lastHSPos=bg.charCoords(c(bj,be),"div").left;return c(bj,be)},moveByDisplayLines:function(bi,bd,be){var bj=bi.getCursor();switch(be.lastMotion){case this.moveByDisplayLines:case this.moveByScroll:case this.moveByLines:case this.moveToColumn:case this.moveToEol:break;default:be.lastHSPos=bi.charCoords(bj,"div").left}var bb=bd.repeat;var bh=bi.findPosV(bj,(bd.forward?bb:-bb),"line",be.lastHSPos);if(bh.hitSide){if(bd.forward){var bc=bi.charCoords(bh,"div");var bf={top:bc.top+8,left:be.lastHSPos};var bh=bi.coordsChar(bf,"div")}else{var bg=bi.charCoords(c(bi.firstLine(),0),"div");bg.left=be.lastHSPos;bh=bi.coordsChar(bg,"div")}}be.lastHPos=bh.ch;return bh},moveByPage:function(bc,bd){var bb=bc.getCursor();var be=bd.repeat;return bc.findPosV(bb,(bd.forward?be:-be),"page")},moveByParagraph:function(bb,bd){var bc=bb.getCursor().line;var bf=bd.repeat;var bg=bd.forward?1:-1;for(var be=0;be<bf;be++){if((!bd.forward&&bc===bb.firstLine())||(bd.forward&&bc==bb.lastLine())){break}bc+=bg;while(bc!==bb.firstLine()&&bc!=bb.lastLine()&&bb.getLine(bc)){bc+=bg}}return c(bc,0)},moveByScroll:function(bb,be,bc){var bi=bb.getScrollInfo();var bg=null;var bf=be.repeat;if(!bf){bf=bi.clientHeight/(2*bb.defaultTextHeight())}var bh=bb.charCoords(bb.getCursor(),"local");be.repeat=bf;var bg=aK.moveByDisplayLines(bb,be,bc);if(!bg){return null}var bd=bb.charCoords(bg,"local");bb.scrollTo(null,bi.top+bd.top-bh.top);return bg},moveByWords:function(bb,bc){return al(bb,bc.repeat,!!bc.forward,!!bc.wordEnd,!!bc.bigWord)},moveTillCharacter:function(bc,bd){var bf=bd.repeat;var be=a4(bc,bf,bd.forward,bd.selectedCharacter);var bb=bd.forward?-1:1;am(bb,bd);if(!be){return null}be.ch+=bb;return be},moveToCharacter:function(bb,bc){var bd=bc.repeat;am(0,bc);return a4(bb,bd,bc.forward,bc.selectedCharacter)||bb.getCursor()},moveToSymbol:function(bb,bc){var bd=bc.repeat;return a5(bb,bd,bc.forward,bc.selectedCharacter)||bb.getCursor()},moveToColumn:function(bb,bd,bc){var be=bd.repeat;bc.lastHPos=be-1;bc.lastHSPos=bb.charCoords(bb.getCursor(),"div").left;return X(bb,be)},moveToEol:function(bb,bf,be){var bg=bb.getCursor();be.lastHPos=Infinity;var bd=c(bg.line+bf.repeat-1,Infinity);var bc=bb.clipPos(bd);bc.ch--;be.lastHSPos=bb.charCoords(bc,"div").left;return bd},moveToFirstNonWhiteSpaceCharacter:function(bb){var bc=bb.getCursor();return c(bc.line,aI(bb.getLine(bc.line)))},moveToMatchedSymbol:function(bc){var bi=bc.getCursor();var be=bi.line;var bg=bi.ch;var bd=bc.getLine(be);var bh;do{bh=bd.charAt(bg++);if(bh&&E(bh)){var bf=bc.getTokenTypeAt(c(be,bg));if(bf!=="string"&&bf!=="comment"){break}}}while(bh);if(bh){var bb=bc.findMatchingBracket(c(be,bg));return bb.to}else{return bi}},moveToStartOfLine:function(bb){var bc=bb.getCursor();return c(bc.line,0)},moveToLineOrEdgeOfDocument:function(bb,bc){var bd=bc.forward?bb.lastLine():bb.firstLine();if(bc.repeatIsExplicit){bd=bc.repeat-bb.getOption("firstLineNumber")}return c(bd,aI(bb.getLine(bd)))},textObjectManipulation:function(bc,be){var bd={"(":")",")":"(","{":"}","}":"{","[":"]","]":"["};var bh={"'":true,'"':true};var bg=be.selectedCharacter;if(bg=="b"){bg="("}else{if(bg=="B"){bg="{"}}var bb=!be.textObjectInner;var bf;if(bd[bg]){bf=m(bc,bg,bb)}else{if(bh[bg]){bf=aA(bc,bg,bb)}else{if(bg==="W"){bf=ao(bc,bb,true,true)}else{if(bg==="w"){bf=ao(bc,bb,true,false)}else{return null}}}}return[bf.start,bf.end]},repeatLastCharacterSearch:function(bd,bf){var bc=p.lastChararacterSearch;var bh=bf.repeat;var be=bf.forward===bc.forward;var bb=(bc.increment?1:0)*(be?-1:1);bd.moveH(-bb,"char");bf.inclusive=be?true:false;var bg=a4(bd,bh,be,bc.selectedCharacter);if(!bg){bd.moveH(bb,"char");return bd.getCursor()}bg.ch+=bb;return bg}};var D={change:function(bc,bg,be,bb,bh){p.registerController.pushText(bg.registerName,"change",bc.getRange(bb,bh),bg.linewise);if(bg.linewise){var bf=bh.line>bc.lastLine()?"":"\n";bc.replaceRange(bf,bb,bh);bc.indentLine(bb.line,"smart");bb.ch=null}else{var bi=bc.getRange(bb,bh);if(!H(bi)){var bd=(/\s+$/).exec(bi);if(bd){bh=x(bh,0,-bd[0].length)}}bc.replaceRange("",bb,bh)}o.enterInsertMode(bc,{},bc.state.vim);bc.setCursor(bb)},"delete":function(bc,be,bd,bb,bf){if(be.linewise&&bf.line>bc.lastLine()&&bb.line>bc.firstLine()){bb.line--;bb.ch=aF(bc,bb.line)}p.registerController.pushText(be.registerName,"delete",bc.getRange(bb,bf),be.linewise);bc.replaceRange("",bb,bf);if(be.linewise){bc.setCursor(aK.moveToFirstNonWhiteSpaceCharacter(bc))}else{bc.setCursor(bb)}},indent:function(bi,bd,bf,bh,bj){var bk=bh.line;var bc=bj.line;var bb=(bf.visualMode)?bd.repeat:1;if(bd.linewise){bc--}for(var bg=bk;bg<=bc;bg++){for(var be=0;be<bb;be++){bi.indentLine(bg,bd.indentRight)}}bi.setCursor(bh);bi.setCursor(aK.moveToFirstNonWhiteSpaceCharacter(bi))},swapcase:function(bj,bc,bh,bi,bk,bg){var be=bj.getRange(bi,bk);var bb="";for(var bd=0;bd<be.length;bd++){var bf=be.charAt(bd);bb+=u(bf)?bf.toLowerCase():bf.toUpperCase()}bj.replaceRange(bb,bi,bk);if(!bc.shouldMoveCursor){bj.setCursor(bg)}},yank:function(bc,bf,be,bb,bg,bd){p.registerController.pushText(bf.registerName,"yank",bc.getRange(bb,bg),bf.linewise);bc.setCursor(bd)}};var o={jumpListWalk:function(bb,bd,be){if(be.visualMode){return}var bg=bd.repeat;var bf=bd.forward;var bc=p.jumpList;var bi=bc.move(bb,bf?bg:-bg);var bh=bi?bi.find():undefined;bh=bh?bh:bb.getCursor();bb.setCursor(bh)},scroll:function(bj,bd,bf){if(bf.visualMode){return}var bb=bd.repeat||1;var bi=bj.defaultTextHeight();var bh=bj.getScrollInfo().top;var bk=bi*bb;var bg=bd.forward?bh+bk:bh-bk;var bl=w(bj.getCursor());var be=bj.charCoords(bl,"local");if(bd.forward){if(bg>be.top){bl.line+=(bg-be.top)/bi;bl.line=Math.ceil(bl.line);bj.setCursor(bl);be=bj.charCoords(bl,"local");bj.scrollTo(null,be.top)}else{bj.scrollTo(null,bg)}}else{var bc=bg+bj.getScrollInfo().clientHeight;if(bc<be.bottom){bl.line-=(be.bottom-bc)/bi;bl.line=Math.floor(bl.line);bj.setCursor(bl);be=bj.charCoords(bl,"local");bj.scrollTo(null,be.bottom-bj.getScrollInfo().clientHeight)}else{bj.scrollTo(null,bg)}}},scrollToCursor:function(bc,bd){var bg=bc.getCursor().line;var be=bc.charCoords(c(bg,0),"local");var bb=bc.getScrollInfo().clientHeight;var bh=be.top;var bf=be.bottom-bh;switch(bd.position){case"center":bh=bh-(bb/2)+bf;break;case"bottom":bh=bh-bb+bf*1.4;break;case"top":bh=bh+bf*0.4;break}bc.scrollTo(null,bh)},replayMacro:function(bb,bc,bd){var be=bc.selectedCharacter;var bf=bc.repeat;var bg=p.macroModeState;if(be=="@"){be=bg.latestRegister}while(bf--){A(bb,bd,bg,be)}},enterMacroRecordMode:function(bb,bc){var be=p.macroModeState;var bd=bc.selectedCharacter;be.enterMacroRecordMode(bb,bd)},enterInsertMode:function(bb,bc,bd){if(bb.getOption("readOnly")){return}bd.insertMode=true;bd.insertModeRepeat=bc&&bc.repeat||1;var be=(bc)?bc.insertAt:null;if(be=="eol"){var bh=bb.getCursor();bh=c(bh.line,aF(bb,bh.line));bb.setCursor(bh)}else{if(be=="charAfter"){bb.setCursor(x(bb.getCursor(),0,1))}else{if(be=="firstNonBlank"){bb.setCursor(aK.moveToFirstNonWhiteSpaceCharacter(bb))}else{if(be=="endOfSelectedArea"){var bg=bb.getCursor("head");var bf=bb.getCursor("anchor");if(bg.line<bf.line){bg=c(bf.line,0)}bb.setCursor(bg);aC(bb)}}}}bb.setOption("keyMap","vim-insert");bb.setOption("disableInput",false);if(bc&&bc.replace){bb.toggleOverwrite(true);bb.setOption("keyMap","vim-replace");b.signal(bb,"vim-mode-change",{mode:"replace"})}else{bb.setOption("keyMap","vim-insert");b.signal(bb,"vim-mode-change",{mode:"insert"})}if(!p.macroModeState.isPlaying){bb.on("change",aW);b.on(bb.getInputField(),"keydown",L)}},toggleVisualMode:function(bc,bd,be){var bg=bd.repeat;var bb=bc.getCursor();var bf;if(!be.visualMode){bc.on("mousedown",aC);be.visualMode=true;be.visualLine=!!bd.linewise;if(be.visualLine){bb.ch=0;bf=N(bc,c(bb.line+bg-1,aF(bc,bb.line)),true)}else{bf=N(bc,c(bb.line,bb.ch+bg),true)}bc.setSelection(bb,bf);b.signal(bc,"vim-mode-change",{mode:"visual",subMode:be.visualLine?"linewise":""})}else{bb=bc.getCursor("anchor");bf=bc.getCursor("head");if(!be.visualLine&&bd.linewise){be.visualLine=true;bb.ch=ay(bb,bf)?0:aF(bc,bb.line);bf.ch=ay(bb,bf)?aF(bc,bf.line):0;bc.setSelection(bb,bf);b.signal(bc,"vim-mode-change",{mode:"visual",subMode:"linewise"})}else{if(be.visualLine&&!bd.linewise){be.visualLine=false;b.signal(bc,"vim-mode-change",{mode:"visual"})}else{aC(bc)}}}aB(bc,be,"<",ay(bb,bf)?bb:bf);aB(bc,be,">",ay(bb,bf)?bf:bb)},reselectLastSelection:function(bc,bi,be){var bd=be.lastSelection;if(bd){var bb=bd.curStartMark.find();var bg=bd.curEndMark.find();bc.setSelection(bb,bg);if(be.visualMode){aU(bc,be);var bf=bc.getCursor("anchor");var bh=bc.getCursor("head");aB(bc,be,"<",ay(bf,bh)?bf:bh);aB(bc,be,">",ay(bf,bh)?bh:bf)}if(bd.visualLine){be.visualMode=true;be.visualLine=true}else{be.visualMode=true;be.visualLine=false}b.signal(bc,"vim-mode-change",{mode:"visual",subMode:be.visualLine?"linewise":""})}},joinLines:function(bc,bd,be){var bb,bg;if(be.visualMode){bb=bc.getCursor("anchor");bg=bc.getCursor("head");bg.ch=aF(bc,bg.line)-1}else{var bf=Math.max(bd.repeat,2);bb=bc.getCursor();bg=N(bc,c(bb.line+bf-1,Infinity))}var bh=0;bc.operation(function(){for(var bk=bb.line;bk<bg.line;bk++){bh=aF(bc,bb.line);var bj=c(bb.line+1,aF(bc,bb.line+1));var bl=bc.getRange(bb,bj);bl=bl.replace(/\n\s*/g," ");bc.replaceRange(bl,bb,bj)}var bi=c(bb.line,bh);bc.setCursor(bi)})},newLineAndEnterInsertMode:function(bb,bc,bd){bd.insertMode=true;var be=w(bb.getCursor());if(be.line===bb.firstLine()&&!bc.after){bb.replaceRange("\n",c(bb.firstLine(),0));bb.setCursor(bb.firstLine(),0)}else{be.line=(bc.after)?be.line:be.line-1;be.ch=aF(bb,be.line);bb.setCursor(be);var bf=b.commands.newlineAndIndentContinueComment||b.commands.newlineAndIndent;bf(bb)}this.enterInsertMode(bb,{repeat:bc.repeat},bd)},paste:function(bm,bl,br){var bh=w(bm.getCursor());var bc=p.registerController.getRegister(bl.registerName);var bo=bc.toString();if(!bo){return}if(bl.matchIndent){var bi=function(bw){var bv=(bw.split("\t").length-1);var bu=(bw.split(" ").length-1);return bv*bm.options.tabSize+bu*1};var bs=bm.getLine(bm.getCursor().line);var bn=bi(bs.match(/^\s*/)[0]);var bb=bo.replace(/\n$/,"");var bg=bo!==bb;var bk=bi(bo.match(/^\s*/)[0]);var bo=bb.replace(/^\s*/gm,function(bu){var bv=bn+(bi(bu)-bk);if(bv<0){return""}else{if(bm.options.indentWithTabs){var bw=Math.floor(bv/bm.options.tabSize);return Array(bw+1).join("\t")}else{return Array(bv+1).join(" ")}}});bo+=bg?"\n":""}if(bl.repeat>1){var bo=Array(bl.repeat+1).join(bo)}var bj=bc.linewise;if(bj){if(br.visualMode){bo=br.visualLine?bo.slice(0,-1):"\n"+bo.slice(0,bo.length-1)+"\n"}else{if(bl.after){bo="\n"+bo.slice(0,bo.length-1);bh.ch=aF(bm,bh.line)}else{bh.ch=0}}}else{bh.ch+=bl.after?1:0}var bf;var bp;if(br.visualMode){br.lastPastedText=bo;var be;var bt=aN(bm,br);var bq=bt[0];var bd=bt[1];if(br.lastSelection){be=br.lastSelection.curEndMark.find()}p.registerController.unnamedRegister.setText(bm.getRange(bq,bd));bm.replaceRange(bo,bq,bd);if(be){br.lastSelection.curEndMark=bm.setBookmark(be)}bf=bm.posFromIndex(bm.indexFromPos(bq)+bo.length-1);if(bj){bf.ch=0}}else{bm.replaceRange(bo,bh);if(bj&&bl.after){bf=c(bh.line+1,aI(bm.getLine(bh.line+1)))}else{if(bj&&!bl.after){bf=c(bh.line,aI(bm.getLine(bh.line)))}else{if(!bj&&bl.after){bp=bm.indexFromPos(bh);bf=bm.posFromIndex(bp+bo.length-1)}else{bp=bm.indexFromPos(bh);bf=bm.posFromIndex(bp+bo.length)}}}}bm.setCursor(bf)},undo:function(bb,bc){bb.operation(function(){ah(bb,b.commands.undo,bc.repeat)();bb.setCursor(bb.getCursor("anchor"))})},redo:function(bb,bc){ah(bb,b.commands.redo,bc.repeat)()},setRegister:function(bd,bb,bc){bc.inputState.registerName=bb.selectedCharacter},setMark:function(bb,bc,bd){var be=bc.selectedCharacter;aB(bb,bd,be,bb.getCursor())},replace:function(bh,bc,be){var bd=bc.selectedCharacter;var bg=bh.getCursor();var bf;var bi;if(be.visualMode){bg=bh.getCursor("start");bi=bh.getCursor("end")}else{var bj=bh.getLine(bg.line);bf=bg.ch+bc.repeat;if(bf>bj.length){bf=bj.length}bi=c(bg.line,bf)}if(bd=="\n"){if(!be.visualMode){bh.replaceRange("",bg,bi)}(b.commands.newlineAndIndentContinueComment||b.commands.newlineAndIndent)(bh)}else{var bb=bh.getRange(bg,bi);bb=bb.replace(/[^\n]/g,bd);bh.replaceRange(bb,bg,bi);if(be.visualMode){bh.setCursor(bg);aC(bh)}else{bh.setCursor(x(bi,0,-1))}}},incrementNumberToken:function(bl,bc){var bm=bl.getCursor();var bh=bl.getLine(bm.line);var bo=/-?\d+/g;var bg;var bb;var bf;var bn;var bd;while((bg=bo.exec(bh))!==null){bd=bg[0];bb=bg.index;bf=bb+bd.length;if(bm.ch<bf){break}}if(!bc.backtrack&&(bf<=bm.ch)){return}if(bd){var bk=bc.increase?1:-1;var be=parseInt(bd)+(bk*bc.repeat);var bj=c(bm.line,bb);var bi=c(bm.line,bf);bn=be.toString();bl.replaceRange(bn,bj,bi)}else{return}bl.setCursor(c(bm.line,bb+bn.length-1))},repeatLastEdit:function(bc,bd,be){var bb=be.lastEditInputState;if(!bb){return}var bf=bd.repeat;if(bf&&bd.repeatIsExplicit){be.lastEditInputState.repeatOverride=bf}else{bf=be.lastEditInputState.repeatOverride||bf}s(bc,be,bf,false)},changeCase:function(bg,bc,bd){var bi=aN(bg,bd);var bf=bi[0];var bj=bi[1];var be=bd.lastSelection.curEndMark.find();var bb=bc.toLower;var bh=bg.getRange(bf,bj);bg.replaceRange(bb?bh.toLowerCase():bh.toUpperCase(),bf,bj);bd.lastSelection.curEndMark=bg.setBookmark(be);bg.setCursor(bf)}};function N(bc,bg,be){var bd=Math.min(Math.max(bc.firstLine(),bg.line),bc.lastLine());var bb=aF(bc,bd)-1;bb=(be)?bb+1:bb;var bf=Math.min(Math.max(0,bg.ch),bb);return c(bd,bf)}function aX(bc){var bb={};for(var bd in bc){if(bc.hasOwnProperty(bd)){bb[bd]=bc[bd]}}return bb}function x(bc,bb,bd){return c(bc.line+bb,bc.ch+bd)}function a0(bd,bb){for(var bc=0;bc<bd.length;bc++){if(bd[bc]!=bb[bc]&&bb[bc]!="character"){return false}}return true}function ah(bb,bc,bd){return function(){for(var be=0;be<bd;be++){bc(bb)}}}function w(bb){return c(bb.line,bb.ch)}function a9(bc,bb){return bc.ch==bb.ch&&bc.line==bb.line}function ay(bc,bb){if(bc.line<bb.line){return true}if(bc.line==bb.line&&bc.ch<bb.ch){return true}return false}function aD(be,bd,bc){var bf=ay(be,bd);var bb=ay(bd,bc);return bf&&bb}function aF(bb,bc){return bb.getLine(bc).length}function j(bb){return bb.split("").reverse().join("")}function aP(bb){if(bb.trim){return bb.trim()}return bb.replace(/^\s+|\s+$/g,"")}function f(bb){return bb.replace(/([.?*+$\[\]\/\\(){}|\-])/g,"\\$1")}function aN(bi,be){var bh=bi.getCursor("anchor");var bj=bi.getCursor("head");var bc=be.lastSelection;if(!be.visualMode){var bd=be.lastSelection.curStartMark.find();var bg=be.lastSelection.curEndMark.find();var bk=bg.line-bd.line;var bb=bk?bg.ch:bg.ch-bd.ch;bj={line:bj.line+bk,ch:bk?bj.ch:bb+bj.ch};if(bc.visualLine){return[{line:bh.line,ch:0},{line:bj.line,ch:aF(bi,bj.line)}]}}else{if(ay(bj,bh)){var bf=bh;bh=bj;bj=bf}aC(bi)}return[bh,bj]}function aU(bb,bc){var bd=bc.marks["<"].find()||bb.getCursor("anchor");var be=bc.marks[">"].find()||bb.getCursor("head");if(bc.lastPastedText){be=bb.posFromIndex(bb.indexFromPos(bd)+bc.lastPastedText.length-1);bc.lastPastedText=null}bc.lastSelection={curStartMark:bb.setBookmark(bd),curEndMark:bb.setBookmark(be),visualMode:bc.visualMode,visualLine:bc.visualLine};if(ay(be,bd)){bc.lastSelection.curStartMark=bb.setBookmark(be);bc.lastSelection.curEndMark=bb.setBookmark(bd)}}function aC(bb){bb.off("mousedown",aC);var bc=bb.state.vim;var bd=bb.getCursor("anchor");var be=bb.getCursor("head");aU(bb,bc);bc.visualMode=false;bc.visualLine=false;if(!a9(bd,be)){bb.setCursor(N(bb,be))}b.signal(bb,"vim-mode-change",{mode:"normal"});if(bc.fakeCursor){bc.fakeCursor.clear()}}function Z(bc,bb,bg){var bf=bc.getRange(bb,bg);if(/\n\s*$/.test(bf)){var be=bf.split("\n");be.pop();var bd;for(var bd=be.pop();be.length>0&&bd&&H(bd);bd=be.pop()){bg.line--;bg.ch=0}if(bd){bg.line--;bg.ch=aF(bc,bg.line)}else{bg.ch=0}}}function aT(bc,bb,bd){bb.ch=0;bd.ch=0;bd.line++}function aI(bc){if(!bc){return 0}var bb=bc.search(/\S/);return bb==-1?bc.length:bb}function ao(bk,bg,bu,bc,bv){var be=bk.getCursor();var bn=bk.getLine(be.line);var bq=be.ch;var bp=bn.substring(bq);var br;if(bv){br=bp.search(/\w/)}else{br=bp.search(/\S/)}if(br==-1){return null}bq+=br;bp=bn.substring(bq);var bt=bn.substring(0,bq);var bw;if(bc){bw=/^\S+/}else{if((/\w/).test(bn.charAt(bq))){bw=/^\w+/}else{bw=/^[^\w\s]+/}}var bh=bw.exec(bp);var bo=bq;var bd=bq+bh[0].length;var bf=j(bt);var bl=bw.exec(bf);if(bl){bo-=bl[0].length}if(bg){var bm=bn.substring(bd);var bb=bm.match(/^\s*/)[0].length;if(bb>0){bd+=bb}else{var bj=bf.length-bo;var bi=bf.substring(bj);var bs=bi.match(/^\s*/)[0].length;bo-=bs}}return{start:c(be.line,bo),end:c(be.line,bd)}}function aV(bb,bc,bd){if(!a9(bc,bd)){p.jumpList.add(bb,bc,bd)}}function am(bb,bc){p.lastChararacterSearch.increment=bb;p.lastChararacterSearch.forward=bc.forward;p.lastChararacterSearch.selectedCharacter=bc.selectedCharacter}var I={"(":"bracket",")":"bracket","{":"bracket","}":"bracket","[":"section","]":"section","*":"comment","/":"comment",m:"method",M:"method","#":"preprocess"};var aH={bracket:{isComplete:function(bb){if(bb.nextCh===bb.symb){bb.depth++;if(bb.depth>=1){return true}}else{if(bb.nextCh===bb.reverseSymb){bb.depth--}}return false}},section:{init:function(bb){bb.curMoveThrough=true;bb.symb=(bb.forward?"]":"[")===bb.symb?"{":"}"},isComplete:function(bb){return bb.index===0&&bb.nextCh===bb.symb}},comment:{isComplete:function(bc){var bb=bc.lastCh==="*"&&bc.nextCh==="/";bc.lastCh=bc.nextCh;return bb}},method:{init:function(bb){bb.symb=(bb.symb==="m"?"{":"}");bb.reverseSymb=bb.symb==="{"?"}":"{"},isComplete:function(bb){if(bb.nextCh===bb.symb){return true}return false}},preprocess:{init:function(bb){bb.index=0},isComplete:function(bc){if(bc.nextCh==="#"){var bb=bc.lineText.match(/#(\w+)/)[1];if(bb==="endif"){if(bc.forward&&bc.depth===0){return true}bc.depth++}else{if(bb==="if"){if(!bc.forward&&bc.depth===0){return true}bc.depth--}}if(bb==="else"&&bc.depth===0){return true}}return false}}};function a5(bk,bc,bf,bd){var bn=w(bk.getCursor());var bl=bf?1:-1;var be=bf?bk.lineCount():-1;var bj=bn.ch;var bp=bn.line;var bi=bk.getLine(bp);var bb={lineText:bi,nextCh:bi.charAt(bj),lastCh:null,index:bj,symb:bd,reverseSymb:(bf?{")":"(","}":"{"}:{"(":")","{":"}"})[bd],forward:bf,depth:0,curMoveThrough:false};var bg=I[bd];if(!bg){return bn}var bo=aH[bg].init;var bm=aH[bg].isComplete;if(bo){bo(bb)}while(bp!==be&&bc){bb.index+=bl;bb.nextCh=bb.lineText.charAt(bb.index);if(!bb.nextCh){bp+=bl;bb.lineText=bk.getLine(bp)||"";if(bl>0){bb.index=0}else{var bh=bb.lineText.length;bb.index=(bh>0)?(bh-1):0}bb.nextCh=bb.lineText.charAt(bb.index)}if(bm(bb)){bn.line=bp;bn.ch=bb.index;bc--}}if(bb.nextCh||bb.curMoveThrough){return c(bp,bb.index)}return bn}function a7(bl,bm,be,bj,bk){var bf=bm.line;var bi=bm.ch;var bp=bl.getLine(bf);var bc=be?1:-1;var bg=bj?a1:ae;if(bk&&bp==""){bf+=bc;bp=bl.getLine(bf);if(!e(bl,bf)){return null}bi=(be)?0:bp.length}while(true){if(bk&&bp==""){return{from:0,to:0,line:bf}}var bh=(bc>0)?bp.length:-1;var bo=bh,bn=bh;while(bi!=bh){var bb=false;for(var bd=0;bd<bg.length&&!bb;++bd){if(bg[bd].test(bp.charAt(bi))){bo=bi;while(bi!=bh&&bg[bd].test(bp.charAt(bi))){bi+=bc}bn=bi;bb=bo!=bn;if(bo==bm.ch&&bf==bm.line&&bn==bo+bc){continue}else{return{from:Math.min(bo,bn+1),to:Math.max(bo,bn),line:bf}}}}if(!bb){bi+=bc}}bf+=bc;if(!e(bl,bf)){return null}bp=bl.getLine(bf);bi=(bc>0)?0:bp.length}throw new Error("The impossible happened.")}function al(bl,bc,bg,bp,bj){var bn=bl.getCursor();var bh=w(bn);var bi=[];if(bg&&!bp||!bg&&bp){bc++}var bk=!(bg&&bp);for(var be=0;be<bc;be++){var bb=a7(bl,bn,bg,bj,bk);if(!bb){var bd=aF(bl,bl.lastLine());bi.push(bg?{line:bl.lastLine(),from:bd,to:bd}:{line:0,from:0,to:0});break}bi.push(bb);bn=c(bb.line,bg?(bb.to-1):bb.from)}var bf=bi.length!=bc;var bm=bi[0];var bo=bi.pop();if(bg&&!bp){if(!bf&&(bm.from!=bh.ch||bm.line!=bh.line)){bo=bi.pop()}return c(bo.line,bo.from)}else{if(bg&&bp){return c(bo.line,bo.to-1)}else{if(!bg&&bp){if(!bf&&(bm.to!=bh.ch||bm.line!=bh.line)){bo=bi.pop()}return c(bo.line,bo.to)}else{return c(bo.line,bo.from)}}}}function a4(bg,bc,be,bf){var bi=bg.getCursor();var bb=bi.ch;var bh;for(var bd=0;bd<bc;bd++){var bj=bg.getLine(bi.line);bh=aR(bb,bj,bf,be,true);if(bh==-1){return null}bb=bh}return c(bg.getCursor().line,bh)}function X(bb,bd){var bc=bb.getCursor().line;return N(bb,c(bc,bd-1))}function aB(bb,bc,bd,be){if(!C(bd,ap)){return}if(bc.marks[bd]){bc.marks[bd].clear()}bc.marks[bd]=bb.setBookmark(be)}function aR(bg,bc,bf,bd,be){var bb;if(bd){bb=bc.indexOf(bf,bg+1);if(bb!=-1&&!be){bb-=1}}else{bb=bc.lastIndexOf(bf,bg-1);if(bb!=-1&&!be){bb+=1}}return bb}function m(bk,bd,bj){var bl=bk.getCursor(),bc,bf;var bi=({"(":/[()]/,")":/[()]/,"[":/[[\]]/,"]":/[[\]]/,"{":/[{}]/,"}":/[{}]/})[bd];var be=({"(":"(",")":"(","[":"[","]":"[","{":"{","}":"{"})[bd];var bb=bk.getLine(bl.line).charAt(bl.ch);var bg=bb===be?1:0;bc=bk.scanForBracket(c(bl.line,bl.ch+bg),-1,null,{bracketRegex:bi});bf=bk.scanForBracket(c(bl.line,bl.ch+bg),1,null,{bracketRegex:bi});if(!bc||!bf){return{start:bl,end:bl}}bc=bc.pos;bf=bf.pos;if((bc.line==bf.line&&bc.ch>bf.ch)||(bc.line>bf.line)){var bh=bc;bc=bf;bf=bh}if(bj){bf.ch+=1}else{bc.ch+=1}return{start:bc,end:bf}}function aA(bj,bd,bi){var bk=w(bj.getCursor());var bl=bj.getLine(bk.line);var bh=bl.split("");var bc,be,bf,bg;var bb=bh.indexOf(bd);if(bk.ch<bb){bk.ch=bb}else{if(bb<bk.ch&&bh[bk.ch]==bd){be=bk.ch;--bk.ch}}if(bh[bk.ch]==bd&&!be){bc=bk.ch+1}else{for(bf=bk.ch;bf>-1&&!bc;bf--){if(bh[bf]==bd){bc=bf+1}}}if(bc&&!be){for(bf=bc,bg=bh.length;bf<bg&&!be;bf++){if(bh[bf]==bd){be=bf}}}if(!bc||!be){return{start:bk,end:bk}}if(bi){--bc;++be}return{start:c(bk.line,bc),end:c(bk.line,be)}}av("pcre",true,"boolean");function Q(){}Q.prototype={getQuery:function(){return p.query},setQuery:function(bb){p.query=bb},getOverlay:function(){return this.searchOverlay},setOverlay:function(bb){this.searchOverlay=bb},isReversed:function(){return p.isReversed},setReversed:function(bb){p.isReversed=bb}};function ar(bb){var bc=bb.state.vim;return bc.searchState_||(bc.searchState_=new Q())}function P(bb,be,bf,bc,bd){if(bb.openDialog){bb.openDialog(be,bc,{bottom:true,value:bd.value,onKeyDown:bd.onKeyDown,onKeyUp:bd.onKeyUp})}else{bc(prompt(bf,""))}}function r(bd){var bc=Y(bd)||[];if(!bc.length){return[]}var be=[];if(bc[0]!==0){return}for(var bb=0;bb<bc.length;bb++){if(typeof bc[bb]=="number"){be.push(bd.substring(bc[bb]+1,bc[bb+1]))}}return be}function Y(be){var bc=false;var bd=[];for(var bb=0;bb<be.length;bb++){var bf=be.charAt(bb);if(!bc&&bf=="/"){bd.push(bb)}bc=!bc&&(bf=="\\")}return bd}function a3(bi){var bj="|(){";var bf="}";var bg=false;var bc=[];for(var bd=-1;bd<bi.length;bd++){var bh=bi.charAt(bd)||"";var bb=bi.charAt(bd+1)||"";var be=(bb&&bj.indexOf(bb)!=-1);if(bg){if(bh!=="\\"||!be){bc.push(bh)}bg=false}else{if(bh==="\\"){bg=true;if(bb&&bf.indexOf(bb)!=-1){be=true}if(!be||bb==="\\"){bc.push(bh)}}else{bc.push(bh);if(be&&bb!=="\\"){bc.push("\\")}}}}return bc.join("")}function a6(be){var bd=false;var bb=[];for(var bc=-1;bc<be.length;bc++){var bg=be.charAt(bc)||"";var bf=be.charAt(bc+1)||"";if(bd){bb.push(bg);bd=false}else{if(bg==="\\"){bd=true;if((T(bf)||bf==="$")){bb.push("$")}else{if(bf!=="/"&&bf!=="\\"){bb.push("\\")}}}else{if(bg==="$"){bb.push("$")}bb.push(bg);if(bf==="/"){bb.push("\\")}}}}return bb.join("")}function S(bd){var bc=new b.StringStream(bd);var bb=[];while(!bc.eol()){while(bc.peek()&&bc.peek()!="\\"){bb.push(bc.next())}if(bc.match("\\/",true)){bb.push("/")}else{if(bc.match("\\\\",true)){bb.push("\\")}else{bb.push(bc.next())}}}return bb.join("")}function aj(bf,bd,bi){var bh=p.registerController.getRegister("/");bh.setText(bf);if(bf instanceof RegExp){return bf}var bg=Y(bf);var bj;var bc;if(!bg.length){bj=bf}else{bj=bf.substring(0,bg[0]);var bb=bf.substring(bg[0]);bc=(bb.indexOf("i")!=-1)}if(!bj){return null}if(!n("pcre")){bj=a3(bj)}if(bi){bd=(/^[^A-Z]*$/).test(bj)}var be=new RegExp(bj,(bd||bc)?"i":undefined);return be}function aZ(bb,bc){if(bb.openNotification){bb.openNotification('<span style="color: red">'+bc+"</span>",{bottom:true,duration:5000})}else{alert(bc)}}function aq(bc,bd){var bb="";if(bc){bb+='<span style="font-family: monospace">'+bc+"</span>"}bb+='<input type="text"/> <span style="color: #888">';if(bd){bb+='<span style="color: #888">';bb+=bd;bb+="</span>"}return bb}var G="(Javascript regexp)";function aJ(bc,bd){var be=(bd.prefix||"")+" "+(bd.desc||"");var bb=aq(bd.prefix,bd.desc);P(bc,bb,be,bd.onClose,bd)}function M(bc,bb){if(bc instanceof RegExp&&bb instanceof RegExp){var be=["global","multiline","ignoreCase","source"];for(var bd=0;bd<be.length;bd++){var bf=be[bd];if(bc[bf]!==bb[bf]){return false}}return true}return false}function a8(bb,bg,bc,bd){if(!bg){return}var bf=ar(bb);var be=aj(bg,!!bc,!!bd);if(!be){return}au(bb,be);if(M(be,bf.getQuery())){return be}bf.setQuery(be);return be}function ax(bc){if(bc.source.charAt(0)=="^"){var bb=true}return{token:function(be){if(bb&&!be.sol()){be.skipToEnd();return}var bd=be.match(bc,false);if(bd){if(bd[0].length==0){be.next();return"searching"}if(!be.sol()){be.backUp(1);if(!bc.exec(be.next()+bd[0])){be.next();return null}}be.match(bc);return"searching"}while(!be.eol()){be.next();if(be.match(bc,false)){break}}},query:bc}}function au(bb,bd){var bc=ar(bb).getOverlay();if(!bc||bd!=bc.query){if(bc){bb.removeOverlay(bc)}bc=ax(bd);bb.addOverlay(bc);ar(bb).setOverlay(bc)}}function ba(bb,bc,be,bd){if(bd===undefined){bd=1}return bb.operation(function(){var bi=bb.getCursor();var bh=bb.getSearchCursor(be,bi);for(var bf=0;bf<bd;bf++){var bg=bh.find(bc);if(bf==0&&bg&&a9(bh.from(),bi)){bg=bh.find(bc)}if(!bg){bh=bb.getSearchCursor(be,(bc)?c(bb.lastLine()):c(bb.firstLine(),0));if(!bh.find(bc)){return}}}return bh.from()})}function aw(bb){bb.removeOverlay(ar(bb).getOverlay());ar(bb).setOverlay(null)}function R(bd,bc,bb){if(typeof bd!="number"){bd=bd.line}if(bc instanceof Array){return C(bd,bc)}else{if(bb){return(bd>=bc&&bd<=bb)}else{return bd==bc}}}function aS(bb){var be=bb.getScrollInfo();var bd=6;var bh=10;var bg=bb.coordsChar({left:0,top:bd+be.top},"local");var bc=be.clientHeight-bh+be.top;var bf=bb.coordsChar({left:0,top:bc},"local");return{top:bg.line,bottom:bf.line}}var v=[{name:"map"},{name:"nmap",shortName:"nm"},{name:"vmap",shortName:"vm"},{name:"unmap"},{name:"write",shortName:"w"},{name:"undo",shortName:"u"},{name:"redo",shortName:"red"},{name:"set",shortName:"set"},{name:"sort",shortName:"sor"},{name:"substitute",shortName:"s",possiblyAsync:true},{name:"nohlsearch",shortName:"noh"},{name:"delmarks",shortName:"delm"},{name:"registers",shortName:"reg",excludeFromCommandHistory:true},{name:"global",shortName:"g"}];d.ExCommandDispatcher=function(){this.buildCommandMap_()};d.ExCommandDispatcher.prototype={processCommand:function(bm,bl,bc){var bg=bm.state.vim;var bd=p.registerController.getRegister(":");var bj=bd.toString();if(bg.visualMode){aC(bm)}var bb=new b.StringStream(bl);bd.setText(bl);var bf=bc||{};bf.input=bl;try{this.parseInput_(bm,bb,bf)}catch(bk){aZ(bm,bk);throw bk}var be;var bi;if(!bf.commandName){if(bf.line!==undefined){bi="move"}}else{be=this.matchCommand_(bf.commandName);if(be){bi=be.name;if(be.excludeFromCommandHistory){bd.setText(bj)}this.parseCommandArgs_(bb,bf,be);if(be.type=="exToKey"){for(var bh=0;bh<be.toKeys.length;bh++){b.Vim.handleKey(bm,be.toKeys[bh])}return}else{if(be.type=="exToEx"){this.processCommand(bm,be.toInput);return}}}}if(!bi){aZ(bm,'Not an editor command ":'+bl+'"');return}try{aM[bi](bm,bf);if((!be||!be.possiblyAsync)&&bf.callback){bf.callback()}}catch(bk){aZ(bm,bk);throw bk}},parseInput_:function(bc,bd,bb){bd.eatWhile(":");if(bd.eat("%")){bb.line=bc.firstLine();bb.lineEnd=bc.lastLine()}else{bb.line=this.parseLineSpec_(bc,bd);if(bb.line!==undefined&&bd.eat(",")){bb.lineEnd=this.parseLineSpec_(bc,bd)}}var be=bd.match(/^(\w+)/);if(be){bb.commandName=be[1]}else{bb.commandName=bd.match(/.*/)[0]}return bb},parseLineSpec_:function(bb,bc){var bd=bc.match(/^(\d+)/);if(bd){return parseInt(bd[1],10)-1}switch(bc.next()){case".":return bb.getCursor().line;case"$":return bb.lastLine();case"'":var be=bb.state.vim.marks[bc.next()];if(be&&be.find()){return be.find().line}throw new Error("Mark not set");default:bc.backUp(1);return undefined}},parseCommandArgs_:function(bc,bf,be){if(bc.eol()){return}bf.argString=bc.match(/.*/)[0];var bd=be.argDelimiter||/\s+/;var bb=aP(bf.argString).split(bd);if(bb.length&&bb[0]){bf.args=bb}},matchCommand_:function(bc){for(var bb=bc.length;bb>0;bb--){var bd=bc.substring(0,bb);if(this.commandMap_[bd]){var be=this.commandMap_[bd];if(be.name.indexOf(bc)===0){return be}}}return null},buildCommandMap_:function(){this.commandMap_={};for(var bc=0;bc<v.length;bc++){var bd=v[bc];var bb=bd.shortName||bd.name;this.commandMap_[bb]=bd}},map:function(bc,bf,bb){if(bc!=":"&&bc.charAt(0)==":"){if(bb){throw Error("Mode not supported for ex mappings")}var be=bc.substring(1);if(bf!=":"&&bf.charAt(0)==":"){this.commandMap_[be]={name:be,type:"exToEx",toInput:bf.substring(1),user:true}}else{this.commandMap_[be]={name:be,type:"exToKey",toKeys:W(bf),user:true}}}else{if(bf!=":"&&bf.charAt(0)==":"){var bd={keys:W(bc),type:"keyToEx",exArgs:{input:bf.substring(1)},user:true};if(bb){bd.context=bb}a.unshift(bd)}else{var bd={keys:W(bc),type:"keyToKey",toKeys:W(bf),user:true};if(bb){bd.context=bb}a.unshift(bd)}}},unmap:function(bc,bb){var bg=function(bi,bh){if(bi===bh){return true}if(bi==null||bh==null){return true}if(bi.length!=bh.length){return false}for(var bj=0;bj<bi.length;bj++){if(bi[bj]!==bh[bj]){return false}}return true};if(bc!=":"&&bc.charAt(0)==":"){if(bb){throw Error("Mode not supported for ex mappings")}var be=bc.substring(1);if(this.commandMap_[be]&&this.commandMap_[be].user){delete this.commandMap_[be];return}}else{var bf=W(bc);for(var bd=0;bd<a.length;bd++){if(bg(bf,a[bd].keys)&&a[bd].context===bb&&a[bd].user){a.splice(bd,1);return}}}throw Error("No such mapping.")}};function W(be){var bc,bb;var bd=[];while(be){bb=(/<\w+-.+?>|<\w+>|./).exec(be);if(bb===null){break}bc=bb[0];be=be.substring(bb.index+bc.length);bd.push(bc)}return bd}var aM={map:function(bb,be,bc){var bd=be.args;if(!bd||bd.length<2){if(bb){aZ(bb,"Invalid mapping: "+be.input)}return}l.map(bd[0],bd[1],bc)},nmap:function(bb,bc){this.map(bb,bc,"normal")},vmap:function(bb,bc){this.map(bb,bc,"visual")},unmap:function(bb,be,bc){var bd=be.args;if(!bd||bd.length<1){if(bb){aZ(bb,"No such mapping: "+be.input)}return}l.unmap(bd[0],bc)},move:function(bb,bc){aQ.processCommand(bb,bb.state.vim,{type:"motion",motion:"moveToLineOrEdgeOfDocument",motionArgs:{forward:false,explicitRepeat:true,linewise:true},repeatOverride:bc.line+1})},set:function(bj,bg){var bd=bg.args;if(!bd||bd.length<1){if(bj){aZ(bj,"Invalid mapping: "+bg.input)}return}var bh=bd[0].split("=");var bc=bh[0];var bi=bh[1];var bf=false;if(bc.charAt(bc.length-1)=="?"){if(bi){throw Error("Trailing characters: "+bg.argString)}bc=bc.substring(0,bc.length-1);bf=true}if(bi===undefined&&bc.substring(0,2)=="no"){bc=bc.substring(2);bi=false}var be=ag[bc]&&ag[bc].type=="boolean";if(be&&bi==undefined){bi=true}if(!be&&!bi||bf){var bb=n(bc);if(bb===true||bb===false){aZ(bj," "+(bb?"":"no")+bc)}else{aZ(bj,"  "+bc+"="+bb)}}else{at(bc,bi)}},registers:function(bg,bc){var bi=bc.args;var bf=p.registerController.registers;var bd="----------Registers----------<br><br>";if(!bi){for(var bb in bf){var bj=bf[bb].toString();if(bj.length){bd+='"'+bb+"    "+bj+"<br>"}}}else{var bb;bi=bi.join("");for(var be=0;be<bi.length;be++){bb=bi.charAt(be);if(!p.registerController.isValidRegister(bb)){continue}var bh=bf[bb]||new a2();bd+='"'+bb+"    "+bh.toString()+"<br>"}}aZ(bg,bd)},sort:function(bk,bu){var bl,be,bc,bd;function bf(){if(bu.argString){var by=new b.StringStream(bu.argString);if(by.eat("!")){bl=true}if(by.eol()){return}if(!by.eatSpace()){return"Invalid arguments"}var bA=by.match(/[a-z]+/);if(bA){bA=bA[0];be=bA.indexOf("i")!=-1;bc=bA.indexOf("u")!=-1;var bx=bA.indexOf("d")!=-1&&1;var bz=bA.indexOf("x")!=-1&&1;var bw=bA.indexOf("o")!=-1&&1;if(bx+bz+bw>1){return"Invalid arguments"}bd=bx&&"decimal"||bz&&"hex"||bw&&"octal"}if(by.eatSpace()&&by.match(/\/.*\//)){"patterns not supported"}}}var bg=bf();if(bg){aZ(bk,bg+": "+bu.argString);return}var bp=bu.line||bk.firstLine();var bt=bu.lineEnd||bu.line||bk.lastLine();if(bp==bt){return}var bj=c(bp,0);var br=c(bt,aF(bk,bt));var bo=bk.getRange(bj,br).split("\n");var bh=(bd=="decimal")?/(-?)([\d]+)/:(bd=="hex")?/(-?)(?:0x)?([0-9a-f]+)/i:(bd=="octal")?/([0-7]+)/:null;var bi=(bd=="decimal")?10:(bd=="hex")?16:(bd=="octal")?8:null;var bm=[],bq=[];if(bd){for(var bs=0;bs<bo.length;bs++){if(bh.exec(bo[bs])){bm.push(bo[bs])}else{bq.push(bo[bs])}}}else{bq=bo}function bv(bx,bw){if(bl){var by;by=bx;bx=bw;bw=by}if(be){bx=bx.toLowerCase();bw=bw.toLowerCase()}var bA=bd&&bh.exec(bx);var bz=bd&&bh.exec(bw);if(!bA){return bx<bw?-1:1}bA=parseInt((bA[1]+bA[2]).toLowerCase(),bi);bz=parseInt((bz[1]+bz[2]).toLowerCase(),bi);return bA-bz}bm.sort(bv);bq.sort(bv);bo=(!bl)?bq.concat(bm):bm.concat(bq);if(bc){var bn=bo;var bb;bo=[];for(var bs=0;bs<bn.length;bs++){if(bn[bs]!=bb){bo.push(bn[bs])}bb=bn[bs]}}bk.replaceRange(bo.join("\n"),bj,br)},global:function(bo,bf){var bc=bf.argString;if(!bc){aZ(bo,"Regular Expression missing from global");return}var bi=(bf.line!==undefined)?bf.line:bo.firstLine();var bg=bf.lineEnd||bf.line||bo.lastLine();var bn=r(bc);var bq=bc,be;if(bn.length){bq=bn[0];be=bn.slice(1,bn.length).join("/")}if(bq){try{a8(bo,bq,true,true)}catch(bl){aZ(bo,"Invalid regex: "+bq);return}}var bm=ar(bo).getQuery();var bb=[],bk="";for(var bh=bi;bh<=bg;bh++){var bd=bm.test(bo.getLine(bh));if(bd){bb.push(bh+1);bk+=bo.getLine(bh)+"<br>"}}if(!be){aZ(bo,bk);return}var bj=0;var bp=function(){if(bj<bb.length){var br=bb[bj]+be;l.processCommand(bo,br,{callback:bp})}bj++};bp()},substitute:function(bi,bq){if(!bi.getSearchCursor){throw new Error("Search feature not available. Requires searchcursor.js or any other getSearchCursor implementation.")}var br=bq.argString;var bl=br?r(br):[];var bj,bk="",bb,bc,bg;var bh=false;var bn=false;if(bl.length){bj=bl[0];bk=bl[1];if(bk!==undefined){if(n("pcre")){bk=S(bk)}else{bk=a6(bk)}p.lastSubstituteReplacePart=bk}bb=bl[2]?bl[2].split(" "):[]}else{if(br&&br.length){aZ(bi,"Substitutions should be of the form :s/pattern/replace/");return}}if(bb){bc=bb[0];bg=parseInt(bb[1]);if(bc){if(bc.indexOf("c")!=-1){bh=true;bc.replace("c","")}if(bc.indexOf("g")!=-1){bn=true;bc.replace("g","")}bj=bj+"/"+bc}}if(bj){try{a8(bi,bj,true,true)}catch(bp){aZ(bi,"Invalid regex: "+bj);return}}bk=bk||p.lastSubstituteReplacePart;if(bk===undefined){aZ(bi,"No previous substitute regular expression");return}var be=ar(bi);var bf=be.getQuery();var bm=(bq.line!==undefined)?bq.line:bi.getCursor().line;var bo=bq.lineEnd||bm;if(bg){bm=bo;bo=bm+bg-1}var bs=N(bi,c(bm,0));var bd=bi.getSearchCursor(bf,bs);aO(bi,bh,bn,bm,bo,bd,bf,bk,bq.callback)},redo:b.commands.redo,undo:b.commands.undo,write:function(bb){if(b.commands.save){b.commands.save(bb)}else{bb.save()}},nohlsearch:function(bb){aw(bb)},delmarks:function(bl,bg){if(!bg.argString||!aP(bg.argString)){aZ(bl,"Argument required");return}var bb=bl.state.vim;var bm=new b.StringStream(aP(bg.argString));while(!bm.eol()){bm.eatSpace();var bj=bm.pos;if(!bm.match(/[a-zA-Z]/,false)){aZ(bl,"Invalid argument: "+bg.argString.substring(bj));return}var bd=bm.next();if(bm.match("-",true)){if(!bm.match(/[a-zA-Z]/,false)){aZ(bl,"Invalid argument: "+bg.argString.substring(bj));return}var be=bd;var bi=bm.next();if(y(be)&&y(bi)||u(be)&&u(bi)){var bc=be.charCodeAt(0);var bk=bi.charCodeAt(0);if(bc>=bk){aZ(bl,"Invalid argument: "+bg.argString.substring(bj));return}for(var bh=0;bh<=bk-bc;bh++){var bf=String.fromCharCode(bc+bh);delete bb.marks[bf]}}else{aZ(bl,"Invalid argument: "+be+"-");return}}else{delete bb.marks[bd]}}}};var l=new d.ExCommandDispatcher();function aO(bp,bc,be,bk,bi,bd,bm,bg,bq){bp.state.vim.exMode=true;var bh=false;var bo=bd.from();function bl(){bp.operation(function(){while(!bh){bf();bj()}bn()})}function bf(){var bs=bp.getRange(bd.from(),bd.to());var br=bs.replace(bm,bg);bd.replace(br)}function bj(){var br;while(br=bd.findNext()&&R(bd.from(),bk,bi)){if(!be&&bo&&bd.from().line==bo.line){continue}bp.scrollIntoView(bd.from(),30);bp.setSelection(bd.from(),bd.to());bo=bd.from();bh=false;return}bh=true}function bn(bs){if(bs){bs()}bp.focus();if(bo){bp.setCursor(bo);var br=bp.state.vim;br.exMode=false;br.lastHPos=br.lastHSPos=bo.ch}if(bq){bq()}}function bb(bu,br,bv){b.e_stop(bu);var bs=b.keyName(bu);switch(bs){case"Y":bf();bj();break;case"N":bj();break;case"A":var bt=bq;bq=undefined;bp.operation(bl);bq=bt;break;case"L":bf();case"Q":case"Esc":case"Ctrl-C":case"Ctrl-[":bn(bv);break}if(bh){bn(bv)}}bj();if(bh){aZ(bp,"No matches for "+bm.source);return}if(!bc){bl();if(bq){bq()}return}aJ(bp,{prefix:"replace with <strong>"+bg+"</strong> (y/n/a/q/l)",onKeyDown:bb})}function an(){function bd(bh,bg){var bf=bh;if(u(bf)&&bg=="Ctrl"){bf=bf.toLowerCase()}if(bg){bf=bg.charAt(0)+"-"+bf}var bi=({Enter:"CR",Backspace:"BS",Delete:"Del"})[bf];bf=bi?bi:bf;bf=bf.length>1?"<"+bf+">":bf;return bf}function bc(bf){return function(bg){b.signal(bg,"vim-keypress",bf);b.Vim.handleKey(bg,bf)}}var bb={nofallthrough:true,style:"fat-cursor"};function be(bk,bg){for(var bj=0;bj<bk.length;bj++){var bi=bk[bj];if(!bg&&bi.length==1){bi="'"+bi+"'"}var bf=bd(bk[bj],bg);var bh=bg?bg+"-"+bi:bi;bb[bh]=bc(bf)}}be(U);be(aa);be(U,"Ctrl");be(h);be(h,"Ctrl");be(K);be(K,"Ctrl");be(aE);be(aE,"Ctrl");return bb}b.keyMap.vim=an();function q(bb){var bd=bb.state.vim;var bf=p.macroModeState;var bc=p.registerController.getRegister(".");var be=bf.isPlaying;if(!be){bb.off("change",aW);b.off(bb.getInputField(),"keydown",L)}if(!be&&bd.insertModeRepeat>1){s(bb,bd,bd.insertModeRepeat-1,true);bd.lastEditInputState.repeatOverride=bd.insertModeRepeat}delete bd.insertModeRepeat;bd.insertMode=false;bb.setCursor(bb.getCursor().line,bb.getCursor().ch-1);bb.setOption("keyMap","vim");bb.setOption("disableInput",true);bb.toggleOverwrite(false);bc.setText(bf.lastInsertModeChanges.changes.join(""));b.signal(bb,"vim-mode-change",{mode:"normal"});if(bf.isRecording){ab(bf)}}b.keyMap["vim-insert"]={Esc:q,"Ctrl-[":q,"Ctrl-C":q,"Ctrl-N":"autocomplete","Ctrl-P":"autocomplete",Enter:function(bb){var bc=b.commands.newlineAndIndentContinueComment||b.commands.newlineAndIndent;bc(bb)},fallthrough:["default"]};b.keyMap["vim-replace"]={Backspace:"goCharLeft",fallthrough:["vim-insert"]};function A(bj,bd,be,bb){var bl=p.registerController.getRegister(bb);var bc=bl.keyBuffer;var bh=0;be.isPlaying=true;be.replaySearchQueries=bl.searchQueries.slice(0);for(var bf=0;bf<bc.length;bf++){var bm=bc[bf];var bg,bk;while(bm){bg=(/<\w+-.+?>|<\w+>|./).exec(bm);bk=bg[0];bm=bm.substring(bg.index+bk.length);b.Vim.handleKey(bj,bk);if(bd.insertMode){var bi=bl.insertModeChanges[bh++].changes;p.macroModeState.lastInsertModeChanges.changes=bi;af(bj,bi,1);q(bj)}}}be.isPlaying=false}function B(be,bb){if(be.isPlaying){return}var bd=be.latestRegister;var bc=p.registerController.getRegister(bd);if(bc){bc.pushText(bb)}}function ab(bd){if(bd.isPlaying){return}var bc=bd.latestRegister;var bb=p.registerController.getRegister(bc);if(bb){bb.pushInsertModeChanges(bd.lastInsertModeChanges)}}function F(be,bd){if(be.isPlaying){return}var bc=be.latestRegister;var bb=p.registerController.getRegister(bc);if(bb){bb.pushSearchQuery(bd)}}function aW(bc,bb){var be=p.macroModeState;var bd=be.lastInsertModeChanges;if(!be.isPlaying){while(bb){bd.expectCursorActivityForChange=true;if(bb.origin=="+input"||bb.origin=="paste"||bb.origin===undefined){var bf=bb.text.join("\n");bd.changes.push(bf)}bb=bb.next}}}function O(bi){var bb=bi.state.vim;if(bb.insertMode){var bc=p.macroModeState;if(bc.isPlaying){return}var bd=bc.lastInsertModeChanges;if(bd.expectCursorActivityForChange){bd.expectCursorActivityForChange=false}else{bd.changes=[]}}else{if(bi.doc.history.lastSelOrigin=="*mouse"){bb.lastHPos=bi.doc.getCursor().ch;if(bi.somethingSelected()){bb.visualMode=true}}}if(bb.visualMode){var bg,bf;bg=bf=bi.getCursor("head");var be=bi.getCursor("anchor");var bh=c(bf.line,bg.ch+(ay(be,bf)?-1:1));if(ay(bh,bg)){var bj=bg;bg=bh;bh=bj}if(bb.fakeCursor){bb.fakeCursor.clear()}bb.fakeCursor=bi.markText(bg,bh,{className:"cm-animate-fat-cursor"})}}function aY(bb){this.keyName=bb}function L(bf){var be=p.macroModeState;var bd=be.lastInsertModeChanges;var bc=b.keyName(bf);function bb(){bd.changes.push(new aY(bc));return true}if(bc.indexOf("Delete")!=-1||bc.indexOf("Backspace")!=-1){b.lookupKey(bc,["vim-insert"],bb)}}function s(bj,be,bc,bb){var bg=p.macroModeState;bg.isPlaying=true;var bk=!!be.lastEditActionCommand;var bh=be.inputState;function bd(){if(bk){aQ.processAction(bj,be,be.lastEditActionCommand)}else{aQ.evalInput(bj,be)}}function bi(bm){if(bg.lastInsertModeChanges.changes.length>0){bm=!be.lastEditActionCommand?1:bm;var bl=bg.lastInsertModeChanges;bg.lastInsertModeChanges={};af(bj,bl.changes,bm);bg.lastInsertModeChanges=bl}}be.inputState=be.lastEditInputState;if(bk&&be.lastEditActionCommand.interlaceInsertRepeat){for(var bf=0;bf<bc;bf++){bd();bi(1)}}else{if(!bb){bd()}bi(bc)}be.inputState=bh;if(be.insertMode&&!bb){q(bj)}bg.isPlaying=false}function af(bb,be,bf){function bg(bj){if(typeof bj=="string"){b.commands[bj](bb)}else{bj(bb)}return true}for(var bd=0;bd<bf;bd++){for(var bc=0;bc<be.length;bc++){var bi=be[bc];if(bi instanceof aY){b.lookupKey(bi.keyName,["vim-insert"],bg)}else{var bh=bb.getCursor();bb.replaceRange(bi,bh,bh)}}}}t();return az};b.Vim=d()});