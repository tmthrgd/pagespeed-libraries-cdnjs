!function(){var version="0.0.11";Event.prototype.preventDefault||(Event.prototype.preventDefault=function(){this.returnValue=!1});var Output=function(refs){this.refs=refs||{},this.type="image/png",this.urlLocation=!1,this.actions=[],this.tagName="",this.hasFilters=!1,this.filters={}};Output.prototype.tag=function(name){return this.tagName=name,this},Output.prototype.resize=function(size){return this.actions.push({method:"resize",options:size}),this},Output.prototype.filter=function(type,value){return"object"!=typeof type||type instanceof Array?(this.filters[type]=value,this.hasFilters=!0,this):(this.filters=type,this.hasFilters=!0,this)},Output.prototype.url=function(location){return this.urlLocation=location,this},Output.prototype.rotate=function(options){return this.actions.push({method:"rotate",options:options}),this},Output.prototype.crop=function(position){return this.actions.push({method:"crop",options:position}),this},Output.prototype.layer=function(refName,options){var action={method:"layer",options:{ref:refName}};return!options||"object"!=typeof options||options instanceof Array||Object.keys(options).forEach(function(index){action.options[index]=options[index]}),this.actions.push(action),this},Output.prototype.type=function(mime){return this.type=mime,this},Output.prototype.export=function(){this.hasFilters&&this.actions.push({method:"filter",options:this.filters});var output={ref:this.refs,type:this.type,tag:this.tagName,methods:this.actions};return this.urlLocation&&(output.url=this.urlLocation),output};var _6px=function(images){this.reset(),images&&"object"==typeof images&&Object.keys(images).forEach(function(index){this.load(index,images[index])},this)};_6px.prototype.load=function(name,path){return this.images[name]=path,this},_6px.prototype.output=function(refs){var output=new Output(refs);return this.outputs.push(output),output},_6px.prototype.reset=function(){this.images={},this.outputs=[],this.callback=!1},_6px.prototype.callback=function(url){return this.url=url,this},_6px.prototype.save=function(options,fn){var _this=this;"function"==typeof options&&(fn=options,options={});var inputs={},inputTotal=Object.keys(this.images),inputTotalLen=inputTotal.length,done=function(){var json={input:inputs,output:_this.outputs.map(function(output){return output.export()})};_this.callback&&(json.callback={url:_this.callback}),px.sendToServer("post","/users/:userId/jobs",json,function(res){fn&&fn.call(_this,null,res)},function(){fn&&fn.call(_this,"Error sending to server")})};inputTotal.forEach(function(index){px.parseInput(this.images[index],function(data){inputs[index]=data,--inputTotalLen||done()})},this)};var px=function(input){if(!px.userData)throw"6px: You must call init!";return new _6px(input)};px.init=function(data){if(px.userData)throw"6px: Init must only be called once!";if(px.debug=!!data.debug||!1,px.dryRun=!!data.dryRun||!1,!data.apiKey)throw"6px: apiKey is required!";if(!data.userId)throw"6px: userId is required!";px.userData=data;var success=function(res){px.openSocket(),px.log(res)},failed=function(res){px.log("failed:",res),px.trigger("error","")};px.sendToServer("post","/users/:userId/auth",null,success,failed)},px.openSocket=function(){var host="ws://socks.6px.io",socket=new WebSocket(host);socket.onopen=function(){px.sendSocketMsg(socket,{auth:{user_id:px.userData.userId}})},setInterval(function(){socket.send(JSON.stringify({ping:!0}))},3e4),socket.onclose=function(){setTimeout(function(){px.openSocket()},1e3)},socket.onmessage=px.handleIncoming},px.sendSocketMsg=function(socket,obj){socket.send(JSON.stringify(obj))},px.handleIncoming=function(msg){var data=JSON.parse(msg.data);data.auth&&data.auth===!0&&console.log("Auth successful"),data.job_id&&data.status&&px.trigger("job-update",data.job_id,data.status)},px.on=function(name,fn){window.addEventListener(name,function(e){var args=[e];if(e.detail)for(var i in e.detail)e.detail.hasOwnProperty(i)&&args.push(e.detail[i]);fn.apply(null,args)},!1)},px.trigger=function(name){var options=Array.prototype.slice.call(arguments,1);"error"==name&&px.log(options[0],!0),window.dispatchEvent(new CustomEvent(name,{detail:options}))},px.dropZone=function(input,options){var elm;if(elm="string"==typeof input?document.querySelector(input):input,!elm)return px.trigger("error","Element is not defined"),!1;var wrapCallbacks=function(e,cb){return e.preventDefault(),cb&&cb(e),!1},dragOver=function(e){return wrapCallbacks(e,options.onDragOver)},dragEnd=function(e){return wrapCallbacks(e,options.onDragEnd)},dropped=function(e){return wrapCallbacks(e,options.onDrop)};elm.ondragover=dragOver,elm.ondragend=function(){return dragEnd},elm.ondrop=dropped},px.parseInput=function(input,fn){if("string"==typeof input)return void fn.call(null,input);if(input instanceof Image)return void fn.call(null,input.src);if(1===input.nodeType&&"img"==input.tagName.toLowerCase())return void fn.call(null,input.src);if(void 0===window.FormData)throw"6px: FileAPI not supported with your browser.";var f=input.files[0],dataUrlReader=new FileReader;dataUrlReader.onloadend=function(){fn.call(null,this.result)},dataUrlReader.readAsDataURL(f)},px.sendToServer=function(method,path,json,success,failed){var user=px.userData;path=path.replace(":userId",user.userId);var url="https://api.6px.io/v1"+path+(/\?/.test(url)?"&":"?")+"key="+user.apiKey,xhr=new XMLHttpRequest;xhr.onreadystatechange=function(){return xhr.readyState<4?void 0:200!==xhr.status?failed.call(window,JSON.parse(xhr.responseText)):void(4===xhr.readyState&&success.call(null,JSON.parse(xhr.responseText)))},xhr.open(method.toUpperCase(),url,!0),json?(xhr.setRequestHeader("Content-Type","application/json"),xhr.send(JSON.stringify(json))):xhr.send()},px.log=function(msg,err){px.debug&&console&&console.log&&(err?console.error("6px:",msg):console.log("6px:",msg))},px.get=function(jobId,cb,binding){px.sendToServer("get","/users/:userId/jobs/"+jobId,!1,function(res){cb.call(binding||window,res)},function(res){cb.call(binding||window,res)})},px.version=version,window.px=px}();