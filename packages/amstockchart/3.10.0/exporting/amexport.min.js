AmCharts.AmExport=AmCharts.Class({construct:function(b,a,c){var d=this;d.DEBUG=false;d.chart=b;d.canvas=null;d.svgs=[];d.userCFG=a;d.buttonIcon="export.png";d.exportPNG=true;d.exportPDF=false;d.exportJPG=false;d.exportSVG=false;d.right=0;d.top=0;d.buttonRollOverColor="#EFEFEF";d.textRollOverColor="#CC0000";d.buttonTitle="Save chart as an image";d.buttonAlpha=0.75;d.imageFileName="amChart";d.imageBackgroundColor="#FFFFFF";if(c){d.init()}},toCoordinate:function(a){if(a===undefined){return"auto"}if(String(a).indexOf("%")!=-1){return a}else{return a+"px"}},init:function(){var f=this;var g=[];if(f.exportPNG){g.push("png")}if(f.exportPDF){g.push("pdf")}if(f.exportJPG){g.push("jpg")}if(f.exportSVG){g.push("svg")}var a=[];if(g.length==1){var h=g[0];a.push({format:h,iconTitle:f.buttonTitle,icon:f.chart.pathToImages+f.buttonIcon})}else{if(g.length>1){var d=[];for(var c=0;c<g.length;c++){d.push({format:g[c],title:g[c].toUpperCase()})}a.push({onclick:function(){},icon:f.chart.pathToImages+f.buttonIcon,items:d})}}var b=f.color;if(b===undefined){b=f.chart.color}var j=f.buttonColor;if(j===undefined){j="transparent"}f.cfg={menuTop:f.toCoordinate(f.top),menuLeft:f.toCoordinate(f.left),menuRight:f.toCoordinate(f.right),menuBottom:f.toCoordinate(f.bottom),menuItems:a,menuItemStyle:{backgroundColor:j,opacity:f.buttonAlpha,rollOverBackgroundColor:f.buttonRollOverColor,color:b,rollOverColor:f.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:f.chart.fontFamily,fontSize:f.chart.fontSize+"px"},menuItemOutput:{backgroundColor:f.imageBackgroundColor,fileName:f.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(i,k,l){l.preventDefault();if(f.chart.prepareForExport){f.chart.prepareForExport()}i.output(k)}},removeImagery:true};f.processing={buffer:[],drawn:0,timer:0};if(typeof(window.canvg)!="undefined"&&typeof(window.RGBColor)!="undefined"){f.cfg.menuItemOutput.render="canvg"}if(typeof(window.saveAs)!="undefined"){f.cfg.menuItemOutput.output="save"}if(AmCharts.isIE&&AmCharts.IEversion<10){f.cfg.menuItemOutput.output="dataurlnewwindow"}var e=f.userCFG;if(e){e.menuItemOutput=AmCharts.extend(f.cfg.menuItemOutput,e.menuItemOutput||{});e.menuItemStyle=AmCharts.extend(f.cfg.menuItemStyle,e.menuItemStyle||{});f.cfg=AmCharts.extend(f.cfg,e)}f.chart.AmExport=f;f.chart.addListener("rendered",function(){f.setup()});if(f.DEBUG){window.AmExport=f}},log:function(){console.log("AmExport: ",arguments)},setup:function(){var a=this;if(a.DEBUG==10){a.log("SETUP START")}if(!AmCharts.isIE||(AmCharts.isIE&&AmCharts.IEversion>9)){a.generateButtons();if(a.DEBUG==10){a.log("SETUP END")}}else{if(a.DEBUG==10){a.log("< IE10 NOT SUPPORTED")}}},generateBinaryArray:function(l){var h=l.length,e=new Uint8Array(h/4*3|0),g=0,k=0,m=[0,0],a=0,j=0,f,b,c,d=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);while(h--){b=l.charCodeAt(g++);f=d[b-43];if(f!==255&&f!==c){m[1]=m[0];m[0]=b;j=(j<<6)|f;a++;if(a===4){e[k++]=j>>>16;if(m[1]!==61){e[k++]=j>>>8}if(m[0]!==61){e[k++]=j}a=0}}}return e},generateBlob:function(e,c){var g=this,a=c!="image/svg+xml"?e.indexOf(",")+1:0,f=e.substring(0,a),d=e,b=new Blob();if(f.indexOf("base64")!=-1){d=g.generateBinaryArray(e.substring(a))}if(AmCharts.isIE&&AmCharts.IEversion<10){b.data=d;b.size=d.length;b.type=c;b.encoding="base64"}else{b=new Blob([d],{type:c})}return b},generatePDF:function(c){var f=this,b={output:function(){return""}},e=f.canvas.toDataURL("image/jpeg"),d=(f.canvas.width*25.4)/c.dpi,a=(f.canvas.height*25.4)/c.dpi;if(window.jsPDF){b=new jsPDF();if(b.addImage){b.addImage(e,"JPEG",0,0,d,a)}else{alert("Missing jsPDF plugin; Please add the 'addImage' plugin.")}}else{alert("Missing jsPDF lib; Don't forget to add the addImage plugin.")}return b},output:function(a,c){var d=this;a=AmCharts.extend(AmCharts.extend({},d.cfg.menuItemOutput),a||{});function b(){var f=null;var e;if(d.DEBUG==10){d.log("OUTPUT",a.format)}if(a.format=="image/svg+xml"||a.format=="svg"){f=d.generateSVG();e=d.generateBlob(f,"image/svg+xml");if(a.output=="save"){saveAs(e,a.fileName+".svg")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e="data:image/svg+xml;base64,"+btoa(f)}else{if(a.output=="dataurlnewwindow"){window.open("data:image/svg+xml;base64,"+btoa(f))}else{if(a.output=="datauri"||a.output=="dataurl"){location.href="data:image/svg+xml;base64,"+btoa(f)}else{if(a.output=="datastream"){location.href="data:image/octet-stream;base64,"+f}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="application/pdf"||a.format=="pdf"){f=d.generatePDF(a).output("dataurlstring");e=d.generateBlob(f,"application/pdf");if(a.output=="save"){saveAs(e,a.fileName+".pdf")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=f}else{if(a.output=="dataurlnewwindow"){window.open(f)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=f}else{if(a.output=="datastream"){location.href=f.replace("application/pdf","application/octet-stream")}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="image/png"||a.format=="png"){f=d.canvas.toDataURL("image/png");e=d.generateBlob(f,"image/png");if(a.output=="save"){saveAs(e,a.fileName+".png")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=f}else{if(a.output=="dataurlnewwindow"){window.open(f)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=f}else{if(a.output=="datastream"){location.href=f.replace("image/png","image/octet-stream")}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="image/jpeg"||a.format=="jpeg"||a.format=="jpg"){f=d.canvas.toDataURL("image/jpeg");e=d.generateBlob(f,"image/jpeg");if(a.output=="save"){saveAs(e,a.fileName+".jpg")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=f}else{if(a.output=="dataurlnewwindow"){window.open(f)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=f}else{if(a.output=="datastream"){location.href=f.replace("image/jpeg","image/octet-stream")}}}}}if(c){c.apply(d,[e])}}}}}}return d.generateOutput(a,b)},polifySVG:function(a){var c=this;function b(g,d){var f=g.getElementsByTagName(d);var j=f.length;while(j--){if(c.cfg.removeImagery){f[j].parentNode.removeChild(f[j])}else{var l=document.createElement("img");var h=document.createElement("canvas");var e=h.getContext("2d");h.width=f[j].getAttribute("width");h.height=f[j].getAttribute("height");l.src=f[j].getAttribute("xlink:href");l.width=f[j].getAttribute("width");l.height=f[j].getAttribute("height");try{e.drawImage(l,0,0,l.width,l.height);datastring=h.toDataURL()}catch(k){datastring=l.src;c.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!");throw new Error(k)}f[j].setAttribute("xlink:href",datastring)}if(c.DEBUG==10){c.log("POLIFIED",f[j])}}}if(AmCharts.IEversion==0){a.setAttribute("xmlns","http://www.w3.org/2000/svg");if(!c.cfg.removeImagery){a.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")}}if(c.DEBUG==10){c.log("POLIFIED",a)}b(a,"pattern");b(a,"image");c.svgs.push(a);return a},generateSVG:function(){var e=this;var b=document.createElement("svg");b.setAttribute("xmlns","http://www.w3.org/2000/svg");b.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var a=0;a<e.processing.buffer.length;a++){var d=document.createElement("g"),c=e.processing.buffer[a];c[0].setAttribute("xmlns","http://www.w3.org/2000/svg");c[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");d.setAttribute("transform","translate("+c[1].x+","+c[1].y+")");d.appendChild(c[0]);b.appendChild(d)}return new XMLSerializer().serializeToString(b)},generateOutput:function(k,n){var j=this,m=j.chart.div.getElementsByTagName("svg"),c=document.createElement("canvas"),b=c.getContext("2d"),e={y:0,x:0},h={};j.processing.buffer=[];j.processing.drawn=0;j.canvas=c;j.svgs=[];if(j.DEBUG==10){j.log("START EXPORT")}if(j.DEBUG==10){j.log("START BUFFERING")}for(var g=0;g<m.length;g++){var l=m[g].parentNode,p=Number(l.style.left.slice(0,-2)),o=Number(l.style.top.slice(0,-2)),f=j.polifySVG(m[g].cloneNode(true)),h=AmCharts.extend({},e);if(l.style.position=="relative"){e.x=p?p:e.x;e.y=o?o:e.y}else{e.x=p;e.y=o}j.processing.buffer.push([f,AmCharts.extend({},e)]);if(o&&p){e=h}else{e.y+=o?0:l.offsetHeight}if(j.DEBUG==10){j.log("BUFFERED",m[g],e)}}if(j.DEBUG==10){j.log("END BUFFERING")}if(j.DEBUG==10){j.log("START DRAWING",k.render)}if(j.DEBUG==10){j.log("FILL BACKGROUND")}c.id=AmCharts.getUniqueId();c.width=j.chart.divRealWidth;c.height=j.chart.divRealHeight;var d={width:false,height:false};if(j.chart.periodSelector){if(["left","right"].indexOf(j.chart.periodSelector.position)!=-1){c.width-=j.chart.periodSelector.div.offsetWidth+16;d.width=true}else{c.height-=j.chart.periodSelector.div.offsetHeight;d.height=true}}if(j.chart.dataSetSelector){if(["left","right"].indexOf(j.chart.dataSetSelector.position)!=-1){if(!d.width){c.width-=j.chart.dataSetSelector.div.offsetWidth+16}}else{c.height-=j.chart.dataSetSelector.div.offsetHeight}}if(k.backgroundColor||k.format=="image/jpeg"){b.fillStyle=k.backgroundColor||"#FFFFFF";b.fillRect(0,0,c.width,c.height)}function a(){var q,i,s,r;if(j.processing.buffer.length==j.processing.drawn||k.format=="svg"){if(j.DEBUG==10){j.log("END DRAWING")}return n()}else{if(j.DEBUG==10){j.log("DRAW",j.processing.drawn+1,"OF",j.processing.buffer.length)}i=j.processing.buffer[j.processing.drawn];r=new XMLSerializer().serializeToString(i[0]);s=i[1];if(j.DEBUG==10){j.log("SOURCE",r)}if(k.render=="browser"){q=new Image();q.id=AmCharts.getUniqueId();r="data:image/svg+xml;base64,"+btoa(r);q.onload=function(){b.drawImage(this,i[1].x,i[1].y);j.processing.drawn++;if(j.DEBUG==10){j.log("ONLOAD",this)}a()};q.onerror=function(){if(j.DEBUG==10){j.log("ONERROR",this)}b.drawImage(this,i[1].x,i[1].y);j.processing.drawn++;a()};q.src=r;if(j.DEBUG==10){j.log("ADD",q)}if(q.complete||typeof(q.complete)=="undefined"||q.complete===undefined){if(j.DEBUG==10){j.log("FORCE ONLOAD",q)}q.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";q.src=r}}else{if(k.render=="canvg"){canvg(c,r,{offsetX:s.x,offsetY:s.y,ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true,renderCallback:function(){j.processing.drawn++;a()}})}}}}return a()},generateButtons:function(){var d=this,c=document.createElement("div"),a=0;function b(k){var j=document.createElement("ul");j.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var f=0;f<k.length;f++){var m=document.createElement("li"),g=document.createElement("img"),l=document.createElement("a"),n=k[f],e=null,h=AmCharts.extend(AmCharts.extend({},d.cfg.menuItemStyle),k[f]);n=AmCharts.extend(AmCharts.extend({},d.cfg.menuItemOutput),n);if(n.icon){g.alt="";g.src=n.icon;g.setAttribute("style","margin: 0 auto;border: none;outline: none");if(n.iconTitle){g.title=n.iconTitle}l.appendChild(g)}l.href="#";if(n.title){g.setAttribute("style","margin-right: 5px;");l.innerHTML+=n.title}l.setAttribute("style","display: block;");AmCharts.extend(l.style,h);l.onclick=n.onclick.bind(l,d,n);m.appendChild(l);if(n.items){e=b(n.items);m.appendChild(e);m.onmouseover=function(){e.style.display="block"};m.onmouseout=function(){e.style.display="none"};e.style.display="none"}j.appendChild(m);l.onmouseover=function(){this.style.backgroundColor=h.rollOverBackgroundColor;this.style.color=h.rollOverColor;this.style.borderColor=h.rollOverBorderColor};l.onmouseout=function(){this.style.backgroundColor=h.backgroundColor;this.style.color=h.color;this.style.borderColor=h.borderColor}}a++;if(d.DEBUG==10){d.log("MENU",j)}return j}c.setAttribute("style","width:39px; height:28px; position: absolute;top:"+d.cfg.menuTop+";right:"+d.cfg.menuRight+";bottom:"+d.cfg.menuBottom+";left:"+d.cfg.menuLeft+";box-shadow:0px 0px 1px 0px rgba(0,0,0,0);");c.setAttribute("class","amExportButton");c.appendChild(b(d.cfg.menuItems));d.chart.containerDiv.appendChild(c)}});