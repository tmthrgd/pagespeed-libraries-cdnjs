(function(){var z=this,g,e,u,q,v,w,r,C,D,p,A;"undefined"!==typeof exports?(g=require("underscore"),e=require("backbone"),"undefined"!==typeof module&&module.exports&&(module.exports=e),exports=e):(g=z._,e=z.Backbone);u=e.Model;q=e.Collection;v=u.prototype;w=q.prototype;e.Associations={VERSION:"0.5.5"};var E=function(){return p},B=function(a){if(!g.isString(a)||1>g.size(a))a=".";p=a;C=RegExp("[\\"+p+"\\[\\]]+","g");D=RegExp("[^\\"+p+"\\[\\]]+","g")};try{Object.defineProperty(e.Associations,"SEPARATOR",
{enumerable:!0,get:E,set:B})}catch(H){}e.Associations.Many=e.Many="Many";e.Associations.One=e.One="One";e.Associations.Self=e.Self="Self";e.Associations.SEPARATOR=".";e.Associations.getSeparator=E;e.Associations.setSeparator=B;e.Associations.EVENTS_BUBBLE=!0;e.Associations.EVENTS_WILDCARD=!0;e.Associations.EVENTS_NC=!0;B();r=e.AssociatedModel=e.Associations.AssociatedModel=u.extend({relations:void 0,_proxyCalls:void 0,get:function(a){var c=v.get.call(this,a);return c?c:this._getAttr.apply(this,arguments)},
set:function(a,c,d){var b;g.isObject(a)||null==a?(b=a,d=c):(b={},b[a]=c);a=this._set(b,d);this._processPendingEvents();return a},_set:function(a,c){var d,b,e,f,h=this;if(!a)return this;for(d in a)if(b||(b={}),d.match(C)){var l=F(d);f=g.initial(l);l=l[l.length-1];f=this.get(f);f instanceof r&&(f=b[f.cid]||(b[f.cid]={model:f,data:{}}),f.data[l]=a[d])}else f=b[this.cid]||(b[this.cid]={model:this,data:{}}),f.data[d]=a[d];if(b)for(e in b)f=b[e],this._setAttr.call(f.model,f.data,c)||(h=!1);else h=this._setAttr.call(this,
a,c);return h},_setAttr:function(a,c){var d;c||(c={});if(c.unset)for(d in a)a[d]=void 0;this.parents=this.parents||[];this.relations&&g.each(this.relations,function(b){var d=b.key,f=b.relatedModel,h=b.collectionType,l=b.map,k=this.attributes[d],n=k&&k.idAttribute,m,s,t,p=!1;!f||f.prototype instanceof u||(f=g.isFunction(f)?f.call(this,b,a):f);f&&g.isString(f)&&(f=f===e.Self?this.constructor:x(f));h&&g.isString(h)&&(h=x(h));l&&g.isString(l)&&(l=x(l));s=b.options?g.extend({},b.options,c):c;if(!f&&!h)throw Error("specify either a relatedModel or collectionType");
if(a[d]){m=g.result(a,d);m=l?l.call(this,m,h?h:f):m;if(b.type===e.Many){if(h&&!h.prototype instanceof q)throw Error("collectionType must inherit from Backbone.Collection");k?(k._deferEvents=!0,k[s.reset?"reset":"set"](m instanceof q?m.models:m,s),b=k):(p=!0,m instanceof q?b=m:(b=h?new h:this._createCollection(f),b[s.reset?"reset":"set"](m,s)))}else if(b.type===e.One){if(!f)throw Error("specify a relatedModel for Backbone.One type");if(!(f.prototype instanceof e.AssociatedModel))throw Error("specify an AssociatedModel for Backbone.One type");
b=m instanceof r?m:new f(m,s);k&&b.attributes[n]&&k.attributes[n]===b.attributes[n]?(k._deferEvents=!0,k._set(m instanceof r?m.attributes:m,s),b=k):p=!0}else throw Error("type attribute must be specified and have the values Backbone.One or Backbone.Many");t=a[d]=b;if(p||t&&!t._proxyCallback)t._proxyCallback=function(){return e.Associations.EVENTS_BUBBLE&&this._bubbleEvent.call(this,d,t,arguments)},t.on("all",t._proxyCallback,this)}a.hasOwnProperty(d)&&(k=a[d],n=this.attributes[d],k?(k.parents=k.parents||
[],-1==g.indexOf(k.parents,this)&&k.parents.push(this)):n&&0<n.parents.length&&(n.parents=g.difference(n.parents,[this]),n._proxyCallback&&n.off("all",n._proxyCallback,this)))},this);return v.set.call(this,a,c)},_bubbleEvent:function(a,c,d){var b=d[0].split(":"),g=b[0],f="change"===g,h=d[1],l=-1,k=c._proxyCalls,b=b[1],n;if("nested-change"!=d[0]){if(e.Associations.EVENTS_WILDCARD&&/\[\*\]/g.test(b))return this;c instanceof q&&(f||b)&&(l=c.indexOf(A||h));this instanceof u&&(A=this);b=a+(-1!==l&&(f||
b)?"["+l+"]":"")+(b?p+b:"");e.Associations.EVENTS_WILDCARD&&(n=b.replace(/\[\d+\]/g,"[*]"));h=[];h.push.apply(h,d);h[0]=g+":"+b;e.Associations.EVENTS_WILDCARD&&b!==n&&(h[0]=h[0]+" "+g+":"+n);k=c._proxyCalls=k||{};if(this._isEventAvailable.call(this,k,b))return this;k[b]=!0;f&&(this._previousAttributes[a]=c._previousAttributes,this.changed[a]=c);this.trigger.apply(this,h);e.Associations.EVENTS_NC&&(f&&this.get(b)!=d[2])&&(a=["nested-change",b,d[1]],d[2]&&a.push(d[2]),this.trigger.apply(this,a));k&&
b&&delete k[b];A=void 0;return this}},_isEventAvailable:function(a,c){return g.find(a,function(a,b){return-1!==c.indexOf(b,c.length-b.length)})},_createCollection:function(a){var c=a;g.isString(c)&&(c=x(c));if(c&&c.prototype instanceof r||g.isFunction(c))a=new q,a.model=c;else throw Error("type must inherit from Backbone.AssociatedModel");return a},_processPendingEvents:function(){this._processedEvents||(this._processedEvents=!0,this._deferEvents=!1,g.each(this._pendingEvents,function(a){a.c.trigger.apply(a.c,
a.a)}),this._pendingEvents=[],g.each(this.relations,function(a){(a=this.attributes[a.key])&&a._processPendingEvents()},this),delete this._processedEvents)},trigger:function(a){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):v.trigger.apply(this,arguments)},toJSON:function(a){var c={},d;c[this.idAttribute]=this.id;this.visited||(this.visited=!0,c=v.toJSON.apply(this,arguments),this.relations&&g.each(this.relations,function(b){var e=b.key,
f=b.remoteKey,h=this.attributes[e];b=!b.isTransient;delete c[e];b&&(d=h&&h.toJSON?h.toJSON(a):h,c[f||e]=g.isArray(d)?g.compact(d):d)},this),delete this.visited);return c},clone:function(){return new this.constructor(this.toJSON())},cleanup:function(){g.each(this.relations,function(a){(a=this.attributes[a.key])&&(a.parents=g.difference(a.parents,[this]))},this);this.off()},_getAttr:function(a){var c=this;a=F(a);var d,b;if(!(1>g.size(a))){for(b=0;b<a.length;b++){d=a[b];if(!c)break;c=c instanceof q?
isNaN(d)?void 0:c.at(d):c.attributes[d]}return c}}});var F=function(a){return""===a?[""]:g.isString(a)?a.match(D):a||[]},x=function(a){return g.reduce(a.split(p),function(a,d){return a[d]},z)},G=function(a,c,d){var b,e;g.find(a,function(a){if(b=g.find(a.relations,function(b){return a.get(b.key)===c},this))return e=a,!0},this);return b&&b.map?b.map.call(e,d,c):d},y={};g.each(["set","remove","reset"],function(a){y[a]=q.prototype[a];w[a]=function(c,d){this.model.prototype instanceof r&&this.parents&&
(arguments[0]=G(this.parents,this,c));return y[a].apply(this,arguments)}});y.trigger=w.trigger;w.trigger=function(a){this._deferEvents?(this._pendingEvents=this._pendingEvents||[],this._pendingEvents.push({c:this,a:arguments})):y.trigger.apply(this,arguments)};w._processPendingEvents=r.prototype._processPendingEvents}).call(this);
