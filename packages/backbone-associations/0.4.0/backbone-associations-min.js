(function(){var f,k,q,l,m,s,o;"undefined"!==typeof require?(f=require("underscore"),k=require("backbone"),exports=module.exports=k):(f=window._,k=window.Backbone);q=k.Model;l=k.Collection;m=q.prototype;s="change add remove reset destroy sync error sort request".split(" ");k.Many="Many";k.One="One";o=k.AssociatedModel=q.extend({relations:void 0,_proxyCalls:void 0,get:function(d){return this.getAttr.apply(this,arguments)},set:function(d,a,c){var b,e,j,n,i=this;if(f.isObject(d)||d==null){b=d;c=a}else{b=
{};b[d]=a}if(!b)return this;for(e in b){var a=r(e),d=f.initial(a),a=f.last(a),g=this,h=this.get(d);j||(j={});if(!(!h&&f.size(d)>0||h instanceof l)){h instanceof o&&(g=h);d=j[g.cid]||(j[g.cid]={model:g,data:{}});d.data[a]=b[e]}}if(j)for(n in j){d=j[n];this.setAttr.call(d.model,d.data,c)||(i=false)}else i=this.setAttr.call(this,b,c);return i},setAttr:function(d,a){var c,b,e;a||(a={});if(a.unset)for(e in d)d[e]=void 0;this.relations&&f.each(this.relations,function(b){var e=b.key,i=b.relatedModel,g=b.collectionType,
h,p;if(d[e]){h=f.result(d,e);i&&f.isString(i)&&(i=eval(i));g&&f.isString(g)&&(g=eval(g));p=b.options?f.extend({},b.options,a):a;if(b.type===k.Many){if(g&&!g.prototype instanceof l)throw Error("collectionType must inherit from Backbone.Collection");if(h instanceof l)m.set.call(this,e,h,p);else if(this.attributes[e])this.attributes[e].reset(h,p);else{b=g?new g:this._createCollection(i);b.add(h,p);m.set.call(this,e,b,p)}}else if(b.type===k.One&&i){b=h instanceof o?h:new i(h);m.set.call(this,e,b,p)}if((h=
this.attributes[e])&&!h._proxyCallback){h._proxyCallback=function(){return this._bubbleEvent.call(this,e,arguments)};h.on("all",h._proxyCallback,this)}!c&&(c=[]);f.indexOf(c,e)===-1&&c.push(e)}},this);if(c){b={};for(e in d)f.indexOf(c,e)===-1&&(b[e]=d[e])}else b=d;return m.set.call(this,b,a)},_bubbleEvent:function(d,a){var c=a[0].split(":"),b=c[0],e=a[1],j=-1,n=this.attributes[d],i=n._proxyCalls,g;if(f.contains(s,b)){f.size(c)>1&&(g=c[1]);if(n instanceof l&&"change"===b&&e){var h=r(g),k=f.initial(h);
(c=n.find(function(b){var a=b.get(h);return e===(a instanceof o||a instanceof l)?a:b.get(k)||b}))&&(j=n.indexOf(c))}g=d+(j!==-1?"["+j+"]":"")+(g?"."+g:"");a[0]=b+":"+g;if(i){if(b=f.find(i,function(b,a){return g.indexOf(a,g.length-a.length)!==-1}))return this}else i=n._proxyCalls={};i[g]=true}this.trigger.apply(this,a);g&&i&&delete i[g];return this},_createCollection:function(d){var a=d;f.isString(a)&&(a=eval(a));if(a&&a.prototype instanceof o){d=new l;d.model=a}else throw Error("type must inherit from Backbone.AssociatedModel");
return d},hasChanged:function(d){var a,c,b;if(!this.visitedHC){this.visitedHC=true;a=m.hasChanged.apply(this,arguments);if(!a&&this.relations)for(b=0;b<this.relations.length;++b){c=this.relations[b];if(c=this.attributes[c.key]){if(c instanceof l){c=c.filter(function(a){return a.hasChanged()===true});f.size(c)>0&&(a=true)}else a=c.hasChanged&&c.hasChanged();if(a)break}}delete this.visitedHC}return!!a},changedAttributes:function(d){var a,c,b,e;if(!this.visited){this.visited=true;a=m.changedAttributes.apply(this,
arguments);if(this.relations)for(e=0;e<this.relations.length;++e){c=this.relations[e];if(b=this.attributes[c.key])if(b instanceof l){b=f.filter(b.map(function(a){return a.changedAttributes()}),function(a){return!!a});f.size(b)>0&&(a[c.key]=b)}else b instanceof o&&b.hasChanged()&&(a[c.key]=b.toJSON())}delete this.visited}return!a?false:a},previousAttributes:function(){var d,a,c,b;if(!this.visited){this.visited=true;d=m.previousAttributes.apply(this,arguments);this.relations&&f.each(this.relations,
function(e){a=this.attributes[e.key];b=(c=d[e.key])?c.toJSON():void 0;c&&c==a?a instanceof o?d[e.key]=a.previousAttributes():a instanceof l&&(d[e.key]=a.map(function(a){return a.previousAttributes()})):c&&(d[e.key]=b)},this);delete this.visited}return d},previous:function(d){return this.previousAttributes()[d]},toJSON:function(d){var a,c;if(!this.visited){this.visited=true;a=m.toJSON.apply(this,arguments);this.relations&&f.each(this.relations,function(b){var e=this.attributes[b.key];if(e){c=e.toJSON(d);
a[b.key]=f.isArray(c)?f.compact(c):c}},this);delete this.visited}return a},clone:function(){return new this.constructor(this.toJSON())},getAttr:function(d,a){var c=this,b=r(d),e,j;if(!(f.size(b)<1)){a||(a=function(a,b){return a instanceof l&&f.isNumber(b)?a.at(b):a.attributes[b]});for(j=0;j<b.length;j++){e=b[j];if(!c)break;c=a.call(this,c,e,b)}return c}}});var t=/^\d+$/,u=/[^\.\[\]]+/g,r=function(d,a,c){if(f.isString(d)){a||(a=function(a){return a.match(t)?parseInt(a,10):a});return f.map(d.match(u)||
[""],a,c)}return d||[""]}})();
