!function(t,e){"undefined"!=typeof exports?module.exports=e(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],e):e(t._,t.Backbone)}(this,function(t,e){var i=e.Ribs={version:"0.2.2"},n=function(t,e,i){return t._super.prototype[e].apply(t,i)},s=function(t){if(-1===t.indexOf("!."))return t.split(".");for(var e,i=[],n="",s=t.charAt(0),r=0,o=t.length;o>r;r++)nch=t.charAt(r+1),"."===s&&"!"===e?n+=".":"."===s&&"!"!==e?(i.push(n),n=""):("!"!==s||"."!==nch)&&(n+=s),e=s,s=nch;return i.push(n),i},r=function(t,e){var i;for(t="string"==typeof t?s(t):t.slice();t.length;){if(i=t.shift(),!e.hasOwnProperty(i)){if(t.length)throw new Error("can't get \""+t.shift()+'" of "'+i+'", "'+i+'" is undefined');return void 0}e=e[i]}return e},o=function(t,e){var i;for(t=t.slice();t.length;)if(i=t.shift(),t.length){if(!e.hasOwnProperty(i))break;e=e[i]}else delete e[i]},h=function(t,e,i){return this.name=e,"function"==typeof t?(this.get=function(){return t.apply(i,arguments)},this.set=function(){throw new Error('set: computed "'+e+'" has no set method')},this._simple=!0,this):(this._deps=t.deps,this._get=t.get,this.set=function(){return t.set.apply(i,arguments)},this._model=i,this)};h.prototype.update=function(e){if(!this._simple){var i,n=[];if(this._previous=this.value,this._deps instanceof Array)for(var s=0;s<this._deps.length;s++){try{i=this._model.get(this._deps[s])}catch(r){i=void 0}n.push(i)}this.value=this._get.apply(this._model,n),t.isEqual(this._previous,this.value)||this._model.trigger("change:"+this.name,this._model,this.value,e)}},h.prototype.get=function(){return this.value};var a=function(t,e){var i=this.view.handlers;if(i[t].multiple)for(var n in e)e.hasOwnProperty(n)&&this.addHandler(t,e[n],n);else this.addHandler(t,e)},l=function(t,e,i){var n;this.selector=e,this.view=t,this.mods={},this._setEl(),this.handlers=[];for(var s in i)if(i.hasOwnProperty(s)&&"collection"!==s)if(n=i[s],n instanceof Array)for(var r=0;r<n.length;r++)a.call(this,s,n[r]);else a.call(this,s,n)};l.prototype._unbind=function(){var t,i,n,r,o,h,a,l,c,d=this.handlers,f=[];for(a=0;a<d.length;a++)for(h=d[a],t=h.paths,l=0;l<t.length;l++)for(i=t[l],r=s(i.attr),n=i.model,o="",this.view[n]instanceof e.Collection&&-1===f.indexOf(n)&&(f.push(n),this.view[n].off("add remove reset sort",h.set)),c=0;c<r.length;c++)o&&(o+="."),o+=r[c],this.view[n].off("change:"+o,h.set)};var c=function(t){var e,i,n=t.match(/^(?:!\.|[^.])+/);try{if(e=n[0],i=t.slice(e.length+1),!i.length||!e.length)throw""}catch(s){throw new Error('wrong binging data"'+t+'"')}return{model:e,attr:i}};l.prototype.addHandler=function(t,i,n){var r,o,h=i,a=i.filter,l=i.events||"change",d=this.view.filters,f=[];if("string"!=typeof i&&(i=i.data),"string"==typeof i)f.push(c(i));else for(r=0,o=i.length;o>r;r++)f.push(c(i[r]));var u,p,v,g,w,_,m,b=[],y=[],O=this,P={paths:f},x=this.view.handlers[t];if("function"!=typeof x&&(m=x.get,x=x.set),"string"==typeof a){if(!d.hasOwnProperty(a))throw new Error('unknown filter "'+a+'"');a=d[a]}var $=function(){for(var t,i,s=[],r=0;r<f.length;r++)i=f[r],s.push(O.view[i.model]instanceof e.Collection?O.view[i.model].pluck(i.attr):O.view[i.model].get(i.attr));t=a?a.apply(O.view,s):s[0],x.call(O,O.$el,t,n,h)};for(r=0;r<f.length;r++){u=f[r],p=u.model,v=u.attr,g=s(v),w="",this.view[p]instanceof e.Collection?(b.push(this.view[p].pluck(v)),-1===y.indexOf(p)&&(y.push(p),this.view[p].on("add remove reset sort",$))):b.push(this.view[p].get(v));for(var C=0;C<g.length;C++)w&&(w+="."),w+=g[C],this.view[p].on("change:"+w,$)}if(_=a?a.apply(this.view,b):b[0],x.call(this,this.$el,_,n,h),m){var k=function(){O.view[p].set(v,m.call(O,O.$el))};this.view.$el.on(l+".bindingHandlers"+this.view.cid,this.selector,k),P.events=l,P.get=k}P.set=$,this.handlers.push(P)},l.prototype._setEl=function(){var t=this.selector;this.$el="el"===t?this.view.$el:this.view.$(t)};var d={not:function(t){return!t},length:function(t){return t.hasOwnProperty("length")?t.length:0}},f={text:function(t,e){t.text(e)},value:{set:function(t,e){t.val()!==e&&t.val(e)},get:function(t){return t.val()}},css:{set:function(t,e,i){t.css(i,e)},multiple:!0},attr:{set:function(t,e,i){t.attr(i,e)},multiple:!0},classes:{set:function(t,e,i){t.toggleClass(i,!!e)},multiple:!0},html:function(t,e){t.html(e)},toggle:function(t,e){t.toggle(!!e)},disabled:function(t,e){t.prop("disabled",!!e)},enabled:function(t,e){t.prop("disabled",!e)},checked:{set:function(t,e){if(t.prop("checked",!1),e instanceof Array)for(var i=0;i<e.length;i++)t.filter('[value="'+e[i]+'"]').prop("checked",!0);else"boolean"==typeof e?t.prop("checked",e):t.filter('[value="'+e+'"]').prop("checked",!0)},get:function(t){var e=t.attr("type"),i=t.filter(":checked");if("checkbox"===e){var n=[];return 1===t.length?!!i.length:(i.each(function(t,e){n.push($(e).val())}),n)}return i.val()}},options:{set:function(t,e){t.val(e)},get:function(t){return t.val()||[]}},mod:{set:function(t,e,i,n){var s=this.mods[n];s&&t.removeClass(s),s=i+e,this.mods[n]=s,t.addClass(s)},multiple:!0}};return i.Model=e.Model.extend({_super:e.Model,constructor:function(e,i){this._ribs={computeds:{},computedsDeps:{}};var n=e||{};i||(i={}),this.cid=t.uniqueId("c"),this.attributes={},i.collection&&(this.collection=i.collection),i.parse&&(n=this.parse(n,i)||{}),n=t.defaults({},n,t.result(this,"defaults"));var s={};for(var r in n)n.hasOwnProperty(r)&&(s[r.replace(".","!.")]=n[r]);this.set(s,i),this.changed={},this._initComputeds(),this.initialize.apply(this,arguments)},get:function(t){if("string"!=typeof t)return void 0;var e=this._ribs.computeds;if(t in e)return e[t].get();var i=s(t);return 1===i.length?n(this,"get",[i[0]]):r(i,this.attributes)},set:function(e,i,n){if(null==e)return this;var h,a,l,c,d,f,u,p,v,g,w,_,m;if("object"==typeof e?(h=e,n=i):(h={},h[e]=i),n||(n={}),!this._validate(h,n))return!1;u=n.unset,f=n.silent,a=[],l=this._changing,this._changing=!0;for(var b,y=this._ribs.computeds,O=t.clone(h),P={},x=!0,$=!0;x;){x=!1,b={};for(g in h)h.hasOwnProperty(g)&&g in y&&(x=!0,t.extend(b,y[g].set(h[g])),$&&(P[g]=h[g]),delete h[g],t.extend(h,b));$=!1}if(!l){this._previousAttributes=t.clone(this.attributes);var C={};for(g in y)y.hasOwnProperty(g)&&(C[g]=y[g].value);t.extend(this._previousAttributes,C),this.changed={}}c=this.attributes,d=this._previousAttributes,this.idAttribute in h&&(this.id=h[this.idAttribute]);for(g in h)if(h.hasOwnProperty(g)){if(i=h[g],p=s(g),!t.isEqual(r(p,c),i)){for(v=p.slice(),w=0;w<v.length;w++)v[w]=v[w].replace(".","!.");a.push({path:p,escapedPath:v,attr:g,val:i})}t.isEqual(r(p,d),i)?delete this.changed[g]:this.changed[g]=i,u&&g in O?o(p,c):this._setPath(p,i)}for(g in P)P.hasOwnProperty(g)&&u&&(this.removeComputed(g),delete P[g]);var k,V,E=this._ribs.computedsDeps,A=[];for(w=0,m=a.length;m>w;w++)if(g=a[w].attr,k=E["change:"+g])for(_=0;_<k.length;_++)V=k[_],-1===A.indexOf(V)&&A.push(V);if(!f)for(m=a.length,m&&(this._pending=n),w=0;m>w;w++)if(this.trigger("change:"+a[w].attr,this,a[w].val,n),n.propagation&&(v=a[w].escapedPath.slice(),v.length))for(;v.length-1;)v.length--,this.trigger("change:"+v.join("."),this,void 0,n);for(w=0;w<A.length;w++)y[A[w]].update(n);if(l)return this;if(!f)for(;this._pending;)n=this._pending,this._pending=!1,this.trigger("change",this,n);return this._pending=!1,this._changing=!1,this},trigger:function(t){var e,i,s=this._ribs.computedsDeps,r=arguments[3];if("string"==typeof t&&t in s){var o,h=this._ribs.computeds,a=s[t];for(e=0,i=a.length;i>e;e++)o=h[a[e]],o.update(r)}return r&&r.silent?this:n(this,"trigger",arguments)},_setPath:function(t,e){var i,n=this.attributes;for(t=t.slice();t.length;)if(i=t.shift(),t.length){if(!(n.hasOwnProperty(i)&&n[i]instanceof Object))throw new Error("set: can't set anything to \""+i+'", typeof == "'+typeof n[i]+'"');n=n[i]}else n[i]=e},_initComputeds:function(){var t,e=this.computeds;for(t in e)e.hasOwnProperty(t)&&this.addComputed(t,e[t],{silent:!0});for(t in e)e.hasOwnProperty(t)&&this._ribs.computeds[t].update()},addComputed:function(t,e){if(t in this.attributes||t in this._ribs.computeds)throw new Error('addComputed: computed name "'+t+'" is already used');var i,n,r=e.deps,o=this._ribs.computedsDeps;if(r instanceof Array)for(var a=0;a<r.length;a++){i=s(r[a]),n="change:"+i[0].replace(".","!.");for(var l=0;l<i.length;l++)n in o?-1===o[n].indexOf(t)&&o[n].push(t):o[n]=[t],i[l+1]&&(n+="."+i[l+1].replace(".","!."))}this._ribs.computeds[t]=new h(e,t,this);var c=arguments[2]||{};return c.silent||this._ribs.computeds[t].update(),this},removeComputed:function(t){var e,i,n,s=this._ribs.computedsDeps;for(i in s)s.hasOwnProperty(i)&&(e=s[i],n=e.indexOf(t),-1!==n&&e.splice(n,1),e.length||delete s[i]);return delete this._ribs.computeds[t],this}}),i.View=e.View.extend({_super:e.View,constructor:function(){this._ribs={_bindings:this.bindings||{},bindings:[],collections:{}},this.filters=this.filters||{},this.handlers=this.handlers||{},t.extend(this.filters,d),t.extend(this.handlers,f),n(this,"constructor",arguments),this._ribs.preventBindings||this.applyBindings()},preventBindings:function(){this._ribs.preventBindings=!0},applyBindings:function(){this.removeBindings();var t=this._ribs._bindings;for(var e in t)t.hasOwnProperty(e)&&this.addBinding(e,t[e])},addBinding:function(t,e){var i=this._ribs._bindings,n=!1;if(i.hasOwnProperty(t)||(i[t]=e),e.collection){var s=e.collection;this.applyCollection(t,this[s.col],this[s.view])}for(var r in e)e.hasOwnProperty(r)&&(n=!0);n&&this._ribs.bindings.push(new l(this,t,e))},removeBindings:function(){var t=this._ribs.bindings,e=this._ribs.collections;this.$el.off(".bindingHandlers"+this.cid);for(var i=0;i<t.length;i++)t[i]._unbind();for(var n in e)if(e.hasOwnProperty(n)){n=e[n];for(var s in n)if(n.hasOwnProperty(s)){s=n[s],s.collection.off("sort",this._onSort,this),s.collection.off("add",this._onaddView,this),s.collection.off("remove",this._removeView,this),s.collection.off("reset",this._onReset,this);for(var r in s.views)s.views.hasOwnProperty(r)&&s.views[r].remove()}}this._ribs.collections={},this._ribs.bindings=[]},updateBindings:function(){for(var t,e=this._ribs.bindings,i=0;i<e.length;i++){t=e[i],t._setEl();for(var n=0;n<t.handlers.length;n++)t.handlers[n].set()}},applyCollection:function(e,i,n,s){var r,o,h,a,l=t.uniqueId("bc"),c={};s=s||{},a=e instanceof $?e:"el"===e?this.$el:this.$(e),i.comparator&&i.sort(),i.cid||(i.cid=t.uniqueId("col")),r=this._ribs.collections[i.cid],r||(r=this._ribs.collections[i.cid]={},i.on("sort",this._onSort,this),i.on("add",this._onaddView,this),i.on("remove",this._removeView,this),i.on("reset",this._onReset,this)),r[l]={collection:i,$el:a,View:n,data:s,views:c};for(var d=document.createDocumentFragment(),f=0;f<i.length;f++)h=i.at(f),o=new n(t.extend(s,{model:h,collection:i})),c[h.cid]=o,d.appendChild(o.el);return a.append(d),l},_onSort:function(t){this.renderCollection(t)},renderCollection:function(t,e){var i,n,s,r=this._ribs.collections[t.cid];for(var o in r)if(r.hasOwnProperty(o)&&(!e||o===e)){if(i=r[o],!i)throw new Error("can't render collection without binding");n=i.views;for(s in n)n.hasOwnProperty(s)&&n[s].$el.detach();for(var h=0;h<t.length;h++)s=n[t.at(h).cid],s?i.$el.append(s.$el):this._addView(t.at(h),t,o)}},_onaddView:function(t,e){this._addView(t,e)},_addView:function(e,i,n){var s,r,o,h,a,l=this._ribs.collections[i.cid],c=e.cid;for(var d in l)if(l.hasOwnProperty(d)&&(!n||d===n)){s=l[d],r=s.views,h=new s.View(t.extend(s.data,{model:e,collection:i})),a=void 0;for(var f=0;f<i.length;f++){if(o=i.at(f).cid,o===c){void 0===a?s.$el.prepend(h.$el):r[a].$el.after(h.$el);break}o in r&&(a=o)}r[c]=h}},_removeView:function(t,e){var i,n,s=this._ribs.collections[e.cid];for(var r in s)s.hasOwnProperty(r)&&(i=s[r],n=i.views[t.cid],n.remove(),delete i.views[t.cid])},_onReset:function(t){var e,i,n=this._ribs.collections[t.cid];for(var s in n)if(n.hasOwnProperty(s)){e=n[s],i=e.views;for(var r in i)i.hasOwnProperty(r)&&(r=i[r],r.remove());e.views={};for(var o=0;o<t.length;o++)this._addView(t.at(o),t)}}}),i});