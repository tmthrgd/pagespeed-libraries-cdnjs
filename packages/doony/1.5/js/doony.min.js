/* Doony v0.1 | (c) 2013 Kevin Burke | License: MIT */
!function(a,b){var c=function(a){var b,c;if(b=c=0,a.offsetParent)do b+=a.offsetLeft,c+=a.offsetTop;while(null!==(a=a.offsetParent));return[b,c]},ProgressCircle=function(a){this.canvas=a.canvas,this.minRadius=a.minRadius||15,this.arcWidth=a.arcWidth||5,this.gapWidth=a.gapWidth||3,this.centerX=a.centerX||this.canvas.width/2,this.centerY=a.centerY||this.canvas.height/2,this.infoLineLength=a.infoLineLength||60,this.horizLineLength=a.horizLineLength||10,this.infoLineAngleInterval=a.infoLineAngleInterval||Math.PI/8,this.infoLineBaseAngle=a.infoLineBaseAngle||Math.PI/6,this.context=this.canvas.getContext("2d"),this.width=this.canvas.width,this.height=this.canvas.height,this.circles=[],this.runningCount=0};ProgressCircle.prototype={constructor:ProgressCircle,addEntry:function(a){return this.circles.push(new d({canvas:this.canvas,context:this.context,centerX:this.centerX,centerY:this.centerY,innerRadius:this.minRadius+this.circles.length*(this.gapWidth+this.arcWidth),arcWidth:this.arcWidth,infoLineLength:this.infoLineLength,horizLineLength:this.horizLineLength,id:this.circles.length,fillColor:a.fillColor,outlineColor:a.outlineColor,progressListener:a.progressListener,infoListener:a.infoListener,infoLineAngle:this.infoLineBaseAngle+this.circles.length*this.infoLineAngleInterval})),this},start:function(a){var b=this;return this.timer=setInterval(function(){b._update()},a||33),this},stop:function(){clearTimeout(this.timer)},_update:function(){return this._clear(),this.circles.forEach(function(a){a.update()}),this},_clear:function(){return this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this}};var d=function(a){if(this.id=a.id,this.canvas=a.canvas,this.context=a.context,this.centerX=a.centerX,this.centerY=a.centerY,this.arcWidth=a.arcWidth,this.innerRadius=a.innerRadius||0,this.fillColor=a.fillColor||"#fff",this.outlineColor=a.outlineColor||this.fillColor,this.progressListener=a.progressListener,this.infoLineLength=a.infoLineLength||250,this.horizLineLength=a.horizLineLength||50,this.infoListener=a.infoListener,this.infoLineAngle=a.infoLineAngle,this.outerRadius=this.innerRadius+this.arcWidth,this.infoListener){var d=this.infoLineAngle,e=(this.innerRadius+this.outerRadius)/2,f=Math.sin(d),g=Math.cos(d);this.infoLineStartX=this.centerX+f*e,this.infoLineStartY=this.centerY-g*e,this.infoLineMidX=this.centerX+f*this.infoLineLength,this.infoLineMidY=this.centerY-g*this.infoLineLength,this.infoLineEndX=this.infoLineMidX+(0>f?-this.horizLineLength:this.horizLineLength),this.infoLineEndY=this.infoLineMidY;var h=b.createElement("div"),i=h.style;i.color=this.fillColor,i.position="absolute",i.left=this.infoLineEndX+c(this.canvas)[0]+"px",h.className="ProgressCircleInfo",h.id="progress_circle_info_"+this.id,b.body.appendChild(h),this.infoText=h}};d.prototype={constructor:d,update:function(){this.progress=this.progressListener(),this._draw(),this.infoListener&&(this.info=this.infoListener(),this._drawInfo())},_draw:function(){var a=this.context,b=-Math.PI/2,c=0+b,d=c+this.progress*Math.PI*2,e=this.centerX,f=this.centerY,g=this.innerRadius,h=this.outerRadius;return a.fillStyle=this.fillColor,a.strokeStyle=this.outlineColor,a.beginPath(),a.arc(e,f,g,c,d,!1),a.arc(e,f,h,d,c,!0),a.closePath(),a.stroke(),a.fill(),this},_drawInfo:function(){var a,b;return a=[[this.infoLineStartX,this.infoLineStartY],[this.infoLineMidX,this.infoLineMidY],[this.infoLineEndX,this.infoLineEndY]],this._drawSegments(a,!1),this.infoText.innerHTML=this.info,b=this.infoText.offsetHeight,this.infoText.style.top=this.infoLineEndY+c(this.canvas)[1]-b/2+"px",this},_drawSegments:function(a,b){var c=this.context;c.beginPath(),c.moveTo(a[0][0],a[0][1]);for(var d=1;d<a.length;++d)c.lineTo(a[d][0],a[d][1]);b&&c.closePath(),c.stroke()}},a.ProgressCircle=ProgressCircle}(window,document),jQuery(function(a){var b=["#C02942","#4ecdc4","#d95b43","#556270","#542437","#8fbe00"],c={ERROR:"alert-danger",WARNING:"alert-warning"},d=function(a){var b=a.split(".");return b.length<=2?b.join("."):b.slice(0,-2).join(".")},e=function(a){var b,c,d=0;if(0===a.length)return d;for(b=0,l=a.length;l>b;b++)c=a.charCodeAt(b),d=(d<<5)-d+c,d|=0;return d},f=function(a){return null!==a.match(/^\/job\/.*?\//)},g=function(a){return null!==a.match(/^\/job\/.*?\/(.*?=.*?\/)?$/)},h=function(a){return null!==a.match(/^\/job\/.*?\/$/)},i=function(a){return a.match(/^\/job\/.*?\//)[0]},j=function(a){return a.match(/^\/job\/.*?\/(.*?=.*?\/)?/)[0]},k=function(b,c){a.getJSON(b+"api/json?tree=builds[number]",function(a){for(var d=0;d<a.builds.length;d++){var e=a.builds[d];e.number===c&&(window.location.href=b+c+"/consoleFull")}setTimeout(function(){k(b,c)},1e3)})},m=function(b,c){return h(b)?void a.getJSON(b+"api/json?tree=activeConfigurations[name]",function(a){if("{}"!==JSON.stringify(a)&&"activeConfigurations"in a){var d=b+a.activeConfigurations[0].name+"/";return k(d,c)}return k(b,c)}):k(b,c)},n=function(b,c){var d=document.createElement("div");d.className="alert doony-alert "+c,d.innerHTML=b,a("#main-panel").prepend(d)},o=a("#top-panel a").first(),p=d(window.location.hostname);o.html("<div id='doony-title'>"+p+"</div>");var q=b[Math.abs(e(p))%b.length];a("#top-panel").css("background-color",q),a(".task").each(function(){a("a img",a(this)).remove(),a(this).html(function(a,b){var c=b.replace(/&nbsp;/g,"","g");return c})});var r=function(a,b){return"<div class='doony-callout doony-callout-info'><a "+(null===b?"":"href='"+b+"'")+">"+a+"</a></div>"},s=function(b,c){a.getJSON(b+c+"api/json?tree=lastBuild[number]",function(d){null!==d.lastBuild&&"number"in d.lastBuild&&a("#matrix .model-link").each(function(e,f){if(f.getAttribute("href")===c){var g=b+c+d.lastBuild.number+"/consoleFull";a(f).next(".doony-callout").children("a").attr("href",g)}})})};a("#matrix").length&&setInterval(function(){var b=j(window.location.pathname);a("#matrix .doony-downstream-link").length||(a("#matrix .model-link").wrap("<div class='doony-downstream-link'>"),a("#matrix .model-link").each(function(b,c){var d="View console output for the latest build";a(c).after(r(d,null))}),a.getJSON(b+"api/json?tree=activeConfigurations[name]",function(a){for(var c=0;c<a.activeConfigurations.length;c++){var d=a.activeConfigurations[c];s(b,d.name+"/")}}))},50);var t=function(b,c){a(b).each(function(){var b=document.createElement("div");b.className="doony-circle doony-circle-"+c,b.style.display="inline-block";var d;"48"===this.getAttribute("width")||"24"===this.getAttribute("width")?(d=.5*this.getAttribute("width")+8,b.style.marginRight="15px",b.style.verticalAlign="middle"):this.classList.contains("icon32x32")?(d=24,b.style.marginTop="4px",b.style.marginLeft="4px"):d=this.getAttribute("width")||12,a(b).css("width",d),a(b).css("height",d),a(this).after(b).remove()})},u=function(b,c){a(b).each(function(){if(!a(this).next(".doony-canvas").length){var b=document.createElement("canvas");b.className="doony-canvas";var d;"48"===this.getAttribute("width")||"24"===this.getAttribute("width")?(d=.5*this.getAttribute("width")+8,b.style.marginRight="15px",b.style.verticalAlign="middle"):this.classList.contains("icon32x32")?(d=24,b.style.marginTop="4px",b.style.marginLeft="4px"):d=this.getAttribute("width")||12,b.setAttribute("width",d),b.setAttribute("height",d);var e=new ProgressCircle({canvas:b,minRadius:3*d/8-2,arcWidth:d/8+1}),f=0;e.addEntry({fillColor:c,progressListener:function(){return f>=1&&(f=0),f+=.005}}),e.start(24),a(this).after(b).css("display","none")}})},v="#4f9f4f";if(setInterval(function(){u("img[src*='red_anime.gif']","#d9534f"),u("img[src*='blue_anime.gif']",v),u("img[src*='grey_anime.gif']","#999"),u("img[src*='yellow_anime.gif']","#f0ad4e")},10),setInterval(function(){t("img[src*='/grey.png']","aborted"),t("img[src*='/blue.png']","success"),t("img[src*='/red.png']","failure"),t("img[src*='/yellow.png']","warning")},10),g(window.location.pathname)){var w=j(window.location.pathname);a.getJSON(w+"api/json?tree=lastBuild[number]",function(b){if("lastBuild"in b&&null!==b.lastBuild&&"number"in b.lastBuild){var c="View console output for the latest build",d=w+b.lastBuild.number+"/consoleFull",e=a("h2:contains('Permalinks')");e.after(r(c,d))}})}if(f(window.location.pathname)){var x=document.createElement("button");x.className="btn btn-primary doony-build",x.innerHTML="Build Now",a(x).click(function(){var b=i(window.location.pathname);a.getJSON(b+"api/json?depth=1&tree=nextBuildNumber,lastBuild[building]",function(d){a.post(b+"build",function(){var a="Build #"+d.nextBuildNumber+" created, you will be redirected when it is ready.";"{}"!==JSON.stringify(d)&&"lastBuild"in d&&null!==d.lastBuild&&d.lastBuild.building&&(a+=" <a href='#' id='doony-clear-build'>Cancel the current build</a>"),n(a,c.WARNING),m(j(window.location.pathname),d.nextBuildNumber)}).fail(function(a){403===a.status?n("Cannot create build. Maybe you need to log in or have the 'build' permission.",c.ERROR):n("An error occured. Please try again.",c.ERROR)})})}),a(document).on("click","#doony-clear-build",function(b){b.preventDefault();var c=i(window.location.pathname);a.getJSON(c+"api/json?tree=lastBuild[number]",function(b){a.post(c+b.lastBuild.number+"/stop")})});var y=a("#main-panel h1").first();y.children("div").length?y.append(x):(y.css("display","inline-block"),y.after(x))}a("#l10n-footer").after("<span class='doony-theme'>Browsing Jenkins with the <a target='_blank' href='https://github.com/kevinburke/doony'>Doony theme</a></span>")});