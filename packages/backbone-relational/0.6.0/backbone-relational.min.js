/**
 * Backbone-relational.js 0.6.0
 * (c) 2011 Paul Uithol
 *
 * Backbone-relational may be freely distributed under the MIT license.
 * For details and documentation: https://github.com/PaulUithol/Backbone-relational.
 * Depends on Backbone: https://github.com/documentcloud/backbone.
 */
(function(a){"use strict";var b,c,d;if(typeof window==="undefined"){b=require("underscore");c=require("backbone");d=module.exports=c}else{b=window._;c=window.Backbone;d=window}c.Relational={showWarnings:true};c.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable){throw new Error("Max permits acquired")}else{this._permitsUsed++}},release:function(){if(this._permitsUsed===0){throw new Error("All permits released")}else{this._permitsUsed--}},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(a){if(this._permitsUsed>a){throw new Error("Available permits cannot be less than used permits")}this._permitsAvailable=a}};c.BlockingQueue=function(){this._queue=[]};b.extend(c.BlockingQueue.prototype,c.Semaphore,{_queue:null,add:function(a){if(this.isBlocked()){this._queue.push(a)}else{a()}},process:function(){while(this._queue&&this._queue.length){this._queue.shift()()}},block:function(){this.acquire()},unblock:function(){this.release();if(!this.isBlocked()){this.process()}},isBlocked:function(){return this.isLocked()}});c.Relational.eventQueue=new c.BlockingQueue;c.Store=function(){this._collections=[];this._reverseRelations=[];this._subModels=[];this._modelScopes=[d]};b.extend(c.Store.prototype,c.Events,{addModelScope:function(a){this._modelScopes.push(a)},addSubModels:function(a,b){this._subModels.push({superModelType:b,subModels:a})},setupSuperModel:function(a){b.find(this._subModels,function(c){return b.find(c.subModels,function(b,d){var e=this.getObjectByName(b);if(a===e){c.superModelType._subModels[d]=a;a._superModel=c.superModelType;a._subModelTypeValue=d;a._subModelTypeAttribute=c.superModelType.prototype.subModelTypeAttribute;return true}},this)},this)},addReverseRelation:function(a){var c=b.any(this._reverseRelations,function(c){return b.all(a,function(a,b){return a===c[b]})});if(!c&&a.model&&a.type){this._reverseRelations.push(a);var d=function(a,c){if(!a.prototype.relations){a.prototype.relations=[]}a.prototype.relations.push(c);b.each(a._subModels,function(a){d(a,c)},this)};d(a.model,a);this.retroFitRelation(a)}},retroFitRelation:function(a){var b=this.getCollection(a.model);b.each(function(b){if(!(b instanceof a.model)){return}new a.type(b,a)},this)},getCollection:function(a){if(a instanceof c.RelationalModel){a=a.constructor}var d=a;while(d._superModel){d=d._superModel}var e=b.detect(this._collections,function(a){return a.model===d});if(!e){e=this._createCollection(d)}return e},getObjectByName:function(a){var c=a.split("."),d=null;b.find(this._modelScopes,function(a){d=b.reduce(c,function(a,b){return a[b]},a);if(d&&d!==a){return true}},this);return d},_createCollection:function(a){var b;if(a instanceof c.RelationalModel){a=a.constructor}if(a.prototype instanceof c.RelationalModel){b=new c.Collection;b.model=a;this._collections.push(b)}return b},resolveIdForItem:function(a,d){var e=b.isString(d)||b.isNumber(d)?d:null;if(e===null){if(d instanceof c.RelationalModel){e=d.id}else if(b.isObject(d)){e=d[a.prototype.idAttribute]}}if(!e&&e!==0){e=null}return e},find:function(a,b){var c=this.resolveIdForItem(a,b);var d=this.getCollection(a);if(d){var e=d.get(c);if(e instanceof a){return e}}return null},register:function(a){var b=this.getCollection(a);if(b){if(b.get(a)){throw new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")}var c=a.collection;b.add(a);a.bind("destroy",this.unregister,this);a.collection=c}},update:function(a){var b=this.getCollection(a);b._onModelEvent("change:"+a.idAttribute,a,b)},unregister:function(a){a.unbind("destroy",this.unregister);var b=this.getCollection(a);b&&b.remove(a)}});c.Relational.store=new c.Store;c.Relation=function(a,d){this.instance=a;d=b.isObject(d)?d:{};this.reverseRelation=b.defaults(d.reverseRelation||{},this.options.reverseRelation);this.reverseRelation.type=!b.isString(this.reverseRelation.type)?this.reverseRelation.type:c[this.reverseRelation.type]||c.Relational.store.getObjectByName(this.reverseRelation.type);this.model=d.model||this.instance.constructor;this.options=b.defaults(d,this.options,c.Relation.prototype.options);this.key=this.options.key;this.keySource=this.options.keySource||this.key;this.keyDestination=this.options.keyDestination||this.keySource||this.key;this.relatedModel=this.options.relatedModel;if(b.isString(this.relatedModel)){this.relatedModel=c.Relational.store.getObjectByName(this.relatedModel)}if(!this.checkPreconditions()){return false}if(a){this.keyContents=this.instance.get(this.keySource);if(this.key!==this.keySource){this.instance.unset(this.keySource,{silent:true})}this.instance._relations.push(this)}if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key){c.Relational.store.addReverseRelation(b.defaults({isAutoRelation:true,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation))}b.bindAll(this,"_modelRemovedFromCollection","_relatedModelAdded","_relatedModelRemoved");if(a){this.initialize();c.Relational.store.getCollection(this.instance).bind("relational:remove",this._modelRemovedFromCollection);c.Relational.store.getCollection(this.relatedModel).bind("relational:add",this._relatedModelAdded).bind("relational:remove",this._relatedModelRemoved)}};c.Relation.extend=c.Model.extend;b.extend(c.Relation.prototype,c.Events,c.Semaphore,{options:{createModels:true,includeInJSON:true,isAutoRelation:false},instance:null,key:null,keyContents:null,relatedModel:null,reverseRelation:null,related:null,_relatedModelAdded:function(a,b,c){var d=this;a.queue(function(){d.tryAddRelated(a,c)})},_relatedModelRemoved:function(a,b,c){this.removeRelated(a,c)},_modelRemovedFromCollection:function(a){if(a===this.instance){this.destroy()}},checkPreconditions:function(){var a=this.instance,d=this.key,e=this.model,f=this.relatedModel,g=c.Relational.showWarnings&&typeof console!=="undefined";if(!e||!d||!f){g&&console.warn("Relation=%o; no model, key or relatedModel (%o, %o, %o)",this,e,d,f);return false}if(!(e.prototype instanceof c.RelationalModel)){g&&console.warn("Relation=%o; model does not inherit from Backbone.RelationalModel (%o)",this,a);return false}if(!(f.prototype instanceof c.RelationalModel)){g&&console.warn("Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)",this,f);return false}if(this instanceof c.HasMany&&this.reverseRelation.type===c.HasMany){g&&console.warn("Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.",this);return false}if(a&&a._relations.length){var h=b.any(a._relations,function(a){var b=this.reverseRelation.key&&a.reverseRelation.key;return a.relatedModel===f&&a.key===d&&(!b||this.reverseRelation.key===a.reverseRelation.key)},this);if(h){g&&console.warn("Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists",this,a,d,f,this.reverseRelation.key);return false}}return true},setRelated:function(a,c){this.related=a;this.instance.acquire();this.instance.set(this.key,a,b.defaults(c||{},{silent:true}));this.instance.release()},_isReverseRelation:function(a){if(a.instance instanceof this.relatedModel&&this.reverseRelation.key===a.key&&this.key===a.reverseRelation.key){return true}return false},getReverseRelations:function(a){var c=[];var d=!b.isUndefined(a)?[a]:this.related&&(this.related.models||[this.related]);b.each(d,function(a){b.each(a.getRelations(),function(a){if(this._isReverseRelation(a)){c.push(a)}},this)},this);return c},sanitizeOptions:function(a){a=a?b.clone(a):{};if(a.silent){a.silentChange=true;delete a.silent}return a},unsanitizeOptions:function(a){a=a?b.clone(a):{};if(a.silentChange){a.silent=true;delete a.silentChange}return a},destroy:function(){c.Relational.store.getCollection(this.instance).unbind("relational:remove",this._modelRemovedFromCollection);c.Relational.store.getCollection(this.relatedModel).unbind("relational:add",this._relatedModelAdded).unbind("relational:remove",this._relatedModelRemoved);b.each(this.getReverseRelations(),function(a){a.removeRelated(this.instance)},this)}});c.HasOne=c.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(){b.bindAll(this,"onChange");this.instance.bind("relational:change:"+this.key,this.onChange);var a=this.findRelated({silent:true});this.setRelated(a);b.each(this.getReverseRelations(),function(a){a.addRelated(this.instance)},this)},findRelated:function(a){var b=this.keyContents;var c=null;if(b instanceof this.relatedModel){c=b}else if(b||b===0){c=this.relatedModel.findOrCreate(b,{create:this.options.createModels})}return c},onChange:function(a,d,e){if(this.isLocked()){return}this.acquire();e=this.sanitizeOptions(e);var f=b.isUndefined(e._related);var g=f?this.related:e._related;if(f){this.keyContents=d;if(d instanceof this.relatedModel){this.related=d}else if(d){var h=this.findRelated(e);this.setRelated(h)}else{this.setRelated(null)}}if(g&&this.related!==g){b.each(this.getReverseRelations(g),function(a){a.removeRelated(this.instance,e)},this)}b.each(this.getReverseRelations(),function(a){a.addRelated(this.instance,e)},this);if(!e.silentChange&&this.related!==g){var i=this;c.Relational.eventQueue.add(function(){i.instance.trigger("update:"+i.key,i.instance,i.related,e)})}this.release()},tryAddRelated:function(a,d){if(this.related){return}d=this.sanitizeOptions(d);var e=this.keyContents;if(e||e===0){var f=c.Relational.store.resolveIdForItem(this.relatedModel,e);if(!b.isNull(f)&&a.id===f){this.addRelated(a,d)}}},addRelated:function(a,b){if(a!==this.related){var c=this.related||null;this.setRelated(a);this.onChange(this.instance,a,{_related:c})}},removeRelated:function(a,b){if(!this.related){return}if(a===this.related){var c=this.related||null;this.setRelated(null);this.onChange(this.instance,a,{_related:c})}}});c.HasMany=c.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:c.Collection,collectionKey:true,collectionOptions:{}},initialize:function(){b.bindAll(this,"onChange","handleAddition","handleRemoval","handleReset");this.instance.bind("relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;if(b.isString(this.collectionType)){this.collectionType=c.Relational.store.getObjectByName(this.collectionType)}if(!this.collectionType.prototype instanceof c.Collection){throw new Error("collectionType must inherit from Backbone.Collection")}if(this.keyContents instanceof c.Collection){this.setRelated(this._prepareCollection(this.keyContents))}else{this.setRelated(this._prepareCollection())}this.findRelated({silent:true})},_getCollectionOptions:function(){return b.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions},_prepareCollection:function(a){if(this.related){this.related.unbind("relational:add",this.handleAddition).unbind("relational:remove",this.handleRemoval).unbind("relational:reset",this.handleReset)}if(!a||!(a instanceof c.Collection)){a=new this.collectionType([],this._getCollectionOptions())}a.model=this.relatedModel;if(this.options.collectionKey){var b=this.options.collectionKey===true?this.options.reverseRelation.key:this.options.collectionKey;if(a[b]&&a[b]!==this.instance){if(c.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,b,this.options.collectionKey)}}else if(b){a[b]=this.instance}}a.bind("relational:add",this.handleAddition).bind("relational:remove",this.handleRemoval).bind("relational:reset",this.handleReset);return a},findRelated:function(a){if(this.keyContents){var d=[];if(this.keyContents instanceof c.Collection){d=this.keyContents.models}else{this.keyContents=b.isArray(this.keyContents)?this.keyContents:[this.keyContents];b.each(this.keyContents,function(a){var b=null;if(a instanceof this.relatedModel){b=a}else if(a||a===0){b=this.relatedModel.findOrCreate(a,{create:this.options.createModels})}if(b&&!this.related.getByCid(b)&&!this.related.get(b)){d.push(b)}},this)}if(d.length){a=this.unsanitizeOptions(a);this.related.add(d,a)}}},onChange:function(a,d,e){e=this.sanitizeOptions(e);this.keyContents=d;b.each(this.getReverseRelations(),function(a){a.removeRelated(this.instance,e)},this);if(d instanceof c.Collection){this._prepareCollection(d);this.related=d}else{var f;if(this.related instanceof c.Collection){f=this.related;f.remove(f.models)}else{f=this._prepareCollection()}this.setRelated(f);this.findRelated(e)}b.each(this.getReverseRelations(),function(a){a.addRelated(this.instance,e)},this);var g=this;c.Relational.eventQueue.add(function(){!e.silentChange&&g.instance.trigger("update:"+g.key,g.instance,g.related,e)})},tryAddRelated:function(a,d){d=this.sanitizeOptions(d);if(!this.related.getByCid(a)&&!this.related.get(a)){var e=b.any(this.keyContents,function(d){var e=c.Relational.store.resolveIdForItem(this.relatedModel,d);return!b.isNull(e)&&e===a.id},this);if(e){this.related.add(a,d)}}},handleAddition:function(a,d,e){if(!(a instanceof c.Model)){return}e=this.sanitizeOptions(e);b.each(this.getReverseRelations(a),function(a){a.addRelated(this.instance,e)},this);var f=this;c.Relational.eventQueue.add(function(){!e.silentChange&&f.instance.trigger("add:"+f.key,a,f.related,e)})},handleRemoval:function(a,d,e){if(!(a instanceof c.Model)){return}e=this.sanitizeOptions(e);b.each(this.getReverseRelations(a),function(a){a.removeRelated(this.instance,e)},this);var f=this;c.Relational.eventQueue.add(function(){!e.silentChange&&f.instance.trigger("remove:"+f.key,a,f.related,e)})},handleReset:function(a,b){b=this.sanitizeOptions(b);var d=this;c.Relational.eventQueue.add(function(){!b.silentChange&&d.instance.trigger("reset:"+d.key,d.related,b)})},addRelated:function(a,b){var c=this;b=this.unsanitizeOptions(b);a.queue(function(){if(c.related&&!c.related.getByCid(a)&&!c.related.get(a)){c.related.add(a,b)}})},removeRelated:function(a,b){b=this.unsanitizeOptions(b);if(this.related.getByCid(a)||this.related.get(a)){this.related.remove(a,b)}}});c.RelationalModel=c.Model.extend({relations:null,_relations:null,_isInitialized:false,_deferProcessing:false,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(a,d){var e=this;if(d&&d.collection){this._deferProcessing=true;var f=function(a){if(a===e){e._deferProcessing=false;e.processQueue();d.collection.unbind("relational:add",f)}};d.collection.bind("relational:add",f);b.defer(function(){f(e)})}this._queue=new c.BlockingQueue;this._queue.block();c.Relational.eventQueue.block();c.Model.apply(this,arguments);c.Relational.eventQueue.unblock()},trigger:function(a){if(a.length>5&&"change"===a.substr(0,6)){var b=this,d=arguments;c.Relational.eventQueue.add(function(){c.Model.prototype.trigger.apply(b,d)})}else{c.Model.prototype.trigger.apply(this,arguments)}return this},initializeRelations:function(){this.acquire();this._relations=[];b.each(this.relations,function(a){var d=!b.isString(a.type)?a.type:c[a.type]||c.Relational.store.getObjectByName(a.type);if(d&&d.prototype instanceof c.Relation){new d(this,a)}else{c.Relational.showWarnings&&typeof console!=="undefined"&&console.warn("Relation=%o; missing or invalid type!",a)}},this);this._isInitialized=true;this.release();this.processQueue()},updateRelations:function(a){if(this._isInitialized&&!this.isLocked()){b.each(this._relations,function(b){var c=this.attributes[b.keySource]||this.attributes[b.key];if(b.related!==c){this.trigger("relational:change:"+b.key,this,c,a||{})}},this)}},queue:function(a){this._queue.add(a)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()){this._queue.unblock()}},getRelation:function(a){return b.detect(this._relations,function(b){if(b.key===a){return true}},this)},getRelations:function(){return this._relations},fetchRelated:function(a,d,e){d||(d={});var f,g=[],h=this.getRelation(a),i=h&&h.keyContents,j=i&&b.select(b.isArray(i)?i:[i],function(a){var d=c.Relational.store.resolveIdForItem(h.relatedModel,a);return!b.isNull(d)&&(e||!c.Relational.store.find(h.relatedModel,d))},this);if(j&&j.length){var k=b.map(j,function(a){var c;if(b.isObject(a)){c=h.relatedModel.build(a)}else{var d={};d[h.relatedModel.prototype.idAttribute]=a;c=h.relatedModel.build(d)}return c},this);if(h.related instanceof c.Collection&&b.isFunction(h.related.url)){f=h.related.url(k)}if(f&&f!==h.related.url()){var l=b.defaults({error:function(){var a=arguments;b.each(k,function(b){b.trigger("destroy",b,b.collection,d);d.error&&d.error.apply(b,a)})},url:f},d,{add:true});g=[h.related.fetch(l)]}else{g=b.map(k,function(a){var c=b.defaults({error:function(){a.trigger("destroy",a,a.collection,d);d.error&&d.error.apply(a,arguments)}},d);return a.fetch(c)},this)}}return g},set:function(a,d,e){c.Relational.eventQueue.block();var f;if(b.isObject(a)||a==null){f=a;e=d}else{f={};f[a]=d}var g=c.Model.prototype.set.apply(this,arguments);if(!this._isInitialized&&!this.isLocked()){this.constructor.initializeModelHierarchy();c.Relational.store.register(this);this.initializeRelations()}else if(f&&this.idAttribute in f){c.Relational.store.update(this)}if(f){this.updateRelations(e)}c.Relational.eventQueue.unblock();return g},unset:function(a,b){c.Relational.eventQueue.block();var d=c.Model.prototype.unset.apply(this,arguments);this.updateRelations(b);c.Relational.eventQueue.unblock();return d},clear:function(a){c.Relational.eventQueue.block();var b=c.Model.prototype.clear.apply(this,arguments);this.updateRelations(a);c.Relational.eventQueue.unblock();return b},change:function(a){var b=this,d=arguments;c.Relational.eventQueue.add(function(){c.Model.prototype.change.apply(b,d)})},clone:function(){var a=b.clone(this.attributes);if(!b.isUndefined(a[this.idAttribute])){a[this.idAttribute]=null}b.each(this.getRelations(),function(b){delete a[b.key]});return new this.constructor(a)},toJSON:function(){if(this.isLocked()){return this.id}this.acquire();var a=c.Model.prototype.toJSON.call(this);if(this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in a)){a[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue}b.each(this._relations,function(d){var e=a[d.key];if(d.options.includeInJSON===true){if(e&&b.isFunction(e.toJSON)){a[d.keyDestination]=e.toJSON()}else{a[d.keyDestination]=null}}else if(b.isString(d.options.includeInJSON)){if(e instanceof c.Collection){a[d.keyDestination]=e.pluck(d.options.includeInJSON)}else if(e instanceof c.Model){a[d.keyDestination]=e.get(d.options.includeInJSON)}else{a[d.keyDestination]=null}}else if(b.isArray(d.options.includeInJSON)){if(e instanceof c.Collection){var f=[];e.each(function(a){var c={};b.each(d.options.includeInJSON,function(b){c[b]=a.get(b)});f.push(c)});a[d.keyDestination]=f}else if(e instanceof c.Model){var f={};b.each(d.options.includeInJSON,function(a){f[a]=e.get(a)});a[d.keyDestination]=f}else{a[d.keyDestination]=null}}else{delete a[d.key]}if(d.keyDestination!==d.key){delete a[d.key]}});this.release();return a}},{setup:function(a){this.prototype.relations=(this.prototype.relations||[]).slice(0);this._subModels={};this._superModel=null;if(this.prototype.hasOwnProperty("subModelTypes")){c.Relational.store.addSubModels(this.prototype.subModelTypes,this)}else{this.prototype.subModelTypes=null}b.each(this.prototype.relations,function(a){if(!a.model){a.model=this}if(a.reverseRelation&&a.model===this){var d=true;if(b.isString(a.relatedModel)){var e=c.Relational.store.getObjectByName(a.relatedModel);d=e&&e.prototype instanceof c.RelationalModel}var f=!b.isString(a.type)?a.type:c[a.type]||c.Relational.store.getObjectByName(a.type);if(d&&f&&f.prototype instanceof c.Relation){new f(null,a)}}},this);return this},build:function(a,b){var c=this;this.initializeModelHierarchy();if(this._subModels&&this.prototype.subModelTypeAttribute in a){var d=a[this.prototype.subModelTypeAttribute];var e=this._subModels[d];if(e){c=e}}return new c(a,b)},initializeModelHierarchy:function(){if(b.isUndefined(this._superModel)||b.isNull(this._superModel)){c.Relational.store.setupSuperModel(this);if(this._superModel){if(this._superModel.prototype.relations){var a=b.any(this.prototype.relations,function(a){return a.model&&a.model!==this},this);if(!a){this.prototype.relations=this._superModel.prototype.relations.concat(this.prototype.relations)}}}else{this._superModel=false}}if(this.prototype.subModelTypes&&b.keys(this.prototype.subModelTypes).length!==b.keys(this._subModels).length){b.each(this.prototype.subModelTypes,function(a){var b=c.Relational.store.getObjectByName(a);b&&b.initializeModelHierarchy()})}},findOrCreate:function(a,d){var e=c.Relational.store.find(this,a);if(b.isObject(a)){if(e){e.set(e.parse?e.parse(a):a,d)}else if(!d||d&&d.create!==false){e=this.build(a,d)}}return e}});b.extend(c.RelationalModel.prototype,c.Semaphore);c.Collection.prototype.__prepareModel=c.Collection.prototype._prepareModel;c.Collection.prototype._prepareModel=function(a,b){b||(b={});if(!(a instanceof c.Model)){var d=a;b.collection=this;if(typeof this.model.findOrCreate!=="undefined"){a=this.model.findOrCreate(d,b)}else{a=new this.model(d,b)}if(!a._validate(a.attributes,b)){a=false}}else if(!a.collection){a.collection=this}return a};var e=c.Collection.prototype.__add=c.Collection.prototype.add;c.Collection.prototype.add=function(a,d){d||(d={});if(!b.isArray(a)){a=[a]}var f=[];b.each(a,function(a){if(!(a instanceof c.Model)){a=c.Collection.prototype._prepareModel.call(this,a,d)}if(a instanceof c.Model&&!this.get(a)&&!this.getByCid(a)){f.push(a)}},this);if(f.length){e.call(this,f,d);b.each(f,function(a){this.trigger("relational:add",a,this,d)},this)}return this};var f=c.Collection.prototype.__remove=c.Collection.prototype.remove;c.Collection.prototype.remove=function(a,d){d||(d={});if(!b.isArray(a)){a=[a]}else{a=a.slice(0)}b.each(a,function(a){a=this.getByCid(a)||this.get(a);if(a instanceof c.Model){f.call(this,a,d);this.trigger("relational:remove",a,this,d)}},this);return this};var g=c.Collection.prototype.__reset=c.Collection.prototype.reset;c.Collection.prototype.reset=function(a,b){g.call(this,a,b);this.trigger("relational:reset",this,b);return this};var h=c.Collection.prototype.__sort=c.Collection.prototype.sort;c.Collection.prototype.sort=function(a){h.call(this,a);this.trigger("relational:reset",this,a);return this};var i=c.Collection.prototype.__trigger=c.Collection.prototype.trigger;c.Collection.prototype.trigger=function(a){if(a==="add"||a==="remove"||a==="reset"){var d=this,e=arguments;if(a==="add"){e=b.toArray(e);if(b.isObject(e[3])){e[3]=b.clone(e[3])}}c.Relational.eventQueue.add(function(){i.apply(d,e)})}else{i.apply(this,arguments)}return this};c.RelationalModel.extend=function(a,b){var d=c.Model.extend.apply(this,arguments);d.setup(this);return d}})()