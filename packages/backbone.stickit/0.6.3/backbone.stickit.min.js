//
// backbone.stickit - v0.6.3
// The MIT License
// Copyright (c) 2012 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com> 
//
(function(t){var e=t.$||window.jQuery||window.Zepto;t.Stickit={_handlers:[],addHandler:function(t){t=_.map(_.flatten([t]),function(t){return _.extend({updateModel:!0,updateView:!0,updateMethod:"text"},t)}),this._handlers=this._handlers.concat(t)}},_.extend(t.View.prototype,{_modelBindings:null,unstickit:function(t){var e=[];_.each(this._modelBindings,function(n,i){return t&&n.model!==t?!1:(n.model.off(n.event,n.fn),e.push(n.model),delete this._modelBindings[i],void 0)},this),_.invoke(_.uniq(e),"trigger","stickit:unstuck",this.cid),this._modelBindings=_.compact(this._modelBindings),this.$el.off(".stickit"+(t?"."+t.cid:""))},stickit:function(t,e){var n=t||this.model,a=".stickit."+n.cid,p=e||this.bindings||{};this._modelBindings||(this._modelBindings=[]),this.unstickit(n),_.each(p,function(t,e){var f,v,g,b,m=p[e]||{},k=_.uniqueId();f=":el"===e?this.$el:this.$(e),f.length&&(_.isString(m)&&(m={observe:m}),_.isFunction(m.observe)&&(m.observe=m.observe.call(this)),b=c(f,m),g=b.observe,b.bindId=k,b.view=this,v=_.extend({stickitChange:b},b.setOptions),r(this,f,b,n,g),d(this,f,b,n,g),g&&(_.each(b.events,function(t){var i=t+a,l=function(t){var e=b.getVal.call(this,f,t,b,_.rest(arguments));o(this,b.updateModel,e,b)&&s(n,g,e,v,this,b)};":el"===e?this.$el.on(i,l):this.$el.on(i,e,l)},this),_.each(_.flatten([g]),function(t){l(n,this,"change:"+t,function(t,e,n){var i=n&&n.stickitChange&&n.stickitChange.bindId||null;i!==k&&h(this,f,b,u(t,g,b,this),t)})},this),h(this,f,b,u(n,g,b,this),n,!0)),n.once("stickit:unstuck",function(t){t===this.cid&&i(this,b.destroy,f,n,b)},this),i(this,b.initialize,f,n,b))},this);var f=this.remove;this.remove=function(){var t=this;return this.unstickit(),f&&(t=f.apply(this,_.rest(arguments))),t}}});var n=function(t,e){var n=(e||"").split("."),i=_.reduce(n,function(t,e){return t[e]},t);return null==i?t:i},i=function(t,e){return e?(_.isString(e)?t[e]:e).apply(t,_.rest(arguments,2)):void 0},a=function(t){return t.find("option").not(function(){return!this.selected})},o=function(t,e){return _.isBoolean(e)?e:_.isFunction(e)||_.isString(e)?i.apply(this,arguments):!1},l=function(t,e,n,i){t.on(n,i,e),e._modelBindings.push({model:t,event:n,fn:i})},s=function(t,e,n,a,o,l){l.onSet&&(n=i(o,l.onSet,n,l)),t.set(e,n,a)},u=function(t,e,n,a){var o,l=function(e){return t[n.escape?"escape":"get"](e)},s=function(t){return null==t?"":t};return o=_.isArray(e)?_.map(e,l):l(e),n.onGet&&(o=i(a,n.onGet,o,n)),_.isArray(o)?_.map(o,s):s(o)},c=t.Stickit.getConfiguration=function(e,n){var i=[{updateModel:!1,updateMethod:"text",update:function(t,e,n,i){t[i.updateMethod]&&t[i.updateMethod](e)},getVal:function(t,e,n){return t[n.updateMethod]()}}];i=i.concat(_.filter(t.Stickit._handlers,function(t){return e.is(t.selector)})),i.push(n);var a=_.extend.apply(_,i);return a.visible&&!_.has(a,"updateView")?a.updateView=!1:_.has(a,"updateView")||(a.updateView=!0),delete a.selector,a},r=function(t,e,n,i,a){var o=["autofocus","autoplay","async","checked","controls","defer","disabled","hidden","loop","multiple","open","readonly","required","scoped","selected"];_.each(n.attributes||[],function(n){var s,c,r="";n=_.clone(n),s=n.observe||(n.observe=a),c=function(){var a=_.indexOf(o,n.name,!0)>-1?"prop":"attr",l=u(i,s,n,t);"class"===n.name?(e.removeClass(r).addClass(l),r=l):e[a](n.name,l)},_.each(_.flatten([s]),function(e){l(i,t,"change:"+e,c)}),c()})},d=function(t,e,n,a,o){if(null!=n.visible){var s=function(){var l=n.visible,s=n.visibleFn,c=u(a,o,n,t),r=!!c;(_.isFunction(l)||_.isString(l))&&(r=!!i(t,l,c,n)),s?i(t,s,e,r,n):e.toggle(r)};_.each(_.flatten([o]),function(e){l(a,t,"change:"+e,s)}),s()}},h=function(t,e,n,a,l,s){o(t,n.updateView,a,n)&&(i(t,n.update,e,a,l,n),s||i(t,n.afterUpdate,e,a,n))};t.Stickit.addHandler([{selector:'[contenteditable="true"]',updateMethod:"html",events:["input","change"]},{selector:"input",events:["propertychange","input","change"],update:function(t,e){t.val(e)},getVal:function(t){return t.val()}},{selector:"textarea",events:["propertychange","input","change"],update:function(t,e){t.val(e)},getVal:function(t){return t.val()}},{selector:'input[type="radio"]',events:["change"],update:function(t,e){t.filter('[value="'+e+'"]').prop("checked",!0)},getVal:function(t){return t.filter(":checked").val()}},{selector:'input[type="checkbox"]',events:["change"],update:function(t,n){t.length>1?(n||(n=[]),_.each(t,function(t){_.indexOf(n,e(t).val())>-1?e(t).prop("checked",!0):e(t).prop("checked",!1)})):_.isBoolean(n)?t.prop("checked",n):t.prop("checked",n===t.val())},getVal:function(t){var n;if(t.length>1)n=_.reduce(t,function(t,n){return e(n).prop("checked")&&t.push(e(n).val()),t},[]);else{n=t.prop("checked");var i=t.val();"on"!==i&&null!=i&&(n=n?t.val():null)}return n}},{selector:"select",events:["change"],update:function(a,o,l,s){var u,c=s.selectOptions,r=c&&c.collection||void 0,d=a.prop("multiple");if(!c){c={};var h=function(t){return t.map(function(){return{value:this.value,label:this.text}}).get()};a.find("optgroup").length?(r={opt_labels:[]},a.find("> option").length&&(r.opt_labels.push(void 0),_.each(a.find("> option"),function(t){r[void 0]=h(e(t))})),_.each(a.find("optgroup"),function(t){var n=e(t).attr("label");r.opt_labels.push(n),r[n]=h(e(t).find("option"))})):r=h(a.find("option"))}c.valuePath=c.valuePath||"value",c.labelPath=c.labelPath||"label";var p=function(t,i,a){_.each(t,function(t){var o=e("<option/>"),l=t,s=function(t,e){o.text(t),l=e,o.data("stickit_bind_val",l),_.isArray(l)||_.isObject(l)||o.val(l)};"__default__"===t?s(c.defaultOption.label,c.defaultOption.value):s(n(t,c.labelPath),n(t,c.valuePath)),!d&&null!=l&&null!=a&&l===a||_.isObject(a)&&_.isEqual(l,a)?o.prop("selected",!0):d&&_.isArray(a)&&_.each(a,function(t){_.isObject(t)&&(t=n(t,c.valuePath)),(t===l||_.isObject(t)&&_.isEqual(l,t))&&o.prop("selected",!0)}),i.append(o)})};a.html("");var f=function(t,e){var i=window;return 0===e.indexOf("this.")&&(i=t),e=e.replace(/^[a-z]*\.(.+)$/,"$1"),n(i,e)};if(u=_.isString(r)?f(this,r):_.isFunction(r)?i(this,r,a,s):r,u instanceof t.Collection&&(u=u.toJSON()),c.defaultOption&&p(["__default__"],a),_.isArray(u))p(u,a,o);else if(u.opt_labels)_.each(u.opt_labels,function(t){var n=e("<optgroup/>").attr("label",t);p(u[t],n,o),a.append(n)});else{var v,g=[];for(var b in u)v={},v[c.valuePath]=b,v[c.labelPath]=u[b],g.push(v);p(_.sortBy(g,c.comparator||c.labelPath),a,o)}},getVal:function(t){var n;return n=t.prop("multiple")?e(a(t).map(function(){return e(this).data("stickit_bind_val")})).get():a(t).data("stickit_bind_val")}}])})(Backbone);