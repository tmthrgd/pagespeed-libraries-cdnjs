/*!
 * Crossroads - JavaScript Routes
 * Released under the MIT license <http://www.opensource.org/licenses/mit-license.php>
 * @author Miller Medeiros
 * @version 0.4
 * @build 31 (06/07/2011 12:15 AM)
 */
(function(a){var e,i,l,c=Object.prototype.toString,k=/^(true|false)$/i;function j(m,o){var p=m.length;while(p--){if(m[p]===o){return p}}return -1}function d(m,n){return"[object "+m+"]"===c.call(n)}function f(m){return d("RegExp",m)}function h(m){return d("Array",m)}function b(m){return d("Function",m)}function g(m){return(m===null)?m:(k.test(m)?(m.toLowerCase()==="true"):((m===""||isNaN(m))?m:parseFloat(m)))}e=(function(){var p=[],t=new signals.Signal(),w=new signals.Signal();function m(A,B,z){var y=new i(A,B,z);x(y);return y}function x(y){var z=n();do{--z}while(p[z]&&y._priority<=p[z]._priority);p.splice(z+1,0,y)}function n(){return p.length}function q(y){var z=s(y);if(z>=0){p.splice(z,1)}y._destroy()}function s(y){return j(p,y)}function v(){var y=n();while(y--){p[y]._destroy()}p.length=0}function o(z){z=z||"";var y=r(z),A=y?u(z,y):null;if(y){A?y.matched.dispatch.apply(y.matched,A):y.matched.dispatch();w.dispatch(z,y,A)}else{t.dispatch(z)}}function r(A){var z=n(),y;while(y=p[--z]){if(y.match(A)){return y}}return null}function u(z,y){return l.getParamValues(z,y._matchRegexp)}return{_routes:p,addRoute:m,removeRoute:q,removeAllRoutes:v,parse:o,bypassed:t,routed:w,getNumRoutes:n,toString:function(){return"[crossroads numRoutes:"+n()+"]"}}}());i=function(n,p,m){var o=f(n);this._pattern=n;this._paramsIds=o?null:l.getParamIds(this._pattern);this._matchRegexp=o?n:l.compilePattern(n);this.matched=new signals.Signal();if(p){this.matched.add(p)}this._priority=m||0};i.prototype={rules:void (0),match:function(m){return this._matchRegexp.test(m)&&this._validateParams(m)},_validateParams:function(m){var n=this.rules,o;for(o in n){if(n.hasOwnProperty(o)&&!this._isValidParam(m,o)){return false}}return true},_isValidParam:function(o,r){var n=this.rules[r],m=this._getParamValuesObject(o),q=m[r],p;if(f(n)){p=n.test(q)}else{if(h(n)){p=j(n,q)!==-1}else{if(b(n)){p=n(q,o,m)}}}return p||false},_getParamValuesObject:function(q){var p=this._paramsIds,m=l.getParamValues(q,this._matchRegexp),r={},s=p?p.length:0;while(s--){r[p[s]]=m[s]}r.request_=g(q);return r},dispose:function(){e.removeRoute(this)},_destroy:function(){this.matched.dispose();this.matched=this._pattern=this._matchRegexp=null},toString:function(){return'[Route pattern:"'+this._pattern+'", numListeners:'+this.matched.getNumListeners()+"]"}};l=e.patternLexer=(function(){var u=/[\\\.\+\*\?\^\$\[\]\(\)\{\}\/\'\#]/g,o=/([^\/]+)/,t=/\{([^\}]+)\}/g,s="___CR_PARAM___",r=new RegExp(s,"g");function p(A){var z=[],y;while(y=t.exec(A)){z.push(y[1])}return z}function w(y){y=y?q(y):"";y=y.replace(/\/$/,"");y=m(y);y=n(y);return new RegExp("^"+y+"/?$")}function q(y){return y.replace(t,s)}function n(y){return y.replace(r,o.source)}function m(y){return y.replace(u,"\\$&")}function v(y,A){var z=A.exec(y);if(z){z.shift();z=x(z)}return z}function x(z){var A=z.length,y=[];while(A--){y[A]=g(z[A])}return y}return{getParamIds:p,getParamValues:v,compilePattern:w}}());a.crossroads=e}(window||this));