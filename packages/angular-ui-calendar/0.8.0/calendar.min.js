/*
 * The MIT License
 * 
 * Copyright (c) 2012 the AngularUI Team, http://angular-ui.github.com
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
angular.module("ui.calendar",[]).constant("uiCalendarConfig",{}).controller("uiCalendarCtrl",["$scope",function(a){var b=1,c=1,d=a.eventSources;extraEventSignature=a.calendarWatchEvent?a.calendarWatchEvent:angular.noop,this.eventsFingerprint=function(a){return a.__uiCalId||(a.__uiCalId=c++),""+a.__uiCalId+(a.id||"")+(a.title||"")+(a.url||"")+(+a.start||"")+(+a.end||"")+(a.allDay||"")+(a.className||"")+extraEventSignature(a)||""},this.sourcesFingerprint=function(a){return a.__id||(a.__id=b++)},this.allEvents=function(){for(var a=[],b=0,c=d.length;c>b;b++){var e=d[b];if(angular.isArray(e))a.push(e);else if(angular.isObject(e)&&angular.isArray(e.events)){var f={};for(var g in e)"_uiCalId"!==g&&"events"!==g&&(f[g]=e[g]);for(var h=0;h<e.events.length;h++)angular.extend(e.events[h],f);a.push(e.events)}}return Array.prototype.concat.apply([],a)},this.changeWatcher=function(a,b){var c,d=function(){for(var e,g,c=angular.isFunction(a)?a():a,d=[],h=0,i=c.length;i>h;h++)g=c[h],e=b(g),f[e]=g,d.push(e);return d},e=function(a,b){var e,f,c=[],d={};for(e=0,f=b.length;f>e;e++)d[b[e]]=!0;for(e=0,f=a.length;f>e;e++)d[a[e]]||c.push(a[e]);return c},f={},g=function(a,d){var g,h,i,j,k={},l=e(d,a);for(g=0,h=l.length;h>g;g++){var m=l[g];i=f[m],delete f[m];var n=b(i);n===m?c.onRemoved(i):(k[n]=m,c.onChanged(i))}var o=e(a,d);for(g=0,h=o.length;h>g;g++)j=o[g],i=f[j],k[j]||c.onAdded(i)};return c={subscribe:function(a,b){a.$watch(d,function(a,c){b&&b(a,c)===!1||g(a,c)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}}}]).directive("uiCalendar",["uiCalendarConfig","$locale",function(a,b){var c=function(a){var b,c;b=[];for(c in a)b[c]=a[c];return b},d=b.DATETIME_FORMATS;return a=angular.extend({monthNames:c(d.MONTH),monthNamesShort:c(d.SHORTMONTH),dayNames:c(d.DAY),dayNamesShort:c(d.SHORTDAY)},a||{}),{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(b,c,d,e){function h(){options={eventSources:f},angular.extend(options,a,d.uiCalendar?b.$parent.$eval(d.uiCalendar):{});var c={};for(var e in options)"eventSources"!==e&&(c[e]=options[e]);return JSON.stringify(c)}var f=b.eventSources,g=!1;eventSourcesWatcher=e.changeWatcher(f,e.sourcesFingerprint),eventsWatcher=e.changeWatcher(e.allEvents,e.eventsFingerprint),options=null,b.destroy=function(){b.calendar=d.calendar?b.$parent[d.calendar]=c.html(""):c.html("")},b.init=function(){b.calendar.fullCalendar(options)},eventSourcesWatcher.onAdded=function(a){b.calendar.fullCalendar("addEventSource",a),g=!0},eventSourcesWatcher.onRemoved=function(a){b.calendar.fullCalendar("removeEventSource",a),g=!0},eventsWatcher.onAdded=function(a){b.calendar.fullCalendar("renderEvent",a)},eventsWatcher.onRemoved=function(a){b.calendar.fullCalendar("removeEvents",function(b){return b===a})},eventsWatcher.onChanged=function(a){b.calendar.fullCalendar("updateEvent",a)},b.destroy(),h(),b.init(),eventSourcesWatcher.subscribe(b),eventsWatcher.subscribe(b,function(){return g?(b.calendar.fullCalendar("rerenderEvents"),g=!1,!1):void 0}),b.$watch(h,function(a,c){a!==c&&(b.destroy(),b.init())})}}}]);