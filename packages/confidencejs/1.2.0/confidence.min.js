!function(t,r){"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?module.exports=r():t.Confidence=r()}(this,function(){function t(t){return-s>t?0:Math.exp(t)}var r=1.96,e=.01,n="1.1.0",a=function(t){t=t||{},this._zScore=t.hasOwnProperty("zScore")?t.zScore:r,this._marginOfError=t.hasOwnProperty("marginOfError")?t.marginOfError:e,this._variants={},this._confidenceIntervals={}};a.version=n;var i=6,o=function(t){var r,e,n;return 0===t?e=0:(n=.5*Math.abs(t),n>.5*i?e=1:1>n?(r=n*n,e=((((((((.000124818987*r-.001075204047)*r+.005198775019)*r-.019198292004)*r+.059054035642)*r-.151968751364)*r+.319152932694)*r-.5319230073)*r+.797884560593)*n*2):(n-=2,e=(((((((((((((-45255659e-12*n+.00015252929)*n-19538132e-12)*n-.000676904986)*n+.001390604284)*n-.00079462082)*n-.002034254874)*n+.006549791214)*n-.010557625006)*n+.011630447319)*n-.009279453341)*n+.005353579108)*n-.002141268741)*n+.000535310849)*n+.999936657524)),t>0?(e+1)/2:(1-e)/2},s=20,u=function(r,e){var n,a,i,o,u,h,c,v=.5723649429247001,f=.5641895835477563;if(0>=r||1>e)return 1;if(n=.5*r,c=!(1&e),e>1&&(a=t(-n)),i=c?a:2*zSquareProbability(-Math.sqrt(r)),e>2){if(r=.5*(e-1),h=c?1:.5,n>s){for(o=c?0:v,u=Math.log(n);r>=h;)o=Math.log(h)+o,i+=t(u*h-n-o),h+=1;return i}for(o=c?1:f/Math.sqrt(n),u=0;r>=h;)o*=n/h,u+=o,h+=1;return u*a+i}return i},h=function(t,r){var e,n=1e-6,a=99999,i=0,o=a;if(0>=t)return o;if(t>=1)return 0;for(e=r/Math.sqrt(t);o-i>n;)u(e,r)<t?o=e:i=e,e=.5*(o+i);return e};return a.prototype.addVariant=function(t){if(this.variantExists(t.id)){var r="A variant with ID '"+t.id+"' already exists.";throw new Error(r)}if(!(t.hasOwnProperty("id")&&t.hasOwnProperty("conversionCount")&&t.hasOwnProperty("eventCount")))throw new Error("variant object needs conversionCount and eventCount properties");t.hasOwnProperty("name")||(t.name="Variant "+t.id),this._variants[t.id]=t},a.prototype.getVariant=function(t){if(this.variantExists(t))return this._variants[t];throw new Error("The variant you requested does not exist.")},a.prototype.variantExists=function(t){return this._variants.hasOwnProperty(t)?!0:!1},a.prototype.hasVariants=function(t){for(var r in t)if(t.hasOwnProperty(r))return!0;return!1},a.prototype.getResult=function(){if(this.hasVariants(this._variants)){confidenceIntervals={};var t;for(var r in this._variants){var e=(this.getRequiredSampleSize(r),!1),n=this.hasEnoughData(r);if(!n)return t={hasWinner:e,hasEnoughData:n,winnerID:null,winnerName:null,confidencePercent:null,confidenceInterval:null,readable:"There is not enough data to determine a conclusive result."};var a=this.getConfidenceInterval(r);confidenceIntervals[r]=a}return t=this.analyzeConfidenceIntervals(confidenceIntervals)}throw new Error("There are no variants available.")},a.prototype.analyzeConfidenceIntervals=function(t){var r=[],e=[];for(var n in t){var a=t[n].min;r.push({id:n,val:a});var i=t[n].max;e.push({id:n,val:i})}r=this.sortList(r);var o=r[0].id,s=r[0].val;e=this.sortList(e);for(var u=0;u<e.length;u++){var h=e[u];h.id==o&&e.splice(u,1)}var c,v=(e[0].id,e[0].val),f=this.getConfidencePercent();if(s>v){winningVariantName=this._variants[o].name;var l=Math.round(1e4*t[o].min)/100,p=Math.round(1e4*t[o].max)/100,d="With "+f+'% confidence, the true population parameter of the "';return d+=winningVariantName+'" variant will fall between ',d+=l+"% and ",d+=p+"%.",c={hasWinner:!0,hasEnoughData:!0,winnerID:o,winnerName:winningVariantName,confidencePercent:f,confidenceInterval:{min:l,max:p},readable:d}}var g="There is no winner, the results are too close.";return c={hasWinner:!1,hasEnoughData:!0,winnerID:null,winnerName:null,confidencePercent:f,confidenceInterval:null,readable:g}},a.prototype.sortList=function(t){return t.sort(function(t,r){return r.val-t.val}),t},a.prototype.getConfidencePercent=function(t){t="number"==typeof t?t:this._zScore;var r=o(t);return(100*(2*r-1)).toFixed(2)},a.prototype.getRequiredSampleSize=function(t){var r=this.getStandardError(t),e=Math.pow(this._zScore,2)*r*(1-r),n=Math.pow(this._marginOfError,2),a=Math.max(e/n,100);return a},a.prototype.hasEnoughData=function(t){var r=this.getVariant(t),e=this.getRequiredSampleSize(t);return r.eventCount>=e?!0:!1},a.prototype.getRate=function(t){var r=this.getVariant(t);if(0===r.eventCount)throw new Error("Total is zero: cannot divide by zero to produce rate.");if(r.eventCount<0)throw new Error("Total is negative: cannot use a negative number to produce rate.");var e=r.conversionCount/r.eventCount;return e},a.prototype.getConfidenceInterval=function(t){var r={},e=this.getRate(t),n=this.getStandardError(t),a=e-this._zScore*n;0>a&&(a=0);var i=e+this._zScore*n;return i>1&&(i=1),r={min:a,max:i}},a.prototype.getStandardError=function(t){var r=this.getVariant(t),e=this.getRate(t),n=Math.sqrt(e*(1-e)/r.eventCount);return n},a.prototype.getMarascuilloResult=function(){var t,r=this.getObservedValues(),e=this.getPooledProportion(r),n=this.getExpectedValues(r,e);if(n.hasEnoughData===!1)return t={hasWinner:!1,hasEnoughData:!1,winnerID:null,winnerName:null};var a=this.getChiParts(r,n),i=this.sumChiParts(a),s=(this.getDegreesOfFreedom(),1-o(this._zScore)),u=h(s,2);if(!(i>u))return t={hasWinner:!1,hasEnoughData:!0,winnerID:null,winnerName:null};var c=this.getBestVariant();return t=this.marascuillo(c,u)},a.prototype.getObservedValues=function(){var t={},r=this._variants;for(var e in r){var n={},a=r[e].conversionCount,i=r[e].eventCount-r[e].conversionCount,o=r[e].eventCount;n.success=a,n.fail=i,n.total=o,t[e]=n}return t},a.prototype.getPooledProportion=function(t){var r=0,e=0;for(var n in t)r+=t[n].success,e+=t[n].total;if(0===e)throw new Error("Summed total is zero: cannot divide by zero to produce rate.");var a=r/e;return a},a.prototype.getExpectedValues=function(t,r){var e={};for(var n in t){var a,i,o={};a=r*t[n].total,i=(1-r)*t[n].total,(5>a||5>i)&&(e.hasEnoughData=!1),o.success=a,o.fail=i,e[n]=o}return e.hasEnoughData!==!1&&(e.hasEnoughData=!0),e},a.prototype.getChiParts=function(t,r){var e,n,a={};for(var i in t){var o={},s=t[i].success,u=r[i].success;if(0===u)throw new Error("Cannot divide by zero to produce chi parts.");e=Math.pow(s-u,2)/u,o.success=e;var h=t[i].fail,c=r[i].fail;if(0===c)throw new Error("Cannot divide by zero to produce chi parts.");n=Math.pow(h-c,2)/c,o.fail=n,a[i]=o}return a},a.prototype.sumChiParts=function(t){var r=0;for(var e in t)r+=t[e].success,r+=t[e].fail;return r},a.prototype.getDegreesOfFreedom=function(){var t=Object.keys(this._variants).length-1;return t},a.prototype.getBestVariant=function(){var t,r=0;for(var e in this._variants){var n=this.getRate(e);n>r&&(r=n,t=e)}return t},a.prototype.marascuillo=function(t,r){var e;for(var n in this._variants)if(n!==t){var a=this.computeTestStatistic(t,n),i=this.computeCriticalValue(t,n,r);if(!(a>i))return e={hasWinner:!1,hasEnoughData:!0,winnerID:null,winnerName:null}}return e={hasWinner:!0,hasEnoughData:!0,winnerID:t,winnerName:this._variants[t].name}},a.prototype.computeTestStatistic=function(t,r){var e=this.getRate(t),n=this.getRate(r),a=Math.abs(e-n);return a},a.prototype.computeCriticalValue=function(t,r,e){var n=this.getRate(t),a=this.getRate(r),i=this._variants[t].eventCount,o=this._variants[r].eventCount,s=n*(1-n)/i,u=a*(1-a)/o,h=Math.sqrt(e)*Math.sqrt(s+u);return h},a});