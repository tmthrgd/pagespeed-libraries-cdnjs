/*  backbone.fetch-cache v0.1.11 (2013-07-18)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],function(_,Backbone){return e.Backbone=t(_,Backbone)}):e.Backbone=t(e._,e.Backbone)})(this,function(_,Backbone){function e(e,t){var c;return(c=t&&t.url?t.url:_.isFunction(e.url)?e.url():e.url)?t&&t.data?c+"?"+$.param(t.data):c:void 0}function t(e,t,c){t=t||{};var h=Backbone.fetchCache.getCacheKey(e,t),i=!1;h&&t.cache!==!1&&(t.cache||t.prefill)&&(t.expires!==!1&&(i=(new Date).getTime()+1e3*(t.expires||300)),Backbone.fetchCache._cache[h]={expires:i,value:c},Backbone.fetchCache.setLocalStorage())}function c(e){delete Backbone.fetchCache._cache[e],Backbone.fetchCache.setLocalStorage()}function h(){if(r&&Backbone.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(e){var t=e.code||e.number||e.message;if(22!==t)throw e;this._deleteCacheWithPriority()}}function i(){if(r&&Backbone.fetchCache.localStorage){var e=localStorage.getItem("backboneCache")||"{}";Backbone.fetchCache._cache=JSON.parse(e)}}var a={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},r=window.localStorage!==void 0;return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.priorityFn=function(e,t){return e&&e.expires&&t&&t.expires?e.expires-t.expires:e},Backbone.fetchCache._prioritize=function(){var e=_.values(this._cache).sort(this.priorityFn),t=_.indexOf(_.values(this._cache),e[0]);return _.keys(this._cache)[t]},Backbone.fetchCache._deleteCacheWithPriority=function(){Backbone.fetchCache._cache[this._prioritize()]=null,delete Backbone.fetchCache._cache[this._prioritize()],Backbone.fetchCache.setLocalStorage()},Backbone.fetchCache.localStorage===void 0&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(e){e=e||{};var t=Backbone.fetchCache.getCacheKey(this,e),c=Backbone.fetchCache._cache[t],h=!1,i=!1,r=new $.Deferred;if(c&&(h=c.expires,h=h&&c.expires<(new Date).getTime(),i=c.value),!h&&(e.cache||e.prefill)&&i){if(this.set(this.parse(i),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this,i,e),this.trigger("cachesync",this,i,e),this.trigger("sync",this,i,e),!e.prefill)return _.isFunction(e.success)&&e.success(this),r.resolve(this);r.notify(this)}return a.modelFetch.apply(this,arguments).done(_.bind(r.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)).fail(_.bind(r.reject,this,this)),r},Backbone.Model.prototype.sync=function(e,t){if("read"===e)return a.modelSync.apply(this,arguments);var h,i,r=t.collection,s=[];for(s.push(Backbone.fetchCache.getCacheKey(t)),r&&s.push(Backbone.fetchCache.getCacheKey(r)),h=0,i=s.length;i>h;h++)c(s[h]);return a.modelSync.apply(this,arguments)},Backbone.Collection.prototype.fetch=function(e){e=e||{};var t=Backbone.fetchCache.getCacheKey(this,e),c=Backbone.fetchCache._cache[t],h=!1,i=!1,r=new $.Deferred;if(c&&(h=c.expires,h=h&&c.expires<(new Date).getTime(),i=c.value),!h&&(e.cache||e.prefill)&&i){if(this[e.reset?"reset":"set"](this.parse(i),e),_.isFunction(e.prefillSuccess)&&e.prefillSuccess(this),this.trigger("cachesync",this,i,e),this.trigger("sync",this,i,e),!e.prefill)return _.isFunction(e.success)&&e.success(this),r.resolve(this);r.notify(this)}return a.collectionFetch.apply(this,arguments).done(_.bind(r.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,e)).fail(_.bind(r.reject,this,this)),r},i(),Backbone.fetchCache._superMethods=a,Backbone.fetchCache.setCache=t,Backbone.fetchCache.getCacheKey=e,Backbone.fetchCache.clearItem=c,Backbone.fetchCache.setLocalStorage=h,Backbone.fetchCache.getLocalStorage=i,Backbone});