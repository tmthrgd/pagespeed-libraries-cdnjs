/*  backbone.fetch-cache v1.1.0 (2013-08-22)
  by Andy Appleton - https://github.com/mrappleton/backbone-fetch-cache.git
 */
(function(e,c){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],function(_,Backbone,t){return e.Backbone=c(_,Backbone,t)}):e.Backbone=c(e._,e.Backbone,e.jQuery)})(this,function(_,Backbone,e){function c(c,t){var h;return(h=t&&t.url?t.url:_.isFunction(c.url)?c.url():c.url)?t&&t.data?h+"?"+e.param(t.data):h:void 0}function t(e,c,t){c=c||{};var h=Backbone.fetchCache.getCacheKey(e,c),a=!1;h&&c.cache!==!1&&(c.cache||c.prefill)&&(c.expires!==!1&&(a=(new Date).getTime()+1e3*(c.expires||300)),Backbone.fetchCache._cache[h]={expires:a,value:t},Backbone.fetchCache.setLocalStorage())}function h(e){delete Backbone.fetchCache._cache[e],Backbone.fetchCache.setLocalStorage()}function a(){if(n&&Backbone.fetchCache.localStorage)try{localStorage.setItem("backboneCache",JSON.stringify(Backbone.fetchCache._cache))}catch(e){var c=e.code||e.number||e.message;if(22!==c)throw e;this._deleteCacheWithPriority()}}function r(){if(n&&Backbone.fetchCache.localStorage){var e=localStorage.getItem("backboneCache")||"{}";Backbone.fetchCache._cache=JSON.parse(e)}}function i(e){return window.setTimeout(e,0)}var o={modelFetch:Backbone.Model.prototype.fetch,modelSync:Backbone.Model.prototype.sync,collectionFetch:Backbone.Collection.prototype.fetch},n=function(){var e=window.localStorage!==void 0;if(e)try{localStorage.setItem("test_support","test_support"),localStorage.removeItem("test_support")}catch(c){e=!1}return e}();return Backbone.fetchCache=Backbone.fetchCache||{},Backbone.fetchCache._cache=Backbone.fetchCache._cache||{},Backbone.fetchCache.priorityFn=function(e,c){return e&&e.expires&&c&&c.expires?e.expires-c.expires:e},Backbone.fetchCache._prioritize=function(){var e=_.values(this._cache).sort(this.priorityFn),c=_.indexOf(_.values(this._cache),e[0]);return _.keys(this._cache)[c]},Backbone.fetchCache._deleteCacheWithPriority=function(){Backbone.fetchCache._cache[this._prioritize()]=null,delete Backbone.fetchCache._cache[this._prioritize()],Backbone.fetchCache.setLocalStorage()},Backbone.fetchCache.localStorage===void 0&&(Backbone.fetchCache.localStorage=!0),Backbone.Model.prototype.fetch=function(c){c=c||{};var t=Backbone.fetchCache.getCacheKey(this,c),h=Backbone.fetchCache._cache[t],a=!1,r=!1,n=new e.Deferred,s=this;return h&&(a=h.expires,a=a&&h.expires<(new Date).getTime(),r=h.value),a||!c.cache&&!c.prefill||!r||(i(function(){s.set(s.parse(r),c),_.isFunction(c.prefillSuccess)&&c.prefillSuccess(s,r,c),s.trigger("cachesync",s,r,c),s.trigger("sync",s,r,c),c.prefill?n.notify(s):(_.isFunction(c.success)&&c.success(s,r,c),n.resolve(s))}),c.prefill)?(o.modelFetch.apply(this,arguments).done(_.bind(n.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,c)).fail(_.bind(n.reject,this,this)),n.promise()):n.promise()},Backbone.Model.prototype.sync=function(e,c){if("read"===e)return o.modelSync.apply(this,arguments);var t,a,r=c.collection,i=[];for(i.push(Backbone.fetchCache.getCacheKey(c)),r&&i.push(Backbone.fetchCache.getCacheKey(r)),t=0,a=i.length;a>t;t++)h(i[t]);return o.modelSync.apply(this,arguments)},Backbone.Collection.prototype.fetch=function(c){c=c||{};var t=Backbone.fetchCache.getCacheKey(this,c),h=Backbone.fetchCache._cache[t],a=!1,r=!1,n=new e.Deferred,s=this;return h&&(a=h.expires,a=a&&h.expires<(new Date).getTime(),r=h.value),a||!c.cache&&!c.prefill||!r||(i(function(){s[c.reset?"reset":"set"](s.parse(r),c),_.isFunction(c.prefillSuccess)&&c.prefillSuccess(s),s.trigger("cachesync",s,r,c),s.trigger("sync",s,r,c),c.prefill?n.notify(s):(_.isFunction(c.success)&&c.success(s,r,c),n.resolve(s))}),c.prefill)?(o.collectionFetch.apply(this,arguments).done(_.bind(n.resolve,this,this)).done(_.bind(Backbone.fetchCache.setCache,null,this,c)).fail(_.bind(n.reject,this,this)),n.promise()):n.promise()},r(),Backbone.fetchCache._superMethods=o,Backbone.fetchCache.setCache=t,Backbone.fetchCache.getCacheKey=c,Backbone.fetchCache.clearItem=h,Backbone.fetchCache.setLocalStorage=a,Backbone.fetchCache.getLocalStorage=r,Backbone});