!function(e,n){"use strict";if("function"==typeof define&&define.amd)define(["backbone","underscore","jquery"],function(){return n.apply(e,arguments)});else if("object"==typeof exports){var t=require("backbone"),r=require("underscore");t.$=t.$||require("jquery"),module.exports=n.call(e,t,r,t.$)}else n.call(e,e.Backbone,e._,e.Backbone.$)}("object"==typeof global?global:this,function(e,n,t){"use strict";var r=this,i=e.View,a=Array.prototype.push,o=Array.prototype.concat,s=Array.prototype.splice,c=String.prototype.trim?n.bind(String.prototype.trim.call,String.prototype.trim):t.trim,l=e.View.extend({_render:function(){var e=this,n=e.__manager__,t=e.beforeRender,r=e.deferred();return e.hasRendered&&e._removeViews(),n.callback=function(){delete n.isAsync,delete n.callback,e.trigger("beforeRender",e),e._viewRender(n).render().then(function(){r.resolve()})},t&&t.call(e,e),n.isAsync||n.callback(),r.promise()},_applyTemplate:function(e,r,i){n.isString(e)&&(r.noel?(e=t.parseHTML(e,!0),this.$el.slice(1).remove(),this.$el.replaceWith(e),this.setElement(e,!1)):this.html(this.$el,e)),i.resolveWith(this,[this])},_viewRender:function(e){function t(n,t){var i;e.callback=function(n){delete e.isAsync,delete e.callback,o._applyTemplate(n,e,a)},l.cache(r,t),t&&(i=o.renderTemplate.call(o,t,n)),e.isAsync||o._applyTemplate(i,e,a)}var r,i,a,o=this;return{render:function(){var s=o.serialize,c=o.template;return a=o.deferred(),n.isFunction(s)&&(s=s.call(o)),e.callback=function(n){delete e.isAsync,delete e.callback,t(s,n)},"string"==typeof c&&(r=o.prefix+c),(i=l.cache(r))?(t(s,i,r),a):("string"==typeof c?i=o.fetchTemplate.call(o,o.prefix+c):"function"==typeof c?i=c:null!=c&&(i=o.fetchTemplate.call(o,c)),e.isAsync||t(s,i),a)}}},constructor:function(t){this.manage=!0,n.extend(this,t),e.View.apply(this,arguments)},async:function(){var e=this.__manager__;return e.isAsync=!0,e.callback},promise:function(){return this.__manager__.renderDeferred.promise()},then:function(){return this.promise().then.apply(this,arguments)},renderViews:function(e){var t=this,r=t.__manager__,i=t.deferred();e=e&&n.isArray(e)?n.chain(e):t.getViews(e);var a=e.map(function(e){return e.render().__manager__.renderDeferred}).value();return r.renderDeferred=i.promise(),t.when(a).then(function(){i.resolveWith(t,[t])}),t},insertView:function(e,n){return n?this.setView(e,n,!0):this.setView(e,!0)},insertViews:function(e){return n.isArray(e)?this.setViews({"":e}):(n.each(e,function(t,r){e[r]=n.isArray(t)?t:[t]}),this.setViews(e))},getView:function(e){return null==e&&(e=arguments[1]),this.getViews(e).first().value()},getViews:function(e){var t;return"string"==typeof e?(e=this.sections[e]||e,t=this.views[e]||[],n.chain([].concat(t))):(t=n.chain(this.views).map(function(e){return n.isArray(e)?e:[e]},this).flatten(),"object"==typeof e?t.where(e):"function"==typeof e?t.filter(e):t)},removeView:function(e){return this.getViews(e).each(function(e){e.remove()})},setView:function(e,n,t){var r,i,a=this;if("string"!=typeof e&&(t=n,n=e,e=""),r=n.__manager__,!r)throw new Error("The argument associated with selector '"+e+"' is defined and a View.  Set `manage` property to true for Backbone.View instances.");return r.parent=a,i=r.selector=a.sections[e]||e,t?(a.views[i]=o.call([],a.views[e]||[],n),a.__manager__.insert=!0,n):(a.getView(e)!==n&&a.removeView(e),a.views[i]=n)},setViews:function(e){return n.each(e,function(e,t){return n.isArray(e)?n.each(e,function(e){this.insertView(t,e)},this):void this.setView(t,e)},this),this},render:function(){function e(){function e(){var e=r.console,t=i.afterRender;t&&t.call(i,i),i.trigger("afterRender",i),a.noel&&i.$el.length>1&&n.isFunction(e.warn)&&!i.suppressWarnings&&(e.warn("`el: false` with multiple top level elements is not supported."),n.isFunction(e.trace)&&e.trace())}return n.each(i.views,function(e,t){n.isArray(e)&&i.htmlBatch(i,e,t)}),o&&!a.insertedViaFragment&&(i.contains(o.el,i.el)||o.partial(o.$el,i.$el,s,a)),i.delegateEvents(),i.hasRendered=!0,a.renderInProgress=!1,delete a.triggeredByRAF,a.queue&&a.queue.length?a.queue.shift()():delete a.queue,s&&(s.renderInProgress||s.queue)?o.once("afterRender",e):e(),c.resolveWith(i,[i])}function t(){i._render().done(function(){if(!n.keys(i.views).length)return e();var t=n.map(i.views,function(e){var t=n.isArray(e);return t&&e.length?i.when(n.map(e,function(e){return e.__manager__.insertedViaFragment=!0,e.render().__manager__.renderDeferred})):t?e:e.render().__manager__.renderDeferred});i.when(t).done(e)})}var i=this,a=i.__manager__,o=a.parent,s=o&&o.__manager__,c=i.deferred();return a.renderInProgress=!0,i._registerWithRAF(t,c),a.renderDeferred=c,i},remove:function(){return l._removeView(this,!0),this._remove.apply(this,arguments)},_registerWithRAF:function(e,n){function t(){o.rafID=null,o.triggeredByRAF=!0,e()}function r(){for(var e=0;e<o.deferreds.length;e++)o.deferreds[e].resolveWith(i,[i]);o.deferreds=[]}var i=this,o=i.__manager__,s=o.parent&&o.parent.__manager__;return this.useRAF===!1?void(o.queue?a.call(o.queue,e):(o.queue=[],e())):(o.deferreds=o.deferreds||[],o.deferreds.push(n),n.done(r),this._cancelQueuedRAFRender(),s&&s.triggeredByRAF?t():void(o.rafID=i.requestAnimationFrame(t)))},_cancelQueuedRAFRender:function(){var e=this,n=e.__manager__;null!=n.rafID&&e.cancelAnimationFrame(n.rafID)}},{_cache:{},_removeViews:function(e,n){"boolean"==typeof e&&(n=e,e=this),e=e||this,e.getViews().each(function(e){(e.hasRendered||n)&&l._removeView(e,n)})},_removeView:function(e,t){var r,i=e.__manager__,a=i.parent&&i.parent.__manager__,o="boolean"==typeof e.keep?e.keep:e.options.keep;if(!o&&a&&a.insert===!0||t){if(l.cleanViews(e),e._removeViews(!0),e.$el.remove(),e._cancelQueuedRAFRender(),!i.parent)return;if(r=i.parent.views[i.selector],n.isArray(r))return n.each(n.clone(r),function(e,n){e&&e.__manager__===i&&s.call(r,n,1)}),void(n.isEmpty(r)&&i.parent.trigger("empty",i.selector));delete i.parent.views[i.selector],i.parent.trigger("empty",i.selector)}},cache:function(e,n){return e in this._cache&&null==n?this._cache[e]:null!=e&&null!=n?this._cache[e]=n:void 0},cleanViews:function(t){n.each(o.call([],t),function(t){t.unbind(),t.model instanceof e.Model&&t.model.off(null,null,t),t.collection instanceof e.Collection&&t.collection.off(null,null,t),t.stopListening(),n.isFunction(t.cleanup)&&t.cleanup()})},configure:function(t){n.extend(l.prototype,t),t.manage&&(e.View.prototype.manage=!0),t.el===!1&&(e.View.prototype.el=!1),t.suppressWarnings===!0&&(e.View.prototype.suppressWarnings=!0),t.useRAF===!1&&(e.View.prototype.useRAF=!1)},setupView:function(t,r){r=n.extend({},r),n.each(o.call([],t),function(t){if(!t.__manager__){var i,a,o=l.prototype;n.defaults(t,{views:{},sections:{},__manager__:{},_removeViews:l._removeViews,_removeView:l._removeView},l.prototype),t.options=r,n.extend(t,r),t._remove=e.View.prototype.remove,t.render=l.prototype.render,t.remove!==o.remove&&(t._remove=t.remove,t.remove=o.remove),i=r.views||t.views,n.keys(i).length&&(a=i,t.views={},n.each(a,function(e,n){"function"==typeof e&&(a[n]=e.call(t,t))}),t.setViews(a))}})}});l.VERSION="0.9.6",e.Layout=l,e.View.prototype.constructor=function(e){var n;e=e||{},("el"in e?e.el===!1:this.el===!1)&&(n=!0),(e.manage||this.manage)&&l.setupView(this,e),this.__manager__&&(this.__manager__.noel=n,this.__manager__.suppressWarnings=e.suppressWarnings),i.apply(this,arguments)},e.View=e.View.prototype.constructor,e.View.extend=i.extend,e.View.prototype=i.prototype;var u={prefix:"",useRAF:!0,deferred:function(){return t.Deferred()},fetchTemplate:function(e){return n.template(t(e).html())},renderTemplate:function(e,n){return c(e.call(this,n))},serialize:function(){return this.model?n.clone(this.model.attributes):{}},partial:function(e,n,t,r){var i;r.selector&&(t.noel?(i=e.filter(r.selector),e=i.length?i:e.find(r.selector)):e=e.find(r.selector)),t.insert?this.insert(e,n):this.html(e,n)},html:function(e,n){e.html(n)},htmlBatch:function(e,r,i){var a=e.__manager__,o={selector:i},s=n.reduce(r,function(n,r){var i="boolean"==typeof r.keep?r.keep:r.options.keep,a=i&&t.contains(e.el,r.el);return r.el&&!a&&n.push(r.el),n},[]);return this.partial(e.$el,t(s),a,o)},insert:function(e,n){e.append(n)},when:function(e){return t.when.apply(null,e)},contains:function(e,n){return t.contains(e,n)},requestAnimationFrame:function(){for(var e=0,t=["ms","moz","webkit","o"],i=r.requestAnimationFrame,a=0;a<t.length&&!r.requestAnimationFrame;++a)i=r[t[a]+"RequestAnimationFrame"];return i||(i=function(n){var t=(new Date).getTime(),i=Math.max(0,16-(t-e)),a=r.setTimeout(function(){n(t+i)},i);return e=t+i,a}),n.bind(i,r)}(),cancelAnimationFrame:function(){for(var e=["ms","moz","webkit","o"],t=r.cancelAnimationFrame,i=0;i<e.length&&!r.requestAnimationFrame;++i)t=r[e[i]+"CancelAnimationFrame"]||r[e[i]+"CancelRequestAnimationFrame"];return t||(t=function(e){clearTimeout(e)}),n.bind(t,r)}()};return n.extend(l.prototype,u),l});