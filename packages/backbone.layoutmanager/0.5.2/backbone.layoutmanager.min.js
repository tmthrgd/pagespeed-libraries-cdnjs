!function(e){"use strict";var t=e.Backbone,n=e._,i=e.$,r=t.View.prototype._configure,s=t.View.prototype.render,o=t.View.extend({constructor:function(e){e=e||{},this._render=function(e){return e(this).render()},o.setupView(this,e),e.paths&&(this._prefix=e.paths.layout||""),t.View.call(this,e)},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return n.each(e,function(t,n){e[n]=[].concat(t)}),this.setViews(e)},getView:function(e){return this.getViews(e).first().value()},getViews:function(e){var t=n.chain(this.views).map(function(e){return[].concat(e)},this).flatten().value();return n.chain(n.filter(t,e?e:n.identity))},setView:function(e,t,i){var r,s,a=this;return n.isString(e)||(i=t,t=e,e=""),this.views=this.views||{},!i&&this.views[e]&&(n.isArray(this.views[e])?n.each(this.views[e],function(e){e.remove()}):this.views[e].remove()),s=t._options(),o.setupView(t,s),t.render.__fake__&&(t._render=function(e){return e(this).render()}),t.render=function(r){function c(){t.__manager__.hasRendered||(s.partial(a.el,e,t.el,i)&&(t.__manager__.hasRendered=!0),t.delegateEvents()),t.__manager__.handler.resolveWith(t,[t.el]),h.resolveWith(t,[t.el]),n.isFunction(r)&&r.call(t,t.el)}var h=s.deferred();return o.prototype.render.call(t).then(c),h.promise()},i||(t.__manager__.isManaged=!0),!t._prefix&&s.paths&&(t._prefix=s.paths.template||""),i?(r=this.views[e]=this.views[e]||[],n.isArray(this.views[e])||(r=this.views[e]=[this.views[e]]),r.push(t),t):this.views[e]=t},setViews:function(e){return n.each(e,function(e,t){return n.isArray(e)?n.each(e,function(e){this.insertView(t,e)},this):void this.setView(t,e)},this),this},render:function(e){var t=this,i=this._options(),r=i.deferred();return t.__manager__.renderDeferred?t.__manager__.renderDeferred:(n.each(this.views,function(e){n.isArray(e)&&n.each(n.clone(e),function(t,i){var r=t.keep;!n.isBoolean(r)&&t.options&&(r=t.options.keep),t.__manager__.hasRendered&&!r&&(t.remove(),e.splice(i,1))})},this),this._render(o._viewRender).fetch.then(function(){t.__manager__.renderDeferred=r;var e=n.map(t.views,function(e){function t(e,n){if(!e.length)return n();var i=e.shift();i.__manager__.isManaged=!0,i.render(function(){t(e,n)})}var r;return n.isArray(e)?(r=i.deferred(),t(n.clone(e),function(){r.resolve()}),r.promise()):(e.__manager__.isManaged=!0,e.render())});i.when(e).then(function(){r.resolveWith(t,[t.el])})}),r.then(function(){n.isFunction(e)&&e.call(t,t.el),delete t.__manager__.renderDeferred}).promise())},remove:function(){return o.cleanViews(this),this._remove.apply(this,arguments)},_options:function(){return n.extend({},o.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e){function t(t,n){o.cache(i,n),n&&a.html(e.el,a.render(n,t)),s.fetch.resolveWith(e,[e.el])}var i,r,s,a=e._options();return{render:function(c){var h=e.template||a.template;return e.serialize&&(a.serialize=e.serialize),!c&&n.isFunction(a.serialize)?c=a.serialize.call(e):!c&&n.isObject(a.serialize)&&(c=a.serialize),s=o._makeAsync(a,n.bind(t,e,c)),s.fetch=a.deferred(),e.__manager__.handler=s,n.isString(h)&&(i=e._prefix+h),(r=o.cache(i))?(t(c,r,i),s):(n.isString(h)?r=a.fetch.call(s,e._prefix+h):null!=h&&(r=a.fetch.call(s,h)),s._isAsync||t(c,r),s)}}},cleanViews:function(e){n.each([].concat(e),function(e){e.unbind(),e.views&&n.each(e.views,function(e){o.cleanViews(e)}),n.isFunction(e.cleanup)&&e.cleanup.call(e)})},cache:function(e,t){return e in this._cache?this._cache[e]:null!=e&&null!=t?this._cache[e]=t:void 0},configure:function(e){n.extend(o.prototype.options,e)},setupView:function(e,i){var r=t.LayoutManager.prototype,s=n.keys(o.prototype.options);i=e.options=n.defaults(i||{},r.options),n.defaults(e,{views:{},__manager__:{}}),n.extend(i,n.pick(this,s)),e._remove=t.View.prototype.remove,e instanceof o||(e.options.render=o.prototype.options.render),e.remove!==r.remove&&(e._remove=e.remove,e.remove=r.remove),e._prefix="",i.views&&e.setViews(i.views),e.template&&(i.template=e.template)},removeView:function(e,t){n.isObject(e)||(e=e||this,t=e),n.each(e.views,function(e){(!t||n.isArray(e))&&n.each([].concat(e),function(e){e.remove(),e.getViews().each(function(e){o.removeView(e,t)})})})}});n.each(["get","set","insert"],function(e){var n=t.View.prototype,i=o.prototype;n[e+"View"]=i[e+"View"],n[e+"Views"]=i[e+"Views"]}),n.extend(t.View.prototype,{removeView:o.removeView,_options:o.prototype._options,_configure:function(){var e,t=r.apply(this,arguments);return this.__manager__||(this._render=this.options.render||this.render,e=this.render=function(){return this.render!==e?this.render.apply(this,arguments):this._render.apply(this,arguments)},this._render===s&&(this.render.__fake__=!0)),t}}),t.Layout=t.LayoutManager=o,o.prototype.options={paths:{},deferred:function(){return i.Deferred()},fetch:function(e){return n.template(i(e).html())},partial:function(e,t,n,r){var s=t?i(e).find(t):i(e);return s.length?(this[r?"append":"html"](s,n),!0):!1},html:function(e,t){i(e).html(t)},append:function(e,t){i(e).append(t)},when:function(e){return i.when.apply(null,e)},render:function(e,t){return e(t)}}}(this);