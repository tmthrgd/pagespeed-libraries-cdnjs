!function(e){"use strict";var t,n=e.Backbone,i=e._,r=e.$,a=n.View.prototype._configure,s=(n.View.prototype.render,n.View.extend({constructor:function(e){e=e||{},s.setupView(this,e),n.View.call(this,e),this._prefix=this._options().paths.layout||""},swapLayout:function(e){return e.views=i.defaults({},this.views,e.views),e.setElement(this.el),e},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return i.each(e,function(t,n){e[n]=[].concat(t)}),this.setViews(e)},getView:function(e){return this.getViews(e).first().value()},getViews:function(e){var t=i.chain(this.views).map(function(e){return[].concat(e)},this).flatten().value();return i.chain(i.filter(t,e?e:i.identity))},setView:function(e,t,n){var r,a,o=this;return i.isString(e)||(n=t,t=e,e=""),this.views=this.views||{},!n&&this.views[e]&&(i.isArray(this.views[e])?i.each(this.views[e],function(e){e.remove()}):this.views[e].remove()),a=t._options(),t.__manager__||s.setupView(t,a),t.render=function(r){function c(){n&&t.__manager__.hasRendered||a.partial(o.el,e,t.el,n)&&(t.__manager__.hasRendered=!0),t.__manager__.handler&&(t.__manager__.handler.resolveWith(t,[t.el]),delete t.__manager__.handler),_.resolveWith(t,[t.el]),i.isFunction(r)&&r.call(t,t.el)}var _=a.deferred();return t._removeView(),s.prototype.render.call(t).then(c),_.promise()},!t._prefix&&a.paths&&(t._prefix=a.paths.template||""),t.__manager__.parent=this,t.__manager__.selector=e,n?(r=this.views[e]=this.views[e]||[],i.isArray(this.views[e])||(r=this.views[e]=[this.views[e]]),i.indexOf(r,t)>-1?t:(r.push(t),t.__manager__.append=!0,t)):this.views[e]=t},setViews:function(e){return i.each(e,function(e,t){return i.isArray(e)?i.each(e,function(e){this.insertView(t,e)},this):void this.setView(t,e)},this),this},render:function(e){var t=this,n=this._options(),r=n.deferred();return this.__manager__.renderDeferred?(this.__manager__.callback=e,this.__manager__.renderDeferred):(this._render(s._viewRender).fetch.then(function(){t.__manager__.renderDeferred=r;var e=i.map(t.views,function(e){function t(e,n){if(!e.length)return n();var i=e.shift();i.render(function(){t(e,n)})}var r;return i.isArray(e)?(r=n.deferred(),t(i.clone(e),function(){r.resolve()}),r.promise()):e.render()});n.when(e).then(function(){r.resolveWith(t,[t.el])})}),r.then(function(){i.isFunction(e)&&e.call(t,t.el),i.isFunction(t.__manager__.callback)&&t.__manager__.callback.call(t,t.el),delete t.__manager__.callback,delete t.__manager__.renderDeferred}).promise())},remove:function(){return s.cleanViews(this),this._remove.apply(this,arguments)},_options:function(){return i.extend({},s.prototype.options,this.options)}},{_cache:{},_makeAsync:function(e,t){var n=e.deferred();return n.async=function(){return n._isAsync=!0,t},n},_viewRender:function(e){function t(t,i){s.cache(n,i),i&&o.html(e.el,o.render(i,t)),a.fetch.resolveWith(e,[e.el])}var n,r,a,o=e._options();return{render:function(c){var _=e.template||o.template;return e.serialize&&(o.serialize=e.serialize),!c&&i.isFunction(o.serialize)?c=o.serialize.call(e):!c&&i.isObject(o.serialize)&&(c=o.serialize),a=s._makeAsync(o,i.bind(t,e,c)),a.fetch=o.deferred(),e.__manager__.handler=a,i.isString(_)&&(n=e._prefix+_),(r=s.cache(n))?(t(c,r,n),a):(i.isString(_)?r=o.fetch.call(a,e._prefix+_):null!=_&&(r=o.fetch.call(a,_)),a._isAsync||t(c,r),a)}}},cleanViews:function(e){i.each([].concat(e),function(e){e.unbind(),e.views&&i.each(e.views,function(e){s.cleanViews(e)}),i.isFunction(e.cleanup)&&e.cleanup.call(e)})},cache:function(e,t){return e in this._cache?this._cache[e]:null!=e&&null!=t?this._cache[e]=t:void 0},configure:function(e){i.extend(s.prototype.options,e),e.manage&&(n.View.prototype.manage=!0)},setupView:function(e,r){var a,o=n.LayoutManager.prototype,c=i.pick(e,t);i.defaults(e,{views:{},__manager__:{},_options:s.prototype._options,_removeView:s._removeView}),i.extend(e,e.options),r=e.options=i.defaults(r||{},e.options,o.options),delete c.render,i.extend(r,c),e._remove=n.View.prototype.remove,e._render=function(e){return i.isFunction(this.beforeRender)&&this.beforeRender.call(this,this),this.trigger("beforeRender",this),e(this).render().then(function(){var e=this.__manager__.parent,t=this,n=function(){this.delegateEvents(),i.isFunction(this.afterRender)&&this.afterRender.call(this,this),this.trigger("afterRender",this)};return e.__manager__.parent&&e.__manager__.handler?void e.__manager__.handler.then(function(){n.call(t)}):n.call(this)})},e.render=s.prototype.render,e.remove!==o.remove&&(e._remove=e.remove,e.remove=o.remove),e._prefix="",a=r.views||e.views,a&&e.setViews(a),e.template&&(r.template=e.template)},_removeView:function(e){e=e||this,e.getViews().each(function(e){var t=e.__manager__,n=i.isBoolean(e.keep)?e.keep:e.options.keep;if(!n&&e.__manager__.append===!0){if(e.remove(),i.isArray(t.parent.views[t.selector]))return t.parent.getView(function(e,n){e.__manager__.selector===t.selector&&t.parent.views[t.selector].splice(n,1)});delete t.parent[t.selector]}})}}));i.each(["get","set","insert"],function(e){var t=n.View.prototype,i=s.prototype;t[e+"View"]=i[e+"View"],t[e+"Views"]=i[e+"Views"]}),n.Layout=n.LayoutManager=s,n.LayoutView=n.View.extend({manage:!0}),n.View.prototype._configure=function(){var e=a.apply(this,arguments);return this.manage&&s.setupView(this),e},s.prototype.options={paths:{},deferred:function(){return r.Deferred()},fetch:function(e){return i.template(r(e).html())},partial:function(e,t,n,i){var a=t?r(e).find(t):r(e);return a.length?(this[i?"append":"html"](a,n),!0):!1},html:function(e,t){r(e).html(t)},append:function(e,t){r(e).append(t)},when:function(e){return r.when.apply(null,e)},render:function(e,t){return e(t)}},t=i.keys(s.prototype.options)}(this);