/*!
 * backbone.layoutmanager.js v0.8.4
 * Copyright 2013, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(window){"use strict";var keys;var Backbone=window.Backbone;var _=window._;var $=window.$;var _configure=Backbone.View.prototype._configure;var render=Backbone.View.prototype.render;var aPush=Array.prototype.push;var aConcat=Array.prototype.concat;var aSplice=Array.prototype.splice;var LayoutManager=Backbone.View.extend({constructor:function Layout(options){options=options||{};LayoutManager.setupView(this,options);Backbone.View.call(this,options)},insertView:function(selector,view){if(view){return this.setView(selector,view,true)}return this.setView(selector,true)},insertViews:function(views){if(_.isArray(views)){return this.setViews({"":views})}_.each(views,function(view,selector){views[selector]=_.isArray(view)?view:[view]});return this.setViews(views)},getView:function(fn){if(typeof fn!=="function"&&typeof fn!=="string"){fn=arguments[1]}return this.getViews(fn).first().value()},getViews:function(fn){var views=_.chain(this.views).map(function(view){return _.isArray(view)?view:[view]},this).flatten().value();if(typeof fn==="string"){return _.chain([this.views[fn]]).flatten()}if(typeof fn==="object"){return _.chain([_.where(views,fn)]).flatten()}return _.chain(typeof fn==="function"?_.filter(views,fn):views)},removeView:function(fn){return this.getViews(fn).each(function(nestedView){nestedView.remove()})},setView:function(name,view,insert){var manager,existing,options;var root=this;if(typeof name!=="string"){insert=view;view=name;name=""}this.views=this.views||{};manager=view.__manager__;existing=this.views[name];if(!manager){throw new Error("Please set `View#manage` property with selector '"+name+"' to `true`.")}options=view.getAllOptions();manager.parent=root;manager.selector=name;view.on("all",function(name){if(name!=="beforeRender"&&name!=="afterRender"){root.trigger.apply(root,arguments)}},view);if(!insert){if(manager.hasRendered){options.partial(root.$el,view.$el,root.__manager__,manager)}if(existing){_.each(aConcat.call([],existing),function(nestedView){nestedView.remove()})}return this.views[name]=view}this.views[name]=aConcat.call([],existing||[],view);manager.insert=true;return view},setViews:function(views){_.each(views,function(view,name){if(_.isArray(view)){return _.each(view,function(view){this.insertView(name,view)},this)}this.setView(name,view)},this);return this},render:function(){var root=this;var options=root.getAllOptions();var manager=root.__manager__;var parent=manager.parent;var rentManager=parent&&parent.__manager__;var def=options.deferred();function resolve(){var next,afterRender;if(parent){if(!options.contains(parent.el,root.el)){options.partial(parent.$el,root.$el,rentManager,manager)}}root.delegateEvents();manager.hasRendered=true;if(next=manager.queue.shift()){next()}else{delete manager.queue}function completeRender(){var afterRender=options.afterRender;if(afterRender){afterRender.call(root,root)}root.trigger("afterRender",root)}if(rentManager&&rentManager.queue){parent.once("afterRender",completeRender)}else{completeRender()}return def.resolveWith(root,[root])}function actuallyRender(){var options=root.getAllOptions();var manager=root.__manager__;var parent=manager.parent;var rentManager=parent&&parent.__manager__;root._render(LayoutManager._viewRender,options).done(function(){if(!_.keys(root.views).length){return resolve()}var promises=_.map(root.views,function(view){var insert=_.isArray(view);if(insert&&view.length){return _.reduce(view.slice(1),function(prevRender,view){return prevRender.then(function(){return view.render()})},view[0].render())}return!insert?view.render():view});options.when(promises).done(resolve)})}if(manager.queue){aPush.call(manager.queue,actuallyRender)}else{manager.queue=[];actuallyRender(root,def)}def.view=root;return def},remove:function(){LayoutManager._removeView(this,true);return this._remove.apply(this,arguments)},getAllOptions:function(){return _.extend({},this,LayoutManager.prototype.options,this.options)}},{_cache:{},_makeAsync:function(options,done){var handler=options.deferred();handler.async=function(){handler._isAsync=true;return done};return handler},_viewRender:function(root,options){var url,contents,fetchAsync,renderedEl;var manager=root.__manager__;function applyTemplate(rendered){if(rendered){if(manager.noel){renderedEl=root.$el.html(rendered).children();root.$el.replaceWith(renderedEl);root.setElement(renderedEl,false)}else{options.html(root.$el,rendered)}}fetchAsync.resolveWith(root,[root])}function done(context,contents){var rendered;var renderAsync=LayoutManager._makeAsync(options,function(rendered){applyTemplate(rendered)});LayoutManager.cache(url,contents);if(contents){rendered=options.render.call(renderAsync,contents,context)}if(!renderAsync._isAsync){applyTemplate(rendered)}}return{render:function(){var context=root.serialize||options.serialize;var template=root.template||options.template;if(_.isFunction(context)){context=context.call(root)}fetchAsync=LayoutManager._makeAsync(options,function(contents){done(context,contents)});if(typeof template==="string"){url=options.prefix+template}if(contents=LayoutManager.cache(url)){done(context,contents,url);return fetchAsync}if(typeof template==="string"){contents=options.fetch.call(fetchAsync,options.prefix+template)}else if(typeof template==="function"){contents=template}else if(template!=null){contents=options.fetch.call(fetchAsync,template)}if(!fetchAsync._isAsync){done(context,contents)}return fetchAsync}}},_removeViews:function(root,force){var views;if(typeof root==="boolean"){force=root;root=this}root=root||this;root.getViews().each(function(view){if(view.__manager__.hasRendered||force){LayoutManager._removeView(view,force)}})},_removeView:function(view,force){var parentViews;var manager=view.__manager__;var keep=typeof view.keep==="boolean"?view.keep:view.options.keep;if(!keep&&(manager.insert===true||force)){LayoutManager.cleanViews(view);view._removeViews(true);view.$el.remove();if(!manager.parent){return}parentViews=manager.parent.views[manager.selector];if(_.isArray(parentViews)){return _.each(_.clone(parentViews),function(view,i){if(view&&view.__manager__===manager){aSplice.call(parentViews,i,1)}})}delete manager.parent.views[manager.selector]}},cache:function(path,contents){if(path in this._cache&&contents==null){return this._cache[path]}else if(path!=null&&contents!=null){return this._cache[path]=contents}},cleanViews:function(views){_.each(aConcat.call([],views),function(view){view.unbind();if(view.model instanceof Backbone.Model){view.model.off(null,null,view)}if(view.collection instanceof Backbone.Collection){view.collection.off(null,null,view)}view.stopListening();_.result(view,"cleanup")})},configure:function(options){_.extend(LayoutManager.prototype.options,options);if(options.manage){Backbone.View.prototype.manage=true}if(options.el===false){Backbone.View.prototype.el=false}},setupView:function(views,options){_.each(aConcat.call([],views),function(view){if(view.__manager__){return}var views,declaredViews,viewOptions;var proto=LayoutManager.prototype;var viewOverrides=_.pick(view,keys);_.defaults(view,{views:{},__manager__:{},_removeViews:LayoutManager._removeViews,_removeView:LayoutManager._removeView},LayoutManager.prototype);options=view.options=_.defaults(options||{},view.options,proto.options);viewOptions=_.pick(options,aConcat.call(["events"],_.values(options.events)));_.extend(view,viewOptions);if(viewOverrides.render===LayoutManager.prototype.render||viewOverrides.render===Backbone.View.prototype.render){delete viewOverrides.render}_.extend(options,viewOverrides);view._remove=Backbone.View.prototype.remove;view._render=function(manage,options){var view=this;var manager=view.__manager__;var beforeRender=options.beforeRender;if(manager.hasRendered){this._removeViews()}if(beforeRender){beforeRender.call(this,this)}this.trigger("beforeRender",this);return manage(this,options).render()};view.render=LayoutManager.prototype.render;if(view.remove!==proto.remove){view._remove=view.remove;view.remove=proto.remove}views=options.views||view.views;if(_.keys(views).length){declaredViews=views;view.views={};view.setViews(declaredViews)}if(view.options.template){view.options.template=options.template}else if(view.template){options.template=view.template;delete view.template}})}});Backbone.Layout=LayoutManager;LayoutManager.VERSION="0.8.4";Backbone.View.prototype._configure=function(options){var noel,retVal;if("el"in options?options.el===false:this.el===false){noel=true}retVal=_configure.apply(this,arguments);if(options.manage||this.manage){LayoutManager.setupView(this)}if(this.__manager__){this.__manager__.noel=noel}return retVal};LayoutManager.prototype.options={prefix:"",deferred:function(){return $.Deferred()},fetch:function(path){return _.template($(path).html())},partial:function($root,$el,rentManager,manager){if(manager.selector){if(rentManager.noel){var $filtered=$root.filter(manager.selector);$root=$filtered.length?$filtered:$root.find(manager.selector)}else{$root=$root.find(manager.selector)}}if(manager.insert){this.insert($root,$el)}else{this.html($root,$el)}},html:function($root,content){$root.html(content)},insert:function($root,$el){$root.append($el)},when:function(promises){return $.when.apply(null,promises)},render:function(template,context){return template(context)},contains:function(parent,child){return $.contains(parent,child)}};keys=_.keys(LayoutManager.prototype.options)})(typeof global==="object"?global:this);