/*!
 * backbone.layoutmanager.js v0.9.5
 * Copyright 2013, Tim Branyen (@tbranyen)
 * backbone.layoutmanager.js may be freely distributed under the MIT license.
 */
(function(b,a){var c=b.Backbone;if(typeof define==="function"&&define.amd){return define(["backbone","underscore","jquery"],function(){return a.apply(b,arguments)})}c.Layout=a.call(b,c,b._,c.$)}(typeof global==="object"?global:this,function(k,l,f){var h=this;var b=k.View;var g=Array.prototype.push;var i=Array.prototype.concat;var c=Array.prototype.splice;var d=String.prototype.trim?l.bind(String.prototype.trim.call,String.prototype.trim):f.trim;var a=k.View.extend({_render:function(){var m=this;var o=m.__manager__;var n=m.beforeRender;var p=m.deferred();if(m.hasRendered){m._removeViews()}o.callback=function(){delete o.isAsync;delete o.callback;m.trigger("beforeRender",m);m._viewRender(o).render().then(function(){p.resolve()})};if(n){n.call(m,m)}if(!o.isAsync){o.callback()}return p.promise()},_applyTemplate:function(o,m,n){if(l.isString(o)){if(m.noel){o=f.parseHTML(o,true);this.$el.slice(1).remove();this.$el.replaceWith(o);this.setElement(o,false)}else{this.html(this.$el,o)}}n.resolveWith(this,[this])},_viewRender:function(p){var o,q,r;var n=this;function m(s,t){var u;p.callback=function(v){delete p.isAsync;delete p.callback;n._applyTemplate(v,p,r)};a.cache(o,t);if(t){u=n.renderTemplate.call(n,t,s)}if(!p.isAsync){n._applyTemplate(u,p,r)}}return{render:function(){var s=n.serialize;var t=n.template;r=n.deferred();if(l.isFunction(s)){s=s.call(n)}p.callback=function(u){delete p.isAsync;delete p.callback;m(s,u)};if(typeof t==="string"){o=n.prefix+t}if(q=a.cache(o)){m(s,q,o);return r}if(typeof t==="string"){q=n.fetchTemplate.call(n,n.prefix+t)}else{if(typeof t==="function"){q=t}else{if(t!=null){q=n.fetchTemplate.call(n,t)}}}if(!p.isAsync){m(s,q)}return r}}},constructor:function j(m){this.manage=true;l.extend(this,m);k.View.apply(this,arguments)},async:function(){var m=this.__manager__;m.isAsync=true;return m.callback},promise:function(){return this.__manager__.renderDeferred.promise()},renderViews:function(){var m=this;var o=m.__manager__;var p=m.deferred();var n=m.getViews().map(function(q){return q.render().__manager__.renderDeferred}).value();o.renderDeferred=p.promise();m.when(n).then(function(){p.resolveWith(m,[m])});return m},insertView:function(m,n){if(n){return this.setView(m,n,true)}return this.setView(m,true)},insertViews:function(m){if(l.isArray(m)){return this.setViews({"":m})}l.each(m,function(o,n){m[n]=l.isArray(o)?o:[o]});return this.setViews(m)},getView:function(m){if(m==null){m=arguments[1]}return this.getViews(m).first().value()},getViews:function(n){var m;if(typeof n==="string"){n=this.sections[n]||n;m=this.views[n]||[];return l.chain([].concat(m))}m=l.chain(this.views).map(function(o){return l.isArray(o)?o:[o]},this).flatten();if(typeof n==="object"){return m.where(n)}return typeof n==="function"?m.filter(n):m},removeView:function(m){return this.getViews(m).each(function(n){n.remove()})},setView:function(p,o,r){var q,m;var n=this;if(typeof p!=="string"){r=o;o=p;p=""}q=o.__manager__;if(!q){throw new Error("The argument associated with selector '"+p+"' is defined and a View.  Set `manage` property to true for Backbone.View instances.")}q.parent=n;m=q.selector=n.sections[p]||p;if(!r){n.removeView(p);return n.views[m]=o}n.views[m]=i.call([],n.views[p]||[],o);n.__manager__.insert=true;return o},setViews:function(m){l.each(m,function(n,o){if(l.isArray(n)){return l.each(n,function(p){this.insertView(o,p)},this)}this.setView(o,n)},this);return this},render:function(){var m=this;var p=m.__manager__;var q=p.parent;var o=q&&q.__manager__;var s=m.deferred();function r(){var u;l.each(m.views,function(w,v){if(l.isArray(w)){m.htmlBatch(m,w,v)}});if(q&&!p.insertedViaFragment){if(!m.contains(q.el,m.el)){q.partial(q.$el,m.$el,o,p)}}m.delegateEvents();m.hasRendered=true;if(u=p.queue.shift()){u()}else{delete p.queue}function t(){var v=h.console;var w=m.afterRender;if(w){w.call(m,m)}m.trigger("afterRender",m);if(p.noel&&m.$el.length>1){if(l.isFunction(v.warn)&&!m.suppressWarnings){v.warn("`el: false` with multiple top level elements is not supported.");if(l.isFunction(v.trace)){v.trace()}}}}if(o&&o.queue){q.once("afterRender",t)}else{t()}return s.resolveWith(m,[m])}function n(){m._render().done(function(){if(!l.keys(m.views).length){return r()}var t=l.map(m.views,function(u){var v=l.isArray(u);if(v&&u.length){return m.when(l.map(u,function(w){w.__manager__.insertedViaFragment=true;return w.render().__manager__.renderDeferred}))}return !v?u.render().__manager__.renderDeferred:u});m.when(t).done(r)})}if(p.queue){g.call(p.queue,n)}else{p.queue=[];n(m,s)}m.__manager__.renderDeferred=s;return m},remove:function(){a._removeView(this,true);return this._remove.apply(this,arguments)}},{_cache:{},_removeViews:function(m,n){if(typeof m==="boolean"){n=m;m=this}m=m||this;m.getViews().each(function(o){if(o.hasRendered||n){a._removeView(o,n)}})},_removeView:function(n,r){var m;var q=n.__manager__;var p=q.parent&&q.parent.__manager__;var o=typeof n.keep==="boolean"?n.keep:n.options.keep;if((!o&&p&&p.insert===true)||r){a.cleanViews(n);n._removeViews(true);n.$el.remove();if(!q.parent){return}m=q.parent.views[q.selector];if(l.isArray(m)){return l.each(l.clone(m),function(s,t){if(s&&s.__manager__===q){c.call(m,t,1)}})}delete q.parent.views[q.selector]}},cache:function(n,m){if(n in this._cache&&m==null){return this._cache[n]}else{if(n!=null&&m!=null){return this._cache[n]=m}}},cleanViews:function(m){l.each(i.call([],m),function(n){n.unbind();if(n.model instanceof k.Model){n.model.off(null,null,n)}if(n.collection instanceof k.Collection){n.collection.off(null,null,n)}n.stopListening();if(l.isFunction(n.cleanup)){n.cleanup()}})},configure:function(m){l.extend(a.prototype,m);if(m.manage){k.View.prototype.manage=true}if(m.el===false){k.View.prototype.el=false}if(m.suppressWarnings===true){k.View.prototype.suppressWarnings=true}},setupView:function(m,n){n=n||{};l.each(i.call([],m),function(p){if(p.__manager__){return}var o,r;var q=a.prototype;l.defaults(p,{views:{},sections:{},__manager__:{},_removeViews:a._removeViews,_removeView:a._removeView},a.prototype);p.options=n;l.extend(p,n);p._remove=k.View.prototype.remove;p.render=a.prototype.render;if(p.remove!==q.remove){p._remove=p.remove;p.remove=q.remove}o=n.views||p.views;if(l.keys(o).length){r=o;p.views={};l.each(r,function(t,s){if(typeof t==="function"){r[s]=t.call(p,p)}});p.setViews(r)}})}});a.VERSION="0.9.5";k.Layout=a;k.View=function(n){var m;n=n||{};if("el" in n?n.el===false:this.el===false){m=true}if(n.manage||this.manage){a.setupView(this,n)}if(this.__manager__){this.__manager__.noel=m;this.__manager__.suppressWarnings=n.suppressWarnings}b.apply(this,arguments)};k.View.extend=b.extend;k.View.prototype=b.prototype;var e={prefix:"",deferred:function(){return f.Deferred()},fetchTemplate:function(m){return l.template(f(m).html())},renderTemplate:function(n,m){return d(n(m))},serialize:function(){return this.model?l.clone(this.model.attributes):{}},partial:function(q,p,o,n){var m;if(n.selector){if(o.noel){m=q.filter(n.selector);q=m.length?m:q.find(n.selector)}else{q=q.find(n.selector)}}if(o.insert){this.insert(q,p)}else{this.html(q,p)}},html:function(n,m){n.html(m)},htmlBatch:function(r,n,m){var q=r.__manager__;var p={selector:m};var o=l.reduce(n,function(t,u){var s=typeof u.keep==="boolean"?u.keep:u.options.keep;var v=s&&f.contains(r.el,u.el);if(u.el&&!v){t.push(u.el)}return t},[]);return this.partial(r.$el,f(o),q,p)},insert:function(n,m){n.append(m)},when:function(m){return f.when.apply(null,m)},contains:function(m,n){return f.contains(m,n)}};l.extend(a.prototype,e);return a}));