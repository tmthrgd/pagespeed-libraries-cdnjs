!function(e){"use strict";var n=e.Backbone,t=e.define?e.define:function(e){e.call(this)};t(function(t){t=t||function(){return!1};var r,i=t("backbone")||e.Backbone,o=t("underscore")||e._,s=t("jquery")||i.$,a=e.console&&e.console.warn,l=e.console&&e.console.trace,c=i.View.prototype._configure,u=(i.View.prototype.render,Array.prototype.push),p=Array.prototype.concat,f=Array.prototype.splice,_=i.View.extend({constructor:function(e){e=e||{},_.setupView(this,e),i.View.call(this,e)},async:function(){var e=this.__manager__;return e.isAsync=!0,e.callback},promise:function(){return this.__manager__.renderDeferred.promise()},renderViews:function(){var e=this.__manager__,n=this.getAllOptions();return e.renderDeferred=n.when(this.getViews().map(function(e){return e.render().__manager__.renderDeferred})).promise(),this},insertView:function(e,n){return n?this.setView(e,n,!0):this.setView(e,!0)},insertViews:function(e){return o.isArray(e)?this.setViews({"":e}):(o.each(e,function(n,t){e[t]=o.isArray(n)?n:[n]}),this.setViews(e))},getView:function(e){return null==e&&(e=arguments[1]),this.getViews(e).first().value()},getViews:function(e){var n;return"string"==typeof e?(n=this.views[e]||[],o.chain([].concat(n))):(n=o.chain(this.views).map(function(e){return o.isArray(e)?e:[e]},this).flatten(),"object"==typeof e?n.where(e):"function"==typeof e?n.filter(e):n)},removeView:function(e){return this.getViews(e).each(function(e){e.remove()})},setView:function(e,n,t){var r,i,s,a=this;if("string"!=typeof e&&(t=n,n=e,e=""),this.views=this.views||{},r=n.__manager__,i=this.views[e],!r)throw new Error("Please set `View#manage` property with selector '"+e+"' to `true`.");return s=n.getAllOptions(),r.parent=a,r.selector=e,n.on("all",function(e){"beforeRender"!==e&&"afterRender"!==e&&a.trigger.apply(a,arguments)},n),o.result(n,"setup"),t?(this.views[e]=p.call([],i||[],n),r.insert=!0,n):(r.hasRendered&&s.partial(a.$el,n.$el,a.__manager__,r),i&&o.each(p.call([],i),function(e){e.remove()}),this.views[e]=n)},setViews:function(e){return o.each(e,function(e,n){return o.isArray(e)?o.each(e,function(e){this.insertView(n,e)},this):void this.setView(n,e)},this),this},render:function(){function n(){function n(){var n=i.afterRender;n&&n.call(r,r),r.trigger("afterRender",r),s.noel&&r.$el.length>1&&a&&!i.suppressWarnings&&(e.console.warn("Using `el: false` with multiple top level elements is not supported."),l&&e.console.trace())}var t;return c&&(i.contains(c.el,r.el)||i.partial(c.$el,r.$el,p,s)),r.delegateEvents(),s.hasRendered=!0,(t=s.queue.shift())?t():delete s.queue,p&&p.queue?c.once("afterRender",n):n(),f.resolveWith(r,[r])}function t(){{var e=r.getAllOptions(),t=r.__manager__,i=t.parent;i&&i.__manager__}r._render(_._viewRender,e).done(function(){if(!o.keys(r.views).length)return n();var t=o.map(r.views,function(e){var n=o.isArray(e);return n&&e.length?o.reduce(e.slice(1),function(e,n){return e.then(function(){return n.render().__manager__.renderDeferred})},e[0].render().__manager__.renderDeferred):n?e:e.render().__manager__.renderDeferred});e.when(t).done(n)})}var r=this,i=r.getAllOptions(),s=r.__manager__,c=s.parent,p=c&&c.__manager__,f=i.deferred();return s.queue?u.call(s.queue,t):(s.queue=[],t(r,f)),r.__manager__.renderDeferred=f,r},remove:function(){return _._removeView(this,!0),this._remove.apply(this,arguments)},getAllOptions:function(){return o.extend({},this,_.prototype.options,this.options)}},{_cache:{},_viewRender:function(e,n){function t(t){t&&(u.noel?(t=s.trim(t),c=s(t),e.$el.slice(1).remove(),e.$el.replaceWith(c),e.setElement(c,!1)):n.html(e.$el,t)),l.resolveWith(e,[e])}function r(r,o){var s;u.callback=function(e){delete u.isAsync,delete u.callback,t(e)},_.cache(i,o),o&&(s=n.render.call(e,o,r)),u.isAsync||t(s)}var i,a,l,c,u=e.__manager__;return{render:function(){var t=e.serialize||n.serialize,s=e.template||n.template;return l=n.deferred(),o.isFunction(t)&&(t=t.call(e)),u.callback=function(e){delete u.isAsync,delete u.callback,r(t,e)},"string"==typeof s&&(i=n.prefix+s),(a=_.cache(i))?(r(t,a,i),l):("string"==typeof s?a=n.fetch.call(e,n.prefix+s):"function"==typeof s?a=s:null!=s&&(a=n.fetch.call(e,s)),u.isAsync||r(t,a),l)}}},_removeViews:function(e,n){"boolean"==typeof e&&(n=e,e=this),e=e||this,e.getViews().each(function(e){(e.__manager__.hasRendered||n)&&_._removeView(e,n)})},_removeView:function(e,n){var t,r=e.__manager__,i="boolean"==typeof e.keep?e.keep:e.options.keep;if(!i&&r.insert===!0||n){if(_.cleanViews(e),e._removeViews(!0),e.$el.remove(),!r.parent)return;if(t=r.parent.views[r.selector],o.isArray(t))return o.each(o.clone(t),function(e,n){e&&e.__manager__===r&&f.call(t,n,1)});delete r.parent.views[r.selector]}},cache:function(e,n){return e in this._cache&&null==n?this._cache[e]:null!=e&&null!=n?this._cache[e]=n:void 0},cleanViews:function(e){o.each(p.call([],e),function(e){var n;e.unbind(),e.model instanceof i.Model&&e.model.off(null,null,e),e.collection instanceof i.Collection&&e.collection.off(null,null,e),e.stopListening(),n=e.getAllOptions().cleanup,o.isFunction(n)&&n.call(e)})},configure:function(e){o.extend(_.prototype.options,e),e.manage&&(i.View.prototype.manage=!0),e.el===!1&&(i.View.prototype.el=!1),e.suppressWarnings===!0&&(i.View.prototype.suppressWarnings=!0)},setupView:function(e,n){o.each(p.call([],e),function(e){if(!e.__manager__){var t,s,a,l=_.prototype,c=o.pick(e,r);o.defaults(e,{views:{},__manager__:{},_removeViews:_._removeViews,_removeView:_._removeView},_.prototype),n=e.options=o.defaults(n||{},e.options,l.options),a=o.pick(n,p.call(["events"],o.values(n.events))),o.extend(e,a),(c.render===_.prototype.render||c.render===i.View.prototype.render)&&delete c.render,o.extend(n,c),e._remove=i.View.prototype.remove,e._render=function(e,n){var t=this,r=t.__manager__,i=n.beforeRender,o=n.deferred();return r.hasRendered&&t._removeViews(),r.callback=function(){delete r.isAsync,delete r.callback,t.trigger("beforeRender",t),e(t,n).render().then(function(){o.resolve()})},i&&i.call(t,t),r.isAsync||r.callback(),o.promise()},e.render=_.prototype.render,e.remove!==l.remove&&(e._remove=e.remove,e.remove=l.remove),t=n.views||e.views,o.keys(t).length&&(s=t,e.views={},e.setViews(s)),e.options.template?e.options.template=n.template:e.template&&(n.template=e.template)}})}});return _.VERSION="0.9.0-pre",i.Layout=_,n&&(n.Layout=_),i.View.prototype._configure=function(e){var n,t;return("el"in e?e.el===!1:this.el===!1)&&(n=!0),t=c.apply(this,arguments),(e.manage||this.manage)&&_.setupView(this),this.__manager__&&(this.__manager__.noel=n,this.__manager__.suppressWarnings=e.suppressWarnings),t},_.prototype.options={prefix:"",deferred:function(){return s.Deferred()},fetch:function(e){return o.template(s(e).html())},partial:function(e,n,t,r){if(r.selector)if(t.noel){var i=e.filter(r.selector);e=i.length?i:e.find(r.selector)}else e=e.find(r.selector);r.insert?this.insert(e,n):this.html(e,n)},html:function(e,n){e.html(n)},insert:function(e,n){e.append(n)},when:function(e){return s.when.apply(null,e)},render:function(e,n){return e(n)},contains:function(e,n){return s.contains(e,n)}},r=o.keys(_.prototype.options),_})}("object"==typeof global?global:this);