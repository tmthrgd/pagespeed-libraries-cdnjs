!function(e){"use strict";var t=e.define||function(t){e.Backbone.Layout=t.call(this,function(){})};t(function(t){var n,r=t("backbone")||e.Backbone,i=t("underscore")||e._,o=t("jquery")||r.$,s=r.View.prototype._configure,a=Array.prototype.push,l=Array.prototype.concat,c=Array.prototype.splice,u=r.View.extend({_render:function(e,t){var n=this,r=n.__manager__,i=t.beforeRender,o=t.deferred();return n.hasRendered&&n._removeViews(),r.callback=function(){delete r.isAsync,delete r.callback,n.trigger("beforeRender",n),e(n,t).render().then(function(){o.resolve()})},i&&i.call(n,n),r.isAsync||r.callback(),o.promise()},constructor:function(e){e=e||{},u.setupView(this,e),r.View.call(this,e)},async:function(){var e=this.__manager__;return e.isAsync=!0,e.callback},promise:function(){return this.__manager__.renderDeferred.promise()},renderViews:function(){var e=this,t=e.__manager__,n=e.getAllOptions(),r=n.deferred(),i=e.getViews().map(function(e){return e.render().__manager__.renderDeferred}).value();return t.renderDeferred=r.promise(),n.when(i).then(function(){r.resolveWith(e,[e])}),e},insertView:function(e,t){return t?this.setView(e,t,!0):this.setView(e,!0)},insertViews:function(e){return i.isArray(e)?this.setViews({"":e}):(i.each(e,function(t,n){e[n]=i.isArray(t)?t:[t]}),this.setViews(e))},getView:function(e){return null==e&&(e=arguments[1]),this.getViews(e).first().value()},getViews:function(e){var t;return"string"==typeof e?(e=this.sections[e]||e,t=this.views[e]||[],i.chain([].concat(t))):(t=i.chain(this.views).map(function(e){return i.isArray(e)?e:[e]},this).flatten(),"object"==typeof e?t.where(e):"function"==typeof e?t.filter(e):t)},removeView:function(e){return this.getViews(e).each(function(e){e.remove()})},setView:function(e,t,n){var r,o,s,a=this;if("string"!=typeof e&&(n=t,t=e,e=""),r=t.__manager__,!r)throw new Error("The argument associated with selector '"+e+"' is defined and a View.  Set `manage` property to true for Backbone.View instances.");return o=t.getAllOptions(),r.parent=a,s=r.selector=a.sections[e]||e,i.result(t,"setup"),n?(a.views[s]=l.call([],a.views[e]||[],t),a.__manager__.insert=!0,t):(t.hasRendered&&o.partial(a.$el,t.$el,a.__manager__,r),a.removeView(e),a.views[s]=t)},setViews:function(e){return i.each(e,function(e,t){return i.isArray(e)?i.each(e,function(e){this.insertView(t,e)},this):void this.setView(t,e)},this),this},render:function(){function t(){function t(){var t=e.console,n=o.afterRender;n&&n.call(r,r),r.trigger("afterRender",r),s.noel&&r.$el.length>1&&i.isFunction(t.warn)&&!o.suppressWarnings&&(t.warn("`el: false` with multiple top level elements is not supported."),i.isFunction(t.trace)&&t.trace())}var n;return i.each(r.views,function(e,t){i.isArray(e)&&o.htmlBatch(r,e,t)}),l&&!s.insertedViaFragment&&(o.contains(l.el,r.el)||l.getAllOptions().partial(l.$el,r.$el,c,s)),r.delegateEvents(),r.hasRendered=!0,(n=s.queue.shift())?n():delete s.queue,c&&c.queue?l.once("afterRender",t):t(),p.resolveWith(r,[r])}function n(){var e=r.getAllOptions();r._render(u._viewRender,e).done(function(){if(!i.keys(r.views).length)return t();var n=i.map(r.views,function(t){var n=i.isArray(t);return n&&t.length?e.when(i.map(t,function(e){return e.__manager__.insertedViaFragment=!0,e.render().__manager__.renderDeferred})):n?t:t.render().__manager__.renderDeferred});e.when(n).done(t)})}var r=this,o=r.getAllOptions(),s=r.__manager__,l=s.parent,c=l&&l.__manager__,p=o.deferred();return s.queue?a.call(s.queue,n):(s.queue=[],n(r,p)),r.__manager__.renderDeferred=p,r},remove:function(){return u._removeView(this,!0),this._remove.apply(this,arguments)},getAllOptions:function(){return i.extend({},this,u.prototype.options,this.options)}},{_cache:{},_viewRender:function(e,t){function n(n){i.isString(n)&&(p.noel?(n=o.trim(n),c=o(n),e.$el.slice(1).remove(),e.$el.replaceWith(c),e.setElement(c,!1)):t.html(e.$el,n)),l.resolveWith(e,[e])}function r(r,i){var o;p.callback=function(e){delete p.isAsync,delete p.callback,n(e)},u.cache(s,i),i&&(o=t.renderTemplate.call(e,i,r)),p.isAsync||n(o)}var s,a,l,c,p=e.__manager__;return{render:function(){var n=e.serialize||t.serialize,o=e.template||t.template;return l=t.deferred(),i.isFunction(n)&&(n=n.call(e)),p.callback=function(e){delete p.isAsync,delete p.callback,r(n,e)},"string"==typeof o&&(s=t.prefix+o),(a=u.cache(s))?(r(n,a,s),l):("string"==typeof o?a=t.fetchTemplate.call(e,t.prefix+o):"function"==typeof o?a=o:null!=o&&(a=t.fetchTemplate.call(e,o)),p.isAsync||r(n,a),l)}}},_removeViews:function(e,t){"boolean"==typeof e&&(t=e,e=this),e=e||this,e.getViews().each(function(e){(e.hasRendered||t)&&u._removeView(e,t)})},_removeView:function(e,t){var n,r=e.__manager__,o=r.parent&&r.parent.__manager__,s="boolean"==typeof e.keep?e.keep:e.options.keep;if(!s&&o&&o.insert===!0||t){if(u.cleanViews(e),e._removeViews(!0),e.$el.remove(),!r.parent)return;if(n=r.parent.views[r.selector],i.isArray(n))return i.each(i.clone(n),function(e,t){e&&e.__manager__===r&&c.call(n,t,1)});delete r.parent.views[r.selector]}},cache:function(e,t){return e in this._cache&&null==t?this._cache[e]:null!=e&&null!=t?this._cache[e]=t:void 0},cleanViews:function(e){i.each(l.call([],e),function(e){var t;e.unbind(),e.model instanceof r.Model&&e.model.off(null,null,e),e.collection instanceof r.Collection&&e.collection.off(null,null,e),e.stopListening(),t=e.getAllOptions().cleanup,i.isFunction(t)&&t.call(e)})},configure:function(e){i.extend(u.prototype.options,e),e.manage&&(r.View.prototype.manage=!0),e.el===!1&&(r.View.prototype.el=!1),e.suppressWarnings===!0&&(r.View.prototype.suppressWarnings=!0)},setupView:function(e,t){i.each(l.call([],e),function(e){if(!e.__manager__){var o,s,a,c=u.prototype,p=i.pick(e,n);i.defaults(e,{views:{},sections:{},__manager__:{},_removeViews:u._removeViews,_removeView:u._removeView},u.prototype),t=e.options=i.defaults(t||{},e.options,c.options),a=i.pick(t,l.call(["events","sections"],i.values(t.events))),i.extend(e,a),i.extend(t,p),e._remove=r.View.prototype.remove,e.render=u.prototype.render,e.remove!==c.remove&&(e._remove=e.remove,e.remove=c.remove),o=t.views||e.views,i.keys(o).length&&(s=o,e.views={},e.setViews(s)),e.options.template?e.options.template=t.template:e.template&&(t.template=e.template)}})}});return u.VERSION="0.9.0-pre",r.Layout=u,r.View.prototype._configure=function(e){var t,n;return("el"in e?e.el===!1:this.el===!1)&&(t=!0),n=s.apply(this,arguments),(e.manage||this.manage)&&u.setupView(this),this.__manager__&&(this.__manager__.noel=t,this.__manager__.suppressWarnings=e.suppressWarnings),n},u.prototype.options={prefix:"",deferred:function(){return o.Deferred()},fetchTemplate:function(e){return i.template(o(e).html())},renderTemplate:function(e,t){return e(t)},partial:function(e,t,n,r){var i;r.selector&&(n.noel?(i=e.filter(r.selector),e=i.length?i:e.find(r.selector)):e=e.find(r.selector)),r.insert?this.insert(e,t):this.html(e,t)},html:function(e,t){e.html(t)},htmlBatch:function(e,t,n){var r=e.__manager__,s={selector:n,insert:r.insert},a=i.reduce(t,function(t,n){var r="boolean"==typeof n.keep?n.keep:n.options.keep,i=r&&o.contains(e.el,n.el);return n.el&&!i&&t.push(n.el),t},[]);return this.partial(e.$el,o(a),r,s)},insert:function(e,t){e.append(t)},when:function(e){return o.when.apply(null,e)},contains:function(e,t){return o.contains(e,t)}},n=i.keys(u.prototype.options),u})}("object"==typeof global?global:this);