(function(){var a={}.hasOwnProperty;angular.module("knalli.angular-vertxbus",["ng"]),angular.module("knalli.angular-vertxbus").provider("vertxEventBus",function(){var a,b;a={enabled:!0,debugEnabled:!1,prefix:"vertx-eventbus.",urlServer:""+location.protocol+"//"+location.hostname+":"+(location.port||80),urlPath:"/eventbus",reconnectEnabled:!0,sockjsStateInterval:1e4,sockjsReconnectInterval:1e4,sockjsOptions:{},messageBuffer:0},b=angular.extend({},a),this.enable=function(c){return null==c&&(c=a.enabled),b.enabled=c===!0,this},this.useDebug=function(c){return null==c&&(c=a.debugEnabled),b.debugEnabled=c===!0,this},this.usePrefix=function(c){return null==c&&(c=a.prefix),b.prefix=c,this},this.useUrlServer=function(c){return null==c&&(c=a.urlServer),b.urlServer=c,this},this.useUrlPath=function(c){return null==c&&(c=a.urlPath),b.urlPath=c,this},this.useReconnect=function(c){return null==c&&(c=a.reconnectEnabled),b.reconnectEnabled=c,this},this.useSockJsStateInterval=function(c){return null==c&&(c=a.sockjsStateInterval),b.sockjsStateInterval=c,this},this.useSockJsReconnectInterval=function(c){return null==c&&(c=a.sockjsReconnectInterval),b.sockjsReconnectInterval=c,this},this.useSockJsOptions=function(c){return null==c&&(c=a.sockjsOptions),b.sockjsOptions=c,this},this.useMessageBuffer=function(c){return null==c&&(c=a.messageBuffer),b.messageBuffer=c,this},this.$get=["$timeout",function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return r=angular.extend({},a,b),g=r.enabled,f=r.debugEnabled,i=r.prefix,q=r.urlServer,p=r.urlPath,j=r.reconnectEnabled,m=r.sockjsStateInterval,l=r.sockjsReconnectInterval,k=r.sockjsOptions,n=null,d="undefined"!=typeof vertx&&null!==vertx?vertx.EventBus:void 0,g&&d?(o=""+q+p,f&&console.debug("[VertX EventBus] Enabled: connecting '"+o+"'"),h=null,e=function(){h=new d(o,void 0,k),h.onopen=function(){f&&console.debug("[VertX EventBus] Connected"),"function"==typeof n.onopen&&n.onopen()},h.onclose=function(){f&&console.debug("[VertX EventBus] Reconnect in "+l+"ms"),"function"==typeof n.onclose&&n.onclose(),j&&c(e,l)}},e(),n={reconnect:function(){return h.close()},close:function(){return h.close()},login:function(a,b,c){return h.login(a,b,c)},send:function(a,b,c){return h.send(a,b,c)},publish:function(a,b){return h.publish(a,b)},registerHandler:function(a,b){return h.registerHandler(a,b),function(){n.unregisterHandler(a,b)}},unregisterHandler:function(a,b){return h.unregisterHandler(a,b)},readyState:function(){return h.readyState()},EventBus:d,getOptions:function(){return angular.extend({},b)}}):f&&console.debug("[VertX EventBus] Disabled"),n}]}),angular.module("knalli.angular-vertxbus").provider("vertxEventBusService",function(){var b,c,d;b={loginRequired:!1,loginBlockForSession:!1,skipUnauthorizeds:!0},c=function(){function a(a){this.maxSize=null!=a?a:10,this.items=[]}return a.prototype.push=function(a){return this.items.push(a),this.recalibrateBufferSize()},a.prototype.recalibrateBufferSize=function(){for(;this.items.length>this.maxSize;)this.first();return this},a.prototype.last=function(){return this.items.pop()},a.prototype.first=function(){return this.items.shift(0)},a.prototype.size=function(){return this.items.length},a}(),d=angular.extend({},b),this.requireLogin=function(a){return null==a&&(a=d.loginRequired),d.loginRequired=a,this},this.blockForSession=function(a){return null==a&&(a=d.loginBlockForSession),d.loginBlockForSession=a,this},this.skipUnauthorizeds=function(a){return null==a&&(a=d.skipUnauthorizeds),d.skipUnauthorizeds=a,this},this.$get=["$rootScope","$q","$interval","$timeout","vertxEventBus",function(b,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;return B=h.getOptions(),k=B.enabled,j=B.debugEnabled,r=B.prefix,x=B.urlServer,w=B.urlPath,s=B.reconnectEnabled,v=B.sockjsStateInterval,u=B.sockjsReconnectInterval,t=B.sockjsOptions,p=B.messageBuffer,i=null!=h&&null!=(C=h.EventBus)?C.CLOSED:void 0,z=!1,o=null,q=new c(p),n={},k&&h&&(h.onopen=function(){var c,d,e,f,g,h,i;A.getConnectionState(!0),b.$broadcast(""+r+"system.connected"),i=A.handlers;for(c in i)if(a.call(i,c))for(e=i[c],g=0,h=e.length;h>g;g++)d=e[g],y.registerHandler(c,d);if(b.$digest(),p&&q.size()){for(;q.size();)f=q.first(),"function"==typeof f&&f();b.$digest()}},h.onclose=function(){return A.getConnectionState(!0),b.$broadcast(""+r+"system.disconnected")}),m=function(a){return A.getConnectionState()===h.EventBus.OPEN?(a(),!0):p?(q.push(a),!0):!1},l=function(a){return m(d.loginRequired?function(){return z?(a(),!0):(j&&console.debug("[VertX EB Service] Message was not sent because login is required"),!1)}:a)},y={registerHandler:function(a,c){return"function"==typeof c?(j&&console.debug("[VertX EB Service] Register handler for "+a),n[c]?n[c]:(n[c]=function(a,d){return c(a,d),b.$digest()},h.registerHandler(a,n[c]))):void 0},unregisterHandler:function(a,b){"function"==typeof b&&(j&&console.debug("[VertX EB Service] Unregister handler for "+a),h.unregisterHandler(a,n[b]),n[b]=void 0)},send:function(a,b,c){var d,f;return null==c&&(c=1e4),d=e.defer(),f=l(function(){return h.send(a,b,function(a){return d?d.resolve(a):void 0}),d?g(function(){return d.reject()},c):void 0}),d&&!f&&d.reject(),null!=d?d.promise:void 0},publish:function(a,b){var c;return c=l(function(){return h.publish(a,b)})},login:function(a,c,d){var f;return null==d&&(d=5e3),f=e.defer(),h.login(a,c,function(a){return"ok"===(null!=a?a.status:void 0)?(f.resolve(a),b.$broadcast(""+r+"system.login.succeeded",{status:null!=a?a.status:void 0})):(f.reject(a),b.$broadcast(""+r+"system.login.failed",{status:null!=a?a.status:void 0}))}),g(function(){return f.reject()},d),f.promise}},A={handlers:{},registerHandler:function(a,b){var c;return A.handlers[a]||(A.handlers[a]=[]),A.handlers[a].push(b),c=null,i===h.EventBus.OPEN&&(c=y.registerHandler(a,b)),function(){var d;c&&c(),A.handlers[a]&&(d=A.handlers[a].indexOf(b),d>-1&&A.handlers[a].splice(d,1))}},unregisterHandler:function(a,b){var c;return A.handlers[a]&&(c=A.handlers[a].indexOf(b),c>-1&&A.handlers[a].splice(c,1)),i===h.EventBus.OPEN?y.unregisterHandler(a,b):void 0},send:function(a,b,c){return null==c&&(c=1e4),y.send(a,b,c)},publish:function(a,b){return y.publish(a,b)},getConnectionState:function(a){return(null!=h?h.EventBus:void 0)?k?a&&(i=h.readyState()):i=h.EventBus.CLOSED:i=3,i},isValidSession:function(){return z},login:function(a,b){return y.login(a,b).then(function(a){return z=!0,a})["catch"](function(a){return z=!1,a})}},f(function(){return A.getConnectionState(!0)},v),{on:A.registerHandler,addListener:A.registerHandler,un:A.unregisterHandler,removeListener:A.unregisterHandler,send:A.send,publish:A.publish,emit:A.publish,readyState:A.getConnectionState,isEnabled:function(){return k},getBufferCount:function(){return q.size()},isValidSession:function(){return z},login:A.login}}]})}).call(this);