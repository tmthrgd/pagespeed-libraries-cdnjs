(function(){var a={}.hasOwnProperty;angular.module("knalli.angular-vertxbus",["ng"]),angular.module("knalli.angular-vertxbus").provider("vertxEventBus",function(){var a,b;a={enabled:!0,debugEnabled:!1,prefix:"vertx-eventbus.",urlServer:""+location.protocol+"//"+location.hostname+":"+(location.port||80),urlPath:"/eventbus",reconnectEnabled:!0,sockjsStateInterval:1e4,sockjsReconnectInterval:1e4,sockjsOptions:{},messageBuffer:0},b=angular.extend({},a),this.enable=function(c){return null==c&&(c=a.enabled),b.enabled=c===!0,this},this.useDebug=function(c){return null==c&&(c=a.debugEnabled),b.debugEnabled=c===!0,this},this.usePrefix=function(c){return null==c&&(c=a.prefix),b.prefix=c,this},this.useUrlServer=function(c){return null==c&&(c=a.urlServer),b.urlServer=c,this},this.useUrlPath=function(c){return null==c&&(c=a.urlPath),b.urlPath=c,this},this.useReconnect=function(c){return null==c&&(c=a.reconnectEnabled),b.reconnectEnabled=c,this},this.useSockJsStateInterval=function(c){return null==c&&(c=a.sockjsStateInterval),b.sockjsStateInterval=c,this},this.useSockJsReconnectInterval=function(c){return null==c&&(c=a.sockjsReconnectInterval),b.sockjsReconnectInterval=c,this},this.useSockJsOptions=function(c){return null==c&&(c=a.sockjsOptions),b.sockjsOptions=c,this},this.useMessageBuffer=function(c){return null==c&&(c=a.messageBuffer),b.messageBuffer=c,this},this.$get=["$timeout",function(c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;return r=angular.extend({},a,b),g=r.enabled,f=r.debugEnabled,i=r.prefix,q=r.urlServer,p=r.urlPath,j=r.reconnectEnabled,m=r.sockjsStateInterval,l=r.sockjsReconnectInterval,k=r.sockjsOptions,n=null,d="undefined"!=typeof vertx&&null!==vertx?vertx.EventBus:void 0,g&&d?(o=""+q+p,f&&console.debug("[VertX EventBus] Enabled: connecting '"+o+"'"),h=null,e=function(){h=new d(o,void 0,k),h.onopen=function(){f&&console.debug("[VertX EventBus] Connected"),"function"==typeof n.onopen&&n.onopen()},h.onclose=function(){f&&console.debug("[VertX EventBus] Reconnect in "+l+"ms"),"function"==typeof n.onclose&&n.onclose(),j&&c(e,l)}},e(),n={reconnect:function(){return h.close()},close:function(){return h.close()},login:function(a,b,c){return h.login(a,b,c)},send:function(a,b,c){return h.send(a,b,c)},publish:function(a,b){return h.publish(a,b)},registerHandler:function(a,b){return h.registerHandler(a,b),function(){n.unregisterHandler(a,b)}},unregisterHandler:function(a,b){return h.unregisterHandler(a,b)},readyState:function(){return h.readyState()},EventBus:d,getOptions:function(){return angular.extend({},b)}}):f&&console.debug("[VertX EventBus] Disabled"),n}]}),angular.module("knalli.angular-vertxbus").provider("vertxEventBusService",function(){var b,c,d,e;b={loginRequired:!1,loginBlockForSession:!1,skipUnauthorizeds:!0},c=function(){function a(a){this.maxSize=null!=a?a:10,this.items=[]}return a.prototype.push=function(a){return this.items.push(a),this.recalibrateBufferSize()},a.prototype.recalibrateBufferSize=function(){for(;this.items.length>this.maxSize;)this.first();return this},a.prototype.last=function(){return this.items.pop()},a.prototype.first=function(){return this.items.shift(0)},a.prototype.size=function(){return this.items.length},a}(),d=function(){function a(){this.keys=[],this.values=[]}return a.prototype.keys=null,a.prototype.values=null,a.prototype.put=function(a,b){var c;return c=this._indexForKey(a),c>-1?this.values[c]=b:(this.keys.push(a),this.values.push(b)),this},a.prototype._indexForKey=function(a){var b,c,d,e,f;for(f=this.keys,b=d=0,e=f.length;e>d;b=++d)if(c=f[b],a===c)return b;return-1},a.prototype._indexForValue=function(a){var b,c,d,e,f;for(f=this.values,b=d=0,e=f.length;e>d;b=++d)if(c=f[b],a===c)return b;return-1},a.prototype.containsKey=function(a){var b;return b=this._indexForKey(a),b>-1},a.prototype.containsValue=function(a){var b;return b=this._indexForValue(a),b>-1},a.prototype.get=function(a){var b;return b=this._indexForKey(a),b>-1?this.values[b]:void 0},a.prototype.remove=function(a){var b;return b=this._indexForKey(a),void(b>-1&&(this.keys[b]=void 0,this.values[b]=void 0))},a.prototype.clear=function(){return this.keys=[],this.values=[],this},a}(),e=angular.extend({},b),this.requireLogin=function(a){return null==a&&(a=e.loginRequired),e.loginRequired=a,this},this.blockForSession=function(a){return null==a&&(a=e.loginBlockForSession),e.loginBlockForSession=a,this},this.skipUnauthorizeds=function(a){return null==a&&(a=e.skipUnauthorizeds),e.skipUnauthorizeds=a,this},this.$get=["$rootScope","$q","$interval","$timeout","vertxEventBus",function(b,f,g,h,i){var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D;return C=(null!=i?i.getOptions():void 0)||{},l=C.enabled,k=C.debugEnabled,s=C.prefix,y=C.urlServer,x=C.urlPath,t=C.reconnectEnabled,w=C.sockjsStateInterval,v=C.sockjsReconnectInterval,u=C.sockjsOptions,q=C.messageBuffer,j=null!=i&&null!=(D=i.EventBus)?D.CLOSED:void 0,A=!1,p=null,r=new c(q),o=new d,l&&i&&(i.onopen=function(){var c,d,e,f,g,h,i;B.getConnectionState(!0),b.$broadcast(""+s+"system.connected"),i=B.handlers;for(c in i)if(a.call(i,c))for(e=i[c],g=0,h=e.length;h>g;g++)d=e[g],z.registerHandler(c,d);if(b.$digest(),q&&r.size()){for(;r.size();)f=r.first(),"function"==typeof f&&f();b.$digest()}},i.onclose=function(){return B.getConnectionState(!0),b.$broadcast(""+s+"system.disconnected")}),n=function(a){return B.getConnectionState()===i.EventBus.OPEN?(a(),!0):q?(r.push(a),!0):!1},m=function(a){return n(e.loginRequired?function(){return A?(a(),!0):(k&&console.debug("[VertX EB Service] Message was not sent because login is required"),!1)}:a)},z={registerHandler:function(a,c){return"function"==typeof c?(k&&console.debug("[VertX EB Service] Register handler for "+a),o.containsKey(c)?o.get(c):(o.put(c,function(a,d){return c(a,d),b.$digest()}),i.registerHandler(a,o.get(c)))):void 0},unregisterHandler:function(a,b){"function"==typeof b&&(k&&console.debug("[VertX EB Service] Unregister handler for "+a),i.unregisterHandler(a,o.get(b)),o.remove(b))},send:function(a,b,c){var d,e;return null==c&&(c=1e4),d=f.defer(),e=m(function(){return i.send(a,b,function(a){return d?d.resolve(a):void 0}),d?h(function(){return d.reject()},c):void 0}),d&&!e&&d.reject(),null!=d?d.promise:void 0},publish:function(a,b){var c;return c=m(function(){return i.publish(a,b)})},login:function(a,c,d){var e;return null==d&&(d=5e3),e=f.defer(),i.login(a,c,function(a){return"ok"===(null!=a?a.status:void 0)?(e.resolve(a),b.$broadcast(""+s+"system.login.succeeded",{status:null!=a?a.status:void 0})):(e.reject(a),b.$broadcast(""+s+"system.login.failed",{status:null!=a?a.status:void 0}))}),h(function(){return e.reject()},d),e.promise}},B={handlers:{},registerHandler:function(a,b){var c;return B.handlers[a]||(B.handlers[a]=[]),B.handlers[a].push(b),c=null,j===i.EventBus.OPEN&&(c=z.registerHandler(a,b)),function(){var d;c&&c(),B.handlers[a]&&(d=B.handlers[a].indexOf(b),d>-1&&B.handlers[a].splice(d,1))}},unregisterHandler:function(a,b){var c;return B.handlers[a]&&(c=B.handlers[a].indexOf(b),c>-1&&B.handlers[a].splice(c,1)),j===i.EventBus.OPEN?z.unregisterHandler(a,b):void 0},send:function(a,b,c){return null==c&&(c=1e4),z.send(a,b,c)},publish:function(a,b){return z.publish(a,b)},getConnectionState:function(a){return(null!=i?i.EventBus:void 0)?l?a&&(j=i.readyState()):j=i.EventBus.CLOSED:j=3,j},isValidSession:function(){return A},login:function(a,b){return z.login(a,b).then(function(a){return A=!0,a})["catch"](function(a){return A=!1,a})}},g(function(){return B.getConnectionState(!0)},w),{on:B.registerHandler,addListener:B.registerHandler,un:B.unregisterHandler,removeListener:B.unregisterHandler,send:B.send,publish:B.publish,emit:B.publish,readyState:B.getConnectionState,isEnabled:function(){return l},getBufferCount:function(){return r.size()},isValidSession:function(){return A},login:B.login}}]})}).call(this);